/**
 * @file controller.js
 *
 * Interacts with web-server for sending and recieving data.
 *//**
 * Global variable to set value of failed record requests
 * to true/false.
 */function call_animate_save(a,b,c){c?c(b):typeof animate_save!="undefined"&&animate_save(a,b)}function removeReadonlyRanges(a){var b={};return a.forEach(function(a){var c=a.delta.action,d=a.delta.start.row+a.delta.start.column,e=a.delta.end.row+a.delta.end.column,f=a.delta.lines.join(),g=a.timestamp,h=c+d+e+f+g;b[h]={initial_state:{code:a.source},delta:a.delta,timestamp:a.timestamp}}),Object.values(b)}function record_changesets(a,b,c,d,e,f){if(!c)return;var g={changesets:a?removeReadonlyRanges(a):[],final_code:b,last_modified:a&&a.length?a[a.length-1].timestamp:(new Date).getTime()};$(".editor-save-code").html("Saving..."),$.ajax({url:c,type:"POST",retry:d,post_data:g,contentType:"application/json; charset=utf-8",async:!0,changesets:a,data:JSON.stringify(g),success:function(a){a.status&&a.status.toLowerCase()==="ok"?(call_animate_save(".editor-save-code",!0,f),g_record_request_failed&&(g_record_request_failed=!1,typeof finish_all_recordings!="undefined"&&finish_all_recordings()),e!=undefined&&typeof e=="function"&&e()):call_animate_save(".editor-save-code",!1,f)},error:function(a){call_animate_save(".editor-save-code",!1,f);if(!this.async)return;if(NOT_ALLOWED_ERROR_CODES.indexOf(a.status)>=0)return;g_record_request_failed=!0,this.retry+=1;var c=this.retry,d=this.async,g=this.changesets,h=this.url,i=function(){return function(){record_changesets(g,b,h,c,e,f)}}(g,h,c,d);setTimeout(i,1e4)}})}function setup_timeline(a,b,c){$.ajax({url:a||SETUP_URL,type:"POST",data:b,dataType:"json",callback:c,success:function(a,b,c){this.callback(c.status,a)},error:function(c,d){Raven&&Raven.captureException(new Error("ajax error in code player setup"),{extra:{origin:"controller.js - ajax error",data:{url:a,status:c.status,responseText:c.responseText,payload:b?JSON.stringify(b):null}}}),this.callback(c.status,c.statusText)}})}var g_record_request_failed=!1,NOT_ALLOWED_ERROR_CODES=[500],SETUP_URL="/timeline/api/codevideos/setup/";