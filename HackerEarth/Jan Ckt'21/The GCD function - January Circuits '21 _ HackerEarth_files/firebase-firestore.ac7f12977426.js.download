!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app"],b):b((a=a||self).firebase)}(this,function(a){"use strict";try{(function(){function e(a,b){function c(){this.constructor=a}d(a,b),a.prototype=null===b?Object.create(b):(c.prototype=b.prototype,new c)}function f(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d.throw(a))}catch(a){f(a)}}function i(a){a.done?e(a.value):(new c(function(b){b(a.value)})).then(g,h)}i((d=d.apply(a,b||[])).next())})}function g(a,b){function h(f){return function(h){return function(f){if(c)throw new TypeError("Generator is already executing.");for(;g;)try{if(c=1,d&&(e=2&f[0]?d.return:f[0]?d.throw||((e=d.return)&&e.call(d),0):d.next)&&!(e=e.call(d,f[1])).done)return e;switch(d=0,e&&(f=[2&f[0],e.value]),f[0]){case 0:case 1:e=f;break;case 4:return g.label++,{value:f[1],done:!1};case 5:g.label++,d=f[1],f=[0];continue;case 7:f=g.ops.pop(),g.trys.pop();continue;default:if(!(e=0<(e=g.trys).length&&e[e.length-1])&&(6===f[0]||2===f[0])){g=0;continue}if(3===f[0]&&(!e||f[1]>e[0]&&f[1]<e[3])){g.label=f[1];break}if(6===f[0]&&g.label<e[1]){g.label=e[1],e=f;break}if(e&&g.label<e[2]){g.label=e[2],g.ops.push(f);break}e[2]&&g.ops.pop(),g.trys.pop();continue}f=b.call(a,g)}catch(h){f=[6,h],d=0}finally{c=e=0}if(5&f[0])throw f[1];return{value:f[0]?f[1]:void 0,done:!0}}([f,h])}}var c,d,e,f,g={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]};return f={next:h(0),"throw":h(1),"return":h(2)},"function"==typeof Symbol&&(f[Symbol.iterator]=function(){return this}),f}function h(a){var b="function"==typeof Symbol&&a[Symbol.iterator],c=0;return b?b.call(a):{next:function(){return a&&c>=a.length&&(a=void 0),{value:a&&a[c++],done:!a}}}}function i(a,b){var c="function"==typeof Symbol&&a[Symbol.iterator];if(!c)return a;var d,e,f=c.call(a),g=[];try{for(;(void 0===b||0<b--)&&!(d=f.next()).done;)g.push(d.value)}catch(a){e={error:a}}finally{try{d&&!d.done&&(c=f.return)&&c.call(f)}finally{if(e)throw e.error}}return g}function j(){for(var a=[],b=0;b<arguments.length;b++)a=a.concat(i(arguments[b]));return a}function k(a,b){var c="function"==typeof Symbol&&a[Symbol.iterator];if(!c)return a;var d,e,f=c.call(a),g=[];try{for(;(void 0===b||0<b--)&&!(d=f.next()).done;)g.push(d.value)}catch(a){e={error:a}}finally{try{d&&!d.done&&(c=f.return)&&c.call(f)}finally{if(e)throw e.error}}return g}function l(){for(var a=[],b=0;b<arguments.length;b++)a=a.concat(k(arguments[b]));return a}function p(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function x(a){return"string"==typeof a}function y(a){return"number"==typeof a}function z(a,b){a=a.split("."),b=b||w;for(var c=0;c<a.length;c++)if(null==(b=b[a[c]]))return null;return b}function A(){}function B(a){var b=typeof a;if("object"==b){if(!a)return"null";if(a instanceof Array)return"array";if(a instanceof Object)return b;var c=Object.prototype.toString.call(a);if("[object Window]"==c)return"object";if("[object Array]"==c||"number"==typeof a.length&&void 0!==a.splice&&void 0!==a.propertyIsEnumerable&&!a.propertyIsEnumerable("splice"))return"array";if("[object Function]"==c||void 0!==a.call&&void 0!==a.propertyIsEnumerable&&!a.propertyIsEnumerable("call"))return"function"}else if("function"==b&&void 0===a.call)return"object";return b}function C(a){return"array"==B(a)}function D(a){var b=B(a);return"array"==b||"object"==b&&"number"==typeof a.length}function E(a){var b=typeof a;return"object"==b&&null!=a||"function"==b}function H(a,b,c){return a.call.apply(a.bind,arguments)}function I(a,b,c){if(!a)throw Error();if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(c,d),a.apply(b,c)}}return function(){return a.apply(b,arguments)}}function J(a,b,c){return(J=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?H:I).apply(null,arguments)}function K(a,b){var c=Array.prototype.slice.call(arguments,1);return function(){var b=c.slice();return b.push.apply(b,arguments),a.apply(this,b)}}function M(a,b){function c(){}c.prototype=b.prototype,a.N=b.prototype,a.prototype=new c,(a.prototype.constructor=a).yb=function(a,c,d){for(var e=Array(arguments.length-2),f=2;f<arguments.length;f++)e[f-2]=arguments[f];return b.prototype[c].apply(a,e)}}function N(){this.j=this.j,this.i=this.i}function Q(a){return Array.prototype.concat.apply([],arguments)}function R(a){var b=a.length;if(0<b){for(var c=Array(b),d=0;d<b;d++)c[d]=a[d];return c}return[]}function S(a){return/^[\s\xa0]*$/.test(a)}function V(a,b){return-1!=a.indexOf(b)}function W(a,b){return a<b?-1:b<a?1:0}function Z(a,b,c){for(var d in a)b.call(c,a[d],d,a)}function $(a){var b,c={};for(b in a)c[b]=a[b];return c}function ab(a,b){for(var c,d,e=1;e<arguments.length;e++){for(c in d=arguments[e])a[c]=d[c];for(var f=0;f<_.length;f++)c=_[f],Object.prototype.hasOwnProperty.call(d,c)&&(a[c]=d[c])}}function bb(a){return bb[" "](a),a}function kb(){var a=w.document;return a?a.documentMode:void 0}function qb(a){return b=a,c=function(){for(var b=0,c=U(String(cb)).split("."),d=U(String(a)).split("."),e=Math.max(c.length,d.length),f=0;0==b&&f<e;f++){var g=c[f]||"",h=d[f]||"";do{if(g=/(\d*)(\D*)(.*)/.exec(g)||["","","",""],h=/(\d*)(\D*)(.*)/.exec(h)||["","","",""],0==g[0].length&&0==h[0].length)break;b=W(0==g[1].length?0:parseInt(g[1],10),0==h[1].length?0:parseInt(h[1],10))||W(0==g[2].length,0==h[2].length)||W(g[2],h[2]),g=g[3],h=h[3]}while(0==b)}return 0<=b},d=pb,Object.prototype.hasOwnProperty.call(d,b)?d[b]:d[b]=c(b);var b,c,d}function vb(a,b){this.type=a,this.a=this.target=b,this.Ja=!0}function wb(a,b){if(vb.call(this,a?a.type:""),this.relatedTarget=this.a=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.pointerId=0,this.pointerType="",this.c=null,a){var c=this.type=a.type,d=a.changedTouches&&a.changedTouches.length?a.changedTouches[0]:null;if(this.target=a.target||a.srcElement,this.a=b,b=a.relatedTarget){if(ib){a:{try{bb(b.nodeName);var e=!0;break a}catch(a){}e=!1}e||(b=null)}}else"mouseover"==c?b=a.fromElement:"mouseout"==c&&(b=a.toElement);this.relatedTarget=b,this.screenY=d?(this.clientX=void 0!==d.clientX?d.clientX:d.pageX,this.clientY=void 0!==d.clientY?d.clientY:d.pageY,this.screenX=d.screenX||0,d.screenY||0):(this.clientX=void 0!==a.clientX?a.clientX:a.pageX,this.clientY=void 0!==a.clientY?a.clientY:a.pageY,this.screenX=a.screenX||0,a.screenY||0),this.button=a.button,this.key=a.key||"",this.ctrlKey=a.ctrlKey,this.altKey=a.altKey,this.shiftKey=a.shiftKey,this.metaKey=a.metaKey,this.pointerId=a.pointerId||0,this.pointerType=x(a.pointerType)?a.pointerType:xb[a.pointerType]||"",(this.c=a).defaultPrevented&&this.b()}}function Ab(a,b,c,d,e){this.listener=a,this.proxy=null,this.src=b,this.type=c,this.capture=!!d,this.da=e,this.key=++zb,this.X=this.Z=!1}function Bb(a){a.X=!0,a.listener=null,a.proxy=null,a.src=null,a.da=null}function Cb(a){this.src=a,this.a={},this.b=0}function Db(a,b){var c=b.type;if(c in a.a){var d,e=a.a[c],f=O(e,b);(d=0<=f)&&Array.prototype.splice.call(e,f,1),d&&(Bb(b),0==a.a[c].length&&(delete a.a[c],a.b--))}}function Eb(a,b,c,d){for(var e=0;e<a.length;++e){var f=a[e];if(!f.X&&f.listener==b&&f.capture==!!c&&f.da==d)return e}return-1}function Hb(a,b,c,d,e){if(d&&d.once)return function g(a,b,c,d,e){if(C(b)){for(var f=0;f<b.length;f++)g(a,b[f],c,d,e);return null}return c=Pb(c),a&&a[yb]?a.Ba(b,c,E(d)?!!d.capture:!!d,e):Ib(a,b,c,!0,d,e)}(a,b,c,d,e);if(C(b)){for(var f=0;f<b.length;f++)Hb(a,b[f],c,d,e);return null}return c=Pb(c),a&&a[yb]?a.Aa(b,c,E(d)?!!d.capture:!!d,e):Ib(a,b,c,!1,d,e)}function Ib(a,b,c,d,e,f){if(!b)throw Error("Invalid event type");var g=E(e)?!!e.capture:!!e;if(g&&!sb)return null;var h,i,j=Nb(a);if(j||(a[Fb]=j=new Cb(a)),(c=j.add(b,c,d,g,f)).proxy)return c;if(h=Mb,d=i=sb?function(a){return h.call(i.src,i.listener,a)}:function(a){if(!(a=h.call(i.src,i.listener,a)))return a},(c.proxy=d).src=a,d.listener=c,a.addEventListener)ub||(e=g),void 0===e&&(e=!1),a.addEventListener(b.toString(),d,e);else if(a.attachEvent)a.attachEvent(Kb(b.toString()),d);else{if(!a.addListener||!a.removeListener)throw Error("addEventListener and attachEvent are unavailable.");a.addListener(d)}return c}function Jb(a){if(!y(a)&&a&&!a.X){var b=a.src;if(b&&b[yb])Db(b.c,a);else{var c=a.type,d=a.proxy;b.removeEventListener?b.removeEventListener(c,d,a.capture):b.detachEvent?b.detachEvent(Kb(c),d):b.addListener&&b.removeListener&&b.removeListener(d),(c=Nb(b))?(Db(c,a),0==c.b&&(c.src=null,b[Fb]=null)):Bb(a)}}}function Kb(a){return a in Gb?Gb[a]:Gb[a]="on"+a}function Lb(a,b){var c=a.listener,d=a.da||a.src;return a.Z&&Jb(a),c.call(d,b)}function Mb(a,b){return!!a.X||(sb?Lb(a,new wb(b,this)):Lb(a,b=new wb(b||z("window.event"),this)))}function Nb(a){return(a=a[Fb])instanceof Cb?a:null}function Pb(a){return"function"==B(a)?a:(a[Ob]||(a[Ob]=function(b){return a.handleEvent(b)}),a[Ob])}function Qb(){N.call(this),this.c=new Cb(this),(this.J=this).B=null}function Rb(a,b,c,d){if(!(b=a.c.a[String(b)]))return!0;b=b.concat();for(var e=!0,f=0;f<b.length;++f){var g=b[f];if(g&&!g.X&&g.capture==c){var h=g.listener,i=g.da||g.src;g.Z&&Db(a.c,g),e=!1!==h.call(i,d)&&e}}return e&&0!=d.Ja}function Tb(a,b){this.c=a,this.f=b,this.b=0,this.a=null}function Ub(){this.b=this.a=null}function Xb(){this.next=this.b=this.a=null}function Yb(a){w.setTimeout(function(){throw a},0)}function Zb(a,b){var c;Vb||(c=w.Promise.resolve(void 0),Vb=function(){c.then(ac)}),$b||(Vb(),$b=!0),_b.add(a,b)}function ac(){for(var a;d=c=void 0,d=null,(c=_b).a&&(d=c.a,c.a=c.a.next,c.a||(c.b=null),d.next=null),a=d;){try{a.a.call(a.b)}catch(a){Yb(a)}var b=Wb;b.f(a),b.b<100&&(b.b++,a.next=b.a,b.a=a)}var c,d;$b=!1}function bc(a,b){Qb.call(this),this.b=a||1,this.a=b||w,this.f=J(this.gb,this),this.g=L()}function cc(a){a.ba=!1,a.L&&(a.a.clearTimeout(a.L),a.L=null)}function dc(a,b,c){if("function"==B(a))c&&(a=J(a,c));else{if(!a||"function"!=typeof a.handleEvent)throw Error("Invalid listener argument");a=J(a.handleEvent,a)}return 2147483647<Number(b)?-1:w.setTimeout(a,b||0)}function ec(a,b,c){N.call(this),this.f=null!=c?J(a,c):a,this.c=b,this.b=J(this.ab,this),this.a=[]}function fc(a){a.U=dc(a.b,a.c),a.f.apply(null,a.a)}function gc(a){N.call(this),this.b=a,this.a={}}function ic(a,b,c,d){C(c)||(c&&(hc[0]=c.toString()),c=hc);for(var e=0;e<c.length;e++){var f=Hb(b,c[e],d||a.handleEvent,!1,a.b||a);if(!f)break;a.a[f.key]=f}}function jc(a){Z(a.a,function(a,b){this.a.hasOwnProperty(b)&&Jb(a)},a),a.a={}}function kc(){}function mc(a){vb.call(this,"serverreachability",a)}function nc(a){lc.dispatchEvent(new mc(lc,a))}function oc(a){vb.call(this,"statevent",a)}function pc(a){lc.dispatchEvent(new oc(lc,a))}function qc(a){vb.call(this,"timingevent",a)}function rc(a,b){if("function"!=B(a))throw Error("Fn must not be null and must be a function");return w.setTimeout(function(){a()},b)}function uc(){}function vc(a){var b;return(b=a.a)||(b=a.a={}),b}function wc(){}function zc(){vb.call(this,"d")}function Ac(){vb.call(this,"c")}function Bc(){}function Cc(a,b,c){this.g=a,this.W=b,this.V=c||1,this.I=new gc(this),this.O=Dc,a=hb?125:void 0,this.P=new bc(a),this.h=null,this.b=!1,this.l=this.D=this.f=this.F=this.v=this.R=this.i=null,this.j=[],this.a=null,this.A=0,this.c=this.w=null,this.o=-1,this.m=!1,this.J=0,this.B=null,this.s=this.S=this.H=!1}function Gc(a,b,c){a.F=1,a.f=dd(Yc(b)),a.l=c,a.H=!0,Ic(a,null)}function Hc(a,b,c,d){a.F=1,a.f=dd(Yc(b)),a.l=null,a.H=c,Ic(a,d)}function Ic(a,b){a.v=L(),Lc(a),a.D=Yc(a.f),cd(a.D,"t",a.V),a.A=0,a.a=a.g.$(a.g.Y()?b:null),0<a.J&&(a.B=new ec(J(a.Ka,a,a.a),a.J)),ic(a.I,a.a,"readystatechange",a.eb),b=a.h?$(a.h):{},a.l?(a.w||(a.w="POST"),b["Content-Type"]="application/x-www-form-urlencoded",a.a.ca(a.D,a.w,a.l,b)):(a.w="GET",a.a.ca(a.D,a.w,null,b)),nc(1)}function Jc(a,b,c){for(var d=!0;!a.m&&a.A<c.length;){var e=Kc(a,c);if(e==Fc){4==b&&(a.c=4,pc(14),d=!1);break}if(e==Ec){a.c=4,pc(15),d=!1;break}Qc(a,e)}4==b&&0==c.length&&(a.c=1,pc(16),d=!1),a.b=a.b&&d,d||(Pc(a),Oc(a))}function Kc(a,b){var c=a.A,d=b.indexOf("\n",c);return-1==d?Fc:(c=Number(b.substring(c,d)),isNaN(c)?Ec:(d+=1)+c>b.length?Fc:(b=b.substr(d,c),a.A=d+c,b))}function Lc(a){a.R=L()+a.O,Mc(a,a.O)}function Mc(a,b){if(null!=a.i)throw Error("WatchDog timer not null");a.i=rc(J(a.bb,a),b)}function Nc(a){a.i&&(w.clearTimeout(a.i),a.i=null)}function Oc(a){a.g.Da()||a.m||a.g.na(a)}function Pc(a){Nc(a);var b=a.B;b&&"function"==typeof b.la&&b.la(),a.B=null,cc(a.P),jc(a.I),a.a&&(b=a.a,a.a=null,b.abort(),b.la())}function Qc(a,b){try{a.g.Ga(a,b),nc(4)}catch(a){}}function Rc(a,b){if(a.forEach&&"function"==typeof a.forEach)a.forEach(b,void 0);else if(D(a)||x(a))P(a,b,void 0);else{if(a.K&&"function"==typeof a.K)var c=a.K();else if(a.C&&"function"==typeof a.C)c=void 0;else if(D(a)||x(a)){c=[];for(var d=a.length,e=0;e<d;e++)c.push(e)}else for(e in c=[],d=0,a)c[d++]=e;e=(d=function(a){if(a.C&&"function"==typeof a.C)return a.C();if(x(a))return a.split("");if(D(a)){for(var b=[],c=a.length,d=0;d<c;d++)b.push(a[d]);return b}for(d in b=[],c=0,a)b[c++]=a[d];return b}(a)).length;for(var f=0;f<e;f++)b.call(void 0,d[f],c&&c[f],a)}}function Sc(a,b){this.b={},this.a=[],this.c=0;var c=arguments.length;if(1<c){if(c%2)throw Error("Uneven number of arguments");for(var d=0;d<c;d+=2)this.set(arguments[d],arguments[d+1])}else if(a)if(a instanceof Sc)for(c=a.K(),d=0;d<c.length;d++)this.set(c[d],a.get(c[d]));else for(d in a)this.set(d,a[d])}function Tc(a,b){Vc(a.b,b)&&(delete a.b[b],a.c--,a.a.length>2*a.c&&Uc(a))}function Uc(a){if(a.c!=a.a.length){for(var b=0,c=0;b<a.a.length;){var d=a.a[b];Vc(a.b,d)&&(a.a[c++]=d),b++}a.a.length=c}if(a.c!=a.a.length){var e={};for(c=b=0;b<a.a.length;)Vc(e,d=a.a[b])||(e[a.a[c++]=d]=1),b++;a.a.length=c}}function Vc(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function Xc(a,b){var c;this.b=this.j=this.f="",this.i=null,this.g=this.a="",this.h=!1,a instanceof Xc?(this.h=void 0!==b?b:a.h,Zc(this,a.f),this.j=a.j,$c(this,a.b),_c(this,a.i),this.a=a.a,ad(this,rd(a.c)),this.g=a.g):a&&(c=String(a).match(Wc))?(this.h=!!b,Zc(this,c[1]||"",!0),this.j=ed(c[2]||""),$c(this,c[3]||"",!0),_c(this,c[4]),this.a=ed(c[5]||"",!0),ad(this,c[6]||"",!0),this.g=ed(c[7]||"")):(this.h=!!b,this.c=new md(null,this.h))}function Yc(a){return new Xc(a)}function Zc(a,b,c){a.f=c?ed(b,!0):b,a.f&&(a.f=a.f.replace(/:$/,""))}function $c(a,b,c){a.b=c?ed(b,!0):b}function _c(a,b){if(b){if(b=Number(b),isNaN(b)||b<0)throw Error("Bad port number "+b);a.i=b}else a.i=null}function ad(a,b,c){var d,e;b instanceof md?(a.c=b,d=a.c,(e=a.h)&&!d.f&&(nd(d),d.c=null,d.a.forEach(function(a,b){var c=b.toLowerCase();b!=c&&(od(this,b),qd(this,c,a))},d)),d.f=e):(c||(b=fd(b,kd)),a.c=new md(b,a.h))}function bd(a,b,c){a.c.set(b,c)}function cd(a,b,c){C(c)||(c=[String(c)]),qd(a.c,b,c)}function dd(a){return bd(a,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^L()).toString(36)),a}function ed(a,b){return a?b?decodeURI(a.replace(/%25/g,"%2525")):decodeURIComponent(a):""}function fd(a,b,c){return x(a)?(a=encodeURI(a).replace(b,gd),c&&(a=a.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),a):null}function gd(a){return"%"+((a=a.charCodeAt(0))>>4&15).toString(16)+(15&a).toString(16)}function md(a,b){this.b=this.a=null,this.c=a||null,this.f=!!b}function nd(a){a.a||(a.a=new Sc,a.b=0,a.c&&function(a,b){if(a){a=a.split("&");for(var c=0;c<a.length;c++){var d=a[c].indexOf("="),e=null;if(0<=d){var f=a[c].substring(0,d);e=a[c].substring(d+1)}else f=a[c];b(f,e?decodeURIComponent(e.replace(/\+/g," ")):"")}}}(a.c,function(b,c){a.add(decodeURIComponent(b.replace(/\+/g," ")),c)}))}function od(a,b){nd(a),b=sd(a,b),Vc(a.a.b,b)&&(a.c=null,a.b-=a.a.get(b).length,Tc(a.a,b))}function pd(a,b){return nd(a),b=sd(a,b),Vc(a.a.b,b)}function qd(a,b,c){od(a,b),0<c.length&&(a.c=null,a.a.set(sd(a,b),R(c)),a.b+=c.length)}function rd(a){var b=new md;return b.c=a.c,a.a&&(b.a=new Sc(a.a),b.b=a.b),b}function sd(a,b){return b=String(b),a.f&&(b=b.toLowerCase()),b}function td(a){this.a=a,this.b=this.h=null,this.g=!1,this.i=null,this.c=-1,this.l=this.f=null}function ud(a){var b=a.a.F.a;if(null!=b)pc(4),b?(pc(10),ie(a.a,a,!1)):(pc(11),ie(a.a,a,!0));else{a.b=new Cc(a,void 0,void 0),a.b.h=a.h,b=ne(b=a.a,b.Y()?a.f:null,a.i),pc(4),cd(b,"TYPE","xmlhttp");var c=a.a.j,d=a.a.I;c&&d&&bd(b,c,d),Hc(a.b,b,!1,a.f)}}function vd(){this.a=this.b=null}function wd(){this.a=new Sc}function xd(a){var b=typeof a;return"object"==b&&a||"function"==b?"o"+(a[F]||(a[F]=++G)):b.charAt(0)+a}function yd(a,b){this.b=a,this.a=b}function zd(a){this.g=a||Ad,a=w.PerformanceNavigationTiming?0<(a=w.performance.getEntriesByType("navigation")).length&&("hq"==a[0].nextHopProtocol||"h2"==a[0].nextHopProtocol):!!(w.ka&&w.ka.Ea&&w.ka.Ea()&&w.ka.Ea().zb),this.f=a?this.g:1,this.a=null,1<this.f&&(this.a=new wd),this.b=null,this.c=[]}function Bd(a,b){!a.a&&(V(b,"spdy")||V(b,"quic")||V(b,"h2"))&&(a.f=a.g,a.a=new wd,a.b&&(Fd(a,a.b),a.b=null))}function Cd(a){return!!a.b||!!a.a&&a.a.a.c>=a.f}function Dd(a){return a.b?1:a.a?a.a.a.c:0}function Ed(a,b){return a=a.b?a.b==b:!!a.a&&(b=xd(b),Vc(a.a.a.b,b))}function Fd(a,b){a.a?a.a.add(b):a.b=b}function Gd(a,b){var c;a.b&&a.b==b?a.b=null:((c=a.a)&&(c=xd(b),c=Vc(a.a.a.b,c)),c&&Tc(a.a.a,xd(b)))}function Hd(a){if(null!=a.b)return a.c.concat(a.b.j);if(null==a.a||0==a.a.a.c)return R(a.c);var b=a.c;return P(a.a.C(),function(a){b=b.concat(a.j)}),b}function Id(){}function Jd(){this.a=new Id}function Kd(a,b,c){var d=c||"";try{Rc(a,function(a,c){var e=a;E(a)&&(e=Sb(a)),b.push(d+c+"="+encodeURIComponent(e))})}catch(a){throw b.push(d+"type="+encodeURIComponent("_badmap")),a}}function Ld(a,b,c,d,e){try{b.onload=null,b.onerror=null,b.onabort=null,b.ontimeout=null,e(d)}catch(a){}}function Nd(a){Qb.call(this),this.headers=new Sc,this.H=a||null,this.b=!1,this.s=this.a=null,this.A="",this.h=0,this.f="",this.g=this.w=this.l=this.v=!1,this.o=0,this.m=null,this.I=Od,this.D=this.F=!1}function Rd(a){return"content-type"==a.toLowerCase()}function Sd(a,b){a.b=!1,a.a&&(a.g=!0,a.a.abort(),a.g=!1),a.f=b,a.h=5,Td(a),Vd(a)}function Td(a){a.v||(a.v=!0,a.dispatchEvent("complete"),a.dispatchEvent("error"))}function Ud(a){if(a.b&&void 0!==v&&(!a.s[1]||4!=Xd(a)||2!=a.T()))if(a.l&&4==Xd(a))dc(a.Fa,0,a);else if(a.dispatchEvent("readystatechange"),4==Xd(a)){a.b=!1;try{var b,c=a.T();a:switch(c){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var d=!0;break a;default:d=!1}if(!(b=d)){var e;if(e=0===c){var f=String(a.A).match(Wc)[1]||null;if(!f&&w.self&&w.self.location){var g=w.self.location.protocol;f=g.substr(0,g.length-1)}e=!Pd.test(f?f.toLowerCase():"")}b=e}b?(a.dispatchEvent("complete"),a.dispatchEvent("success")):(a.h=6,a.f=a.za()+" ["+a.T()+"]",Td(a))}finally{Vd(a)}}}function Vd(a,b){if(a.a){Wd(a);var c=a.a,d=a.s[0]?A:null;a.a=null,a.s=null,b||a.dispatchEvent("ready");try{c.onreadystatechange=d}catch(a){}}}function Wd(a){a.a&&a.D&&(a.a.ontimeout=null),a.m&&(w.clearTimeout(a.m),a.m=null)}function Xd(a){return a.a?a.a.readyState:0}function Yd(a,b){return a.a?a.a.getResponseHeader(b):null}function Zd(a,b,c){a:{for(d in c){var d=!1;break a}d=!0}if(d)return a;var e;if(e="",Z(c,function(a,b){e+=b,e+=":",e+=a,e+="\r\n"}),c=e,x(a)){if(b=encodeURIComponent(String(b)),b+=c=null!=c?"="+encodeURIComponent(String(c)):""){if((c=a.indexOf("#"))<0&&(c=a.length),(d=a.indexOf("?"))<0||c<d){d=c;var f=""}else f=a.substring(d+1,c);c=(a=[a.substr(0,d),f,a.substr(c)])[1],a[1]=b?c?c+"&"+b:b:c,a=a[0]+(a[1]?"?"+a[1]:"")+a[2]}return a}return bd(a,b,c),a}function $d(a){this.f=[],this.F=new vd,this.ga=this.pa=this.B=this.ha=this.a=this.I=this.j=this.V=this.g=this.J=this.i=null,this.Ra=this.P=0,this.Pa=!!z("internalChannelParams.failFast",a),this.ia=this.w=this.s=this.l=this.h=this.c=null,this.oa=!0,this.m=this.ra=this.O=-1,this.S=this.v=this.A=0,this.Oa=z("internalChannelParams.baseRetryDelayMs",a)||5e3,this.Sa=z("internalChannelParams.retryDelaySeedMs",a)||1e4,this.Qa=z("internalChannelParams.forwardChannelMaxRetries",a)||2,this.qa=z("internalChannelParams.forwardChannelRequestTimeoutMs",a)||2e4,this.La=a&&a.Ab||void 0,this.D=void 0,this.R=a&&a.supportsCrossDomainXhr||!1,this.H="",this.b=new zd(a&&a.concurrentRequestLimit),this.ja=new Jd,this.o=!a||void 0===a.backgroundChannelTest||a.backgroundChannelTest,(this.W=a&&a.fastHandshake||!1)&&!this.o&&(this.o=!0),a&&a.forceLongPolling&&(this.oa=!1),this.fa=void 0}function _d(a){if(ae(a),3==a.u){var b=a.P++,c=Yc(a.B);bd(c,"SID",a.H),bd(c,"RID",b),bd(c,"TYPE","terminate"),ee(a,c),(b=new Cc(a,b,void 0)).F=2,b.f=dd(Yc(c)),c=!1,w.navigator&&w.navigator.sendBeacon&&(c=w.navigator.sendBeacon(b.f.toString(),"")),!c&&w.Image&&((new Image).src=b.f,c=!0),c||(b.a=b.g.$(null),b.a.ca(b.f)),b.v=L(),Lc(b)}me(a)}function ae(a){a.w&&(a.w.abort(),a.w=null),a.a&&(a.a.cancel(),a.a=null),a.l&&(w.clearTimeout(a.l),a.l=null),je(a),a.b.cancel(),a.h&&(y(a.h)&&w.clearTimeout(a.h),a.h=null)}function be(a,b){a.f.push(new yd(a.Ra++,b)),3==a.u&&ce(a)}function ce(a){Cd(a.b)||a.h||(a.h=!0,Zb(a.Ia,a),a.A=0)}function de(a,b){var c;c=b?b.W:a.P++;var d=Yc(a.B);bd(d,"SID",a.H),bd(d,"RID",c),bd(d,"AID",a.O),ee(a,d),a.g&&a.i&&Zd(d,a.g,a.i),c=new Cc(a,c,a.A+1),null===a.g&&(c.h=a.i),b&&(a.f=b.j.concat(a.f)),b=fe(a,c,1e3),c.setTimeout(Math.round(.5*a.qa)+Math.round(.5*a.qa*Math.random())),Fd(a.b,c),Gc(c,d,b)}function ee(a,b){a.c&&Rc({},function(a,c){bd(b,c,a)})}function fe(a,b,c){c=Math.min(a.f.length,c);var d=a.c?J(a.c.Ta,a.c,a):null;a:for(var e=a.f,f=-1;;){var g=["count="+c];-1==f?0<c?(f=e[0].b,g.push("ofs="+f)):f=0:g.push("ofs="+f);for(var h=!0,i=0;i<c;i++){var j=e[i].b,k=e[i].a;if((j-=f)<0)f=Math.max(0,e[i].b-100),h=!1;else try{Kd(k,g,"req"+j+"_")}catch(a){d&&d(k)}}if(h){d=g.join("&");break a}}return a=a.f.splice(0,c),b.j=a,d}function ge(a){a.a||a.l||(a.S=1,Zb(a.Ha,a),a.v=0)}function he(a){return!(a.a||a.l||3<=a.v)&&(a.S++,a.l=rc(J(a.Ha,a),ke(a,a.v)),a.v++,!0)}function ie(a,b,c){var d=b.l;d&&Bd(a.b,d),a.ia=a.oa&&c,a.m=b.c,a.B=ne(a,null,a.ha),ce(a)}function je(a){null!=a.s&&(w.clearTimeout(a.s),a.s=null)}function ke(a,b){var c=a.Oa+Math.floor(Math.random()*a.Sa);return a.ma()||(c*=2),c*b}function le(a,b){if(2==b){var c=null;a.c&&(c=null);var d=J(a.fb,a);c||(c=new Xc("//www.google.com/images/cleardot.gif"),w.location&&"http"==w.location.protocol||Zc(c,"https"),dd(c)),function(a,b){var c=new kc;if(w.Image){var d=new Image;d.onload=K(Ld,c,d,"TestLoadImage: loaded",!0,b),d.onerror=K(Ld,c,d,"TestLoadImage: error",!1,b),d.onabort=K(Ld,c,d,"TestLoadImage: abort",!1,b),d.ontimeout=K(Ld,c,d,"TestLoadImage: timeout",!1,b),w.setTimeout(function(){d.ontimeout&&d.ontimeout()},1e4),d.src=a}else b(!1)}(c.toString(),d)}else pc(2);a.u=0,a.c&&a.c.ta(b),me(a),ae(a)}function me(a){a.u=0,a.m=-1,a.c&&(0==Hd(a.b).length&&0==a.f.length||(a.b.c.length=0,R(a.f),a.f.length=0),a.c.sa())}function ne(a,b,c){var d,e,f,g,h,i,j=(d=c)instanceof Xc?Yc(d):new Xc(d,void 0);if(""!=j.b)b&&$c(j,b+"."+j.b),_c(j,j.i);else{var k,l=w.location;k=b?b+"."+l.hostname:l.hostname,e=l.protocol,f=k,g=+l.port,h=c,i=new Xc(null,void 0),e&&Zc(i,e),f&&$c(i,f),g&&_c(i,g),h&&(i.a=h),j=i}return a.V&&Z(a.V,function(a,b){bd(j,b,a)}),b=a.j,c=a.I,b&&c&&bd(j,b,c),bd(j,"VER",a.wa),ee(a,j),j}function oe(){}function pe(){if(fb&&!(10<=Number(ob)))throw Error("Environmental error: no available transport.")}function qe(a,b){Qb.call(this),this.a=new $d(b),this.g=a,this.m=b&&b.testUrl?b.testUrl:function(a){for(var b=a,c=1;c<arguments.length;c++){var d,e=arguments[c];0==e.lastIndexOf("/",0)?b=e:((d=""==b)||(d=0<=(d=b.length-1)&&b.indexOf("/",d)==d),b+=d?e:"/"+e)}return b}(this.g,"test"),this.b=b&&b.messageUrlParams||null,a=b&&b.messageHeaders||null,b&&b.clientProtocolHeaderRequired&&(a?a["X-Client-Protocol"]="webchannel":a={"X-Client-Protocol":"webchannel"}),this.a.i=a,a=b&&b.initMessageHeaders||null,b&&b.messageContentType&&(a?a["X-WebChannel-Content-Type"]=b.messageContentType:a={"X-WebChannel-Content-Type":b.messageContentType}),b&&b.xa&&(a?a["X-WebChannel-Client-Profile"]=b.xa:a={"X-WebChannel-Client-Profile":b.xa}),this.a.J=a,(a=b&&b.httpHeadersOverwriteParam)&&!S(a)&&(this.a.g=a),this.l=b&&b.supportsCrossDomainXhr||!1,this.h=b&&b.sendRawJson||!1,(b=b&&b.httpSessionIdParam)&&!S(b)&&(this.a.j=b,null!==(a=this.b)&&b in a&&b in(a=this.b)&&delete a[b]),this.f=new te(this)}function re(a){zc.call(this);var b=a.__sm__;if(b){a:{for(var c in b){a=c;break a}a=void 0}(this.c=a)?(a=this.c,this.data=null!==b&&a in b?b[a]:void 0):this.data=b}else this.data=a}function se(){Ac.call(this),this.status=1}function te(a){this.a=a}function Fe(){return Ee.logLevel===b.DEBUG?ve.DEBUG:Ee.logLevel===b.SILENT?ve.SILENT:ve.ERROR}function Ge(a){switch(a){case ve.DEBUG:Ee.logLevel=b.DEBUG;break;case ve.ERROR:Ee.logLevel=b.ERROR;break;case ve.SILENT:Ee.logLevel=b.SILENT;break;default:Ee.error("Firestore ("+De+"): Invalid value passed to `setLogLevel`")}}function He(a,c){for(var d=[],e=2;e<arguments.length;e++)d[e-2]=arguments[e];if(Ee.logLevel<=b.DEBUG){var f=d.map(Je);Ee.debug.apply(Ee,j(["Firestore ("+De+") ["+a+"]: "+c],f))}}function Ie(a){for(var c=[],d=1;d<arguments.length;d++)c[d-1]=arguments[d];if(Ee.logLevel<=b.ERROR){var e=c.map(Je);Ee.error.apply(Ee,j(["Firestore ("+De+"): "+a],e))}}function Je(a){if("string"==typeof a)return a;var b=Me.getPlatform();try{return b.formatJSON(a)}catch(b){return a}}function Ke(a){var b="FIRESTORE ("+De+") INTERNAL ASSERTION FAILED: "+a;throw Ie(b),new Error(b)}function Le(a,b){a||Ke(b)}function Ne(){return Me.getPlatform().emptyByteString}function Qe(a,b){function c(){var a="This constructor is private.";throw b&&(a+=" ",a+=b),new Pe(Oe.INVALID_ARGUMENT,a)}for(var d in c.prototype=a.prototype,a)a.hasOwnProperty(d)&&(c[d]=a[d]);return c}function Re(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function Se(a,b){return void 0!==a?a:b}function Te(a,b){for(var c in a)if(Object.prototype.hasOwnProperty.call(a,c)){var d=Number(c);isNaN(d)||b(d,a[c])}}function Ue(a,b){for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&b(c,a[c])}function Ve(a){for(var b in Le(null!=a&&"object"==typeof a,"isEmpty() expects object parameter."),a)if(Object.prototype.hasOwnProperty.call(a,b))return!1;return!0}function We(a,b){if(0!==b.length)throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() does not support arguments, but was called with "+mf(b.length,"argument")+".")}function Xe(a,b,c){if(b.length!==c)throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() requires "+mf(c,"argument")+", but was called with "+mf(b.length,"argument")+".")}function Ye(a,b,c){if(b.length<c)throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() requires at least "+mf(c,"argument")+", but was called with "+mf(b.length,"argument")+".")}function Ze(a,b,c,d){if(b.length<c||b.length>d)throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() requires between "+c+" and "+d+" arguments, but was called with "+mf(b.length,"argument")+".")}function $e(a,b,c,d){ef(a,b,lf(c)+" argument",d)}function _e(a,b,c,d){void 0!==d&&$e(a,b,c,d)}function af(a,b,c,d){ef(a,b,c+" option",d)}function bf(a,b,c,d){void 0!==d&&af(a,b,c,d)}function cf(a,b,c,d,e){void 0!==d&&function(a,b,c,d,e){if(!(d instanceof Array))throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() requires its "+b+" option to be an array, but it was: "+gf(d));for(var f=0;f<d.length;++f)if(!e(d[f]))throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() requires all "+b+" elements to be "+c+", but the value at index "+f+" was: "+gf(d[f]))}(a,b,c,d,e)}function df(a,b,c,d,e){void 0!==d&&function(a,b,c,d,e){var f,g,i=[];try{for(var j=h(e),k=j.next();!k.done;k=j.next()){var l=k.value;if(l===d)return;i.push(gf(l))}}catch(a){f={error:a}}finally{try{k&&!k.done&&(g=j.return)&&g.call(j)}finally{if(f)throw f.error}}var m=gf(d);throw new Pe(Oe.INVALID_ARGUMENT,"Invalid value "+m+" provided to function "+a+'() for option "'+c+'". Acceptable values: '+i.join(", "))}(a,0,c,d,e)}function ef(a,b,c,d){if("object"===b?!ff(d):"non-empty string"===b?"string"!=typeof d||""===d:typeof d!==b){var e=gf(d);throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() requires its "+c+" to be of type "+b+", but it was: "+e)}}function ff(a){return"object"==typeof a&&null!==a&&(Object.getPrototypeOf(a)===Object.prototype||null===Object.getPrototypeOf(a))}function gf(a){if(void 0===a)return"undefined";if(null===a)return"null";if("string"==typeof a)return 20<a.length&&(a=a.substring(0,20)+"..."),JSON.stringify(a);if("number"==typeof a||"boolean"==typeof a)return""+a;if("object"!=typeof a)return"function"==typeof a?"a function":Ke("Unknown wrong type: "+typeof a);if(a instanceof Array)return"an array";var b=function(a){if(a.constructor){var b=/function\s+([^\s(]+)\s*\(/.exec(a.constructor.toString());if(b&&1<b.length)return b[1]}return null}(a);return b?"a custom "+b+" object":"an object"}function hf(a,b,c){if(void 0===c)throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() requires a valid "+lf(b)+" argument, but it was undefined.")}function jf(a,b,c){Ue(b,function(b,d){if(c.indexOf(b)<0)throw new Pe(Oe.INVALID_ARGUMENT,"Unknown option '"+b+"' passed to function "+a+"(). Available options: "+c.join(", "))})}function kf(a,b,c,d){var e=gf(d);return new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() requires its "+lf(c)+" argument to be a "+b+", but it was: "+e)}function lf(a){switch(a){case 1:return"first";case 2:return"second";case 3:return"third";default:return a+"th"}}function mf(a,b){return a+" "+b+(1===a?"":"s")}function of(a,b){return a<b?-1:b<a?1:0}function pf(a,b){if(a.length!==b.length)return!1;for(var c=0;c<a.length;c++)if(!a[c].isEqual(b[c]))return!1;return!0}function qf(a){return a+"\0"}function rf(){if("undefined"==typeof Uint8Array)throw new Pe(Oe.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.")}function sf(){if(!Me.getPlatform().base64Available)throw new Pe(Oe.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.")}function Of(a){for(var b="",c=0;c<a.length;c++)0<b.length&&(b=Qf(b)),b=Pf(a.get(c),b);return Qf(b)}function Pf(a,b){for(var c=b,d=a.length,e=0;e<d;e++){var f=a.charAt(e);switch(f){case"\0":c+=Kf+Mf;break;case Kf:c+=Kf+Nf;break;default:c+=f}}return c}function Qf(a){return a+Kf+Lf}function Rf(a){var b=a.length;if(Le(2<=b,"Invalid path "+a),2===b)return Le(a.charAt(0)===Kf&&a.charAt(1)===Lf,"Non-empty path "+a+" had length 2"),Df.EMPTY_PATH;for(var c=b-2,d=[],e="",f=0;f<b;){var g=a.indexOf(Kf,f);switch((g<0||c<g)&&Ke('Invalid encoded resource path: "'+a+'"'),a.charAt(g+1)){case Lf:var h=a.substring(f,g),i=void 0;0===e.length?i=h:(i=e+=h,e=""),d.push(i);break;case Mf:e+=a.substring(f,g),e+="\0";break;case Nf:e+=a.substring(f,g+1);break;default:Ke('Invalid encoded resource path: "'+a+'"')}f=g+2}return new Df(d)}function _f(){return $f}function ag(){return _f()}function cg(){return bg}function eg(){return dg}function gg(){for(var a,b,c=[],d=0;d<arguments.length;d++)c[d]=arguments[d];var e=fg;try{for(var f=h(c),g=f.next();!g.done;g=f.next()){var i=g.value;e=e.add(i)}}catch(b){a={error:b}}finally{try{g&&!g.done&&(b=f.return)&&b.call(f)}finally{if(a)throw a.error}}return e}function ig(){return hg}function ng(a,b,c){var d=dh.prefixForPath(b,c.path),e=d[1],f=IDBKeyRange.lowerBound(d),g=!1;return rg(a).iterate({range:f,keysOnly:!0},function(a,c,d){var f=i(a,3),h=f[0],j=f[1];f[2],h===b&&j===e&&(g=!0),d.done()}).next(function(){return g})}function og(a,b,c){var d,e,f=a.store(ch.store),g=a.store(dh.store),i=[],j=IDBKeyRange.only(c.batchId),k=0,l=f.iterate({range:j},function(a,b,c){return k++,c.delete()});i.push(l.next(function(){Le(1===k,"Dangling document-mutation reference found: Missing batch "+c.batchId)}));var m=[];try{for(var n=h(c.mutations),o=n.next();!o.done;o=n.next()){var p=o.value,q=dh.key(b,p.key.path,c.batchId);i.push(g.delete(q)),m.push(p.key)}}catch(a){d={error:a}}finally{try{o&&!o.done&&(e=n.return)&&e.call(n)}finally{if(d)throw d.error}}return lg.waitFor(i).next(function(){return m})}function pg(a){return a instanceof Uint8Array?(Le("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence."),a.toString()):a}function qg(a){return Gh.getStore(a,ch.store)}function rg(a){return Gh.getStore(a,dh.store)}function sg(a){return Gh.getStore(a,bh.store)}function Bg(a){return new lg(function(b,c){a.onsuccess=function(a){var c=a.target.result;b(c)},a.onerror=function(a){var b=Dg(a.target.error);c(b)}})}function Dg(a){var b=xg.getIOSVersion(p());if(12.2<=b&&b<13){var c="An internal error was encountered in the Indexed Database server";if(0<=a.message.indexOf(c)){var d=new Pe("internal","IOS_INDEXEDDB_BUG1: IndexedDb has thrown '"+c+"'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround."
);return Cg||(Cg=!0,setTimeout(function(){throw d},0)),d}}return a}function Fg(a){return Gh.getStore(a,ih.store)}function Gg(a){return xg.getStore(a,kh.store).get(kh.key).next(function(a){return Le(null!==a,"Missing metadata row."),a})}function Hg(a){return Gg(a).next(function(a){return a.highestListenSequenceNumber})}function Ig(a){return Gh.getStore(a,jh.store)}function Rg(a){return Gh.getStore(a,hh.store)}function Tg(a){return Gh.getStore(a,gh.store)}function Ug(a){return Gh.getStore(a,nh.store)}function Vg(a){return a.path.toArray()}function Wg(a){var b;if(a.document)b=a.document;else if(a.unknownDocument)b=a.unknownDocument;else{if(!a.noDocument)throw Ke("Unknown remote document type");b=a.noDocument}return JSON.stringify(b).length}function mh(a){a.createObjectStore(jh.store,{keyPath:jh.keyPath}).createIndex(jh.documentTargetsIndex,jh.documentTargetsKeyPath,{unique:!0}),a.createObjectStore(ih.store,{keyPath:ih.keyPath}).createIndex(ih.queryTargetsIndexName,ih.queryTargetsKeyPath,{unique:!0}),a.createObjectStore(kh.store)}function th(a){return Gh.getStore(a,lh.store)}function wh(a,b){var c=i(a,2),d=c[0],e=c[1],f=i(b,2),g=f[0],h=f[1],j=of(d,g);return 0===j?of(e,h):j}function Hh(a){return f(this,void 0,void 0,function(){return g(this,function(b){if((c=a).code!==Oe.FAILED_PRECONDITION||c.message!==Dh)throw a;var c;return He(Ch,"Unexpectedly lost primary lease"),[2]})})}function Ih(a){return a.store(ah.store)}function Jh(a){return a.store(oh.store)}function Ph(a,b){return Ig(a).put((c=b,d=a.currentSequenceNumber,new jh(0,Of(c.path),d)));var c,d}function Vh(a,b){return a===b?0!==a||1/a==1/b:a!=a&&b!=b}function Gi(a){return null==a}function Hi(a){return Fi(a)&&a<=Ei&&Di<=a}function Yi(a){switch(a){case Oe.OK:return Ke("Treated status OK as error");case Oe.CANCELLED:case Oe.UNKNOWN:case Oe.DEADLINE_EXCEEDED:case Oe.RESOURCE_EXHAUSTED:case Oe.INTERNAL:case Oe.UNAVAILABLE:case Oe.UNAUTHENTICATED:return!1;case Oe.INVALID_ARGUMENT:case Oe.NOT_FOUND:case Oe.ALREADY_EXISTS:case Oe.PERMISSION_DENIED:case Oe.FAILED_PRECONDITION:case Oe.ABORTED:case Oe.OUT_OF_RANGE:case Oe.UNIMPLEMENTED:case Oe.DATA_LOSS:return!0;default:return Ke("Unknown status code: "+a)}}function Zi(a){if(void 0===a)return Ie("GRPC error has no .code"),Oe.UNKNOWN;switch(a){case Vi.OK:return Oe.OK;case Vi.CANCELLED:return Oe.CANCELLED;case Vi.UNKNOWN:return Oe.UNKNOWN;case Vi.DEADLINE_EXCEEDED:return Oe.DEADLINE_EXCEEDED;case Vi.RESOURCE_EXHAUSTED:return Oe.RESOURCE_EXHAUSTED;case Vi.INTERNAL:return Oe.INTERNAL;case Vi.UNAVAILABLE:return Oe.UNAVAILABLE;case Vi.UNAUTHENTICATED:return Oe.UNAUTHENTICATED;case Vi.INVALID_ARGUMENT:return Oe.INVALID_ARGUMENT;case Vi.NOT_FOUND:return Oe.NOT_FOUND;case Vi.ALREADY_EXISTS:return Oe.ALREADY_EXISTS;case Vi.PERMISSION_DENIED:return Oe.PERMISSION_DENIED;case Vi.FAILED_PRECONDITION:return Oe.FAILED_PRECONDITION;case Vi.ABORTED:return Oe.ABORTED;case Vi.OUT_OF_RANGE:return Oe.OUT_OF_RANGE;case Vi.UNIMPLEMENTED:return Oe.UNIMPLEMENTED;case Vi.DATA_LOSS:return Oe.DATA_LOSS;default:return Ke("Unknown status code: "+a)}}function oj(){return new Uf(Gf.comparator)}function pj(){return new Uf(Gf.comparator)}function Lj(a){return a instanceof gi?a.internalValue.slice():[]}function Sj(a,b){Le(!Gi(a),b+" is missing")}function Tj(a){return"number"==typeof a?a:"string"==typeof a?Number(a):Ke("can't parse "+a)}function Ck(a){return function(a,b){var c,d;if("object"!=typeof a||null===a)return!1;var e=a;try{for(var f=h(b),g=f.next();!g.done;g=f.next()){var i=g.value;if(i in e&&"function"==typeof e[i])return!0}}catch(a){c={error:a}}finally{try{g&&!g.done&&(d=f.return)&&d.call(f)}finally{if(c)throw c.error}}return!1}(a,["next","error","complete"])}function Pk(a){switch(a){case Dk.Set:case Dk.MergeSet:case Dk.Update:return!0;case Dk.Argument:return!1;default:throw Ke("Unexpected case for UserDataSource: "+a)}}function Tk(a){return!("object"!=typeof a||null===a||a instanceof Array||a instanceof Date||a instanceof Sf||a instanceof sj||a instanceof vf||a instanceof Rk||a instanceof Fk)}function Uk(a,b,c){if(!Tk(c)||!ff(c)){var d=gf(c);throw"an object"===d?b.createError(a+" a custom object"):b.createError(a+" "+d)}}function Vk(a,b){if(b instanceof vk)return b._internalPath;if("string"==typeof b)return Wk(a,b);throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() called with invalid data. Field path arguments must be of type string or FieldPath.")}function Wk(a,b){try{return function(a){if(0<=a.search(wk))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid field path ("+a+"). Paths must not contain '~', '*', '/', '[', or ']'");try{return new(vk.bind.apply(vk,j([void 0],a.split("."))))}catch(b){throw new Pe(Oe.INVALID_ARGUMENT,"Invalid field path ("+a+"). Paths must not be empty, begin with '.', end with '.', or contain '..'")}}(b)._internalPath}catch(b){var c=Xk(b);throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() called with invalid data. "+c)}}function Xk(a){return a instanceof Error?a.message:a.toString()}function jl(a,b){if(void 0===b)return{merge:!1};if(jf(a,b,["merge","mergeFields"]),bf(a,"boolean","merge",b.merge),cf(a,"mergeFields","a string or a FieldPath",b.mergeFields,function(a){return"string"==typeof a||a instanceof vk}),void 0!==b.mergeFields&&void 0!==b.merge)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid options passed to function "+a+'(): You cannot specify both "merge" and "mergeFields".');return b}function kl(a,b){return void 0===b?{}:(jf(a,b,["serverTimestamps"]),df(a,0,"serverTimestamps",b.serverTimestamps,["estimate","previous","none"]),b)}function ll(a,b){_e(a,"object",1,b),b&&(jf(a,b,["source"]),df(a,0,"source",b.source,["default","server","cache"]))}function ml(a,b,c){if(b instanceof cl){if(b.firestore!==c)throw new Pe(Oe.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return b}throw kf(a,"DocumentReference",1,b)}function xl(a){a.INTERNAL.registerService("firestore",function(a){return new _k(a)},function(a){Le(a&&"object"==typeof a,"shallowCopy() expects object parameter.");var b={};for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b}(wl))}a=a&&a.hasOwnProperty("default")?a.default:a;var b,c,d=function(a,b){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])})(a,b)};(c=b||(b={}))[c.DEBUG=0]="DEBUG",c[c.VERBOSE=1]="VERBOSE",c[c.INFO=2]="INFO",c[c.WARN=3]="WARN",c[c.ERROR=4]="ERROR",c[c.SILENT=5]="SILENT";var m=b.INFO,n=function(a,c){for(var d=[],e=2;e<arguments.length;e++)d[e-2]=arguments[e];if(!(c<a.logLevel)){var f=(new Date).toISOString();switch(c){case b.DEBUG:case b.VERBOSE:console.log.apply(console,l(["["+f+"]  "+a.name+":"],d));break;case b.INFO:console.info.apply(console,l(["["+f+"]  "+a.name+":"],d));break;case b.WARN:console.warn.apply(console,l(["["+f+"]  "+a.name+":"],d));break;case b.ERROR:console.error.apply(console,l(["["+f+"]  "+a.name+":"],d));break;default:throw new Error("Attempted to log a message with an invalid logType (value: "+c+")")}}},o=function(){function a(a){this.name=a,this._logLevel=m,this._logHandler=n}return Object.defineProperty(a.prototype,"logLevel",{get:function(){return this._logLevel},set:function(a){if(!(a in b))throw new TypeError("Invalid value assigned to `logLevel`");this._logLevel=a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"logHandler",{get:function(){return this._logHandler},set:function(a){if("function"!=typeof a)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=a},enumerable:!0,configurable:!0}),a.prototype.debug=function(){for(var a=[],c=0;c<arguments.length;c++)a[c]=arguments[c];this._logHandler.apply(this,l([this,b.DEBUG],a))},a.prototype.log=function(){for(var a=[],c=0;c<arguments.length;c++)a[c]=arguments[c];this._logHandler.apply(this,l([this,b.VERBOSE],a))},a.prototype.info=function(){for(var a=[],c=0;c<arguments.length;c++)a[c]=arguments[c];this._logHandler.apply(this,l([this,b.INFO],a))},a.prototype.warn=function(){for(var a=[],c=0;c<arguments.length;c++)a[c]=arguments[c];this._logHandler.apply(this,l([this,b.WARN],a))},a.prototype.error=function(){for(var a=[],c=0;c<arguments.length;c++)a[c]=arguments[c];this._logHandler.apply(this,l([this,b.ERROR],a))},a}();!function(){function a(){this.byteToCharMap_=null,this.charToByteMap_=null,this.byteToCharMapWebSafe_=null,this.charToByteMapWebSafe_=null,this.ENCODED_VALS_BASE="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",this.HAS_NATIVE_SUPPORT="function"==typeof atob}Object.defineProperty(a.prototype,"ENCODED_VALS",{get:function(){return this.ENCODED_VALS_BASE+"+/="},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"ENCODED_VALS_WEBSAFE",{get:function(){return this.ENCODED_VALS_BASE+"-_."},enumerable:!0,configurable:!0}),a.prototype.encodeByteArray=function(a,b){if(!Array.isArray(a))throw Error("encodeByteArray takes an array as a parameter");this.init_();for(var c=b?this.byteToCharMapWebSafe_:this.byteToCharMap_,d=[],e=0;e<a.length;e+=3){var f=a[e],g=e+1<a.length,h=g?a[e+1]:0,i=e+2<a.length,j=i?a[e+2]:0,k=f>>2,l=(3&f)<<4|h>>4,m=(15&h)<<2|j>>6,n=63&j;i||(n=64,g||(m=64)),d.push(c[k],c[l],c[m],c[n])}return d.join("")},a.prototype.encodeString=function(a,b){return this.HAS_NATIVE_SUPPORT&&!b?btoa(a):this.encodeByteArray(function(a){for(var b=[],c=0,d=0;d<a.length;d++){var e=a.charCodeAt(d);b[c++]=e<128?e:(b[c++]=e<2048?e>>6|192:(55296==(64512&e)&&d+1<a.length&&56320==(64512&a.charCodeAt(d+1))?(e=65536+((1023&e)<<10)+(1023&a.charCodeAt(++d)),b[c++]=e>>18|240,b[c++]=e>>12&63|128):b[c++]=e>>12|224,e>>6&63|128),63&e|128)}return b}(a),b)},a.prototype.decodeString=function(a,b){return this.HAS_NATIVE_SUPPORT&&!b?atob(a):function(a){for(var b=[],c=0,d=0;c<a.length;){var e=a[c++];if(e<128)b[d++]=String.fromCharCode(e);else if(191<e&&e<224){var f=a[c++];b[d++]=String.fromCharCode((31&e)<<6|63&f)}else if(239<e&&e<365){var g=((7&e)<<18|(63&(f=a[c++]))<<12|(63&(h=a[c++]))<<6|63&a[c++])-65536;b[d++]=String.fromCharCode(55296+(g>>10)),b[d++]=String.fromCharCode(56320+(1023&g))}else{f=a[c++];var h=a[c++];b[d++]=String.fromCharCode((15&e)<<12|(63&f)<<6|63&h)}}return b.join("")}(this.decodeStringToByteArray(a,b))},a.prototype.decodeStringToByteArray=function(a,b){this.init_();for(var c=b?this.charToByteMapWebSafe_:this.charToByteMap_,d=[],e=0;e<a.length;){var f=c[a.charAt(e++)],g=e<a.length?c[a.charAt(e)]:0,h=++e<a.length?c[a.charAt(e)]:64,i=++e<a.length?c[a.charAt(e)]:64;if(++e,null==f||null==g||null==h||null==i)throw Error();var j=f<<2|g>>4;if(d.push(j),64!==h){var k=g<<4&240|h>>2;if(d.push(k),64!==i){var l=h<<6&192|i;d.push(l)}}}return d},a.prototype.init_=function(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(var a=0;a<this.ENCODED_VALS.length;a++)this.byteToCharMap_[a]=this.ENCODED_VALS.charAt(a),this.charToByteMap_[this.byteToCharMap_[a]]=a,this.byteToCharMapWebSafe_[a]=this.ENCODED_VALS_WEBSAFE.charAt(a),(this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[a]]=a)>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(a)]=a,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(a)]=a)}}}();var q=function(a){function b(c,d){var e=a.call(this,d)||this;return e.code=c,e.name="FirebaseError",Object.setPrototypeOf(e,b.prototype),Error.captureStackTrace&&Error.captureStackTrace(e,r.prototype.create),e}return e(b,a),b}(Error),r=function(){function a(a,b,c){this.service=a,this.serviceName=b,this.errors=c}return a.prototype.create=function(a){for(var b,c,d=[],e=1;e<arguments.length;e++)d[e-1]=arguments[e];var f,g=d[0]||{},i=this.service+"/"+a,j=this.errors[a],k=j?(f=g,j.replace(t,function(a,b){var c=f[b];return null!=c?c.toString():"<"+b+"?>"})):"Error",l=this.serviceName+": "+k+" ("+i+").",m=new q(i,l);try{for(var n=h(Object.keys(g)),o=n.next();!o.done;o=n.next()){var p=o.value;"_"!==p.slice(-1)&&(p in m&&console.warn('Overwriting FirebaseError base field "'+p+'" can cause unexpected behavior.'),m[p]=g[p])}}catch(a){b={error:a}}finally{try{o&&!o.done&&(c=n.return)&&c.call(n)}finally{if(b)throw b.error}}return m},a}(),s,t=/\{\$([^}]+)}/g,u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},v=v||{},w=u,F="closure_uid_"+(1e9*Math.random()>>>0),G=0,L=Date.now||function(){return+(new Date)};N.prototype.j=!1,N.prototype.la=function(){!this.j&&(this.j=!0,this.G(),0)&&(this[F]||(this[F]=++G))},N.prototype.G=function(){if(this.i)for(;this.i.length;)this.i.shift()()};var O=Array.prototype.indexOf?function(a,b){return Array.prototype.indexOf.call(a,b,void 0)}:function(a,b){if(x(a))return x(b)&&1==b.length?a.indexOf(b,0):-1;for(var c=0;c<a.length;c++)if(c in a&&a[c]===b)return c;return-1},P=Array.prototype.forEach?function(a,b,c){Array.prototype.forEach.call(a,b,c)}:function(a,b,c){for(var d=a.length,e=x(a)?a.split(""):a,f=0;f<d;f++)f in e&&b.call(c,e[f],f,a)},T,U=String.prototype.trim?function(a){return a.trim()}:function(a){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(a)[1]};a:{var X=w.navigator;if(X){var Y=X.userAgent;if(Y){T=Y;break a}}T=""}var _="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");bb[" "]=A;var cb,db,eb=V(T,"Opera"),fb=V(T,"Trident")||V(T,"MSIE"),gb=V(T,"Edge"),hb=gb||fb,ib=V(T,"Gecko")&&(!V(T.toLowerCase(),"webkit")||!!V(T,"Edge"))&&!V(T,"Trident")&&!V(T,"MSIE")&&!V(T,"Edge"),jb=V(T.toLowerCase(),"webkit")&&!V(T,"Edge");a:{var lb="",mb=(db=T,ib?/rv:([^\);]+)(\)|;)/.exec(db):gb?/Edge\/([\d\.]+)/.exec(db):fb?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(db):jb?/WebKit\/(\S+)/.exec(db):eb?/(?:Version)[ \/]?(\S+)/.exec(db):void 0);if(mb&&(lb=mb?mb[1]:""),fb){var nb=kb();if(null!=nb&&nb>parseFloat(lb)){cb=String(nb);break a}}cb=lb}var ob,pb={},rb=w.document;ob=rb&&fb?kb()||("CSS1Compat"==rb.compatMode?parseInt(cb,10):5):void 0;var sb=!fb||9<=Number(ob),tb=fb&&!qb("9"),ub=function(){if(!w.addEventListener||!Object.defineProperty)return!1;var a=!1,b=Object.defineProperty({},"passive",{get:function(){a=!0}});try{w.addEventListener("test",A,b),w.removeEventListener("test",A,b)}catch(a){}return a}();vb.prototype.b=function(){this.Ja=!1},M(wb,vb);var xb={2:"touch",3:"pen",4:"mouse"};wb.prototype.b=function(){wb.N.b.call(this);var a=this.c;if(a.preventDefault)a.preventDefault();else if(a.returnValue=!1,tb)try{(a.ctrlKey||112<=a.keyCode&&a.keyCode<=123)&&(a.keyCode=-1)}catch(a){}};var yb="closure_listenable_"+(1e6*Math.random()|0),zb=0;Cb.prototype.add=function(a,b,c,d,e){var f=a.toString();(a=this.a[f])||(a=this.a[f]=[],this.b++);var g=Eb(a,b,d,e);return-1<g?(b=a[g],c||(b.Z=!1)):((b=new Ab(b,this.src,f,!!d,e)).Z=c,a.push(b)),b};var Fb="closure_lm_"+(1e6*Math.random()|0),Gb={},Ob="__closure_events_fn_"+(1e9*Math.random()>>>0);M(Qb,N),Qb.prototype[yb]=!0,(s=Qb.prototype).addEventListener=function(a,b,c,d){Hb(this,a,b,c,d)},s.removeEventListener=function(a,b,c,d){!function e(a,b,c,d,f){if(C(b))for(var g=0;g<b.length;g++)e(a,b[g],c,d,f);else d=E(d)?!!d.capture:!!d,c=Pb(c),a&&a[yb]?(a=a.c,(b=String(b).toString())in a.a&&-1<(c=Eb(g=a.a[b],c,d,f))&&(Bb(g[c]),Array.prototype.splice.call(g,c,1),0==g.length&&(delete a.a[b],a.b--))):a&&(a=Nb(a))&&(b=a.a[b.toString()],a=-1,b&&(a=Eb(b,c,d,f)),(c=-1<a?b[a]:null)&&Jb(c))}(this,a,b,c,d)},s.dispatchEvent=function(a){var b,c=this.B;if(c)for(b=[];c;c=c.B)b.push(c);c=this.J;var d=a.type||a;if(x(a))a=new vb(a,c);else if(a instanceof vb)a.target=a.target||c;else{var e=a;ab(a=new vb(d,c),e)}if(e=!0,b)for(var f=b.length-1;0<=f;f--){var g=a.a=b[f];e=Rb(g,d,!0,a)&&e}if(e=Rb(g=a.a=c,d,!0,a)&&e,e=Rb(g,d,!1,a)&&e,b)for(f=0;f<b.length;f++)e=Rb(g=a.a=b[f],d,!1,a)&&e;return e},s.G=function(){if(Qb.N.G.call(this),this.c){var a,b=this.c;for(a in b.a){for(var c=b.a[a],d=0;d<c.length;d++)Bb(c[d]);delete b.a[a],b.b--}}this.B=null},s.Aa=function(a,b,c,d){return this.c.add(String(a),b,!1,c,d)},s.Ba=function(a,b,c,d){return this.c.add(String(a),b,!0,c,d)};var Sb=w.JSON.stringify;Tb.prototype.get=function(){if(0<this.b){this.b--;var a=this.a;this.a=a.next,a.next=null}else a=this.c();return a};var Vb,Wb=new Tb(function(){return new Xb},function(a){a.reset()});Ub.prototype.add=function(a,b){var c=Wb.get();c.set(a,b),this.b?this.b.next=c:this.a=c,this.b=c},Xb.prototype.set=function(a,b){this.a=a,this.b=b,this.next=null};var $b=!(Xb.prototype.reset=function(){this.next=this.b=this.a=null}),_b=new Ub;M(bc,Qb),(s=bc.prototype).ba=!1,s.L=null,s.gb=function(){if(this.ba){var a=L()-this.g;0<a&&a<.8*this.b?this.L=this.a.setTimeout(this.f,this.b-a):(this.L&&(this.a.clearTimeout(this.L),this.L=null),this.dispatchEvent("tick"),this.ba&&(cc(this),this.start()))}},s.start=function(){this.ba=!0,this.L||(this.L=this.a.setTimeout(this.f,this.b),this.g=L())},s.G=function(){bc.N.G.call(this),cc(this),delete this.a},M(ec,N),(s=ec.prototype).ea=!1,s.U=null,s.Ua=function(a){this.a=arguments,this.U?this.ea=!0:fc(this)},s.G=function(){ec.N.G.call(this),this.U&&(w.clearTimeout(this.U),this.U=null,this.ea=!1,this.a=[])},s.ab=function(){this.U=null,this.ea&&(this.ea=!1,fc(this))},M(gc,N);var hc=[];gc.prototype.G=function(){gc.N.G.call(this),jc(this)},gc.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var lc=new Qb;M(mc,vb),M(oc,vb),M(qc,vb);var sc={NO_ERROR:0,hb:1,ob:2,nb:3,kb:4,mb:5,pb:6,Ma:7,TIMEOUT:8,sb:9},tc={jb:"complete",wb:"success",Na:"error",Ma:"abort",ub:"ready",vb:"readystatechange",TIMEOUT:"timeout",qb:"incrementaldata",tb:"progress",lb:"downloadprogress",xb:"uploadprogress"};uc.prototype.a=null;var xc,yc={OPEN:"a",ib:"b",Na:"c",rb:"d"};M(zc,vb),M(Ac,vb),M(Bc,uc),xc=new Bc;var Dc=45e3,Ec={},Fc={};(s=Cc.prototype).setTimeout=function(a){this.O=a},s.eb=function(a){a=a.target;var b=this.B;b&&3==Xd(a)?b.Ua():this.Ka(a)},s.Ka=function(a){try{if(a==this.a)a:{var b=Xd(this.a),c=this.a.ya(),d=this.a.T();if(!(b<3||3==b&&!hb&&!this.a.aa())){this.m||4!=b||7==c||nc(8==c||d<=0?3:2),Nc(this);var e=this.a.T();this.o=e;var f=this.a.aa();if(this.b=200==e){if(this.S&&!this.s){b:{if(this.a){var g=Yd(this.a,"X-HTTP-Initial-Response");if(g&&!S(g)){var h=g;break b}}h=null}if(!h){this.b=!1,this.c=3,pc(12),Pc(this),Oc(this);break a}this.s=!0,Qc(this,h)}this.H?(Jc(this,b,f),hb&&this.b&&3==b&&(ic(this.I,this.P,"tick",this.cb),this.P.start())):Qc(this,f),4==b&&Pc(this),this.b&&!this.m&&(4==b?this.g.na(this):(this.b=!1,Lc(this)))}else 400==e&&0<f.indexOf("Unknown SID")?(this.c=3,pc(12)):(this.c=0,pc(13)),Pc(this),Oc(this)}}}catch(a){}},s.cb=function(){if(this.a){var a=Xd(this.a),b=this.a.aa();this.A<b.length&&(Nc(this),Jc(this,a,b),this.b&&4!=a&&Lc(this))}},s.cancel=function(){this.m=!0,Pc(this)},s.bb=function(){this.i=null;var a=L();0<=a-this.R?(2!=this.F&&(nc(3),pc(17)),Pc(this),this.c=2,Oc(this)):Mc(this,this.R-a)},(s=Sc.prototype).C=function(){Uc(this);for(var a=[],b=0;b<this.a.length;b++)a.push(this.b[this.a[b]]);return a},s.K=function(){return Uc(this),this.a.concat()},s.get=function(a,b){return Vc(this.b,a)?this.b[a]:b},s.set=function(a,b){Vc(this.b,a)||(this.c++,this.a.push(a)),this.b[a]=b},s.forEach=function(a,b){for(var c=this.K(),d=0;d<c.length;d++){var e=c[d],f=this.get(e);a.call(b,f,e,this)}};var Wc=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;Xc.prototype.toString=function(){var a=[],b=this.f;b&&a.push(fd(b,hd,!0),":");var c=this.b;return(c||"file"==b)&&(a.push("//"),(b=this.j)&&a.push(fd(b,hd,!0),"@"),a.push(encodeURIComponent(String(c)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(c=this.i)&&a.push(":",String(c))),(c=this.a)&&(this.b&&"/"!=c.charAt(0)&&a.push("/"),a.push(fd(c,"/"==c.charAt(0)?jd:id,!0))),(c=this.c.toString())&&a.push("?",c),(c=this.g)&&a.push("#",fd(c,ld)),a.join("")},Xc.prototype.resolve=function(a){var b=Yc(this),c=!!a.f;c?Zc(b,a.f):c=!!a.j,c?b.j=a.j:c=!!a.b,c?$c(b,a.b):c=null!=a.i;var d=a.a;if(c)_c(b,a.i);else if(c=!!a.a){if("/"!=d.charAt(0))if(this.b&&!this.a)d="/"+d;else{var e=b.a.lastIndexOf("/");-1!=e&&(d=b.a.substr(0,e+1)+d)}if(".."==(e=d)||"."==e)d="";else if(V(e,"./")||V(e,"/.")){d=0==e.lastIndexOf("/",0),e=e.split("/");for(var f=[],g=0;g<e.length;){var h=e[g++];"."==h?d&&g==e.length&&f.push(""):".."==h?((1<f.length||1==f.length&&""!=f[0])&&f.pop(),d&&g==e.length&&f.push("")):(f.push(h),d=!0)}d=f.join("/")}else d=e}return c?b.a=d:c=""!==a.c.toString(),c?ad(b,rd(a.c)):c=!!a.g,c&&(b.g=a.g),b};var hd=/[#\/\?@]/g,id=/[#\?:]/g,jd=/[#\?]/g,kd=/[#\?@]/g,ld=/#/g;(s=md.prototype).add=function(a,b){nd(this),this.c=null,a=sd(this,a);var c=this.a.get(a);return c||this.a.set(a,c=[]),c.push(b),this.b+=1,this},s.forEach=function(a,b){nd(this),this.a.forEach(function(c,d){P(c,function(c){a.call(b,c,d,this)},this)},this)},s.K=function(){nd(this);for(var a=this.a.C(),b=this.a.K(),c=[],d=0;d<b.length;d++)for(var e=a[d],f=0;f<e.length;f++)c.push(b[d]);return c},s.C=function(a){nd(this);var b=[];if(x(a))pd(this,a)&&(b=Q(b,this.a.get(sd(this,a))));else{a=this.a.C();for(var c=0;c<a.length;c++)b=Q(b,a[c])}return b},s.set=function(a,b){return nd(this),this.c=null,pd(this,a=sd(this,a))&&(this.b-=this.a.get(a).length),this.a.set(a,[b]),this.b+=1,this},s.get=function(a,b){return a&&0<(a=this.C(a)).length?String(a[0]):b},s.toString=function(){if(this.c)return this.c;if(!this.a)return"";for(var a=[],b=this.a.K(),c=0;c<b.length;c++){var d=b[c],e=encodeURIComponent(String(d));d=this.C(d);for(var f=0;f<d.length;f++){var g=e;""!==d[f]&&(g+="="+encodeURIComponent(String(d[f]))),a.push(g)}}return this.c=a.join("&")},M(function(){},function(){}),(s=td.prototype).M=null,s.$=function(a){return this.a.$(a)},s.abort=function(){this.b&&(this.b.cancel(),this.b=null),this.c=-1},s.Da=function(){return!1},s.Ga=function(a,b){if(this.c=a.o,0==this.M){if(!this.a.o&&(a=a.a)){var c=Yd(a,"X-Client-Wire-Protocol");this.l=c||null,this.a.j&&(a=Yd(a,"X-HTTP-Session-Id"))&&(this.a.I=a)}if(b){try{var d=this.a.ja.a.parse(b)}catch(a){return(b=this.a).m=this.c,void le(b,2)}this.f=d[0]}else(b=this.a).m=this.c,le(b,2)}else 1==this.M&&(this.g?pc(6):"11111"==b?(pc(5),this.g=!0,(!fb||10<=Number(ob))&&(this.c=200,this.b.cancel(),pc(11),ie(this.a,this,!0))):(pc(7),this.g=!1))},s.na=function(){if(this.c=this.b.o,this.b.b)0==this.M?(this.M=1,ud(this)):1==this.M&&(this.g?(pc(11),ie(this.a,this,!0)):(pc(10),ie(this.a,this,!1)));else{0==this.M?pc(8):1==this.M&&pc(9);var a=this.a;a.m=this.c,le(a,2)}},s.Y=function(){return this.a.Y()},s.ma=function(){return this.a.ma()},wd.prototype.add=function(a){this.a.set(xd(a),a)},wd.prototype.C=function(){return this.a.C()};var Ad=10;zd.prototype.cancel=function(){var a;this.c=Hd(this),this.b?(this.b.cancel(),this.b=null):this.a&&0!=this.a.a.c&&(P(this.a.C(),function(a){a.cancel()}),(a=this.a.a).b={},a.a.length=0,a.c=0)},Id.prototype.stringify=function(a){return w.JSON.stringify(a,void 0)},Id.prototype.parse=function(a){return w.JSON.parse(a,void 0)};var Md=w.JSON.parse;M(Nd,Qb);var Od="",Pd=/^https?$/i,Qd=["POST","PUT"];(s=Nd.prototype).ca=function(a,b,c,d){if(this.a)throw Error("[goog.net.XhrIo] Object is active with another request="+this.A+"; newUri="+a);b=b?b.toUpperCase():"GET",this.A=a,this.f="",this.h=0,this.v=!1,this.b=!0,this.a=new XMLHttpRequest,this.s=this.H?vc(this.H):vc(xc),this.a.onreadystatechange=J(this.Fa,this);try{this.w=!0,this.a.open(b,String(a),!0),this.w=!1}catch(a){return void Sd(this,a)}a=c||"";var e,f=new Sc(this.headers);d&&Rc(d,function(a,b){f.set(b,a)}),d=function(a){a:{for(var b=Rd,c=a.length,d=x(a)?a.split(""):a,e=0;e<c;e++)if(e in d&&b.call(void 0,d[e],e,a)){b=e;break a}b=-1}return b<0?null:x(a)?a.charAt(b):a[b]}(f.K()),c=w.FormData&&a instanceof w.FormData,!(0<=O(Qd,b))||d||c||f.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),f.forEach(function(a,b){this.a.setRequestHeader(b,a)},this),this.I&&(this.a.responseType=this.I),"withCredentials"in this.a&&this.a.withCredentials!==this.F&&(this.a.withCredentials=this.F);try{Wd(this),0<this.o&&((this.D=(e=this.a,fb&&qb(9)&&y(e.timeout)&&void 0!==e.ontimeout))?(this.a.timeout=this.o,this.a.ontimeout=J(this.Ca,this)):this.m=dc(this.Ca,this.o,this)),this.l=!0,this.a.send(a),this.l=!1}catch(a){Sd(this,a)}},s.Ca=function(){void 0!==v&&this.a&&(this.f="Timed out after "+this.o+"ms, aborting",this.h=8,this.dispatchEvent("timeout"),this.abort(8))},s.abort=function(a){this.a&&this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1,this.h=a||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),Vd(this))},s.G=function(){this.a&&(this.b&&(this.b=!1,this.g=!0,this.a.abort(),this.g=!1),Vd(this,!0)),Nd.N.G.call(this)},s.Fa=function(){this.j||(this.w||this.l||this.g?Ud(this):this.$a())},s.$a=function(){Ud(this)},s.T=function(){try{return 2<Xd(this)?this.a.status:-1}catch(a){return-1}},s.za=function(){try{return 2<Xd(this)?this.a.statusText:""}catch(a){return""}},s.aa=function(){try{return this.a?this.a.responseText:""}catch(a){return""}},s.Va=function(a){if(this.a){var b=this.a.responseText;return a&&0==b.indexOf(a)&&(b=b.substring(a.length)),Md(b)}},s.ya=function(){return this.h},s.Ya=function(){return x(this.f)?this.f:String(this.f)},(s=$d.prototype).wa=8,s.u=1,s.Da=function(){return 0==this.u},s.Ia=function(a){if(this.h)if(this.h=null,1==this.u){if(!a){this.P=Math.floor(1e5*Math.random());var b,c=new Cc(this,a=this.P++,void 0),d=this.i;if(this.J&&(d?ab(d=$(d),this.J):d=this.J),null===this.g&&(c.h=d),this.W)a:{for(var e=b=0;e<this.f.length;e++){var f=this.f[e];if(void 0===(f="__data__"in f.a&&x(f=f.a.__data__)?f.length:void 0))break;if(4096<(b+=f)){b=e;break a}if(4096===b||e===this.f.length-1){b=e+1;break a}}b=1e3}else b=1e3;b=fe(this,c,b),bd(e=Yc(this.B),"RID",a),bd(e,"CVER",22),this.o&&this.j&&bd(e,"X-HTTP-Session-Id",this.j),ee(this,e),this.g&&d&&Zd(e,this.g,d),Fd(this.b,c),this.W?(bd(e,"$req",b),bd(e,"SID","null"),c.S=!0,Gc(c,e,null)):Gc(c,e,b),this.u=2}}else 3==this.u&&(a?de(this,a):0==this.f.length||Cd(this.b)||de(this))},s.Ha=function(){this.l=null,this.a=new Cc(this,"rpc",this.S),null===this.g&&(this.a.h=this.i),this.a.J=0;var a=Yc(this.pa);bd(a,"RID","rpc"),bd(a,"SID",this.H),bd(a,"CI",this.ia?"0":"1"),bd(a,"AID",this.O),ee(this,a),bd(a,"TYPE","xmlhttp"),this.g&&this.i&&Zd(a,this.g,this.i),this.D&&this.a.setTimeout(this.D),Hc(this.a,a,!0,this.ga)},s.Ga=function(a,b){if(0!=this.u&&(this.a==a||Ed(this.b,a)))if(this.m=a.o,!a.s&&Ed(this.b,a)&&3==this.u){try{var c=this.ja.a.parse(b)}catch(a){c=null}if(C(c)&&3==c.length){if(0==(b=c)[0])a:if(!this.l){if(this.a){if(!(this.a.v+3e3<a.v))break a;je(this),this.a.cancel(),this.a=null}he(this),pc(18)}else this.ra=b[1],0<this.ra-this.O&&b[2]<37500&&this.ia&&0==this.v&&!this.s&&(this.s=rc(J(this.Za,this),6e3));if(Dd(this.b)<=1&&this.fa){try{this.fa()}catch(a){}this.fa=void 0}}else le(this,11)}else if((a.s||this.a==a)&&je(this),!S(b))for(b=c=this.ja.a.parse(b),c=0;c<b.length;c++){var d=b[c];if(this.O=d[0],d=d[1],2==this.u)if("c"==d[0]){this.H=d[1],this.ga=d[2];var e=d[3];null!=e&&(this.wa=e),null!=(d=d[5])&&y(d)&&0<d&&(this.D=1.5*d),this.o&&(d=a.a)&&((e=Yd(d,"X-Client-Wire-Protocol"))&&Bd(this.b,e),this.j&&(d=Yd(d,"X-HTTP-Session-Id")))&&(this.I=d,bd(this.B,this.j,d)),this.u=3,this.c&&this.c.va(),d=a,this.pa=ne(this,this.Y()?this.ga:null,this.ha),d.s?(Gd(this.b,d),(e=this.D)&&d.setTimeout(e),d.i&&(Nc(d),Lc(d)),this.a=d):ge(this),0<this.f.length&&ce(this)}else"stop"!=d[0]&&"close"!=d[0]||le(this,7);else 3==this.u&&("stop"==d[0]||"close"==d[0]?"stop"==d[0]?le(this,7):_d(this):"noop"!=d[0]&&this.c&&this.c.ua(d),this.v=0)}},s.Za=function(){null!=this.s&&(this.s=null,this.a.cancel(),this.a=null,he(this),pc(19))},s.na=function(a){var b,c,d=null;if(this.a==a){je(this),this.a=null;var e=2}else{if(!Ed(this.b,a))return;d=a.j,Gd(this.b,a),e=1}if(this.m=a.o,0!=this.u)if(a.b)1==e?(d=L()-a.v,lc.dispatchEvent(new qc(lc,a.l?a.l.length:0,d,this.A)),ce(this)):ge(this);else{var f=a.c;if(3==f||0==f&&0<this.m||(1!=e||(c=a,Dd((b=this).b)>=b.b.f-(b.h?1:0)||(b.h?(b.f=c.j.concat(b.f),0):1==b.u||2==b.u||b.A>=(b.Pa?0:b.Qa)||(b.h=rc(J(b.Ia,b,c),ke(b,b.A)),b.A++,0))))&&(2!=e||!he(this)))switch(d&&0<d.length&&(a=this.b,a.c=a.c.concat(d)),f){case 1:le(this,5);break;case 4:le(this,10);break;case 3:le(this,6);break;default:le(this,2)}}},s.fb=function(a){pc(a?2:1)},s.$=function(a){if(a&&!this.R)throw Error("Can't create secondary domain capable XhrIo object.");return(a=new Nd(this.La)).F=this.R,a},s.ma=function(){return!!this.c&&!0},s.Y=function(){return this.R},(s=oe.prototype).va=function(){},s.ua=function(){},s.ta=function(){},s.sa=function(){},s.Ta=function(){},pe.prototype.a=function(a,b){return new qe(a,b)},M(qe,Qb),(s=qe.prototype).addEventListener=function(a,b,c,d){qe.N.addEventListener.call(this,a,b,c,d)},s.removeEventListener=function(a,b,c,d){qe.N.removeEventListener.call(this,a,b,c,d)},s.Wa=function(){this.a.c=this.f,this.l&&(this.a.R=!0);var a=this.a,b=this.m,c=this.g,d=this.b||void 0;pc(0),a.ha=c,a.V=d||{},a.o&&(a.F.b=[],a.F.a=!1),a.w=new td(a),null===a.g&&(a.w.h=a.i),c=b,a.g&&a.i&&(c=Zd(b,a.g,a.i)),(a=a.w).i=c,b=ne(a.a,null,a.i),pc(3),null!=(c=a.a.F.b)?(a.f=c[0],a.M=1,ud(a)):(cd(b,"MODE","init"),!a.a.o&&a.a.j&&cd(b,"X-HTTP-Session-Id",a.a.j),a.b=new Cc(a,void 0,void 0),a.b.h=a.h,Hc(a.b,b,!1,null),a.M=0)},s.close=function(){_d(this.a)},s.Xa=function(a){if(x(a)){var b={};b.__data__=a,be(this.a,b)}else this.h?((b={}).__data__=Sb(a),be(this.a,b)):be(this.a,a)},s.G=function(){this.a.c=null,delete this.f,_d(this.a),delete this.a,qe.N.G.call(this)},M(re,zc),M(se,Ac),M(te,oe),te.prototype.va=function(){this.a.dispatchEvent("a")},te.prototype.ua=function(a){this.a.dispatchEvent(new re(a))},te.prototype.ta=function(a){this.a.dispatchEvent(new se(a))},te.prototype.sa=function(){this.a.dispatchEvent("b")};var ue=K(function(a,b){function c(){}c.prototype=a.prototype;var d=new c;return a.apply(d,Array.prototype.slice.call(arguments,1)),d},pe);pe.prototype.createWebChannel=pe.prototype.a,qe.prototype.send=qe.prototype.Xa,qe.prototype.open=qe.prototype.Wa,qe.prototype.close=qe.prototype.close,sc.NO_ERROR=0,sc.TIMEOUT=8,sc.HTTP_ERROR=6,tc.COMPLETE="complete",(wc.EventType=yc).OPEN="a",yc.CLOSE="b",yc.ERROR="c",yc.MESSAGE="d",Qb.prototype.listen=Qb.prototype.Aa,Nd.prototype.listenOnce=Nd.prototype.Ba,Nd.prototype.getLastError=Nd.prototype.Ya,Nd.prototype.getLastErrorCode=Nd.prototype.ya,Nd.prototype.getStatus=Nd.prototype.T,Nd.prototype.getStatusText=Nd.prototype.za,Nd.prototype.getResponseJson=Nd.prototype.Va,Nd.prototype.getResponseText=Nd.prototype.aa,Nd.prototype.send=Nd.prototype.ca;var ve,we,xe={createWebChannelTransport:ue,ErrorCode:sc,EventType:tc,WebChannel:wc,XhrIo:Nd},ye=xe.createWebChannelTransport,ze=xe.ErrorCode,Ae=xe.EventType,Be=xe.WebChannel,Ce=xe.XhrIo,De=a.SDK_VERSION,Ee=new o("@firebase/firestore");(we=ve||(ve={}))[we.DEBUG=0]="DEBUG",we[we.ERROR=1]="ERROR",we[we.SILENT=2]="SILENT";var Me=function(){function a(){}return a.setPlatform=function(b){a.platform&&Ke("Platform already defined"),a.platform=b},a.getPlatform=function(){return a.platform||Ke("Platform not set"),a.platform},a}(),Oe={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},Pe=function(a){function b(b,c){var d=a.call(this,c)||this;return d.code=b,d.message=c,d.name="FirebaseError",d.toString=function(){return d.name+": [code="+d.code+"]: "+d.message},d}return e(b,a),b}(Error),nf=function(){function a(){}return a.newId=function(){for(var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",b="",c=0;c<20;c++)b+=a.charAt(Math.floor(Math.random()*a.length));return Le(20===b.length,"Invalid auto ID: "+b),b},a}(),tf,uf,vf=function(){function a(a){sf(),this._binaryString=a}return a.fromBase64String=function(b){Xe("Blob.fromBase64String",arguments,1),$e("Blob.fromBase64String","string",1,b),sf();try{return new a(Me.getPlatform().atob(b))}catch(b){throw new Pe(Oe.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+b)}},a.fromUint8Array=function(b){if(Xe("Blob.fromUint8Array",arguments,1),rf(),b instanceof Uint8Array)return new a(Array.prototype.map.call(b,function(a){return String.fromCharCode(a)}).join(""));throw kf("Blob.fromUint8Array","Uint8Array",1,b)},a.prototype.toBase64=function(){return Xe("Blob.toBase64",arguments,0),sf(),Me.getPlatform().btoa(this._binaryString)},a.prototype.toUint8Array=function(){Xe("Blob.toUint8Array",arguments,0),rf();for(var a=new 
Uint8Array(this._binaryString.length),b=0;b<this._binaryString.length;b++)a[b]=this._binaryString.charCodeAt(b);return a},a.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"},a.prototype.isEqual=function(a){return this._binaryString===a._binaryString},a.prototype._compareTo=function(a){return of(this._binaryString,a._binaryString)},a}(),wf=Qe(vf,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),xf=function(a,b,c,d,e){this.databaseId=a,this.persistenceKey=b,this.host=c,this.ssl=d,this.forceLongPolling=e},yf="(default)",zf=function(){function a(a,b){this.projectId=a,this.database=b||yf}return Object.defineProperty(a.prototype,"isDefaultDatabase",{get:function(){return this.database===yf},enumerable:!0,configurable:!0}),a.prototype.isEqual=function(b){return b instanceof a&&b.projectId===this.projectId&&b.database===this.database},a.prototype.compareTo=function(a){return of(this.projectId,a.projectId)||of(this.database,a.database)},a}(),Af=function(){function a(a,b){var c=this;this.previousValue=a,b&&(b.sequenceNumberHandler=function(a){return c.setPreviousValue(a)},this.writeNewSequenceNumber=function(a){return b.writeSequenceNumber(a)})}return a.prototype.setPreviousValue=function(a){return this.previousValue=Math.max(a,this.previousValue),this.previousValue},a.prototype.next=function(){var a=++this.previousValue;return this.writeNewSequenceNumber&&this.writeNewSequenceNumber(a),a},a.INVALID=-1,a}(),Bf="__name__",Cf=function(){function a(a,b,c){this.init(a,b,c)}return a.prototype.init=function(a,b,c){void 0===b?b=0:b>a.length&&Ke("offset "+b+" out of range "+a.length),void 0===c?c=a.length-b:c>a.length-b&&Ke("length "+c+" out of range "+(a.length-b)),this.segments=a,this.offset=b,this.len=c},a.prototype.construct=function(a,b,c){var d=Object.create(Object.getPrototypeOf(this));return d.init(a,b,c),d},Object.defineProperty(a.prototype,"length",{get:function(){return this.len},enumerable:!0,configurable:!0}),a.prototype.isEqual=function(b){return 0===a.comparator(this,b)},a.prototype.child=function(b){var c=this.segments.slice(this.offset,this.limit());return b instanceof a?b.forEach(function(a){c.push(a)}):"string"==typeof b?c.push(b):Ke("Unknown parameter type for Path.child(): "+b),this.construct(c)},a.prototype.limit=function(){return this.offset+this.length},a.prototype.popFirst=function(a){return a=void 0===a?1:a,Le(this.length>=a,"Can't call popFirst() with less segments"),this.construct(this.segments,this.offset+a,this.length-a)},a.prototype.popLast=function(){return Le(!this.isEmpty(),"Can't call popLast() on empty path"),this.construct(this.segments,this.offset,this.length-1)},a.prototype.firstSegment=function(){return Le(!this.isEmpty(),"Can't call firstSegment() on empty path"),this.segments[this.offset]},a.prototype.lastSegment=function(){return this.get(this.length-1)},a.prototype.get=function(a){return Le(a<this.length,"Index out of range"),this.segments[this.offset+a]},a.prototype.isEmpty=function(){return 0===this.length},a.prototype.isPrefixOf=function(a){if(a.length<this.length)return!1;for(var b=0;b<this.length;b++)if(this.get(b)!==a.get(b))return!1;return!0},a.prototype.isImmediateParentOf=function(a){if(this.length+1!==a.length)return!1;for(var b=0;b<this.length;b++)if(this.get(b)!==a.get(b))return!1;return!0},a.prototype.forEach=function(a){for(var b=this.offset,c=this.limit();b<c;b++)a(this.segments[b])},a.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())},a.comparator=function(a,b){for(var c=Math.min(a.length,b.length),d=0;d<c;d++){var e=a.get(d),f=b.get(d);if(e<f)return-1;if(f<e)return 1}return a.length<b.length?-1:a.length>b.length?1:0},a}(),Df=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return e(b,a),b.prototype.canonicalString=function(){return this.toArray().join("/")},b.prototype.toString=function(){return this.canonicalString()},b.fromString=function(a){if(0<=a.indexOf("//"))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid path ("+a+"). Paths must not contain // in them.");return new b(a.split("/").filter(function(a){return 0<a.length}))},b.EMPTY_PATH=new b([]),b}(Cf),Ef=/^[_a-zA-Z][_a-zA-Z0-9]*$/,Ff=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return e(b,a),b.isValidIdentifier=function(a){return Ef.test(a)},b.prototype.canonicalString=function(){return this.toArray().map(function(a){return a=a.replace("\\","\\\\").replace("`","\\`"),b.isValidIdentifier(a)||(a="`"+a+"`"),a}).join(".")},b.prototype.toString=function(){return this.canonicalString()},b.prototype.isKeyField=function(){return 1===this.length&&this.get(0)===Bf},b.keyField=function(){return new b([Bf])},b.fromServerFormat=function(a){for(var c=[],d="",e=0,f=function(){if(0===d.length)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid field path ("+a+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");c.push(d),d=""},g=!1;e<a.length;){var h=a[e];if("\\"===h){if(e+1===a.length)throw new Pe(Oe.INVALID_ARGUMENT,"Path has trailing escape character: "+a);var i=a[e+1];if("\\"!==i&&"."!==i&&"`"!==i)throw new Pe(Oe.INVALID_ARGUMENT,"Path has invalid escape sequence: "+a);d+=i,e+=2}else"`"===h?g=!g:"."!==h||g?d+=h:f(),e++}if(f(),g)throw new Pe(Oe.INVALID_ARGUMENT,"Unterminated ` in path: "+a);return new b(c)},b.EMPTY_PATH=new b([]),b}(Cf),Gf=function(){function a(b){this.path=b,Le(a.isDocumentKey(b),"Invalid DocumentKey with an odd number of segments: "+b.toArray().join("/"))}return a.prototype.hasCollectionId=function(a){return 2<=this.path.length&&this.path.get(this.path.length-2)===a},a.prototype.isEqual=function(a){return null!==a&&0===Df.comparator(this.path,a.path)},a.prototype.toString=function(){return this.path.toString()},a.comparator=function(a,b){return Df.comparator(a.path,b.path)},a.isDocumentKey=function(a){return a.length%2==0},a.fromSegments=function(b){return new a(new Df(b.slice()))},a.fromPathString=function(b){return new a(Df.fromString(b))},a.EMPTY=new a(new Df([])),a}(),Hf=function(){var a=this;this.promise=new Promise(function(b,c){a.resolve=b,a.reject=c})};(uf=tf||(tf={})).All="all",uf.ListenStreamIdle="listen_stream_idle",uf.ListenStreamConnectionBackoff="listen_stream_connection_backoff",uf.WriteStreamIdle="write_stream_idle",uf.WriteStreamConnectionBackoff="write_stream_connection_backoff",uf.OnlineStateTimeout="online_state_timeout",uf.ClientMetadataRefresh="client_metadata_refresh",uf.LruGarbageCollection="lru_garbage_collection";var If=function(){function a(a,b,c,d,e){this.asyncQueue=a,this.timerId=b,this.targetTimeMs=c,this.op=d,this.removalCallback=e,this.deferred=new Hf,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.catch=this.deferred.promise.catch.bind(this.deferred.promise),this.deferred.promise.catch(function(a){})}return a.createAndSchedule=function(b,c,d,e,f){var g=new a(b,c,Date.now()+d,e,f);return g.start(d),g},a.prototype.start=function(a){var b=this;this.timerHandle=setTimeout(function(){return b.handleDelayElapsed()},a)},a.prototype.skipDelay=function(){return this.handleDelayElapsed()},a.prototype.cancel=function(a){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Pe(Oe.CANCELLED,"Operation cancelled"+(a?": "+a:""))))},a.prototype.handleDelayElapsed=function(){var a=this;this.asyncQueue.enqueueAndForget(function(){return null!==a.timerHandle?(a.clearTimeout(),a.op().then(function(b){return a.deferred.resolve(b)})):Promise.resolve()})},a.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)},a}(),Jf=function(){function a(){this.tail=Promise.resolve(),this.delayedOperations=[],this.operationInProgress=!1}return a.prototype.enqueueAndForget=function(a){this.enqueue(a)},a.prototype.enqueue=function(a){var b=this;this.verifyNotFailed();var c=this.tail.then(function(){return b.operationInProgress=!0,a().catch(function(a){b.failure=a,b.operationInProgress=!1;var c=a.stack||a.message||"";throw Ie("INTERNAL UNHANDLED ERROR: ",c),c.indexOf("Firestore Test Simulated Error")<0&&setTimeout(function(){throw a},0),a}).then(function(a){return b.operationInProgress=!1,a})});return this.tail=c},a.prototype.enqueueAfterDelay=function(a,b,c){var d=this;this.verifyNotFailed(),Le(0<=b,"Attempted to schedule an operation with a negative delay of "+b),Le(!this.containsDelayedOperation(a),"Attempted to schedule multiple operations with timer id "+a+".");var e=If.createAndSchedule(this,a,b,c,function(a){return d.removeDelayedOperation(a)});return this.delayedOperations.push(e),e},a.prototype.verifyNotFailed=function(){this.failure&&Ke("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))},a.prototype.verifyOperationInProgress=function(){Le(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")},a.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})},a.prototype.containsDelayedOperation=function(a){var b,c;try{for(var d=h(this.delayedOperations),e=d.next();!e.done;e=d.next())if(e.value.timerId===a)return!0}catch(a){b={error:a}}finally{try{e&&!e.done&&(c=d.return)&&c.call(d)}finally{if(b)throw b.error}}return!1},a.prototype.runDelayedOperationsEarly=function(a){var b=this;return this.drain().then(function(){var c,d;Le(a===tf.All||b.containsDelayedOperation(a),"Attempted to drain to missing operation "+a),b.delayedOperations.sort(function(a,b){return a.targetTimeMs-b.targetTimeMs});try{for(var e=h(b.delayedOperations),f=e.next();!f.done;f=e.next()){var g=f.value;if(g.skipDelay(),a!==tf.All&&g.timerId===a)break}}catch(d){c={error:d}}finally{try{f&&!f.done&&(d=e.return)&&d.call(e)}finally{if(c)throw c.error}}return b.drain()})},a.prototype.removeDelayedOperation=function(a){var b=this.delayedOperations.indexOf(a);Le(0<=b,"Delayed operation not found."),this.delayedOperations.splice(b,1)},a}(),Kf="",Lf="",Mf="",Nf="",Sf=function(){function a(a,b){if(this.seconds=a,(this.nanoseconds=b)<0)throw new Pe(Oe.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+b);if(1e9<=b)throw new Pe(Oe.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+b);if(a<-62135596800)throw new Pe(Oe.INVALID_ARGUMENT,"Timestamp seconds out of range: "+a);if(253402300800<=a)throw new Pe(Oe.INVALID_ARGUMENT,"Timestamp seconds out of range: "+a)}return a.now=function(){return a.fromMillis(Date.now())},a.fromDate=function(b){return a.fromMillis(b.getTime())},a.fromMillis=function(b){var c=Math.floor(b/1e3);return new a(c,1e6*(b-1e3*c))},a.prototype.toDate=function(){return new Date(this.toMillis())},a.prototype.toMillis=function(){return 1e3*this.seconds+this.nanoseconds/1e6},a.prototype._compareTo=function(a){return this.seconds===a.seconds?of(this.nanoseconds,a.nanoseconds):of(this.seconds,a.seconds)},a.prototype.isEqual=function(a){return a.seconds===this.seconds&&a.nanoseconds===this.nanoseconds},a.prototype.toString=function(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"},a}(),Tf=function(){function a(a){this.timestamp=a}return a.fromMicroseconds=function(b){var c=Math.floor(b/1e6);return new a(new Sf(c,b%1e6*1e3))},a.fromTimestamp=function(b){return new a(b)},a.forDeletedDoc=function(){return a.MIN},a.prototype.compareTo=function(a){return this.timestamp._compareTo(a.timestamp)},a.prototype.isEqual=function(a){return this.timestamp.isEqual(a.timestamp)},a.prototype.toMicroseconds=function(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3},a.prototype.toString=function(){return"SnapshotVersion("+this.timestamp.toString()+")"},a.prototype.toTimestamp=function(){return this.timestamp},a.MIN=new a(new Sf(0,0)),a}(),Uf=function(){function a(a,b){this.comparator=a,this.root=b||Wf.EMPTY}return a.prototype.insert=function(b,c){return new a(this.comparator,this.root.insert(b,c,this.comparator).copy(null,null,Wf.BLACK,null,null))},a.prototype.remove=function(b){return new a(this.comparator,this.root.remove(b,this.comparator).copy(null,null,Wf.BLACK,null,null))},a.prototype.get=function(a){for(var b=this.root;!b.isEmpty();){var c=this.comparator(a,b.key);if(0===c)return b.value;c<0?b=b.left:0<c&&(b=b.right)}return null},a.prototype.indexOf=function(a){for(var b=0,c=this.root;!c.isEmpty();){var d=this.comparator(a,c.key);if(0===d)return b+c.left.size;c=d<0?c.left:(b+=c.left.size+1,c.right)}return-1},a.prototype.isEmpty=function(){return this.root.isEmpty()},Object.defineProperty(a.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0}),a.prototype.minKey=function(){return this.root.minKey()},a.prototype.maxKey=function(){return this.root.maxKey()},a.prototype.inorderTraversal=function(a){return this.root.inorderTraversal(a)},a.prototype.forEach=function(a){this.inorderTraversal(function(b,c){return a(b,c),!1})},a.prototype.toString=function(){var a=[];return this.inorderTraversal(function(b,c){return a.push(b+":"+c),!1}),"{"+a.join(", ")+"}"},a.prototype.reverseTraversal=function(a){return this.root.reverseTraversal(a)},a.prototype.getIterator=function(){return new Vf(this.root,null,this.comparator,!1)},a.prototype.getIteratorFrom=function(a){return new Vf(this.root,a,this.comparator,!1)},a.prototype.getReverseIterator=function(){return new Vf(this.root,null,this.comparator,!0)},a.prototype.getReverseIteratorFrom=function(a){return new Vf(this.root,a,this.comparator,!0)},a}(),Vf=function(){function a(a,b,c,d){this.isReverse=d,this.nodeStack=[];for(var e=1;!a.isEmpty();)if(e=b?c(a.key,b):1,d&&(e*=-1),e<0)a=this.isReverse?a.left:a.right;else{if(0===e){this.nodeStack.push(a);break}this.nodeStack.push(a),a=this.isReverse?a.right:a.left}}return a.prototype.getNext=function(){Le(0<this.nodeStack.length,"getNext() called on iterator when hasNext() is false.");var a=this.nodeStack.pop(),b={key:a.key,value:a.value};if(this.isReverse)for(a=a.left;!a.isEmpty();)this.nodeStack.push(a),a=a.right;else for(a=a.right;!a.isEmpty();)this.nodeStack.push(a),a=a.left;return b},a.prototype.hasNext=function(){return 0<this.nodeStack.length},a.prototype.peek=function(){if(0===this.nodeStack.length)return null;var a=this.nodeStack[this.nodeStack.length-1];return{key:a.key,value:a.value}},a}(),Wf=function(){function a(b,c,d,e,f){this.key=b,this.value=c,this.color=null!=d?d:a.RED,this.left=null!=e?e:a.EMPTY,this.right=null!=f?f:a.EMPTY,this.size=this.left.size+1+this.right.size}return a.prototype.copy=function(b,c,d,e,f){return new a(null!=b?b:this.key,null!=c?c:this.value,null!=d?d:this.color,null!=e?e:this.left,null!=f?f:this.right)},a.prototype.isEmpty=function(){return!1},a.prototype.inorderTraversal=function(a){return this.left.inorderTraversal(a)||a(this.key,this.value)||this.right.inorderTraversal(a)},a.prototype.reverseTraversal=function(a){return this.right.reverseTraversal(a)||a(this.key,this.value)||this.left.reverseTraversal(a)},a.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()},a.prototype.minKey=function(){return this.min().key},a.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()},a.prototype.insert=function(a,b,c){var d=this,e=c(a,d.key);return(d=e<0?d.copy(null,null,null,d.left.insert(a,b,c),null):0===e?d.copy(null,b,null,null,null):d.copy(null,null,null,null,d.right.insert(a,b,c))).fixUp()},a.prototype.removeMin=function(){if(this.left.isEmpty())return a.EMPTY;var b=this;return b.left.isRed()||b.left.left.isRed()||(b=b.moveRedLeft()),(b=b.copy(null,null,null,b.left.removeMin(),null)).fixUp()},a.prototype.remove=function(b,c){var d,e=this;if(c(b,e.key)<0)e.left.isEmpty()||e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.remove(b,c),null);else{if(e.left.isRed()&&(e=e.rotateRight()),e.right.isEmpty()||e.right.isRed()||e.right.left.isRed()||(e=e.moveRedRight()),0===c(b,e.key)){if(e.right.isEmpty())return a.EMPTY;d=e.right.min(),e=e.copy(d.key,d.value,null,null,e.right.removeMin())}e=e.copy(null,null,null,null,e.right.remove(b,c))}return e.fixUp()},a.prototype.isRed=function(){return this.color},a.prototype.fixUp=function(){var a=this;return a.right.isRed()&&!a.left.isRed()&&(a=a.rotateLeft()),a.left.isRed()&&a.left.left.isRed()&&(a=a.rotateRight()),a.left.isRed()&&a.right.isRed()&&(a=a.colorFlip()),a},a.prototype.moveRedLeft=function(){var a=this.colorFlip();return a.right.left.isRed()&&(a=(a=(a=a.copy(null,null,null,null,a.right.rotateRight())).rotateLeft()).colorFlip()),a},a.prototype.moveRedRight=function(){var a=this.colorFlip();return a.left.left.isRed()&&(a=(a=a.rotateRight()).colorFlip()),a},a.prototype.rotateLeft=function(){var b=this.copy(null,null,a.RED,null,this.right.left);return this.right.copy(null,null,this.color,b,null)},a.prototype.rotateRight=function(){var b=this.copy(null,null,a.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,b)},a.prototype.colorFlip=function(){var a=this.left.copy(null,null,!this.left.color,null,null),b=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,a,b)},a.prototype.checkMaxDepth=function(){var a=this.check();return Math.pow(2,a)<=this.size+1},a.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw Ke("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw Ke("Right child of ("+this.key+","+this.value+") is red");var a=this.left.check();if(a!==this.right.check())throw Ke("Black depths differ");return a+(this.isRed()?0:1)},a.EMPTY=null,a.RED=!0,a.BLACK=!1,a}(),Xf=function(){function a(){this.size=0}return a.prototype.copy=function(a,b,c,d,e){return this},a.prototype.insert=function(a,b,c){return new Wf(a,b)},a.prototype.remove=function(a,b){return this},a.prototype.isEmpty=function(){return!0},a.prototype.inorderTraversal=function(a){return!1},a.prototype.reverseTraversal=function(a){return!1},a.prototype.minKey=function(){return null},a.prototype.maxKey=function(){return null},a.prototype.isRed=function(){return!1},a.prototype.checkMaxDepth=function(){return!0},a.prototype.check=function(){return 0},a}();Wf.EMPTY=new Xf;var Yf=function(){function a(a){this.comparator=a,this.data=new Uf(this.comparator)}return a.fromMapKeys=function(b){var c=new a(b.comparator);return b.forEach(function(a){c=c.add(a)}),c},a.prototype.has=function(a){return null!==this.data.get(a)},a.prototype.first=function(){return this.data.minKey()},a.prototype.last=function(){return this.data.maxKey()},Object.defineProperty(a.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0}),a.prototype.indexOf=function(a){return this.data.indexOf(a)},a.prototype.forEach=function(a){this.data.inorderTraversal(function(b,c){return a(b),!1})},a.prototype.forEachInRange=function(a,b){for(var c=this.data.getIteratorFrom(a[0]);c.hasNext();){var d=c.getNext();if(0<=this.comparator(d.key,a[1]))return;b(d.key)}},a.prototype.forEachWhile=function(a,b){var c;for(c=void 0!==b?this.data.getIteratorFrom(b):this.data.getIterator();c.hasNext();)if(!a(c.getNext().key))return},a.prototype.firstAfterOrEqual=function(a){var b=this.data.getIteratorFrom(a);return b.hasNext()?b.getNext().key:null},a.prototype.getIterator=function(){return new Zf(this.data.getIterator())},a.prototype.getIteratorFrom=function(a){return new Zf(this.data.getIteratorFrom(a))},a.prototype.add=function(a){return this.copy(this.data.remove(a).insert(a,!0))},a.prototype.delete=function(a){return this.has(a)?this.copy(this.data.remove(a)):this},a.prototype.isEmpty=function(){return this.data.isEmpty()},a.prototype.unionWith=function(a){var b=this;return a.forEach(function(a){b=b.add(a)}),b},a.prototype.isEqual=function(b){if(b instanceof a){if(this.size!==b.size)return!1;for(var c=this.data.getIterator(),d=b.data.getIterator();c.hasNext();){var e=c.getNext().key,f=d.getNext().key;if(0!==this.comparator(e,f))return!1}return!0}return!1},a.prototype.toArray=function(){var a=[];return this.forEach(function(b){a.push(b)}),a},a.prototype.toString=function(){var a=[];return this.forEach(function(b){return a.push(b)}),"SortedSet("+a.toString()+")"},a.prototype.copy=function(b){var c=new a(this.comparator);return c.data=b,c},a}(),Zf=function(){function a(a){this.iter=a}return a.prototype.getNext=function(){return this.iter.getNext().key},a.prototype.hasNext=function(){return this.iter.hasNext()},a}(),$f=new Uf(Gf.comparator),bg=new Uf(Gf.comparator),dg=new Uf(Gf.comparator),fg=new Yf(Gf.comparator),hg=new Yf(of),jg=function(){function a(a,b,c,d){this.batchId=a,this.localWriteTime=b,this.baseMutations=c,Le(0<(this.mutations=d).length,"Cannot create an empty mutation batch")}return a.prototype.applyToRemoteDocument=function(a,b,c){b&&Le(b.key.isEqual(a),"applyToRemoteDocument: key "+a+" should match maybeDoc key\n        "+b.key);var d=c.mutationResults;Le(d.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+d.length+").");for(var e=0;e<this.mutations.length;e++){var f=this.mutations[e];if(f.key.isEqual(a)){var g=d[e];b=f.applyToRemoteDocument(b,g)}}return b},a.prototype.applyToLocalView=function(a,b){var c,d,e,f;b&&Le(b.key.isEqual(a),"applyToLocalDocument: key "+a+" should match maybeDoc key\n        "+b.key);try{for(var g=h(this.baseMutations),i=g.next();!i.done;i=g.next())(m=i.value).key.isEqual(a)&&(b=m.applyToLocalView(b,b,this.localWriteTime))}catch(a){c={error:a}}finally{try{i&&!i.done&&(d=g.return)&&d.call(g)}finally{if(c)throw c.error}}var j=b;try{for(var k=h(this.mutations),l=k.next();!l.done;l=k.next()){var m;(m=l.value).key.isEqual(a)&&(b=m.applyToLocalView(b,j,this.localWriteTime))}}catch(a){e={error:a}}finally{try{l&&!l.done&&(f=k.return)&&f.call(k)}finally{if(e)throw e.error}}return b},a.prototype.applyToLocalDocumentSet=function(a){var b=this,c=a;return this.mutations.forEach(function(d){var e=b.applyToLocalView(d.key,a.get(d.key));e&&(c=c.insert(d.key,e))}),c},a.prototype.keys=function(){return this.mutations.reduce(function(a,b){return a.add(b.key)},gg())},a.prototype.isEqual=function(a){return this.batchId===a.batchId&&pf(this.mutations,a.mutations)&&pf(this.baseMutations,a.baseMutations)},a}(),kg=function(){function a(a,b,c,d,e){this.batch=a,this.commitVersion=b,this.mutationResults=c,this.streamToken=d,this.docVersions=e}return a.from=function(b,c,d,e){Le(b.mutations.length===d.length,"Mutations sent "+b.mutations.length+" must equal results received "+d.length);for(var f=eg(),g=b.mutations,h=0;h<g.length;h++)f=f.insert(g[h].key,d[h].version);return new a(b,c,d,e,f)},a}(),lg=function(){function a(a){var b=this;this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,a(function(a){b.isDone=!0,b.result=a,b.nextCallback&&b.nextCallback(a)},function(a){b.isDone=!0,b.error=a,b.catchCallback&&b.catchCallback(a)})}return a.prototype.catch=function(a){return this.next(void 0,a)},a.prototype.next=function(b,c){var d=this;return this.callbackAttached&&Ke("Called next() or catch() twice for PersistencePromise"),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(c,this.error):this.wrapSuccess(b,this.result):new a(function(a,e){d.nextCallback=function(c){d.wrapSuccess(b,c).next(a,e)},d.catchCallback=function(b){d.wrapFailure(c,b).next(a,e)}})},a.prototype.toPromise=function(){var a=this;return new Promise(function(b,c){a.next(b,c)})},a.prototype.wrapUserFunction=function(b){try{var c=b();return c instanceof a?c:a.resolve(c)}catch(b){return a.reject(b)}},a.prototype.wrapSuccess=function(b,c){return b?this.wrapUserFunction(function(){return b(c)}):a.resolve(c)},a.prototype.wrapFailure=function(b,c){return b?this.wrapUserFunction(function(){return b(c)}):a.reject(c)},a.resolve=function(b){return new a(function(a,c){a(b)})},a.reject=function(b){return new a(function(a,c){c(b)})},a.waitFor=function(b){return new a(function(a,c){var d=0,e=0,f=!1;b.forEach(function(b){++d,b.next(function(){++e,f&&e===d&&a()},function(a){return c(a)})}),f=!0,e===d&&a()})},a.or=function(b){var c,d,e=a.resolve(!1),f=function(b){e=e.next(function(c){return c?a.resolve(c):b()})};try{for(var g=h(b),i=g.next();!i.done;i=g.next())f(i.value)}catch(b){c={error:b}}finally{try{i&&!i.done&&(d=g.return)&&d.call(g)}finally{if(c)throw c.error}}return e},a.forEach=function(a,b){var c=this,d=[];return a.forEach(function(a,e){d.push(b.call(c,a,e))}),this.waitFor(d)},a}(),mg=function(){function a(a,b,c,d){this.userId=a,this.serializer=b,this.indexManager=c,this.referenceDelegate=d,this.documentKeysByBatchId={}}return a.forUser=function(b,c,d,e){return Le(""!==b.uid,"UserID must not be an empty string."),new a(b.isAuthenticated()?b.uid:"",c,d,e)},a.prototype.checkEmpty=function(a){var b=!0,c=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return qg(a).iterate({index:ch.userMutationsIndex,range:c},function(a,c,d){b=!1,d.done()}).next(function(){return b})},a.prototype.acknowledgeBatch=function(a,b,c){return this.getMutationQueueMetadata(a).next(function(b){return b.lastStreamToken=pg(c),sg(a).put(b)})},a.prototype.getLastStreamToken=function(a){return this.getMutationQueueMetadata(a).next(function(a){return a.lastStreamToken})},a.prototype.setLastStreamToken=function(a,b){return this.getMutationQueueMetadata(a).next(function(c){return c.lastStreamToken=pg(b),sg(a).put(c)})},a.prototype.addMutationBatch=function(a,b,c,d){var e=this,f=rg(a),g=qg(a);return g.add({}).next(function(i){var j,k;Le("number"==typeof i,"Auto-generated key is not a number");var l=new jg(i,b,c,d),m=e.serializer.toDbMutationBatch(e.userId,l);e.documentKeysByBatchId[i]=l.keys();var n=[];try{for(var o=h(d),p=o.next();!p.done;p=o.next()){var q=p.value,r=dh.key(e.userId,q.key.path,i);n.push(g.put(m)),n.push(f.put(r,dh.PLACEHOLDER)),n.push(e.indexManager.addToCollectionParentIndex(a,q.key.path.popLast()))}}catch(i){j={error:i}}finally{try{p&&!p.done&&(k=o.return)&&k.call(o)}finally{if(j)throw j.error}}return lg.waitFor(n).next(function(){return l})})},a.prototype.lookupMutationBatch=function(a,b){var c=this;return qg(a).get(b).next(function(a){return a?(Le(a.userId===c.userId,"Unexpected user '"+a.userId+"' for mutation batch "+b),c.serializer.fromDbMutationBatch(a)):null})},a.prototype.lookupMutationKeys=function(a,b){var c=this;return this.documentKeysByBatchId[b]?lg.resolve(this.documentKeysByBatchId[b]):this.lookupMutationBatch(a,b).next(function(a){if(a){var d=a.keys();return c.documentKeysByBatchId[b]=d}return null})},a.prototype.getNextMutationBatchAfterBatchId=function(a,b){var c=this,d=b+1,e=IDBKeyRange.lowerBound([this.userId,d]),f=null;return qg(a).iterate({index:ch.userMutationsIndex,range:e},function(a,b,e){b.userId===c.userId&&(Le(b.batchId>=d,"Should have found mutation after "+d),f=c.serializer.fromDbMutationBatch(b)),e.done()}).next(function(){return f})},a.prototype.getAllMutationBatches=function(a){var b=this,c=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return qg(a).loadAll(ch.userMutationsIndex,c).next(function(a){return a.map(function(a){return b.serializer.fromDbMutationBatch(a)})})},a.prototype.getAllMutationBatchesAffectingDocumentKey=function(a,b){var c=this,d=dh.prefixForPath(this.userId,b.path),e=IDBKeyRange.lowerBound(d),f=[];return rg(a).iterate({range:e},function(d,e,g){var h=i(d,3),j=h[0],k=h[1],l=h[2],m=Rf(k);if(j===c.userId&&b.path.isEqual(m))return qg(a).get(l).next(function(a){if(!a)throw Ke("Dangling document-mutation reference found: "+d+" which points to "+l);Le(a.userId===c.userId,"Unexpected user '"+a.userId+"' for mutation batch "+l),f.push(c.serializer.fromDbMutationBatch(a))});g.done()}).next(function(){return f})},a.prototype.getAllMutationBatchesAffectingDocumentKeys=function(a,b){var c=this,d=new Yf(of),e=[];return b.forEach(function(b){var f=dh.prefixForPath(c.userId,b.path),g=IDBKeyRange.lowerBound(f),h=rg(a).iterate({range:g},function(a,e,f){var g=i(a,3),h=g[0],j=g[1],k=g[2],l=Rf(j);h===c.userId&&b.path.isEqual(l)?d=d.add(k):f.done()});e.push(h)}),lg.waitFor(e).next(function(){return c.lookupMutationBatches(a,d)})},a.prototype.getAllMutationBatchesAffectingQuery=function(a,b){var c=this;Le(!b.isDocumentQuery(),"Document queries shouldn't go down this path"),Le(!b.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var d=b.path,e=d.length+1,f=dh.prefixForPath(this.userId,d),g=IDBKeyRange.lowerBound(f),h=new Yf(of);return rg(a).iterate({range:g},function(a,b,f){var g=i(a,3),j=g[0],k=g[1],l=g[2],m=Rf(k);j===c.userId&&d.isPrefixOf(m)?m.length===e&&(h=h.add(l)):f.done()}).next(function(){return c.lookupMutationBatches(a,h)})},a.prototype.lookupMutationBatches=function(a,b){var c=this,d=[],e=[];return b.forEach(function(b){e.push(qg(a).get(b).next(function(a){if(null===a)throw Ke("Dangling document-mutation reference found, which points to "+b);Le(a.userId===c.userId,"Unexpected user '"+a.userId+"' for mutation batch "+b),d.push(c.serializer.fromDbMutationBatch(a))}))}),lg.waitFor(e).next(function(){return d})},a.prototype.removeMutationBatch=function(a,b){var c=this;return og(a.simpleDbTransaction,this.userId,b).next(function(d){return c.removeCachedMutationKeys(b.batchId),lg.forEach(d,function(b){return c.referenceDelegate.removeMutationReference(a,b)})})},a.prototype.removeCachedMutationKeys=function(a){delete this.documentKeysByBatchId[a]},a.prototype.performConsistencyCheck=function(a){var b=this;return this.checkEmpty(a).next(function(c){if(!c)return lg.resolve();var d=IDBKeyRange.lowerBound(dh.prefixForUser(b.userId)),e=[];return rg(a).iterate({range:d},function(a,c,d){if(a[0]===b.userId){var f=Rf(a[1]);e.push(f)}else d.done()}).next(function(){Le(0===e.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+e.map(function(a){return a.canonicalString()}))})})},a.prototype.containsKey=function(a,b){return ng(a,this.userId,b)},a.prototype.getMutationQueueMetadata=function(a){var b=this;return sg(a).get(this.userId).next(function(a){return a||new bh(b.userId,-1,"")})},a}(),tg,ug;(ug=tg||(tg={}))[ug.QueryCache=0]="QueryCache",ug[ug.SyncEngine=1]="SyncEngine";var vg=function(){function a(a,b){Le((1&(this.generatorId=a))===a,"Generator ID "+a+" contains more than 1 reserved bits"),this.seek(void 0!==b?b:this.generatorId)}return a.prototype.next=function(){var a=this.nextId;return this.nextId+=2,a},a.prototype.after=function(a){return this.seek(a+2),this.next()},a.prototype.seek=function(a){Le((1&a)===this.generatorId,"Cannot supply target ID from different generator ID"),this.nextId=a},a.forQueryCache=function(){return new a(tg.QueryCache,2)},a.forSyncEngine=function(){return new a(tg.SyncEngine)},a}(),wg="SimpleDb",xg=function(){function a(b){this.db=b,12.2===a.getIOSVersion(p())&&Ie("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}return a.openOrCreate=function(b,c,d){return Le(a.isAvailable(),"IndexedDB not supported in current environment."),He(wg,"Opening database:",b),(new lg(function(e,f){var g=window.indexedDB.open(b,c);g.onsuccess=function(b){var c=b.target.result;e(new a(c))},g.onblocked=function(){f(new Pe(Oe.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},g.onerror=function(a){var b=a.target.error;"VersionError"===b.name?f(new Pe(Oe.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):f(b)},g.onupgradeneeded=function(a){He(wg,'Database "'+b+'" requires upgrade from version:',a.oldVersion);var c=a.target.result,e=new zg(g.transaction);d.createOrUpgrade(c,e,a.oldVersion,Zg).next(function(){He(wg,"Database upgrade to version "+Zg+" complete")})}})).toPromise()},a.delete=function(a){return He(wg,"Removing database:",a),Bg(window.indexedDB.deleteDatabase(a)).toPromise()},a.isAvailable=function(){if("undefined"==typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var b=p(),c=a.getIOSVersion(b),d=0<c&&c<10,e=a.getAndroidVersion(b),f=0<e&&e<4.5;return!(0<b.indexOf("MSIE ")||0<b.indexOf("Trident/")||0<b.indexOf("Edge/")||d||f)},a.getStore=function(a,b){return a.store(b)},a.getIOSVersion=function(a){var b=a.match(/i(?:phone|pad|pod) os ([\d_]+)/i),
c=b?b[1].split("_").slice(0,2).join("."):"-1";return Number(c)},a.getAndroidVersion=function(a){var b=a.match(/Android ([\d.]+)/i),c=b?b[1].split(".").slice(0,2).join("."):"-1";return Number(c)},a.prototype.setVersionChangeListener=function(a){this.db.onversionchange=function(b){return a(b)}},a.prototype.runTransaction=function(a,b,c){var d=zg.open(this.db,a,b),e=c(d).catch(function(a){return d.abort(a),lg.reject(a)}).toPromise();return e.catch(function(){}),d.completionPromise.then(function(){return e})},a.prototype.close=function(){this.db.close()},a}(),yg=function(){function a(a){this.dbCursor=a,this.shouldStop=!1,this.nextKey=null}return Object.defineProperty(a.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"cursor",{set:function(a){this.dbCursor=a},enumerable:!0,configurable:!0}),a.prototype.done=function(){this.shouldStop=!0},a.prototype.skip=function(a){this.nextKey=a},a.prototype.delete=function(){return Bg(this.dbCursor.delete())},a}(),zg=function(){function a(a){var b=this;this.transaction=a,this.aborted=!1,this.completionDeferred=new Hf,this.transaction.oncomplete=function(){b.completionDeferred.resolve()},this.transaction.onabort=function(){a.error?b.completionDeferred.reject(a.error):b.completionDeferred.resolve()},this.transaction.onerror=function(a){var c=Dg(a.target.error);b.completionDeferred.reject(c)}}return a.open=function(b,c,d){return new a(b.transaction(d,c))},Object.defineProperty(a.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,configurable:!0}),a.prototype.abort=function(a){a&&this.completionDeferred.reject(a),this.aborted||(He(wg,"Aborting transaction:",a?a.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())},a.prototype.store=function(a){var b=this.transaction.objectStore(a);return Le(!!b,"Object store not part of transaction: "+a),new Ag(b)},a}(),Ag=function(){function a(a){this.store=a}return a.prototype.put=function(a,b){return Bg(void 0!==b?(He(wg,"PUT",this.store.name,a,b),this.store.put(b,a)):(He(wg,"PUT",this.store.name,"<auto-key>",a),this.store.put(a)))},a.prototype.add=function(a){return He(wg,"ADD",this.store.name,a,a),Bg(this.store.add(a))},a.prototype.get=function(a){var b=this;return Bg(this.store.get(a)).next(function(c){return void 0===c&&(c=null),He(wg,"GET",b.store.name,a,c),c})},a.prototype.delete=function(a){return He(wg,"DELETE",this.store.name,a),Bg(this.store.delete(a))},a.prototype.count=function(){return He(wg,"COUNT",this.store.name),Bg(this.store.count())},a.prototype.loadAll=function(a,b){var c=this.cursor(this.options(a,b)),d=[];return this.iterateCursor(c,function(a,b){d.push(b)}).next(function(){return d})},a.prototype.deleteAll=function(a,b){He(wg,"DELETE ALL",this.store.name);var c=this.options(a,b);c.keysOnly=!1;var d=this.cursor(c);return this.iterateCursor(d,function(a,b,c){return c.delete()})},a.prototype.iterate=function(a,b){var c;b?c=a:(c={},b=a);var d=this.cursor(c);return this.iterateCursor(d,b)},a.prototype.iterateSerial=function(a){var b=this.cursor({});return new lg(function(c,d){b.onerror=function(a){var b=Dg(a.target.error);d(b)},b.onsuccess=function(b){var d=b.target.result;d?a(d.primaryKey,d.value).next(function(a){a?d.continue():c()}):c()}})},a.prototype.iterateCursor=function(a,b){var c=[];return(new lg(function(d,e){a.onerror=function(a){e(a.target.error)},a.onsuccess=function(a){var e=a.target.result;if(e){var f=new yg(e),g=b(e.primaryKey,e.value,f);if(g instanceof lg){var h=g.catch(function(a){return f.done(),lg.reject(a)});c.push(h)}f.isDone?d():null===f.skipToKey?e.continue():e.continue(f.skipToKey)}else d()}})).next(function(){return lg.waitFor(c)})},a.prototype.options=function(a,b){var c=void 0;return void 0!==a&&("string"==typeof a?c=a:(Le(void 0===b,"3rd argument must not be defined if 2nd is a range."),b=a)),{index:c,range:b}},a.prototype.cursor=function(a){var b="next";if(a.reverse&&(b="prev"),a.index){var c=this.store.index(a.index);return a.keysOnly?c.openKeyCursor(a.range,b):c.openCursor(a.range,b)}return this.store.openCursor(a.range,b)},a}(),Cg=!1,Eg=function(){function a(a,b){this.referenceDelegate=a,this.serializer=b,this.targetIdGenerator=vg.forQueryCache()}return a.prototype.allocateTargetId=function(a){var b=this;return this.retrieveMetadata(a).next(function(c){return c.highestTargetId=b.targetIdGenerator.after(c.highestTargetId),b.saveMetadata(a,c).next(function(){return c.highestTargetId})})},a.prototype.getLastRemoteSnapshotVersion=function(a){return this.retrieveMetadata(a).next(function(a){return Tf.fromTimestamp(new Sf(a.lastRemoteSnapshotVersion.seconds,a.lastRemoteSnapshotVersion.nanoseconds))})},a.prototype.getHighestSequenceNumber=function(a){return Hg(a.simpleDbTransaction)},a.prototype.setTargetsMetadata=function(a,b,c){var d=this;return this.retrieveMetadata(a).next(function(e){return e.highestListenSequenceNumber=b,c&&(e.lastRemoteSnapshotVersion=c.toTimestamp()),b>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=b),d.saveMetadata(a,e)})},a.prototype.addQueryData=function(a,b){var c=this;return this.saveQueryData(a,b).next(function(){return c.retrieveMetadata(a).next(function(d){return d.targetCount+=1,c.updateMetadataFromQueryData(b,d),c.saveMetadata(a,d)})})},a.prototype.updateQueryData=function(a,b){return this.saveQueryData(a,b)},a.prototype.removeQueryData=function(a,b){var c=this;return this.removeMatchingKeysForTargetId(a,b.targetId).next(function(){return Fg(a).delete(b.targetId)}).next(function(){return c.retrieveMetadata(a)}).next(function(b){return Le(0<b.targetCount,"Removing from an empty query cache"),b.targetCount-=1,c.saveMetadata(a,b)})},a.prototype.removeTargets=function(a,b,c){var d=this,e=0,f=[];return Fg(a).iterate(function(g,h){var i=d.serializer.fromDbTarget(h);i.sequenceNumber<=b&&void 0===c[i.targetId]&&(e++,f.push(d.removeQueryData(a,i)))}).next(function(){return lg.waitFor(f)}).next(function(){return e})},a.prototype.forEachTarget=function(a,b){var c=this;return Fg(a).iterate(function(a,d){var e=c.serializer.fromDbTarget(d);b(e)})},a.prototype.retrieveMetadata=function(a){return Gg(a.simpleDbTransaction)},a.prototype.saveMetadata=function(a,b){return(c=a,Gh.getStore(c,kh.store)).put(kh.key,b);var c},a.prototype.saveQueryData=function(a,b){return Fg(a).put(this.serializer.toDbTarget(b))},a.prototype.updateMetadataFromQueryData=function(a,b){var c=!1;return a.targetId>b.highestTargetId&&(b.highestTargetId=a.targetId,c=!0),a.sequenceNumber>b.highestListenSequenceNumber&&(b.highestListenSequenceNumber=a.sequenceNumber,c=!0),c},a.prototype.getQueryCount=function(a){return this.retrieveMetadata(a).next(function(a){return a.targetCount})},a.prototype.getQueryData=function(a,b){var c=this,d=b.canonicalId(),e=IDBKeyRange.bound([d,Number.NEGATIVE_INFINITY],[d,Number.POSITIVE_INFINITY]),f=null;return Fg(a).iterate({range:e,index:ih.queryTargetsIndexName},function(a,d,e){var g=c.serializer.fromDbTarget(d);b.isEqual(g.query)&&(f=g,e.done())}).next(function(){return f})},a.prototype.addMatchingKeys=function(a,b,c){var d=this,e=[],f=Ig(a);return b.forEach(function(b){var g=Of(b.path);e.push(f.put(new jh(c,g))),e.push(d.referenceDelegate.addReference(a,b))}),lg.waitFor(e)},a.prototype.removeMatchingKeys=function(a,b,c){var d=this,e=Ig(a);return lg.forEach(b,function(b){var f=Of(b.path);return lg.waitFor([e.delete([c,f]),d.referenceDelegate.removeReference(a,b)])})},a.prototype.removeMatchingKeysForTargetId=function(a,b){var c=Ig(a),d=IDBKeyRange.bound([b],[b+1],!1,!0);return c.delete(d)},a.prototype.getMatchingKeysForTargetId=function(a,b){var c=IDBKeyRange.bound([b],[b+1],!1,!0),d=Ig(a),e=gg();return d.iterate({range:c,keysOnly:!0},function(a,b,c){var d=Rf(a[1]),f=new Gf(d);e=e.add(f)}).next(function(){return e})},a.prototype.containsKey=function(a,b){var c=Of(b.path),d=IDBKeyRange.bound([c],[qf(c)],!1,!0),e=0;return Ig(a).iterate({index:jh.documentTargetsIndex,keysOnly:!0,range:d},function(a,b,c){var d=i(a,2),f=d[0];d[1],0!==f&&(e++,c.done())}).next(function(){return 0<e})},a.prototype.getQueryDataForTarget=function(a,b){var c=this;return Fg(a).get(b).next(function(a){return a?c.serializer.fromDbTarget(a):null})},a}(),Jg=function(){function a(a,b){this.key=a,this.version=b}return a.compareByKey=function(a,b){return Gf.comparator(a.key,b.key)},a}(),Kg=function(a){function b(b,c,d,e,f){var g=a.call(this,b,c)||this;return g.data=d,g.proto=f,g.hasLocalMutations=!!e.hasLocalMutations,g.hasCommittedMutations=!!e.hasCommittedMutations,g}return e(b,a),b.prototype.field=function(a){return this.data.field(a)},b.prototype.fieldValue=function(a){var b=this.field(a);return b?b.value():void 0},b.prototype.value=function(){return this.data.value()},b.prototype.isEqual=function(a){return a instanceof b&&this.key.isEqual(a.key)&&this.version.isEqual(a.version)&&this.data.isEqual(a.data)&&this.hasLocalMutations===a.hasLocalMutations&&this.hasCommittedMutations===a.hasCommittedMutations},b.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", {hasLocalMutations: "+this.hasLocalMutations+"}), {hasCommittedMutations: "+this.hasCommittedMutations+"})"},Object.defineProperty(b.prototype,"hasPendingWrites",{get:function(){return this.hasLocalMutations||this.hasCommittedMutations},enumerable:!0,configurable:!0}),b.compareByField=function(a,b,c){var d=b.field(a),e=c.field(a);return null!==d&&null!==e?d.compareTo(e):Ke("Trying to compare documents on fields that don't exist")},b}(Jg),Lg=function(a){function b(b,c,d){var e=a.call(this,b,c)||this;return e.hasCommittedMutations=!!d&&!!d.hasCommittedMutations,e}return e(b,a),b.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"},Object.defineProperty(b.prototype,"hasPendingWrites",{get:function(){return this.hasCommittedMutations},enumerable:!0,configurable:!0}),b.prototype.isEqual=function(a){return a instanceof b&&a.hasCommittedMutations===this.hasCommittedMutations&&a.version.isEqual(this.version)&&a.key.isEqual(this.key)},b}(Jg),Mg=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return e(b,a),b.prototype.toString=function(){return"UnknownDocument("+this.key+", "+this.version+")"},Object.defineProperty(b.prototype,"hasPendingWrites",{get:function(){return!0},enumerable:!0,configurable:!0}),b.prototype.isEqual=function(a){return a instanceof b&&a.version.isEqual(this.version)&&a.key.isEqual(this.key)},b}(Jg),Ng=function(){function a(a){this.mapKeyFn=a,this.inner={}}return a.prototype.get=function(a){var b,c,d=this.mapKeyFn(a),e=this.inner[d];if(void 0!==e)try{for(var f=h(e),g=f.next();!g.done;g=f.next()){var j=i(g.value,2),k=j[0],l=j[1];if(k.isEqual(a))return l}}catch(a){b={error:a}}finally{try{g&&!g.done&&(c=f.return)&&c.call(f)}finally{if(b)throw b.error}}},a.prototype.has=function(a){return void 0!==this.get(a)},a.prototype.set=function(a,b){var c=this.mapKeyFn(a),d=this.inner[c];if(void 0!==d){for(var e=0;e<d.length;e++)if(d[e][0].isEqual(a))return void (d[e]=[a,b]);d.push([a,b])}else this.inner[c]=[[a,b]]},a.prototype.delete=function(a){var b=this.mapKeyFn(a),c=this.inner[b];if(void 0===c)return!1;for(var d=0;d<c.length;d++)if(c[d][0].isEqual(a))return 1===c.length?delete this.inner[b]:c.splice(d,1),!0;return!1},a.prototype.forEach=function(a){Ue(this.inner,function(b,c){var d,e;try{for(var f=h(c),g=f.next();!g.done;g=f.next()){var j=i(g.value,2),k=j[0],l=j[1];a(k,l)}}catch(b){d={error:b}}finally{try{g&&!g.done&&(e=f.return)&&e.call(f)}finally{if(d)throw d.error}}})},a.prototype.isEmpty=function(){return Ve(this.inner)},a}(),Og=function(){function a(){this.changes=_f(),this.documentSizes=new Ng(function(a){return a.toString()})}return a.prototype.addEntry=function(a){var b=this.assertChanges();this.changes=b.insert(a.key,a)},a.prototype.getEntry=function(a,b){var c=this,d=this.assertChanges().get(b);return d?lg.resolve(d):this.getFromCache(a,b).next(function(a){return null===a?(c.documentSizes.set(b,0),null):(c.documentSizes.set(b,a.size),a.maybeDocument)})},a.prototype.getEntries=function(a,b){var c=this;return this.getAllFromCache(a,b).next(function(a){var b=a.maybeDocuments;return a.sizeMap.forEach(function(a,b){c.documentSizes.set(a,b)}),b})},a.prototype.apply=function(a){var b=this.applyChanges(a);return this.changes=null,b},a.prototype.assertChanges=function(){return Le(null!==this.changes,"Changes have already been applied."),this.changes},a}(),Pg="The remote document changelog no longer contains all changes for all local query views. It may be necessary to rebuild these views.",Qg=function(){function a(a,b,c){this.serializer=a,this.indexManager=b,this.keepDocumentChangeLog=c,this._lastProcessedDocumentChangeId=0}return Object.defineProperty(a.prototype,"lastProcessedDocumentChangeId",{get:function(){return this._lastProcessedDocumentChangeId},enumerable:!0,configurable:!0}),a.prototype.start=function(a){var b=xg.getStore(a,nh.store);return this.synchronizeLastDocumentChangeId(b)},a.prototype.addEntries=function(a,b,c){var d,e,f=[];if(0<b.length){var g=Tg(a),i=gg();try{for(var j=h(b),k=j.next();!k.done;k=j.next()){var l=k.value,m=l.key,n=l.doc;f.push(g.put(Vg(m),n)),i=i.add(m),f.push(this.indexManager.addToCollectionParentIndex(a,m.path.popLast()))}}catch(a){d={error:a}}finally{try{k&&!k.done&&(e=j.return)&&e.call(j)}finally{if(d)throw d.error}}this.keepDocumentChangeLog&&f.push(Ug(a).put({changes:this.serializer.toDbResourcePaths(i)})),f.push(this.updateSize(a,c))}return lg.waitFor(f)},a.prototype.removeEntry=function(a,b){var c=Tg(a),d=Vg(b);return c.get(d).next(function(a){return a?c.delete(d).next(function(){return Wg(a)}):lg.resolve(0)})},a.prototype.getEntry=function(a,b){var c=this;return Tg(a).get(Vg(b)).next(function(a){return a?c.serializer.fromDbRemoteDocument(a):null})},a.prototype.getSizedEntry=function(a,b){var c=this;return Tg(a).get(Vg(b)).next(function(a){return a?{maybeDocument:c.serializer.fromDbRemoteDocument(a),size:Wg(a)}:null})},a.prototype.getEntries=function(a,b){var c=this,d=ag();return this.forEachDbEntry(a,b,function(a,b){d=b?d.insert(a,c.serializer.fromDbRemoteDocument(b)):d.insert(a,null)}).next(function(){return d})},a.prototype.getSizedEntries=function(a,b){var c=this,d=ag(),e=new Uf(Gf.comparator);return this.forEachDbEntry(a,b,function(a,b){e=b?(d=d.insert(a,c.serializer.fromDbRemoteDocument(b)),e.insert(a,Wg(b))):(d=d.insert(a,null),e.insert(a,0))}).next(function(){return{maybeDocuments:d,sizeMap:e}})},a.prototype.forEachDbEntry=function(a,b,c){if(b.isEmpty())return lg.resolve();var d=IDBKeyRange.bound(b.first().path.toArray(),b.last().path.toArray()),e=b.getIterator(),f=e.getNext();return Tg(a).iterate({range:d},function(a,b,d){for(var g=Gf.fromSegments(a);f&&Gf.comparator(f,g)<0;)c(f,null),f=e.getNext();f&&f.isEqual(g)&&(c(f,b),f=e.hasNext()?e.getNext():null),f?d.skip(f.path.toArray()):d.done()}).next(function(){for(;f;)c(f,null),f=e.hasNext()?e.getNext():null})},a.prototype.getDocumentsMatchingQuery=function(a,b){var c=this;Le(!b.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var d=cg(),e=b.path.length+1,f=b.path.toArray(),g=IDBKeyRange.lowerBound(f);return Tg(a).iterate({range:g},function(a,f,g){if(a.length===e){var h=c.serializer.fromDbRemoteDocument(f);b.path.isPrefixOf(h.key.path)?h instanceof Kg&&b.matches(h)&&(d=d.insert(h.key,h)):g.done()}}).next(function(){return d})},a.prototype.getNewDocumentChanges=function(a){var b=this;Le(this.keepDocumentChangeLog,"Can only call getNewDocumentChanges() when document change log is enabled");var c=gg(),d=_f(),e=IDBKeyRange.lowerBound(this._lastProcessedDocumentChangeId+1),f=!0,g=Ug(a);return g.iterate({range:e},function(a,d){if(f&&(f=!1,b._lastProcessedDocumentChangeId+1!==d.id))return b.synchronizeLastDocumentChangeId(g).next(function(){return lg.reject(new Pe(Oe.DATA_LOSS,Pg))});c=c.unionWith(b.serializer.fromDbResourcePaths(d.changes)),b._lastProcessedDocumentChangeId=d.id}).next(function(){var e=[];return c.forEach(function(c){e.push(b.getEntry(a,c).next(function(a){var b=a||new Lg(c,Tf.forDeletedDoc());d=d.insert(c,b)}))}),lg.waitFor(e)}).next(function(){return d})},a.prototype.removeDocumentChangesThroughChangeId=function(a,b){var c=IDBKeyRange.upperBound(b);return Ug(a).delete(c)},a.prototype.synchronizeLastDocumentChangeId=function(a){var b=this;return this._lastProcessedDocumentChangeId=0,a.iterate({keysOnly:!0,reverse:!0},function(a,c,d){b._lastProcessedDocumentChangeId=a,d.done()})},a.prototype.newChangeBuffer=function(){return new Sg(this)},a.prototype.getSize=function(a){return this.getMetadata(a).next(function(a){return a.byteSize})},a.prototype.getMetadata=function(a){return Rg(a).get(hh.key).next(function(a){return Le(!!a,"Missing document cache metadata"),a})},a.prototype.setMetadata=function(a,b){return Rg(a).put(hh.key,b)},a.prototype.updateSize=function(a,b){var c=this;return this.getMetadata(a).next(function(d){return d.byteSize+=b,c.setMetadata(a,d)})},a}(),Sg=function(a){function b(b){var c=a.call(this)||this;return c.documentCache=b,c}return e(b,a),b.prototype.applyChanges=function(a){var b=this,c=this.assertChanges(),d=0,e=[];return c.forEach(function(a,c){var f=b.documentCache.serializer.toDbRemoteDocument(c),g=b.documentSizes.get(a);Le(void 0!==g,"Attempting to change document "+a.toString()+" without having read it first");var h=Wg(f);d+=h-g,e.push({key:a,doc:f})}),this.documentCache.addEntries(a,e,d)},b.prototype.getFromCache=function(a,b){return this.documentCache.getSizedEntry(a,b)},b.prototype.getAllFromCache=function(a,b){return this.documentCache.getSizedEntries(a,b)},b}(Og),Xg=function(){function a(){this.collectionParentIndex=new Yg}return a.prototype.addToCollectionParentIndex=function(a,b){return this.collectionParentIndex.add(b),lg.resolve()},a.prototype.getCollectionParents=function(a,b){return lg.resolve(this.collectionParentIndex.getEntries(b))},a}(),Yg=function(){function a(){this.index={}}return a.prototype.add=function(a){Le(a.length%2==1,"Expected a collection path.");var b=a.lastSegment(),c=a.popLast(),d=this.index[b]||new Yf(Df.comparator),e=!d.has(c);return this.index[b]=d.add(c),e},a.prototype.getEntries=function(a){return(this.index[a]||new Yf(Df.comparator)).toArray()},a}(),Zg=8,$g=function(){function a(a){this.serializer=a}return a.prototype.createOrUpgrade=function(a,b,c,d){var e,f=this;Le(c<d&&0<=c&&d<=Zg,"Unexpected schema upgrade from v"+c+" to v{toVersion}."),c<1&&1<=d&&(a.createObjectStore(ah.store),(e=a).createObjectStore(bh.store,{keyPath:bh.keyPath}),e.createObjectStore(ch.store,{keyPath:ch.keyPath,autoIncrement:!0}).createIndex(ch.userMutationsIndex,ch.userMutationsKeyPath,{unique:!0}),e.createObjectStore(dh.store),mh(a),a.createObjectStore(gh.store));var g,h=lg.resolve();return c<3&&3<=d&&(0!==c&&((g=a).deleteObjectStore(jh.store),g.deleteObjectStore(ih.store),g.deleteObjectStore(kh.store),mh(a)),h=h.next(function(){return a=b.store(kh.store),c=new kh(0,0,Tf.MIN.toTimestamp(),0),a.put(kh.key,c);var a,c})),c<4&&4<=d&&(0!==c&&(h=h.next(function(){return c=a,(d=b).store(ch.store).loadAll().next(function(a){c.deleteObjectStore(ch.store);var b=c.createObjectStore(ch.store,{keyPath:ch.keyPath,autoIncrement:!0});b.createIndex(ch.userMutationsIndex,ch.userMutationsKeyPath,{unique:!0});var e=d.store(ch.store),f=a.map(function(a){return e.put(a)});return lg.waitFor(f)});var c,d})),h=h.next(function(){a.createObjectStore(oh.store,{keyPath:oh.keyPath}),a.createObjectStore(nh.store,{keyPath:"id",autoIncrement:!0})})),c<5&&5<=d&&(h=h.next(function(){return f.removeAcknowledgedMutations(b)})),c<6&&6<=d&&(h=h.next(function(){return a.createObjectStore(hh.store),f.addDocumentGlobal(b)})),c<7&&7<=d&&(h=h.next(function(){return f.ensureSequenceNumbers(b)})),c<8&&8<=d&&(h=h.next(function(){return f.createCollectionParentIndex(a,b)})),h},a.prototype.addDocumentGlobal=function(a){var b=0;return a.store(gh.store).iterate(function(a,c){b+=Wg(c)}).next(function(){var c=new hh(b);return a.store(hh.store).put(hh.key,c)})},a.prototype.removeAcknowledgedMutations=function(a){var b=this,c=a.store(bh.store),d=a.store(ch.store);return c.loadAll().next(function(c){return lg.forEach(c,function(c){var e=IDBKeyRange.bound([c.userId,-1],[c.userId,c.lastAcknowledgedBatchId]);return d.loadAll(ch.userMutationsIndex,e).next(function(d){return lg.forEach(d,function(d){Le(d.userId===c.userId,"Cannot process batch "+d.batchId+" from unexpected user");var e=b.serializer.fromDbMutationBatch(d);return og(a,c.userId,e).next(function(){})})})})})},a.prototype.ensureSequenceNumbers=function(a){var b=a.store(jh.store),c=a.store(gh.store);return Hg(a).next(function(a){var d=[];return c.iterate(function(c,e){var f=new Df(c),g=[0,Of(f)];d.push(b.get(g).next(function(c){return c?lg.resolve():(d=f,b.put(new jh(0,Of(d),a)));var d}))}).next(function(){return lg.waitFor(d)})})},a.prototype.createCollectionParentIndex=function(a,b){a.createObjectStore(lh.store,{keyPath:lh.keyPath});var c=b.store(lh.store),d=new Yg,e=function(a){if(d.add(a)){var b=a.lastSegment(),e=a.popLast();return c.put({collectionId:b,parent:Of(e)})}};return b.store(gh.store).iterate({keysOnly:!0},function(a,b){var c=new Df(a);return e(c.popLast())}).next(function(){return b.store(dh.store).iterate({keysOnly:!0},function(a,b){var c=i(a,3),d=(c[0],c[1]),f=(c[2],Rf(d));return e(f.popLast())})})},a}(),_g=function(a,b){this.seconds=a,this.nanoseconds=b},ah=function(){function a(a,b,c){this.ownerId=a,this.allowTabSynchronization=b,this.leaseTimestampMs=c}return a.store="owner",a.key="owner",a}(),bh=function(){function a(a,b,c){this.userId=a,this.lastAcknowledgedBatchId=b,this.lastStreamToken=c}return a.store="mutationQueues",a.keyPath="userId",a}(),ch=function(){function a(a,b,c,d,e){this.userId=a,this.batchId=b,this.localWriteTimeMs=c,this.baseMutations=d,this.mutations=e}return a.store="mutations",a.keyPath="batchId",a.userMutationsIndex="userMutationsIndex",a.userMutationsKeyPath=["userId","batchId"],a}(),dh=function(){function a(){}return a.prefixForUser=function(a){return[a]},a.prefixForPath=function(a,b){return[a,Of(b)]},a.key=function(a,b,c){return[a,Of(b),c]},a.store="documentMutations",a.PLACEHOLDER=new a,a}(),eh=function(a,b){this.path=a,this.readTime=b},fh=function(a,b){this.path=a,this.version=b},gh=function(){function a(a,b,c,d){this.unknownDocument=a,this.noDocument=b,this.document=c,this.hasCommittedMutations=d}return a.store="remoteDocuments",a}(),hh=function(){function a(a){this.byteSize=a}return a.store="remoteDocumentGlobal",a.key="remoteDocumentGlobalKey",a}(),ih=function(){function a(a,b,c,d,e,f){this.targetId=a,this.canonicalId=b,this.readTime=c,this.resumeToken=d,this.lastListenSequenceNumber=e,this.query=f}return a.store="targets",a.keyPath="targetId",a.queryTargetsIndexName="queryTargetsIndex",a.queryTargetsKeyPath=["canonicalId","targetId"],a}(),jh=function(){function a(a,b,c){this.targetId=a,this.path=b,Le(0===a==(void 0!==(this.sequenceNumber=c)),"A target-document row must either have targetId == 0 and a defined sequence number, or a non-zero targetId and no sequence number")}return a.store="targetDocuments",a.keyPath=["targetId","path"],a.documentTargetsIndex="documentTargetsIndex",a.documentTargetsKeyPath=["path","targetId"],a}(),kh=function(){function a(a,b,c,d){this.highestTargetId=a,this.highestListenSequenceNumber=b,this.lastRemoteSnapshotVersion=c,this.targetCount=d}return a.key="targetGlobalKey",a.store="targetGlobal",a}(),lh=function(){function a(a,b){this.collectionId=a,this.parent=b}return a.store="collectionParents",a.keyPath=["collectionId","parent"],a}(),nh=function(){function a(a){this.changes=a}return a.store="remoteDocumentChanges",a.keyPath="id",a}(),oh=function(){function a(a,b,c,d,e){this.clientId=a,this.updateTimeMs=b,this.networkEnabled=c,this.inForeground=d,this.lastProcessedDocumentChangeId=e}return a.store="clientMetadata",a.keyPath="clientId",a}(),ph,qh,rh=j(j(j([bh.store,ch.store,dh.store,gh.store,ih.store,ah.store,kh.store,jh.store],[oh.store,nh.store]),[hh.store]),[lh.store]),sh=function(){function a(){this.collectionParentsCache=new Yg}return a.prototype.addToCollectionParentIndex=function(a,b){if(Le(b.length%2==1,"Expected a collection path."),this.collectionParentsCache.add(b)){Le(1<=b.length,"Invalid collection path.");var c=b.lastSegment(),d=b.popLast();return th(a).put({collectionId:c,parent:Of(d)})}return lg.resolve()},a.prototype.getCollectionParents=function(a,b){var c=[],d=IDBKeyRange.bound([b,""],[qf(b),""],!1,!0);return th(a).loadAll(d).next(function(a){var d,e;try{for(var f=h(a),g=f.next();!g.done;g=f.next()){var i=g.value;if(i.collectionId!==b)break;c.push(Rf(i.parent))}}catch(a){d={error:a}}finally{try{g&&!g.done&&(e=f.return)&&e.call(f)}finally{if(d)throw d.error}}return c})},a}();(qh=ph||(ph={}))[qh.Listen=0]="Listen",qh[qh.ExistenceFilterMismatch=1]="ExistenceFilterMismatch",qh[qh.LimboResolution=2]="LimboResolution";var uh=function(){function a(a,b,c,d,e,f){void 0===e&&(e=Tf.MIN),void 0===f&&(f=Ne()),this.query=a,this.targetId=b,this.purpose=c,this.sequenceNumber=d,this.snapshotVersion=e,this.resumeToken=f}return a.prototype.copy=function(b){return new a(this.query,this.targetId,this.purpose,void 0===b.sequenceNumber?this.sequenceNumber:b.sequenceNumber,void 0===b.snapshotVersion?this.snapshotVersion:b.snapshotVersion,void 0===b.resumeToken?this.resumeToken:b.resumeToken)},a.prototype.isEqual=function(a){return this.targetId===a.targetId&&this.purpose===a.purpose&&this.sequenceNumber===a.sequenceNumber&&this.snapshotVersion.isEqual(a.snapshotVersion)&&this.resumeToken===a.resumeToken&&this.query.isEqual(a.query)},a}(),vh=function(){function a(a){this.remoteSerializer=a}return a.prototype.fromDbRemoteDocument=function(a){if(a.document)return this.remoteSerializer.fromDocument(a.document,!!a.hasCommittedMutations);if(a.noDocument){var b=Gf.fromSegments(a.noDocument.path),c=this.fromDbTimestamp(a.noDocument.readTime);return new Lg(b,c,{hasCommittedMutations:!!a.hasCommittedMutations})}return a.unknownDocument?(b=Gf.fromSegments(a.unknownDocument.path),c=this.fromDbTimestamp(a.unknownDocument.version),new Mg(b,c)):Ke("Unexpected DbRemoteDocument")},a.prototype.toDbRemoteDocument=function(a){if(a instanceof Kg){var b=a.proto?a.proto:this.remoteSerializer.toDocument(a),c=a.hasCommittedMutations;return new gh(null,null,b,c)}if(a instanceof Lg){var d=a.key.path.toArray(),e=this.toDbTimestamp(a.version);return c=a.hasCommittedMutations,new gh(null,new eh(d,e),null,c)}return a instanceof Mg?(d=a.key.path.toArray(),e=this.toDbTimestamp(a.version),new gh(new fh(d,e),null,null,!0)):Ke("Unexpected MaybeDocumment")},a.prototype.toDbTimestamp=function(a){var b=a.toTimestamp();return new _g(b.seconds,b.nanoseconds)},a.prototype.fromDbTimestamp=function(a){var b=new Sf(a.seconds,a.nanoseconds);return Tf.fromTimestamp(b)},a.prototype.toDbMutationBatch=function(a,b){var c=this,d=b.baseMutations.map(function(a){return c.remoteSerializer.toMutation(a)}),e=b.mutations.map(function(a){return c.remoteSerializer.toMutation(a)});return new ch(a,b.batchId,b.localWriteTime.toMillis(),d,e)},a.prototype.fromDbMutationBatch=function(a){var b=this,c=(a.baseMutations||[]).map(function(a){return b.remoteSerializer.fromMutation(a)}),d=a.mutations.map(function(a){return b.remoteSerializer.fromMutation(a)}),e=Sf.fromMillis(a.localWriteTimeMs);return new jg(a.batchId,e,c,d)},a.prototype.toDbResourcePaths=function(a){var b=[];return a.forEach(function(a){b.push(Of(a.path))}),b},a.prototype.fromDbResourcePaths=function(a){var b,c,d=gg();try{for(var e=h(a),f=e.next();!f.done;f=e.next()){var g=f.value;d=d.add(new Gf(Rf(g)))}}catch(a){b={error:a}}finally{try{f&&!f.done&&(c=e.return)&&c.call(e)}finally{if(b)throw b.error}}return d},a.prototype.fromDbTarget=function(a){var b,c=this.fromDbTimestamp(a.readTime);return b=void 0!==a.query.documents?this.remoteSerializer.fromDocumentsTarget(a.query):this.remoteSerializer.fromQueryTarget(a.query),new uh(b,a.targetId,ph.Listen,a.lastListenSequenceNumber,c,a.resumeToken)},a.prototype.toDbTarget=function(a){Le(ph.Listen===a.purpose,"Only queries with purpose "+ph.Listen+" may be stored, got "+a.purpose);var b,c,d=this.toDbTimestamp(a.snapshotVersion);return b=a.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(a.query):this.remoteSerializer.toQueryTarget(a.query),c=a.resumeToken instanceof Uint8Array?(Le("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),a.resumeToken.toString()):a.resumeToken,new ih(a.targetId,a.query.canonicalId(),d,c,a.sequenceNumber,b)},a}(),xh=function(){function a(a){this.maxElements=a,this.buffer=new Yf(wh),this.previousIndex=0}return a.prototype.nextIndex=function(){return++this.previousIndex},a.prototype.addElement=function(a){var b=[a,this.nextIndex()];if(this.buffer.size<this.maxElements)this.buffer=this.buffer.add(b);else{var c=this.buffer.last();wh(b,c)<0&&(this.buffer=this.buffer.delete(c).add(b))}},Object.defineProperty(a.prototype,"maxValue",{get:function(){return this.buffer.last()[0]},enumerable:!0,configurable:!0}),a}(),yh={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0},zh=function(){function a(a,b,c){this.cacheSizeCollectionThreshold=a,this.percentileToCollect=b,this.maximumSequenceNumbersToCollect=c}return a.withCacheSize=function(b){return new a(b,a.DEFAULT_COLLECTION_PERCENTILE,a.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)},a.COLLECTION_DISABLED=-1,a.MINIMUM_CACHE_SIZE_BYTES=1048576,a.DEFAULT=new a(a.DEFAULT_CACHE_SIZE_BYTES=41943040,a.DEFAULT_COLLECTION_PERCENTILE=10,a.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3),a.DISABLED=new a(a.COLLECTION_DISABLED,0,0),a}(),Ah=function(){function a(a,b,c){this.garbageCollector=a,this.asyncQueue=b,this.localStore=c,this.gcTask=null}return a.prototype.start=function(){Le(null===this.gcTask,"Cannot start an already started LruScheduler"),this.garbageCollector.params.cacheSizeCollectionThreshold!==zh.COLLECTION_DISABLED&&this.scheduleGC()},a.prototype.stop=function(){this.gcTask&&(this.gcTask.cancel(),this.gcTask=null)},Object.defineProperty(a.prototype,"started",{get:function(){return null!==this.gcTask},enumerable:!0,configurable:!0}),a.prototype.scheduleGC=function(){var a=this;Le(null===this.gcTask,"Cannot schedule GC while a task is pending");var b=this.hasRun?3e5:6e4;He("LruGarbageCollector","Garbage collection scheduled in "+b+"ms"),this.gcTask=this.asyncQueue.enqueueAfterDelay(tf.LruGarbageCollection,b,function(){return a.gcTask=null,a.hasRun=!0,a.localStore.collectGarbage(a.garbageCollector).then(function(){return a.scheduleGC()}).catch(Hh)})},a}(),Bh=function(){function a(a,b){this.delegate=a,this.params=b}return a.prototype.calculateTargetCount=function(a,b){return this.delegate.getSequenceNumberCount(a).next(function(a){return Math.floor(b/100*a)})},a.prototype.nthSequenceNumber=function(a,b){var c=this;if(0===b)return lg.resolve(Af.INVALID);var d=new xh(b);return this.delegate.forEachTarget(a,function(a){return d.addElement(a.sequenceNumber)}).next(function(){return c.delegate.forEachOrphanedDocumentSequenceNumber(a,function(a){return d.addElement(a)})}).next(function(){return d.maxValue})},a.prototype.removeTargets=function(a,b,c){return this.delegate.removeTargets(a,b,c)},a.prototype.removeOrphanedDocuments=function(a,b){return this.delegate.removeOrphanedDocuments(a,b)},a.prototype.collect=function(a,b){var c=this;return this.params.cacheSizeCollectionThreshold===zh.COLLECTION_DISABLED?(He("LruGarbageCollector","Garbage collection skipped; disabled"),lg.resolve(yh)):this.getCacheSize(a).next(function(d){return d<c.params.cacheSizeCollectionThreshold?(He("LruGarbageCollector","Garbage collection skipped; Cache size "+d+" is lower than threshold "+c.params.cacheSizeCollectionThreshold),yh):c.runGarbageCollection(a,b)})},a.prototype.getCacheSize=function(a){return this.delegate.getCacheSize(a)},a.prototype.runGarbageCollection=function(a,b){var c,d,e,f,g,h,i,j=this,k=Date.now();return this.calculateTargetCount(a,this.params.percentileToCollect).next(function(b){return d=b>j.params.maximumSequenceNumbersToCollect?(He("LruGarbageCollector","Capping sequence numbers to collect down to the maximum of "+j.params.maximumSequenceNumbersToCollect+" from "+b),j.params.maximumSequenceNumbersToCollect):b,f=Date.now(),j.nthSequenceNumber(a,d)}).next(function(d){return c=d,g=Date.now(),j.removeTargets(a,c,b)}).next(function(b){return e=b,h=Date.now(),j.removeOrphanedDocuments(a,c)}).next(function(a){return(i=Date.now(),Fe()<=ve.DEBUG)&&He("LruGarbageCollector"
,"LRU Garbage Collection\n	Counted targets in "+(f-k)+"ms\n	Determined least recently used "+d+" in "+(g-f)+"ms\n	Removed "+e+" targets in "+(h-g)+"ms\n	Removed "+a+" documents in "+(i-h)+"ms\nTotal Duration: "+(i-k)+"ms"),lg.resolve({didRun:!0,sequenceNumbersCollected:d,targetsRemoved:e,documentsRemoved:a})})},a}(),Ch="IndexedDbPersistence",Dh="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",Eh="Another tab has exclusive access to the persistence layer. To allow shared access, make sure to invoke `enablePersistence()` with `synchronizeTabs:true` in all tabs.",Fh=function(a){function b(b,c){var d=a.call(this)||this;return d.simpleDbTransaction=b,d.currentSequenceNumber=c,d}return e(b,a),b}(function(){}),Gh=function(){function a(b,c,d,e,f,g,h){if(this.persistenceKey=b,this.clientId=c,this.queue=e,this.multiClientParams=h,this._started=!1,this.isPrimary=!1,this.networkEnabled=!0,this.inForeground=!1,this.lastGarbageCollectionTime=Number.NEGATIVE_INFINITY,this.primaryStateListener=function(a){return Promise.resolve()},!a.isAvailable())throw new Pe(Oe.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");if(this.referenceDelegate=new Oh(this,g),this.dbName=b+a.MAIN_DATABASE,this.serializer=new vh(f),this.document=d.document,this.allowTabSynchronization=void 0!==h,this.queryCache=new Eg(this.referenceDelegate,this.serializer),this.indexManager=new sh,this.remoteDocumentCache=new Qg(this.serializer,this.indexManager,this.allowTabSynchronization),!d.window||!d.window.localStorage)throw new Pe(Oe.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");this.window=d.window,this.webStorage=this.window.localStorage}return a.getStore=function(a,b){if(a instanceof Fh)return xg.getStore(a.simpleDbTransaction,b);throw Ke("IndexedDbPersistence must use instances of IndexedDbTransaction")},a.createIndexedDbPersistence=function(b,c,d,e,h,i){return f(this,void 0,void 0,function(){var f;return g(this,function(g){switch(g.label){case 0:return[4,(f=new a(b,c,d,e,h,i)).start()];case 1:return g.sent(),[2,f]}})})},a.createMultiClientIndexedDbPersistence=function(b,c,d,e,h,i,j){return f(this,void 0,void 0,function(){var f;return g(this,function(g){switch(g.label){case 0:return[4,(f=new a(b,c,d,e,h,i,j)).start()];case 1:return g.sent(),[2,f]}})})},a.prototype.start=function(){var a=this;return Le(!this.started,"IndexedDbPersistence double-started!"),Le(null!==this.window,"Expected 'window' to be defined"),xg.openOrCreate(this.dbName,Zg,new $g(this.serializer)).then(function(b){return a.simpleDb=b,a.updateClientMetadataAndTryBecomePrimary()}).then(function(){return a.attachVisibilityHandler(),a.attachWindowUnloadHook(),a.scheduleClientMetadataAndPrimaryLeaseRefreshes(),a.startRemoteDocumentCache()}).then(function(){return a.simpleDb.runTransaction("readonly",[kh.store],function(b){return Hg(b).next(function(b){var c=a.multiClientParams?a.multiClientParams.sequenceNumberSyncer:void 0;a.listenSequence=new Af(b,c)})})}).then(function(){a._started=!0}).catch(function(b){return a.simpleDb&&a.simpleDb.close(),Promise.reject(b)})},a.prototype.startRemoteDocumentCache=function(){var a=this;return this.simpleDb.runTransaction("readonly",rh,function(b){return a.remoteDocumentCache.start(b)})},a.prototype.setPrimaryStateListener=function(a){var b=this;return this.primaryStateListener=function(c){return f(b,void 0,void 0,function(){return g(this,function(b){return this.started?[2,a(c)]:[2]})})},a(this.isPrimary)},a.prototype.setDatabaseDeletedListener=function(a){var b=this;this.simpleDb.setVersionChangeListener(function(c){return f(b,void 0,void 0,function(){return g(this,function(b){switch(b.label){case 0:return null!==c.newVersion?[3,2]:[4,a()];case 1:b.sent(),b.label=2;case 2:return[2]}})})})},a.prototype.setNetworkEnabled=function(a){var b=this;this.networkEnabled!==a&&(this.networkEnabled=a,this.queue.enqueueAndForget(function(){return f(b,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return this.started?[4,this.updateClientMetadataAndTryBecomePrimary()]:[3,2];case 1:a.sent(),a.label=2;case 2:return[2]}})})}))},a.prototype.updateClientMetadataAndTryBecomePrimary=function(){var a=this;return this.simpleDb.runTransaction("readwrite",rh,function(b){return Jh(b).put(new oh(a.clientId,Date.now(),a.networkEnabled,a.inForeground,a.remoteDocumentCache.lastProcessedDocumentChangeId)).next(function(){if(a.isPrimary)return a.verifyPrimaryLease(b).next(function(b){b||(a.isPrimary=!1,a.queue.enqueueAndForget(function(){return a.primaryStateListener(!1)}))})}).next(function(){return a.canActAsPrimary(b)}).next(function(c){var d=a.isPrimary;return a.isPrimary=c,d!==a.isPrimary&&a.queue.enqueueAndForget(function(){return a.primaryStateListener(a.isPrimary)}),d&&!a.isPrimary?a.releasePrimaryLeaseIfHeld(b):a.isPrimary?a.acquireOrExtendPrimaryLease(b):void 0})})},a.prototype.verifyPrimaryLease=function(a){var b=this;return Ih(a).get(ah.key).next(function(a){return lg.resolve(b.isLocalClient(a))})},a.prototype.removeClientMetadata=function(a){return Jh(a).delete(this.clientId)},a.prototype.maybeGarbageCollectMultiClientState=function(){return f(this,void 0,void 0,function(){var b,c,d=this;return g(this,function(e){switch(e.label){case 0:return!this.isPrimary||this.isWithinAge(this.lastGarbageCollectionTime,18e5)?[3,2]:(this.lastGarbageCollectionTime=Date.now(),c=[],[4,this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",function(e){var f=a.getStore(e,oh.store);return f.loadAll().next(function(a){b=d.filterActiveClients(a,18e5),c=a.filter(function(a){return-1===b.indexOf(a)})}).next(function(){return lg.forEach(c,function(a){return f.delete(a.clientId)})}).next(function(){if(0<(b=b.filter(function(a){return a.clientId!==d.clientId})).length){var a=b.map(function(a){return a.lastProcessedDocumentChangeId||0}),c=Math.min.apply(Math,j(a));return d.remoteDocumentCache.removeDocumentChangesThroughChangeId(e,c)}})})]);case 1:e.sent(),c.forEach(function(a){d.window.localStorage.removeItem(d.zombiedClientLocalStorageKey(a.clientId))}),e.label=2;case 2:return[2]}})})},a.prototype.scheduleClientMetadataAndPrimaryLeaseRefreshes=function(){var a=this;this.clientMetadataRefresher=this.queue.enqueueAfterDelay(tf.ClientMetadataRefresh,4e3,function(){return a.updateClientMetadataAndTryBecomePrimary().then(function(){return a.maybeGarbageCollectMultiClientState()}).then(function(){return a.scheduleClientMetadataAndPrimaryLeaseRefreshes()})})},a.prototype.isLocalClient=function(a){return!!a&&a.ownerId===this.clientId},a.prototype.canActAsPrimary=function(a){var b=this;return Ih(a).get(ah.key).next(function(c){if(null!==c&&b.isWithinAge(c.leaseTimestampMs,5e3)&&!b.isClientZombied(c.ownerId)){if(b.isLocalClient(c)&&b.networkEnabled)return!0;if(!b.isLocalClient(c)){if(!c.allowTabSynchronization)throw new Pe(Oe.FAILED_PRECONDITION,Eh);return!1}}return!!b.networkEnabled&&!!b.inForeground||Jh(a).loadAll().next(function(a){return void 0===b.filterActiveClients(a,5e3).find(function(a){if(b.clientId!==a.clientId){var c=!b.networkEnabled&&a.networkEnabled,d=!b.inForeground&&a.inForeground,e=b.networkEnabled===a.networkEnabled;if(c||d&&e)return!0}return!1})})}).next(function(a){return b.isPrimary!==a&&He(Ch,"Client "+(a?"is":"is not")+" eligible for a primary lease."),a})},a.prototype.shutdown=function(){return f(this,void 0,void 0,function(){var a=this;return g(this,function(b){switch(b.label){case 0:return this._started=!1,this.markClientZombied(),this.clientMetadataRefresher&&this.clientMetadataRefresher.cancel(),this.detachVisibilityHandler(),this.detachWindowUnloadHook(),[4,this.simpleDb.runTransaction("readwrite",[ah.store,oh.store],function(b){return a.releasePrimaryLeaseIfHeld(b).next(function(){return a.removeClientMetadata(b)})})];case 1:return b.sent(),this.simpleDb.close(),this.removeClientZombiedEntry(),[2]}})})},a.prototype.filterActiveClients=function(a,b){var c=this;return a.filter(function(a){return c.isWithinAge(a.updateTimeMs,b)&&!c.isClientZombied(a.clientId)})},a.prototype.getActiveClients=function(){var a=this;return this.simpleDb.runTransaction("readonly",[oh.store],function(b){return Jh(b).loadAll().next(function(b){return a.filterActiveClients(b,18e5).map(function(a){return a.clientId})})})},a.clearPersistence=function(b){return f(this,void 0,void 0,function(){var c;return g(this,function(d){switch(d.label){case 0:return a.isAvailable()?(c=b+a.MAIN_DATABASE,[4,xg.delete(c)]):[2,Promise.resolve()];case 1:return d.sent(),[2]}})})},Object.defineProperty(a.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),a.prototype.getMutationQueue=function(a){return Le(this.started,"Cannot initialize MutationQueue before persistence is started."),mg.forUser(a,this.serializer,this.indexManager,this.referenceDelegate)},a.prototype.getQueryCache=function(){return Le(this.started,"Cannot initialize QueryCache before persistence is started."),this.queryCache},a.prototype.getRemoteDocumentCache=function(){return Le(this.started,"Cannot initialize RemoteDocumentCache before persistence is started."),this.remoteDocumentCache},a.prototype.getIndexManager=function(){return Le(this.started,"Cannot initialize IndexManager before persistence is started."),this.indexManager},a.prototype.runTransaction=function(a,b,c){var d=this;return He(Ch,"Starting transaction:",a),this.simpleDb.runTransaction("readonly"===b?"readonly":"readwrite",rh,function(e){return"readwrite-primary"===b?d.verifyPrimaryLease(e).next(function(b){if(!b)throw Ie("Failed to obtain primary lease for action '"+a+"'."),d.isPrimary=!1,d.queue.enqueueAndForget(function(){return d.primaryStateListener(!1)}),new Pe(Oe.FAILED_PRECONDITION,Dh);return c(new Fh(e,d.listenSequence.next()))}).next(function(a){return d.acquireOrExtendPrimaryLease(e).next(function(){return a})}):d.verifyAllowTabSynchronization(e).next(function(){return c(new Fh(e,d.listenSequence.next()))})})},a.prototype.verifyAllowTabSynchronization=function(a){var b=this;return Ih(a).get(ah.key).next(function(a){if(null!==a&&b.isWithinAge(a.leaseTimestampMs,5e3)&&!b.isClientZombied(a.ownerId)&&!b.isLocalClient(a)&&!a.allowTabSynchronization)throw new Pe(Oe.FAILED_PRECONDITION,Eh)})},a.prototype.acquireOrExtendPrimaryLease=function(a){var b=new ah(this.clientId,this.allowTabSynchronization,Date.now());return Ih(a).put(ah.key,b)},a.isAvailable=function(){return xg.isAvailable()},a.buildStoragePrefix=function(a){var b=a.databaseId.projectId;return a.databaseId.isDefaultDatabase||(b+="."+a.databaseId.database),"firestore/"+a.persistenceKey+"/"+b+"/"},a.prototype.releasePrimaryLeaseIfHeld=function(a){var b=this,c=Ih(a);return c.get(ah.key).next(function(a){return b.isLocalClient(a)?(He(Ch,"Releasing primary lease."),c.delete(ah.key)):lg.resolve()})},a.prototype.isWithinAge=function(a,b){var c=Date.now();return!(a<c-b)&&(!(c<a)||(Ie("Detected an update time that is in the future: "+a+" > "+c),!1))},a.prototype.attachVisibilityHandler=function(){var a=this;null!==this.document&&"function"==typeof this.document.addEventListener&&(this.documentVisibilityHandler=function(){a.queue.enqueueAndForget(function(){return a.inForeground="visible"===a.document.visibilityState,a.updateClientMetadataAndTryBecomePrimary()})},this.document.addEventListener("visibilitychange",this.documentVisibilityHandler),this.inForeground="visible"===this.document.visibilityState)},a.prototype.detachVisibilityHandler=function(){this.documentVisibilityHandler&&(Le(null!==this.document&&"function"==typeof this.document.addEventListener,"Expected 'document.addEventListener' to be a function"),this.document.removeEventListener("visibilitychange",this.documentVisibilityHandler),this.documentVisibilityHandler=null)},a.prototype.attachWindowUnloadHook=function(){var a=this;"function"==typeof this.window.addEventListener&&(this.windowUnloadHandler=function(){a.markClientZombied(),a.queue.enqueueAndForget(function(){return a.shutdown()})},this.window.addEventListener("unload",this.windowUnloadHandler))},a.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(Le("function"==typeof this.window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),this.window.removeEventListener("unload",this.windowUnloadHandler),this.windowUnloadHandler=null)},a.prototype.isClientZombied=function(a){try{var b=null!==this.webStorage.getItem(this.zombiedClientLocalStorageKey(a));return He(Ch,"Client '"+a+"' "+(b?"is":"is not")+" zombied in LocalStorage"),b}catch(a){return Ie(Ch,"Failed to get zombied client id.",a),!1}},a.prototype.markClientZombied=function(){try{this.webStorage.setItem(this.zombiedClientLocalStorageKey(this.clientId),String(Date.now()))}catch(a){Ie("Failed to set zombie client id.",a)}},a.prototype.removeClientZombiedEntry=function(){try{this.webStorage.removeItem(this.zombiedClientLocalStorageKey(this.clientId))}catch(a){}},a.prototype.zombiedClientLocalStorageKey=function(a){return"firestore_zombie_"+this.persistenceKey+"_"+a},a.MAIN_DATABASE="main",a}(),Kh,Lh,Mh,Nh,Oh=function(){function a(a,b){this.db=a,this.garbageCollector=new Bh(this,b)}return a.prototype.getSequenceNumberCount=function(a){var b=this.orphanedDocmentCount(a);return this.db.getQueryCache().getQueryCount(a).next(function(a){return b.next(function(b){return a+b})})},a.prototype.orphanedDocmentCount=function(a){var b=0;return this.forEachOrphanedDocumentSequenceNumber(a,function(a){b++}).next(function(){return b})},a.prototype.forEachTarget=function(a,b){return this.db.getQueryCache().forEachTarget(a,b)},a.prototype.forEachOrphanedDocumentSequenceNumber=function(a,b){return this.forEachOrphanedDocument(a,function(a,c){return b(c)})},a.prototype.setInMemoryPins=function(a){this.inMemoryPins=a},a.prototype.addReference=function(a,b){return Ph(a,b)},a.prototype.removeReference=function(a,b){return Ph(a,b)},a.prototype.removeTargets=function(a,b,c){return this.db.getQueryCache().removeTargets(a,b,c)},a.prototype.removeMutationReference=function(a,b){return Ph(a,b)},a.prototype.isPinned=function(a,b){return this.inMemoryPins.containsKey(b)?lg.resolve(!0):(d=b,e=!1,sg(c=a).iterateSerial(function(a){return ng(c,a,d).next(function(a){return a&&(e=!0),lg.resolve(!a)})}).next(function(){return e}));var c,d,e},a.prototype.removeOrphanedDocuments=function(a,b){var c=this,d=0,e=0,f=[];return this.forEachOrphanedDocument(a,function(g,h){if(h<=b){var i=c.isPinned(a,g).next(function(b){if(!b)return d++,c.removeOrphanedDocument(a,g).next(function(a){e+=a})});f.push(i)}}).next(function(){return lg.waitFor(f)}).next(function(){return c.db.getRemoteDocumentCache().updateSize(a,-e)}).next(function(){return d})},a.prototype.removeOrphanedDocument=function(a,b){var c,d=0,e=this.db.getRemoteDocumentCache();return lg.waitFor([Ig(a).delete((c=b,[0,Of(c.path)])),e.removeEntry(a,b).next(function(a){d+=a})]).next(function(){return d})},a.prototype.removeTarget=function(a,b){var c=b.copy({sequenceNumber:a.currentSequenceNumber});return this.db.getQueryCache().updateQueryData(a,c)},a.prototype.updateLimboDocument=function(a,b){return Ph(a,b)},a.prototype.forEachOrphanedDocument=function(a,b){var c,d=Ig(a),e=Af.INVALID;return d.iterate({index:jh.documentTargetsIndex},function(a,d){var f=i(a,2),g=f[0],h=(f[1],d.path),j=d.sequenceNumber;0===g?(e!==Af.INVALID&&b(new Gf(Rf(c)),e),e=j,c=h):e=Af.INVALID}).next(function(){e!==Af.INVALID&&b(new Gf(Rf(c)),e)})},a.prototype.getCacheSize=function(a){return this.db.getRemoteDocumentCache().getSize(a)},a}();(Lh=Kh||(Kh={}))[Lh.NullValue=0]="NullValue",Lh[Lh.BooleanValue=1]="BooleanValue",Lh[Lh.NumberValue=2]="NumberValue",Lh[Lh.TimestampValue=3]="TimestampValue",Lh[Lh.StringValue=4]="StringValue",Lh[Lh.BlobValue=5]="BlobValue",Lh[Lh.RefValue=6]="RefValue",Lh[Lh.GeoPointValue=7]="GeoPointValue",Lh[Lh.ArrayValue=8]="ArrayValue",Lh[Lh.ObjectValue=9]="ObjectValue",(Nh=Mh||(Mh={}))[Nh.Default=0]="Default",Nh[Nh.Estimate=1]="Estimate",Nh[Nh.Previous=2]="Previous";var Qh=function(){function a(a,b){this.serverTimestampBehavior=a,this.timestampsInSnapshots=b}return a.fromSnapshotOptions=function(b,c){switch(b.serverTimestamps){case"estimate":return new a(Mh.Estimate,c);case"previous":return new a(Mh.Previous,c);case"none":case void 0:return new a(Mh.Default,c);default:return Ke("fromSnapshotOptions() called with invalid options.")}},a}(),Rh=function(){function a(){}return a.prototype.toString=function(){var a=this.value();return null===a?"null":a.toString()},a.prototype.defaultCompareTo=function(a){return Le(this.typeOrder!==a.typeOrder,"Default compareTo should not be used for values of same type."),of(this.typeOrder,a.typeOrder)},a}(),Sh=function(a){function b(){var b=a.call(this)||this;return b.typeOrder=Kh.NullValue,b.internalValue=null,b}return e(b,a),b.prototype.value=function(a){return null},b.prototype.isEqual=function(a){return a instanceof b},b.prototype.compareTo=function(a){return a instanceof b?0:this.defaultCompareTo(a)},b.INSTANCE=new b,b}(Rh),Th=function(a){function b(b){var c=a.call(this)||this;return c.internalValue=b,c.typeOrder=Kh.BooleanValue,c}return e(b,a),b.prototype.value=function(a){return this.internalValue},b.prototype.isEqual=function(a){return a instanceof b&&this.internalValue===a.internalValue},b.prototype.compareTo=function(a){return a instanceof b?of(this,a):this.defaultCompareTo(a)},b.of=function(a){return a?b.TRUE:b.FALSE},b.TRUE=new b(!0),b.FALSE=new b(!1),b}(Rh),Uh=function(a){function b(b){var c=a.call(this)||this;return c.internalValue=b,c.typeOrder=Kh.NumberValue,c}return e(b,a),b.prototype.value=function(a){return this.internalValue},b.prototype.compareTo=function(a){return a instanceof b?(c=this.internalValue,d=a.internalValue,c<d?-1:d<c?1:c===d?0:isNaN(c)?isNaN(d)?0:-1:1):this.defaultCompareTo(a);var c,d},b}(Rh),Wh,Xh,Yh=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return e(b,a),b.prototype.isEqual=function(a){return a instanceof b&&Vh(this.internalValue,a.internalValue)},b}(Uh),Zh=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return e(b,a),b.prototype.isEqual=function(a){return a instanceof b&&Vh(this.internalValue,a.internalValue)},b.NAN=new b(NaN),b.POSITIVE_INFINITY=new b(1/0),b.NEGATIVE_INFINITY=new b(-1/0),b}(Uh),$h=function(a){function b(b){var c=a.call(this)||this;return c.internalValue=b,c.typeOrder=Kh.StringValue,c}return e(b,a),b.prototype.value=function(a){return this.internalValue},b.prototype.isEqual=function(a){return a instanceof b&&this.internalValue===a.internalValue},b.prototype.compareTo=function(a){return a instanceof b?of(this.internalValue,a.internalValue):this.defaultCompareTo(a)},b}(Rh),ai=function(a){function b(b){var c=a.call(this)||this;return c.internalValue=b,c.typeOrder=Kh.TimestampValue,c}return e(b,a),b.prototype.value=function(a){return!a||a.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()},b.prototype.isEqual=function(a){return a instanceof b&&this.internalValue.isEqual(a.internalValue)},b.prototype.compareTo=function(a){return a instanceof b?this.internalValue._compareTo(a.internalValue):a instanceof bi?-1:this.defaultCompareTo(a)},b}(Rh),bi=function(a){function b(b,c){var d=a.call(this)||this;return d.localWriteTime=b,d.previousValue=c,d.typeOrder=Kh.TimestampValue,d}return e(b,a),b.prototype.value=function(a){return a&&a.serverTimestampBehavior===Mh.Estimate?(new ai(this.localWriteTime)).value(a):a&&a.serverTimestampBehavior===Mh.Previous&&this.previousValue?this.previousValue.value(a):null},b.prototype.isEqual=function(a){return a instanceof b&&this.localWriteTime.isEqual(a.localWriteTime)},b.prototype.compareTo=function(a){return a instanceof b?this.localWriteTime._compareTo(a.localWriteTime):a instanceof ai?1:this.defaultCompareTo(a)},b.prototype.toString=function(){return"<ServerTimestamp localTime="+this.localWriteTime.toString()+">"},b}(Rh),ci=function(a){function b(b){var c=a.call(this)||this;return c.internalValue=b,c.typeOrder=Kh.BlobValue,c}return e(b,a),b.prototype.value=function(a){return this.internalValue},b.prototype.isEqual=function(a){return a instanceof b&&this.internalValue.isEqual(a.internalValue)},b.prototype.compareTo=function(a){return a instanceof b?this.internalValue._compareTo(a.internalValue):this.defaultCompareTo(a)},b}(Rh),di=function(a){function b(b,c){var d=a.call(this)||this;return d.databaseId=b,d.key=c,d.typeOrder=Kh.RefValue,d}return e(b,a),b.prototype.value=function(a){return this.key},b.prototype.isEqual=function(a){return a instanceof b&&this.key.isEqual(a.key)&&this.databaseId.isEqual(a.databaseId)},b.prototype.compareTo=function(a){if(a instanceof b){var c=this.databaseId.compareTo(a.databaseId);return 0!==c?c:Gf.comparator(this.key,a.key)}return this.defaultCompareTo(a)},b}(Rh),ei=function(a){function b(b){var c=a.call(this)||this;return c.internalValue=b,c.typeOrder=Kh.GeoPointValue,c}return e(b,a),b.prototype.value=function(a){return this.internalValue},b.prototype.isEqual=function(a){return a instanceof b&&this.internalValue.isEqual(a.internalValue)},b.prototype.compareTo=function(a){return a instanceof b?this.internalValue._compareTo(a.internalValue):this.defaultCompareTo(a)},b}(Rh),fi=function(a){function b(b){var c=a.call(this)||this;return c.internalValue=b,c.typeOrder=Kh.ObjectValue,c}return e(b,a),b.prototype.value=function(a){var b={};return this.internalValue.inorderTraversal(function(c,d){b[c]=d.value(a)}),b},b.prototype.forEach=function(a){this.internalValue.inorderTraversal(a)},b.prototype.isEqual=function(a){if(a instanceof b){for(var c=this.internalValue.getIterator(),d=a.internalValue.getIterator();c.hasNext()&&d.hasNext();){var e=c.getNext(),f=d.getNext();if(e.key!==f.key||!e.value.isEqual(f.value))return!1}return!c.hasNext()&&!d.hasNext()}return!1},b.prototype.compareTo=function(a){if(a instanceof b){for(var c=this.internalValue.getIterator(),d=a.internalValue.getIterator();c.hasNext()&&d.hasNext();){var e=c.getNext(),f=d.getNext(),g=of(e.key,f.key)||e.value.compareTo(f.value);if(g)return g}return of(c.hasNext(),d.hasNext())}return this.defaultCompareTo(a)},b.prototype.set=function(a,c){if(Le(!a.isEmpty(),"Cannot set field for empty path on ObjectValue"),1===a.length)return this.setChild(a.firstSegment(),c);var d=this.child(a.firstSegment());d instanceof b||(d=b.EMPTY);var e=d.set(a.popFirst(),c);return this.setChild(a.firstSegment(),e)},b.prototype.delete=function(a){if(Le(!a.isEmpty(),"Cannot delete field for empty path on ObjectValue"),1===a.length)return new b(this.internalValue.remove(a.firstSegment()));var c=this.child(a.firstSegment());if(c instanceof b){var d=c.delete(a.popFirst());return new b(this.internalValue.insert(a.firstSegment(),d))}return this},b.prototype.contains=function(a){return null!==this.field(a)},b.prototype.field=function(a){Le(!a.isEmpty(),"Can't get field of empty path");var c=this;return a.forEach(function(a){c=c instanceof b?c.internalValue.get(a):null}),c},b.prototype.fieldMask=function(){var a=new Yf(Ff.comparator);return this.internalValue.forEach(function(c,d){var e=new Ff([c]);if(d instanceof b){var f=d.fieldMask().fields;f.isEmpty()?a=a.add(e):f.forEach(function(b){a=a.add(e.child(b))})}else a=a.add(e)}),hi.fromSet(a)},b.prototype.toString=function(){return this.internalValue.toString()},b.prototype.child=function(a){return this.internalValue.get(a)||void 0},b.prototype.setChild=function(a,c){return new b(this.internalValue.insert(a,c))},b.EMPTY=new b(new Uf(of)),b}(Rh),gi=function(a){function b(b){var c=a.call(this)||this;return c.internalValue=b,c.typeOrder=Kh.ArrayValue,c}return e(b,a),b.prototype.value=function(a){return this.internalValue.map(function(b){return b.value(a)})},b.prototype.contains=function(a){var b,c;try{for(var d=h(this.internalValue),e=d.next();!e.done;e=d.next())if(e.value.isEqual(a))return!0}catch(a){b={error:a}}finally{try{e&&!e.done&&(c=d.return)&&c.call(d)}finally{if(b)throw b.error}}return!1},b.prototype.forEach=function(a){this.internalValue.forEach(a)},b.prototype.isEqual=function(a){if(a instanceof b){if(this.internalValue.length!==a.internalValue.length)return!1;for(var c=0;c<this.internalValue.length;c++)if(!this.internalValue[c].isEqual(a.internalValue[c]))return!1;return!0}return!1},b.prototype.compareTo=function(a){if(a instanceof b){for(var c=Math.min(this.internalValue.length,a.internalValue.length),d=0;d<c;d++){var e=this.internalValue[d].compareTo(a.internalValue[d]);if(e)return e}return of(this.internalValue.length,a.internalValue.length)}return this.defaultCompareTo(a)},b.prototype.toString=function(){return"["+this.internalValue.map(function(a){return a.toString()}).join(",")+"]"},b}(Rh),hi=function(){function a(a){this.fields=a}return a.fromSet=function(b){return new a(b)},a.fromArray=function(b){var c=new Yf(Ff.comparator);return b.forEach(function(a){return c=c.add(a)}),new a(c)},a.prototype.covers=function(a){var b=!1;return this.fields.forEach(function(c){c.isPrefixOf(a)&&(b=!0)}),b},a.prototype.isEqual=function(a){return this.fields.isEqual(a.fields)},a}(),ii=function(){function a(a,b){this.field=a,this.transform=b}return a.prototype.isEqual=function(a){return this.field.isEqual(a.field)&&this.transform.isEqual(a.transform)},a}(),ji=function(a,b){this.version=a,this.transformResults=b};(Xh=Wh||(Wh={}))[Xh.Set=0]="Set",Xh[Xh.Patch=1]="Patch",Xh[Xh.Transform=2]="Transform",Xh[Xh.Delete=3]="Delete";var ki=function(){function a(a,b){this.updateTime=a,this.exists=b,Le(void 0===a||void 0===b,'Precondition can specify "exists" or "updateTime" but not both')}return a.exists=function(b){return new a(void 0,b)},a.updateTime=function(b){return new a(b)},Object.defineProperty(a.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0}),a.prototype.isValidFor=function(a){return void 0!==this.updateTime?a instanceof Kg&&a.version.isEqual(this.updateTime):void 0!==this.exists?this.exists===a instanceof Kg:(Le(this.isNone,"Precondition should be empty"),!0)},a.prototype.isEqual=function(a){return b=this.updateTime,c=a.updateTime,(null!=b?!!c&&!!b.isEqual(c):b===c)&&this.exists===a.exists;var b,c},a.NONE=new a,a}(),li=function(){function a(){}return a.prototype.verifyKeyMatches=function(a){null!=a&&Le(a.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")},a.getPostMutationVersion=function(a){return a instanceof Kg?a.version:Tf.MIN},a}(),mi=function(a){function b(b,c,d){var e=a.call(this)||this;return e.key=b,e.value=c,e.precondition=d,e.type=Wh.Set,e}return e(b,a),b.prototype.applyToRemoteDocument=function(a,b){this.verifyKeyMatches(a),Le(null==b.transformResults,"Transform results received by SetMutation.");var c=b.version;return new Kg(this.key,c,this.value,{hasCommittedMutations:!0})},b.prototype.applyToLocalView=function(a,b,c){if(this.verifyKeyMatches(a),!this.precondition.isValidFor(a))return a;var d=li.getPostMutationVersion(a);return new Kg(this.key,d,this.value,{hasLocalMutations:!0})},b.prototype.extractBaseValue=function(a){return null},b.prototype.isEqual=function(a){return a instanceof b&&this.key.isEqual(a.key)&&this.value.isEqual(a.value)&&this.precondition.isEqual(a.precondition)},b}(li),ni=function(a){function b(b,c,d,e){var f=a.call(this)||this;return f.key=b,f.data=c,f.fieldMask=d,f.precondition=e,f.type=Wh.Patch,f}return e(b,a),b.prototype.applyToRemoteDocument=function(a,b){if(this.verifyKeyMatches(a),Le(null==b.transformResults,"Transform results received by PatchMutation."),!this.precondition.isValidFor(a))return new Mg(this.key,b.version);var c=this.patchDocument(a);return new Kg(this.key,b.version,c,{hasCommittedMutations:!0})},b.prototype.applyToLocalView=function(a,b,c){if(this.verifyKeyMatches(a),!this.precondition.isValidFor(a))return a;var d=li.getPostMutationVersion(a),e=this.patchDocument(a);return new Kg(this.key,d,e,{hasLocalMutations:!0})},b.prototype.extractBaseValue=function(a){return null},b.prototype.isEqual=function(a){return a instanceof b&&this.key.isEqual(a.key)&&this.fieldMask.isEqual(a.fieldMask)&&this.precondition.isEqual(a.precondition)},b.prototype.patchDocument=function(a){var b;return b=a instanceof Kg?a.data:fi.EMPTY,this.patchObject(b)},b.prototype.patchObject=function(a){var b=this;return this.fieldMask.fields.forEach(function(c){if(!c.isEmpty()){var d=b.data.field(c);a=null!==d?a.set(c,d):a.delete(c)}}),a},b}(li),oi=function(a){function b(b,c){var d=a.call(this)||this;return d.key=b,d.fieldTransforms=c,d.type=Wh.Transform,d.precondition=ki.exists(!0),d}return e(b,a),b.prototype.applyToRemoteDocument=function(a,b){if(this.verifyKeyMatches(a),Le(null!=b.transformResults,"Transform results missing for TransformMutation."),!this.precondition.isValidFor(a))return new Mg(this.key,b.version);var c=this.requireDocument(a),d=this.serverTransformResults(a,b.transformResults),e=b.version,f=this.transformObject(c.data,d);return new Kg(this.key,e,f,{hasCommittedMutations:!0})},b.prototype.applyToLocalView=function(a,b,c){if(this.verifyKeyMatches(a),!this.precondition.isValidFor(a))return a;var d=this.requireDocument(a),e=this.localTransformResults(c,a,b),f=this.transformObject(d.data,e);return new Kg(this.key,d.version,f,{hasLocalMutations:!0})},b.prototype.extractBaseValue=function(a){var b,c,d=null;try{for(var e=h(this.fieldTransforms),f=e.next();!f.done;f=e.next()){var g=f.value,i=a instanceof Kg?a.field(g.field):void 0,j=g.transform.computeBaseValue(i||null);null!=j&&(d=null==d?fi.EMPTY.set(g.field,j):d.set(g.field,j))}}catch(a){b={error:a}}finally{try{f&&!f.done&&(c=e.return)&&c.call(e)}finally{if(b)throw b.error}}return d},b.prototype.isEqual=function(a){return a instanceof b&&this.key.isEqual(a.key)&&pf(this.fieldTransforms,a.fieldTransforms)&&this.precondition.isEqual(a.precondition)},b.prototype.requireDocument=function(a){Le(a instanceof Kg,"Unknown MaybeDocument type "+a);var b=a;return Le(b.key.isEqual(this.key),"Can only transform a document with the same key"),b},b.prototype.serverTransformResults=function(a,b){var c=[];Le(this.fieldTransforms.length===b.length,"server transform result count ("+b.length+") should match field transform count ("+this.fieldTransforms.length+")");for(var d=0;d<b.length;d++){var e=this.fieldTransforms[d],f=e.transform,g=null;a instanceof Kg&&(g=a.field(e.field)),c.push(f.applyToRemoteDocument(g,b[d]))}return c},b.prototype.localTransformResults=function(a,b,c){var d,e,f=[];try{for(var g=h(this.fieldTransforms),i=g.next();!i.done;i=g.next()){var j=i.value,k=j.transform,l=null;b instanceof Kg&&(l=b.field(j.field)),null===l&&c instanceof Kg&&(l=c.field(j.field)),f.push(k.applyToLocalView(l,a))}}catch(a){d={error:a}}finally{try{i&&!i.done&&(e=g.return)&&e.call(g)}finally{if(d)throw d.error}}return f},b.prototype.transformObject=function(a,b){Le(b.length===this.fieldTransforms.length,"TransformResults length mismatch.");for(var c=0;c<this.fieldTransforms.length;c++){var d=this.fieldTransforms[c].field;a=a.set(d,b[c])}return a},b}(li),pi=function(a){function b(b,c){var d=a.call(this)||this;return d.key=b,d.precondition=c,d.type=Wh.Delete,d}return e(b,a),b.prototype.applyToRemoteDocument=function(a,b){return this.verifyKeyMatches(a),Le(null==b.transformResults,"Transform results received by DeleteMutation."),new Lg(this.key,b.version,{hasCommittedMutations:!0})},b.prototype.applyToLocalView=function(a,b,c){return this.verifyKeyMatches(a),this.precondition.isValidFor(a)?(a&&Le(a.key.isEqual(this.key),"Can only apply mutation to document with same key"),new Lg(this.key,Tf.forDeletedDoc())):a},b.prototype.extractBaseValue=function(a){return null},b.prototype.isEqual=function(a){return a instanceof b&&this.key.isEqual(a.key)&&this.precondition.isEqual(a.precondition)},b}(li),qi=function(){function a(a,b,c){this.remoteDocumentCache=a,this.mutationQueue=b,this.indexManager=c}return a.prototype.getDocument=function(a,b){var c=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(a,b).next(function(d){return c.getDocumentInternal(a,b,d)})},a.prototype.getDocumentInternal=function(a,b,c){return this.remoteDocumentCache.getEntry(a,b).next(function(a){var d,e;try{for(var f=h(c),g=f.next();!g.done;g=f.next())a=g.value.applyToLocalView(b,a)}catch(a){d={error:a}}finally{try{g&&!g.done&&(e=f.return)&&e.call(f)}finally{if(d)throw d.error}}return a})},a.prototype.applyLocalMutationsToDocuments=function(a,b,c){var d=ag();return b.forEach(function(a,b){var e,f;try{for(var g=h(c),i=g.next();!i.done;i=g.next())b=i.value.applyToLocalView(a,b)}catch(a){e={error:a}}finally{try{i&&!i.done&&(f=g.return)&&
f.call(g)}finally{if(e)throw e.error}}d=d.insert(a,b)}),d},a.prototype.getDocuments=function(a,b){var c=this;return this.remoteDocumentCache.getEntries(a,b).next(function(b){return c.getLocalViewOfDocuments(a,b)})},a.prototype.getLocalViewOfDocuments=function(a,b){var c=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(a,b).next(function(d){var e=c.applyLocalMutationsToDocuments(a,b,d),f=_f();return e.forEach(function(a,b){b||(b=new Lg(a,Tf.forDeletedDoc())),f=f.insert(a,b)}),f})},a.prototype.getDocumentsMatchingQuery=function(a,b){return b.isDocumentQuery()?this.getDocumentsMatchingDocumentQuery(a,b.path):b.isCollectionGroupQuery()?this.getDocumentsMatchingCollectionGroupQuery(a,b):this.getDocumentsMatchingCollectionQuery(a,b)},a.prototype.getDocumentsMatchingDocumentQuery=function(a,b){return this.getDocument(a,new Gf(b)).next(function(a){var b=cg();return a instanceof Kg&&(b=b.insert(a.key,a)),b})},a.prototype.getDocumentsMatchingCollectionGroupQuery=function(a,b){var c=this;Le(b.path.isEmpty(),"Currently we only support collection group queries at the root.");var d=b.collectionGroup,e=cg();return this.indexManager.getCollectionParents(a,d).next(function(f){return lg.forEach(f,function(f){var g=b.asCollectionQueryAtPath(f.child(d));return c.getDocumentsMatchingCollectionQuery(a,g).next(function(a){a.forEach(function(a,b){e=e.insert(a,b)})})}).next(function(){return e})})},a.prototype.getDocumentsMatchingCollectionQuery=function(a,b){var c,d,e=this;return this.remoteDocumentCache.getDocumentsMatchingQuery(a,b).next(function(d){return c=d,e.mutationQueue.getAllMutationBatchesAffectingQuery(a,b)}).next(function(b){return d=b,e.addMissingBaseDocuments(a,d,c).next(function(a){var b,e,f,g;c=a;try{for(var i=h(d),j=i.next();!j.done;j=i.next()){var k=j.value;try{for(var l=(f=void 0,h(k.mutations)),m=l.next();!m.done;m=l.next()){var n=m.value,o=n.key,p=c.get(o),q=n.applyToLocalView(p,p,k.localWriteTime);c=q instanceof Kg?c.insert(o,q):c.remove(o)}}catch(a){f={error:a}}finally{try{m&&!m.done&&(g=l.return)&&g.call(l)}finally{if(f)throw f.error}}}}catch(a){b={error:a}}finally{try{j&&!j.done&&(e=i.return)&&e.call(i)}finally{if(b)throw b.error}}})}).next(function(){return c.forEach(function(a,d){b.matches(d)||(c=c.remove(a))}),c})},a.prototype.addMissingBaseDocuments=function(a,b,c){var d,e,f,g,i=gg();try{for(var j=h(b),k=j.next();!k.done;k=j.next()){var l=k.value;try{for(var m=(f=void 0,h(l.mutations)),n=m.next();!n.done;n=m.next()){var o=n.value;o instanceof ni&&null===c.get(o.key)&&(i=i.add(o.key))}}catch(a){f={error:a}}finally{try{n&&!n.done&&(g=m.return)&&g.call(m)}finally{if(f)throw f.error}}}}catch(a){d={error:a}}finally{try{k&&!k.done&&(e=j.return)&&e.call(j)}finally{if(d)throw d.error}}var p=c;return this.remoteDocumentCache.getEntries(a,i).next(function(a){return a.forEach(function(a,b){null!==b&&b instanceof Kg&&(p=p.insert(a,b))}),p})},a}(),ri=function(){function a(){this.refsByKey=new Yf(si.compareByKey),this.refsByTarget=new Yf(si.compareByTargetId)}return a.prototype.isEmpty=function(){return this.refsByKey.isEmpty()},a.prototype.addReference=function(a,b){var c=new si(a,b);this.refsByKey=this.refsByKey.add(c),this.refsByTarget=this.refsByTarget.add(c)},a.prototype.addReferences=function(a,b){var c=this;a.forEach(function(a){return c.addReference(a,b)})},a.prototype.removeReference=function(a,b){this.removeRef(new si(a,b))},a.prototype.removeReferences=function(a,b){var c=this;a.forEach(function(a){return c.removeReference(a,b)})},a.prototype.removeReferencesForId=function(a){var b=this,c=Gf.EMPTY,d=new si(c,a),e=new si(c,a+1),f=[];return this.refsByTarget.forEachInRange([d,e],function(a){b.removeRef(a),f.push(a.key)}),f},a.prototype.removeAllReferences=function(){var a=this;this.refsByKey.forEach(function(b){return a.removeRef(b)})},a.prototype.removeRef=function(a){this.refsByKey=this.refsByKey.delete(a),this.refsByTarget=this.refsByTarget.delete(a)},a.prototype.referencesForId=function(a){var b=Gf.EMPTY,c=new si(b,a),d=new si(b,a+1),e=gg();return this.refsByTarget.forEachInRange([c,d],function(a){e=e.add(a.key)}),e},a.prototype.containsKey=function(a){var b=new si(a,0),c=this.refsByKey.firstAfterOrEqual(b);return null!==c&&a.isEqual(c.key)},a}(),si=function(){function a(a,b){this.key=a,this.targetOrBatchId=b}return a.compareByKey=function(a,b){return Gf.comparator(a.key,b.key)||of(a.targetOrBatchId,b.targetOrBatchId)},a.compareByTargetId=function(a,b){return of(a.targetOrBatchId,b.targetOrBatchId)||Gf.comparator(a.key,b.key)},a}(),ti=function(){function a(a,b){this.persistence=a,this.localViewReferences=new ri,this.queryDataByTarget={},Le(a.started,"LocalStore was passed an unstarted persistence implementation"),this.persistence.referenceDelegate.setInMemoryPins(this.localViewReferences),this.mutationQueue=a.getMutationQueue(b),this.remoteDocuments=a.getRemoteDocumentCache(),this.queryCache=a.getQueryCache(),this.localDocuments=new qi(this.remoteDocuments,this.mutationQueue,this.persistence.getIndexManager())}return a.prototype.handleUserChange=function(a){var b=this;return this.persistence.runTransaction("Handle user change","readonly",function(c){var d;return b.mutationQueue.getAllMutationBatches(c).next(function(e){return d=e,b.mutationQueue=b.persistence.getMutationQueue(a),b.localDocuments=new qi(b.remoteDocuments,b.mutationQueue,b.persistence.getIndexManager()),b.mutationQueue.getAllMutationBatches(c)}).next(function(a){var e,f,g,i,j,k,l,m,n=[],o=[],p=gg();try{for(var q=h(d),r=q.next();!r.done;r=q.next()){var s=r.value;n.push(s.batchId);try{for(var t=(g=void 0,h(s.mutations)),u=t.next();!u.done;u=t.next()){var v=u.value;p=p.add(v.key)}}catch(a){g={error:a}}finally{try{u&&!u.done&&(i=t.return)&&i.call(t)}finally{if(g)throw g.error}}}}catch(a){e={error:a}}finally{try{r&&!r.done&&(f=q.return)&&f.call(q)}finally{if(e)throw e.error}}try{for(var w=h(a),x=w.next();!x.done;x=w.next()){s=x.value,o.push(s.batchId);try{for(var y=(l=void 0,h(s.mutations)),z=y.next();!z.done;z=y.next())v=z.value,p=p.add(v.key)}catch(a){l={error:a}}finally{try{z&&!z.done&&(m=y.return)&&m.call(y)}finally{if(l)throw l.error}}}}catch(a){j={error:a}}finally{try{x&&!x.done&&(k=w.return)&&k.call(w)}finally{if(j)throw j.error}}return b.localDocuments.getDocuments(c,p).next(function(a){return{affectedDocuments:a,removedBatchIds:n,addedBatchIds:o}})})})},a.prototype.localWrite=function(a){var b=this,c=Sf.now(),d=a.reduce(function(a,b){return a.add(b.key)},gg());return this.persistence.runTransaction("Locally write mutations","readwrite",function(e){return b.localDocuments.getDocuments(e,d).next(function(d){var f,g,i=[];try{for(var j=h(a),k=j.next();!k.done;k=j.next()){var l=k.value,m=l.extractBaseValue(d.get(l.key));null!=m&&i.push(new ni(l.key,m,m.fieldMask(),ki.exists(!0)))}}catch(g){f={error:g}}finally{try{k&&!k.done&&(g=j.return)&&g.call(j)}finally{if(f)throw f.error}}return b.mutationQueue.addMutationBatch(e,c,i,a).next(function(a){var b=a.applyToLocalDocumentSet(d);return{batchId:a.batchId,changes:b}})})})},a.prototype.lookupMutationDocuments=function(a){var b=this;return this.persistence.runTransaction("Lookup mutation documents","readonly",function(c){return b.mutationQueue.lookupMutationKeys(c,a).next(function(a){return a?b.localDocuments.getDocuments(c,a):lg.resolve(null)})})},a.prototype.acknowledgeBatch=function(a){var b=this;return this.persistence.runTransaction("Acknowledge batch","readwrite-primary",function(c){var d=a.batch.keys(),e=b.remoteDocuments.newChangeBuffer();return b.mutationQueue.acknowledgeBatch(c,a.batch,a.streamToken).next(function(){return b.applyWriteToRemoteDocuments(c,a,e)}).next(function(){return e.apply(c)}).next(function(){return b.mutationQueue.performConsistencyCheck(c)}).next(function(){return b.localDocuments.getDocuments(c,d)})})},a.prototype.rejectBatch=function(a){var b=this;return this.persistence.runTransaction("Reject batch","readwrite-primary",function(c){var d;return b.mutationQueue.lookupMutationBatch(c,a).next(function(a){return Le(null!==a,"Attempt to reject nonexistent batch!"),d=a.keys(),b.mutationQueue.removeMutationBatch(c,a)}).next(function(){return b.mutationQueue.performConsistencyCheck(c)}).next(function(){return b.localDocuments.getDocuments(c,d)})})},a.prototype.getLastStreamToken=function(){var a=this;return this.persistence.runTransaction("Get last stream token","readonly",function(b){return a.mutationQueue.getLastStreamToken(b)})},a.prototype.setLastStreamToken=function(a){var b=this;return this.persistence.runTransaction("Set last stream token","readwrite-primary",function(c){return b.mutationQueue.setLastStreamToken(c,a)})},a.prototype.getLastRemoteSnapshotVersion=function(){var a=this;return this.persistence.runTransaction("Get last remote snapshot version","readonly",function(b){return a.queryCache.getLastRemoteSnapshotVersion(b)})},a.prototype.applyRemoteEvent=function(b){var c=this,d=this.remoteDocuments.newChangeBuffer();return this.persistence.runTransaction("Apply remote event","readwrite-primary",function(e){var f=[],g=gg();Te(b.targetChanges,function(d,h){var i=c.queryDataByTarget[d];if(i){h.addedDocuments.forEach(function(a){g=g.add(a)}),h.modifiedDocuments.forEach(function(a){g=g.add(a)}),f.push(c.queryCache.removeMatchingKeys(e,h.removedDocuments,d).next(function(){return c.queryCache.addMatchingKeys(e,h.addedDocuments,d)}));var j=h.resumeToken;if(0<j.length){var k=i;i=i.copy({resumeToken:j,snapshotVersion:b.snapshotVersion}),c.queryDataByTarget[d]=i,a.shouldPersistQueryData(k,i,h)&&f.push(c.queryCache.updateQueryData(e,i))}}});var h=_f(),i=gg();b.documentUpdates.forEach(function(a,b){i=i.add(a)}),f.push(d.getEntries(e,i).next(function(a){b.documentUpdates.forEach(function(i,j){var k=a.get(i);null==k||j.version.isEqual(Tf.MIN)||g.has(j.key)&&!k.hasPendingWrites||0<=j.version.compareTo(k.version)?(d.addEntry(j),h=h.insert(i,j)):He("LocalStore","Ignoring outdated watch update for ",i,". Current version:",k.version," Watch version:",j.version),b.resolvedLimboDocuments.has(i)&&f.push(c.persistence.referenceDelegate.updateLimboDocument(e,i))})}));var j=b.snapshotVersion;if(!j.isEqual(Tf.MIN)){var k=c.queryCache.getLastRemoteSnapshotVersion(e).next(function(a){return Le(0<=j.compareTo(a),"Watch stream reverted to previous snapshot?? "+j+" < "+a),c.queryCache.setTargetsMetadata(e,e.currentSequenceNumber,j)});f.push(k)}return lg.waitFor(f).next(function(){return d.apply(e)}).next(function(){return c.localDocuments.getLocalViewOfDocuments(e,h)})})},a.shouldPersistQueryData=function(a,b,c){return 0!==b.resumeToken.length&&(0===a.resumeToken.length||b.snapshotVersion.toMicroseconds()-a.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS||0<c.addedDocuments.size+c.modifiedDocuments.size+c.removedDocuments.size)},a.prototype.notifyLocalViewChanges=function(a){var b=this;return this.persistence.runTransaction("notifyLocalViewChanges","readwrite",function(c){return lg.forEach(a,function(a){return b.localViewReferences.addReferences(a.addedKeys,a.targetId),b.localViewReferences.removeReferences(a.removedKeys,a.targetId),lg.forEach(a.removedKeys,function(a){return b.persistence.referenceDelegate.removeReference(c,a)})})})},a.prototype.nextMutationBatch=function(a){var b=this;return this.persistence.runTransaction("Get next mutation batch","readonly",function(c){return void 0===a&&(a=-1),b.mutationQueue.getNextMutationBatchAfterBatchId(c,a)})},a.prototype.readDocument=function(a){var b=this;return this.persistence.runTransaction("read document","readonly",function(c){return b.localDocuments.getDocument(c,a)})},a.prototype.allocateQuery=function(a){var b=this;return this.persistence.runTransaction("Allocate query","readwrite",function(c){var d;return b.queryCache.getQueryData(c,a).next(function(e){return e?(d=e,lg.resolve()):b.queryCache.allocateTargetId(c).next(function(e){return d=new uh(a,e,ph.Listen,c.currentSequenceNumber),b.queryCache.addQueryData(c,d)})}).next(function(){return Le(!b.queryDataByTarget[d.targetId],"Tried to allocate an already allocated query: "+a),b.queryDataByTarget[d.targetId]=d})})},a.prototype.releaseQuery=function(a,b){var c=this,d=b?"readwrite":"readwrite-primary";return this.persistence.runTransaction("Release query",d,function(d){return c.queryCache.getQueryData(d,a).next(function(e){Le(null!=e,"Tried to release nonexistent query: "+a);var f=e.targetId,g=c.queryDataByTarget[f],h=c.localViewReferences.removeReferencesForId(f);return delete c.queryDataByTarget[f],b?lg.resolve():lg.forEach(h,function(a){return c.persistence.referenceDelegate.removeReference(d,a)}).next(function(){return c.persistence.referenceDelegate.removeTarget(d,g)})})})},a.prototype.executeQuery=function(a){var b=this;return this.persistence.runTransaction("Execute query","readonly",function(c){return b.localDocuments.getDocumentsMatchingQuery(c,a)})},a.prototype.remoteDocumentKeys=function(a){var b=this;return this.persistence.runTransaction("Remote document keys","readonly",function(c){return b.queryCache.getMatchingKeysForTargetId(c,a)})},a.prototype.getActiveClients=function(){return this.persistence.getActiveClients()},a.prototype.removeCachedMutationBatchMetadata=function(a){this.mutationQueue.removeCachedMutationKeys(a)},a.prototype.setNetworkEnabled=function(a){this.persistence.setNetworkEnabled(a)},a.prototype.applyWriteToRemoteDocuments=function(a,b,c){var d=this,e=b.batch,f=e.keys(),g=lg.resolve();return f.forEach(function(d){g=g.next(function(){return c.getEntry(a,d)}).next(function(a){var f=a,g=b.docVersions.get(d);Le(null!==g,"ackVersions should contain every doc in the write."),(!f||f.version.compareTo(g)<0)&&((f=e.applyToRemoteDocument(d,f,b))?c.addEntry(f):Le(!a,"Mutation batch "+e+" applied to document "+a+" resulted in null"))})}),g.next(function(){return d.mutationQueue.removeMutationBatch(a,e)})},a.prototype.collectGarbage=function(a){var b=this;return this.persistence.runTransaction("Collect garbage","readwrite-primary",function(c){return a.collect(c,b.queryDataByTarget)})},a.prototype.getQueryForTarget=function(a){var b=this;return this.queryDataByTarget[a]?Promise.resolve(this.queryDataByTarget[a].query):this.persistence.runTransaction("Get query data","readonly",function(c){return b.queryCache.getQueryDataForTarget(c,a).next(function(a){return a?a.query:null})})},a.prototype.getNewDocumentChanges=function(){var a=this;return this.persistence.runTransaction("Get new document changes","readonly",function(b){return a.remoteDocuments.getNewDocumentChanges(b)})},a.RESUME_TOKEN_MAX_AGE_MICROS=3e8,a}(),ui=function(){function a(a,b){this.indexManager=a,this.referenceDelegate=b,this.mutationQueue=[],this.nextBatchId=1,this.lastStreamToken=Ne(),this.batchesByDocumentKey=new Yf(si.compareByKey)}return a.prototype.checkEmpty=function(a){return lg.resolve(0===this.mutationQueue.length)},a.prototype.acknowledgeBatch=function(a,b,c){var d=b.batchId,e=this.indexOfExistingBatchId(d,"acknowledged");Le(0===e,"Can only acknowledge the first batch in the mutation queue");var f=this.mutationQueue[e];return Le(d===f.batchId,"Queue ordering failure: expected batch "+d+", got batch "+f.batchId),this.lastStreamToken=c,lg.resolve()},a.prototype.getLastStreamToken=function(a){return lg.resolve(this.lastStreamToken)},a.prototype.setLastStreamToken=function(a,b){return this.lastStreamToken=b,lg.resolve()},a.prototype.addMutationBatch=function(a,b,c,d){var e,f;Le(0!==d.length,"Mutation batches should not be empty");var g=this.nextBatchId;(this.nextBatchId++,0<this.mutationQueue.length)&&Le(this.mutationQueue[this.mutationQueue.length-1].batchId<g,"Mutation batchIDs must be monotonically increasing order");var i=new jg(g,b,c,d);this.mutationQueue.push(i);try{for(var j=h(d),k=j.next();!k.done;k=j.next()){var l=k.value;this.batchesByDocumentKey=this.batchesByDocumentKey.add(new si(l.key,g)),this.indexManager.addToCollectionParentIndex(a,l.key.path.popLast())}}catch(a){e={error:a}}finally{try{k&&!k.done&&(f=j.return)&&f.call(j)}finally{if(e)throw e.error}}return lg.resolve(i)},a.prototype.lookupMutationBatch=function(a,b){return lg.resolve(this.findMutationBatch(b))},a.prototype.lookupMutationKeys=function(a,b){var c=this.findMutationBatch(b);return Le(null!=c,"Failed to find local mutation batch."),lg.resolve(c.keys())},a.prototype.getNextMutationBatchAfterBatchId=function(a,b){var c=b+1,d=this.indexOfBatchId(c),e=d<0?0:d;return lg.resolve(this.mutationQueue.length>e?this.mutationQueue[e]:null)},a.prototype.getAllMutationBatches=function(a){return lg.resolve(this.mutationQueue.slice())},a.prototype.getAllMutationBatchesAffectingDocumentKey=function(a,b){var c=this,d=new si(b,0),e=new si(b,Number.POSITIVE_INFINITY),f=[];return this.batchesByDocumentKey.forEachInRange([d,e],function(a){Le(b.isEqual(a.key),"Should only iterate over a single key's batches");var d=c.findMutationBatch(a.targetOrBatchId);Le(null!==d,"Batches in the index must exist in the main table"),f.push(d)}),lg.resolve(f)},a.prototype.getAllMutationBatchesAffectingDocumentKeys=function(a,b){var c=this,d=new Yf(of);return b.forEach(function(a){var b=new si(a,0),e=new si(a,Number.POSITIVE_INFINITY);c.batchesByDocumentKey.forEachInRange([b,e],function(b){Le(a.isEqual(b.key),"For each key, should only iterate over a single key's batches"),d=d.add(b.targetOrBatchId)})}),lg.resolve(this.findMutationBatches(d))},a.prototype.getAllMutationBatchesAffectingQuery=function(a,b){Le(!b.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");var c=b.path,d=c.length+1,e=c;Gf.isDocumentKey(e)||(e=e.child(""));var f=new si(new Gf(e),0),g=new Yf(of);return this.batchesByDocumentKey.forEachWhile(function(a){var b=a.key.path;return!!c.isPrefixOf(b)&&(b.length===d&&(g=g.add(a.targetOrBatchId)),!0)},f),lg.resolve(this.findMutationBatches(g))},a.prototype.findMutationBatches=function(a){var b=this,c=[];return a.forEach(function(a){var d=b.findMutationBatch(a);null!==d&&c.push(d)}),c},a.prototype.removeMutationBatch=function(a,b){var c=this;Le(0===this.indexOfExistingBatchId(b.batchId,"removed"),"Can only remove the first entry of the mutation queue"),this.mutationQueue.shift();var d=this.batchesByDocumentKey;return lg.forEach(b.mutations,function(e){var f=new si(e.key,b.batchId);return d=d.delete(f),c.referenceDelegate.removeMutationReference(a,e.key)}).next(function(){c.batchesByDocumentKey=d})},a.prototype.removeCachedMutationKeys=function(a){},a.prototype.containsKey=function(a,b){var c=new si(b,0),d=this.batchesByDocumentKey.firstAfterOrEqual(c);return lg.resolve(b.isEqual(d&&d.key))},a.prototype.performConsistencyCheck=function(a){return 0===this.mutationQueue.length&&Le(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty."),lg.resolve()},a.prototype.indexOfExistingBatchId=function(a,b){var c=this.indexOfBatchId(a);return Le(0<=c&&c<this.mutationQueue.length,"Batches must exist to be "+b),c},a.prototype.indexOfBatchId=function(a){return 0===this.mutationQueue.length?0:a-this.mutationQueue[0].batchId},a.prototype.findMutationBatch=function(a){var b=this.indexOfBatchId(a);if(b<0||b>=this.mutationQueue.length)return null;var c=this.mutationQueue[b];return Le(c.batchId===a,"If found batch must match"),c},a}(),vi=function(){function a(a){this.persistence=a,this.queries=new Ng(function(a){return a.canonicalId()}),this.lastRemoteSnapshotVersion=Tf.MIN,this.highestTargetId=0,this.highestSequenceNumber=0,this.references=new ri,this.targetCount=0,this.targetIdGenerator=vg.forQueryCache()}return a.prototype.getTargetCount=function(a){return lg.resolve(this.targetCount)},a.prototype.forEachTarget=function(a,b){return this.queries.forEach(function(a,c){return b(c)}),lg.resolve()},a.prototype.getLastRemoteSnapshotVersion=function(a){return lg.resolve(this.lastRemoteSnapshotVersion)},a.prototype.getHighestSequenceNumber=function(a){return lg.resolve(this.highestSequenceNumber)},a.prototype.allocateTargetId=function(a){var b=this.targetIdGenerator.after(this.highestTargetId);return this.highestTargetId=b,lg.resolve(b)},a.prototype.setTargetsMetadata=function(a,b,c){return c&&(this.lastRemoteSnapshotVersion=c),b>this.highestSequenceNumber&&(this.highestSequenceNumber=b),lg.resolve()},a.prototype.saveQueryData=function(a){this.queries.set(a.query,a);var b=a.targetId;b>this.highestTargetId&&(this.highestTargetId=b),a.sequenceNumber>this.highestSequenceNumber&&(this.highestSequenceNumber=a.sequenceNumber)},a.prototype.addQueryData=function(a,b){return Le(!this.queries.has(b.query),"Adding a query that already exists"),this.saveQueryData(b),this.targetCount+=1,lg.resolve()},a.prototype.updateQueryData=function(a,b){return Le(this.queries.has(b.query),"Updating a non-existent query"),this.saveQueryData(b),lg.resolve()},a.prototype.removeQueryData=function(a,b){return Le(0<this.targetCount,"Removing a target from an empty cache"),Le(this.queries.has(b.query),"Removing a non-existent target from the cache"),this.queries.delete(b.query),this.references.removeReferencesForId(b.targetId),this.targetCount-=1,lg.resolve()},a.prototype.removeTargets=function(a,b,c){var d=this,e=0,f=[];return this.queries.forEach(function(g,h){h.sequenceNumber<=b&&!c[h.targetId]&&(d.queries.delete(g),f.push(d.removeMatchingKeysForTargetId(a,h.targetId)),e++)}),lg.waitFor(f).next(function(){return e})},a.prototype.getQueryCount=function(a){return lg.resolve(this.targetCount)},a.prototype.getQueryData=function(a,b){var c=this.queries.get(b)||null;return lg.resolve(c)},a.prototype.getQueryDataForTarget=function(a,b){return Ke("Not yet implemented.")},a.prototype.addMatchingKeys=function(a,b,c){this.references.addReferences(b,c);var d=this.persistence.referenceDelegate,e=[];return d&&b.forEach(function(b){e.push(d.addReference(a,b))}),lg.waitFor(e)},a.prototype.removeMatchingKeys=function(a,b,c){this.references.removeReferences(b,c);var d=this.persistence.referenceDelegate,e=[];return d&&b.forEach(function(b){e.push(d.removeReference(a,b))}),lg.waitFor(e)},a.prototype.removeMatchingKeysForTargetId=function(a,b){return this.references.removeReferencesForId(b),lg.resolve()},a.prototype.getMatchingKeysForTargetId=function(a,b){var c=this.references.referencesForId(b);return lg.resolve(c)},a.prototype.containsKey=function(a,b){return lg.resolve(this.references.containsKey(b))},a}(),wi=function(){function a(a,b){this.indexManager=a,this.sizer=b,this.docs=new Uf(Gf.comparator),this.newDocumentChanges=gg(),this.size=0}return a.prototype.addEntries=function(a,b,c){var d,e,f=[];try{for(var g=h(b),i=g.next();!i.done;i=g.next()){var j=i.value,k=j.maybeDocument.key;this.docs=this.docs.insert(k,j),this.newDocumentChanges=this.newDocumentChanges.add(k),f.push(this.indexManager.addToCollectionParentIndex(a,k.path.popLast()))}}catch(a){d={error:a}}finally{try{i&&!i.done&&(e=g.return)&&e.call(g)}finally{if(d)throw d.error}}return this.size+=c,lg.waitFor(f)},a.prototype.removeEntry=function(a,b){var c=this.docs.get(b);return c?(this.docs=this.docs.remove(b),this.size-=c.size,lg.resolve(c.size)):lg.resolve(0)},a.prototype.getEntry=function(a,b){var c=this.docs.get(b);return lg.resolve(c?c.maybeDocument:null)},a.prototype.getSizedEntry=function(a,b){return lg.resolve(this.docs.get(b))},a.prototype.getEntries=function(a,b){var c=this,d=ag();return b.forEach(function(a){var b=c.docs.get(a);d=d.insert(a,b?b.maybeDocument:null)}),lg.resolve(d)},a.prototype.getSizedEntries=function(a,b){var c=this,d=ag(),e=new Uf(Gf.comparator);return b.forEach(function(a){var b=c.docs.get(a);d=d.insert(a,b?b.maybeDocument:null),e=e.insert(a,b?b.size:0)}),lg.resolve({maybeDocuments:d,sizeMap:e})},a.prototype.getDocumentsMatchingQuery=function(a,b){Le(!b.isCollectionGroupQuery(),"CollectionGroup queries should be handled in LocalDocumentsView");for(var c=cg(),d=new Gf(b.path.child("")),e=this.docs.getIteratorFrom(d);e.hasNext();){var f=e.getNext(),g=f.key,h=f.value.maybeDocument;if(!b.path.isPrefixOf(g.path))break;h instanceof Kg&&b.matches(h)&&(c=c.insert(h.key,h))}return lg.resolve(c)},a.prototype.forEachDocumentKey=function(a,b){return lg.forEach(this.docs,function(a){return b(a)})},a.prototype.getNewDocumentChanges=function(a){var b=this,c=_f();return this.newDocumentChanges.forEach(function(a){var d=b.docs.get(a),e=d?d.maybeDocument:new Lg(a,Tf.forDeletedDoc());c=c.insert(a,e)}),this.newDocumentChanges=gg(),lg.resolve(c)},a.prototype.newChangeBuffer=function(){return new xi(this.sizer,this)},a.prototype.getSize=function(a){return lg.resolve(this.size)},a}(),xi=function(a){function b(b,c){var d=a.call(this)||this;return d.sizer=b,d.documentCache=c,d}return e(b,a),b.prototype.applyChanges=function(a){var b=this,c=this.assertChanges(),d=0,e=[];return c.forEach(function(a,c){var f=b.documentSizes.get(a);Le(void 0!==f,"Attempting to change document "+a.toString()+" without having read it first");var g=b.sizer(c);d+=g-f,e.push({maybeDocument:c,size:g})}),this.documentCache.addEntries(a,e,d)},b.prototype.getFromCache=function(a,b){return this.documentCache.getSizedEntry(a,b)},b.prototype.getAllFromCache=function(a,b){return this.documentCache.getSizedEntries(a,b)},b}(Og),yi=function(){function a(a,b){var c=this;this.clientId=a,this.mutationQueues={},this.listenSequence=new Af(0),this._started=!1,this._started=!0,this.referenceDelegate=b(this),this.queryCache=new vi(this),this.indexManager=new Xg,this.remoteDocumentCache=new wi(this.indexManager,function(a){return c.referenceDelegate.documentSize(a)})}return a.createLruPersistence=function(b,c,d){return new a(b,function(a){return new Bi(a,new vh(c),d)})},a.createEagerPersistence=function(b){return new a(b,function(a){return new Ai(a)})},a.prototype.shutdown=function(){return this._started=!1,Promise.resolve()},Object.defineProperty(a.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),a.prototype.getActiveClients=function(){return f(this,void 0,void 0,function(){return g(this,function(a){return[2,[this.clientId]]})})},a.prototype.setPrimaryStateListener=function(a){return a(!0)},a.prototype.setDatabaseDeletedListener=function(){},a.prototype.setNetworkEnabled=function(a){},a.prototype.getIndexManager=function(){return this.indexManager},a.prototype.getMutationQueue=function(a){var b=this.mutationQueues[a.toKey()];return b||(b=new ui(this.indexManager,this.referenceDelegate),this.mutationQueues[a.toKey()]=b),b},a.prototype.getQueryCache=function(){return this.queryCache},a.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache},a.prototype.runTransaction=function(a,b,c){var d=this;He("MemoryPersistence","Starting transaction:",a);var e=new zi(this.listenSequence.next());return this.referenceDelegate.onTransactionStarted(),c(e).next(function(a){return d.referenceDelegate.onTransactionCommitted(e).next(function(){return a})}).toPromise()},a.prototype.mutationQueuesContainKey=function(a,b){return lg.or((c=this.mutationQueues,d=[],Ue(c,function(a,b){return d.push(b)}),d).map(function(c){return function(){return c.containsKey(a,b)}}));var c,d},a}(),zi=function(a){this.currentSequenceNumber=a},Ai=function(){function a(a){this.persistence=a}return a.prototype.setInMemoryPins=function(a){this.inMemoryPins=a},a.prototype.addReference=function(a,b){return this.orphanedDocuments.delete(b),lg.resolve()},a.prototype.removeReference=function(a,b){return this.orphanedDocuments.add(b),lg.resolve()},a.prototype.removeMutationReference=function(a,b){return this.orphanedDocuments.add(b),lg.resolve()},a.prototype.removeTarget=function(a,b){var c=this,d=this.persistence.getQueryCache();return d.getMatchingKeysForTargetId(a,b.targetId).next(function(a){a.forEach(function(a){return c.orphanedDocuments.add(a)})}).next(function(){return d.removeQueryData(a,b)})},a.prototype.onTransactionStarted=function(){this.orphanedDocuments=new Set},a.prototype.onTransactionCommitted=function(a){var b=this,c=this.persistence.getRemoteDocumentCache();return lg.forEach(this.orphanedDocuments,function(d){return b.isReferenced(a,d).next(function(b){return b?lg.resolve():c.removeEntry(a,d).next(function(){})})})},a.prototype.updateLimboDocument=function(a,b){var c=this;return this.isReferenced(a,b).next(function(a){a?c.orphanedDocuments.delete(b):c.orphanedDocuments.add(b)})},a.prototype.documentSize=function(a){return 0},a.prototype.isReferenced=function(a,b){var c=this;return lg.or([function(){return c.persistence.getQueryCache().containsKey(a,b)},function(){return c.persistence.mutationQueuesContainKey(a,b)},function(){return lg.resolve(c.inMemoryPins.containsKey(b))}])},a}(),Bi=function(){function a(a,b,c){this.persistence=a,this.serializer=b,this.orphanedSequenceNumbers=new Ng(function(a){return Of(a.path)}),this.garbageCollector=new Bh(this,c)}return a.prototype.onTransactionStarted=function(){},a.prototype.onTransactionCommitted=function(a){return lg.resolve()},a.prototype.forEachTarget=function(a,b){return this.persistence.getQueryCache().forEachTarget(a,b)},a.prototype.getSequenceNumberCount=function(a){var b=this.orphanedDocumentCount(a);return this.persistence.getQueryCache().getTargetCount(a).next(function(a){return b.next(function(b){return a+b})})},a.prototype.orphanedDocumentCount=function(a){var b=0;return this.forEachOrphanedDocumentSequenceNumber(a,function(a){b++}).next(function(){return b})},a.prototype.forEachOrphanedDocumentSequenceNumber=function(a,b){var c=this;return lg.forEach(this.orphanedSequenceNumbers,function(d,e){return c.isPinned(a,d,e).next(function(a){return a?lg.resolve():b(e)})})},a.prototype.setInMemoryPins=function(a){this.inMemoryPins=a},a.prototype.removeTargets=function(a,b,c){return this.persistence.getQueryCache().removeTargets(a,b,c)},a.prototype.removeOrphanedDocuments=function(a,b){var c=this,d=0,e=this.persistence.getRemoteDocumentCache();return e.forEachDocumentKey(a,function(f){return c.isPinned(a,f,b).next(function(b){return b?lg.resolve():(d++,e.removeEntry(a,f).next())})}).next(function(){return d})},a.prototype.removeMutationReference=function(a,b){return this.orphanedSequenceNumbers.set(b,a.currentSequenceNumber),lg.resolve()},a.prototype.removeTarget=function(a,b){var c=b.copy({sequenceNumber:a.currentSequenceNumber});return this.persistence.getQueryCache().updateQueryData(a,c)},a.prototype.addReference=function(a,b){return this.orphanedSequenceNumbers.set(b,a.currentSequenceNumber),lg.resolve()},a.prototype.removeReference=function(a,b){return this.orphanedSequenceNumbers.set(b,a.currentSequenceNumber),lg.resolve()},a.prototype.updateLimboDocument=function(a,b){return this.orphanedSequenceNumbers.set(b,a.currentSequenceNumber),lg.resolve()},a.prototype.documentSize=function(a){var b,c=this.serializer.toDbRemoteDocument(a);if(c.document)b=c.document;else if(c.unknownDocument)b=c.unknownDocument;else{if(!c.noDocument)throw Ke("Unknown remote document type");b=c.noDocument}return JSON.stringify(b).length},a.prototype.isPinned=function(a,b,c){var d=this;return lg.or([function(){return d.persistence.mutationQueuesContainKey(a,b)},function(){return lg.resolve(d.inMemoryPins.containsKey(b))},function(){return d.persistence.getQueryCache().containsKey(a,b)},function(){var a=d.orphanedSequenceNumbers.get(b);return lg.resolve(void 0!==a&&c<a)}])},a.prototype.getCacheSize=function(a){return this.persistence.getRemoteDocumentCache().getSize(a)},a}(),Ci=Number,Di=Ci.MIN_SAFE_INTEGER||-(Math.pow(2,53)-1),Ei=Ci.MAX_SAFE_INTEGER||Math.pow(2,53)-1,Fi=Ci.isInteger||function(a){return"number"==typeof a&&isFinite(a)&&Math.floor(a)===a},Ii,Ji,Ki=function(){function a(a,b,c,d,e){this.queue=a,this.timerId=b,this.initialDelayMs=c,this.backoffFactor=d,this.maxDelayMs=e,this.timerPromise=null,this.lastAttemptTime=Date.now(),this.reset()}return a.prototype.reset=function(){this.currentBaseMs=0},a.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs},a.prototype.backoffAndRun=function(a){var b=this;this.cancel();var c=Math.floor(this.currentBaseMs+this.jitterDelayMs()),d=Math.max(0,Date.now()-this.lastAttemptTime),e=Math.max(0,c-d);0<this.currentBaseMs&&He("ExponentialBackoff","Backing off for "+e+" ms (base delay: "+this.currentBaseMs+" ms, delay with jitter: "+c+" ms, last attempt: "+d+" ms ago)"),this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,e,function(){return b.lastAttemptTime=Date.now(),a()}),this.currentBaseMs*=this.backoffFactor,this.currentBaseMs<this.initialDelayMs&&(this.currentBaseMs=this.initialDelayMs),this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)},a.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)},a.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs},a}(),Li="PersistentStream";(Ji=
Ii||(Ii={}))[Ji.Initial=0]="Initial",Ji[Ji.Starting=1]="Starting",Ji[Ji.Open=2]="Open",Ji[Ji.Error=3]="Error",Ji[Ji.Backoff=4]="Backoff";var Mi,Ni,Oi,Pi,Qi=function(){function a(a,b,c,d,e,f){this.queue=a,this.idleTimerId=c,this.connection=d,this.credentialsProvider=e,this.listener=f,this.state=Ii.Initial,this.closeCount=0,this.idleTimer=null,this.stream=null,this.backoff=new Ki(a,b,1e3,1.5,6e4)}return a.prototype.isStarted=function(){return this.state===Ii.Starting||this.state===Ii.Open||this.state===Ii.Backoff},a.prototype.isOpen=function(){return this.state===Ii.Open},a.prototype.start=function(){this.state!==Ii.Error?(Le(this.state===Ii.Initial,"Already started"),this.auth()):this.performBackoff()},a.prototype.stop=function(){return f(this,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return this.isStarted()?[4,this.close(Ii.Initial)]:[3,2];case 1:a.sent(),a.label=2;case 2:return[2]}})})},a.prototype.inhibitBackoff=function(){Le(!this.isStarted(),"Can only inhibit backoff in a stopped state"),this.state=Ii.Initial,this.backoff.reset()},a.prototype.markIdle=function(){var a=this;this.isOpen()&&null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6e4,function(){return a.handleIdleCloseTimer()}))},a.prototype.sendRequest=function(a){this.cancelIdleCheck(),this.stream.send(a)},a.prototype.handleIdleCloseTimer=function(){return f(this,void 0,void 0,function(){return g(this,function(a){return this.isOpen()?[2,this.close(Ii.Initial)]:[2]})})},a.prototype.cancelIdleCheck=function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)},a.prototype.close=function(a,b){return f(this,void 0,void 0,function(){return g(this,function(c){switch(c.label){case 0:return Le(this.isStarted(),"Only started streams should be closed."),Le(a===Ii.Error||Gi(b),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),this.closeCount++,a!==Ii.Error?this.backoff.reset():b&&b.code===Oe.RESOURCE_EXHAUSTED?(Ie(b.toString()),Ie("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):b&&b.code===Oe.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=a,[4,this.listener.onClose(b)];case 1:return c.sent(),[2]}})})},a.prototype.tearDown=function(){},a.prototype.auth=function(){var a=this;Le(this.state===Ii.Initial,"Must be in initial state to auth"),this.state=Ii.Starting;var b=this.getCloseGuardedDispatcher(this.closeCount),c=this.closeCount;this.credentialsProvider.getToken().then(function(b){a.closeCount===c&&a.startStream(b)},function(c){b(function(){var b=new Pe(Oe.UNKNOWN,"Fetching auth token failed: "+c.message);return a.handleStreamClose(b)})})},a.prototype.startStream=function(a){var b=this;Le(this.state===Ii.Starting,"Trying to start stream in a non-starting state");var c=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(a),this.stream.onOpen(function(){c(function(){return Le(b.state===Ii.Starting,"Expected stream to be in state Starting, but was "+b.state),b.state=Ii.Open,b.listener.onOpen()})}),this.stream.onClose(function(a){c(function(){return b.handleStreamClose(a)})}),this.stream.onMessage(function(a){c(function(){return b.onMessage(a)})})},a.prototype.performBackoff=function(){var a=this;Le(this.state===Ii.Error,"Should only perform backoff when in Error state"),this.state=Ii.Backoff,this.backoff.backoffAndRun(function(){return f(a,void 0,void 0,function(){return g(this,function(a){return Le(this.state===Ii.Backoff,"Backoff elapsed but state is now: "+this.state),this.state=Ii.Initial,this.start(),Le(this.isStarted(),"PersistentStream should have started"),[2]})})})},a.prototype.handleStreamClose=function(a){return Le(this.isStarted(),"Can't handle server close on non-started stream"),He(Li,"close with error: "+a),this.stream=null,this.close(Ii.Error,a)},a.prototype.getCloseGuardedDispatcher=function(a){var b=this;return function(c){b.queue.enqueueAndForget(function(){return b.closeCount===a?c():(He(Li,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())})}},a}(),Ri=function(a){function b(b,c,d,e,f){var g=a.call(this,b,tf.ListenStreamConnectionBackoff,tf.ListenStreamIdle,c,d,f)||this;return g.serializer=e,g}return e(b,a),b.prototype.startRpc=function(a){return this.connection.openStream("Listen",a)},b.prototype.onMessage=function(a){this.backoff.reset();var b=this.serializer.fromWatchChange(a),c=this.serializer.versionFromListenResponse(a);return this.listener.onWatchChange(b,c)},b.prototype.watch=function(a){var b={};b.database=this.serializer.encodedDatabaseId,b.addTarget=this.serializer.toTarget(a);var c=this.serializer.toListenRequestLabels(a);c&&(b.labels=c),this.sendRequest(b)},b.prototype.unwatch=function(a){var b={};b.database=this.serializer.encodedDatabaseId,b.removeTarget=a,this.sendRequest(b)},b}(Qi),Si=function(a){function b(b,c,d,e,f){var g=a.call(this,b,tf.WriteStreamConnectionBackoff,tf.WriteStreamIdle,c,d,f)||this;return g.serializer=e,g.handshakeComplete_=!1,g}return e(b,a),Object.defineProperty(b.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0}),b.prototype.start=function(){this.handshakeComplete_=!1,a.prototype.start.call(this)},b.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])},b.prototype.startRpc=function(a){return this.connection.openStream("Write",a)},b.prototype.onMessage=function(a){if(Le(!!a.streamToken,"Got a write response without a stream token"),this.lastStreamToken=a.streamToken,this.handshakeComplete_){this.backoff.reset();var b=this.serializer.fromWriteResults(a.writeResults,a.commitTime),c=this.serializer.fromVersion(a.commitTime);return this.listener.onMutationResult(c,b)}return Le(!a.writeResults||0===a.writeResults.length,"Got mutation results for handshake"),this.handshakeComplete_=!0,this.listener.onHandshakeComplete()},b.prototype.writeHandshake=function(){Le(this.isOpen(),"Writing handshake requires an opened stream"),Le(!this.handshakeComplete_,"Handshake already completed");var a={};a.database=this.serializer.encodedDatabaseId,this.sendRequest(a)},b.prototype.writeMutations=function(a){var b=this;Le(this.isOpen(),"Writing mutations requires an opened stream"),Le(this.handshakeComplete_,"Handshake must be complete before writing mutations"),Le(0<this.lastStreamToken.length,"Trying to write mutation without a token");var c={streamToken:this.lastStreamToken,writes:a.map(function(a){return b.serializer.toMutation(a)})};this.sendRequest(c)},b}(Qi),Ti=function(){function a(a,b,c,d){this.queue=a,this.connection=b,this.credentials=c,this.serializer=d}return a.prototype.newPersistentWriteStream=function(a){return new Si(this.queue,this.connection,this.credentials,this.serializer,a)},a.prototype.newPersistentWatchStream=function(a){return new Ri(this.queue,this.connection,this.credentials,this.serializer,a)},a.prototype.commit=function(a){var b=this,c={database:this.serializer.encodedDatabaseId,writes:a.map(function(a){return b.serializer.toMutation(a)})};return this.invokeRPC("Commit",c).then(function(a){return b.serializer.fromWriteResults(a.writeResults,a.commitTime)})},a.prototype.lookup=function(a){var b=this,c={database:this.serializer.encodedDatabaseId,documents:a.map(function(a){return b.serializer.toName(a)})};return this.invokeStreamingRPC("BatchGetDocuments",c).then(function(c){var d=_f();c.forEach(function(a){var c=b.serializer.fromMaybeDocument(a);d=d.insert(c.key,c)});var e=[];return a.forEach(function(a){var b=d.get(a);Le(!!b,"Missing entity in write response for "+a),e.push(b)}),e})},a.prototype.invokeRPC=function(a,b){var c=this;return this.credentials.getToken().then(function(d){return c.connection.invokeRPC(a,b,d)}).catch(function(a){throw a.code===Oe.UNAUTHENTICATED&&c.credentials.invalidateToken(),a})},a.prototype.invokeStreamingRPC=function(a,b){var c=this;return this.credentials.getToken().then(function(d){return c.connection.invokeStreamingRPC(a,b,d)}).catch(function(a){throw a.code===Oe.UNAUTHENTICATED&&c.credentials.invalidateToken(),a})},a}(),Ui=function(){function a(a){this.datastore=a,this.readVersions=eg(),this.mutations=[],this.committed=!1,this.writtenDocs=new Set}return a.prototype.lookup=function(a){var b=this;if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Pe(Oe.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");return this.datastore.lookup(a).then(function(a){return a.forEach(function(a){a instanceof Lg||a instanceof Kg?b.recordVersion(a):Ke("Document in a transaction was a "+a.constructor.name)}),a})},a.prototype.set=function(a,b){this.write(b.toMutations(a,this.precondition(a))),this.writtenDocs.add(a)},a.prototype.update=function(a,b){try{this.write(b.toMutations(a,this.preconditionForUpdate(a)))}catch(a){this.lastWriteError=a}this.writtenDocs.add(a)},a.prototype.delete=function(a){this.write([new pi(a,this.precondition(a))]),this.writtenDocs.add(a)},a.prototype.commit=function(){var a=this;if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;var b=this.readVersions;if(this.mutations.forEach(function(a){b=b.remove(a.key)}),!b.isEmpty())throw new Pe(Oe.INVALID_ARGUMENT,"Every document read in a transaction must also be written.");return this.datastore.commit(this.mutations).then(function(){a.committed=!0})},a.prototype.recordVersion=function(a){var b;if(a instanceof Kg)b=a.version;else{if(!(a instanceof Lg))throw Ke("Document in a transaction was a "+a.constructor.name);b=Tf.forDeletedDoc()}var c=this.readVersions.get(a.key);if(null!==c){if(!b.isEqual(c))throw new Pe(Oe.ABORTED,"Document version changed between two reads.")}else this.readVersions=this.readVersions.insert(a.key,b)},a.prototype.precondition=function(a){var b=this.readVersions.get(a);return!this.writtenDocs.has(a)&&b?ki.updateTime(b):ki.NONE},a.prototype.preconditionForUpdate=function(a){var b=this.readVersions.get(a);if(this.writtenDocs.has(a)||!b)return ki.exists(!0);if(b.isEqual(Tf.forDeletedDoc()))throw new Pe(Oe.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return ki.updateTime(b)},a.prototype.write=function(a){this.ensureCommitNotCalled(),this.mutations=this.mutations.concat(a)},a.prototype.ensureCommitNotCalled=function(){Le(!this.committed,"A transaction object cannot be used after its update callback has been invoked.")},a}();(Ni=Mi||(Mi={}))[Ni.Unknown=0]="Unknown",Ni[Ni.Online=1]="Online",Ni[Ni.Offline=2]="Offline",(Pi=Oi||(Oi={}))[Pi.RemoteStore=0]="RemoteStore",Pi[Pi.SharedClientState=1]="SharedClientState";var Vi,Wi,Xi=function(){function a(a,b){this.asyncQueue=a,this.onlineStateHandler=b,this.state=Mi.Unknown,this.watchStreamFailures=0,this.onlineStateTimer=null,this.shouldWarnClientIsOffline=!0}return a.prototype.handleWatchStreamStart=function(){var a=this;0===this.watchStreamFailures&&(this.setAndBroadcast(Mi.Unknown),Le(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(tf.OnlineStateTimeout,1e4,function(){return a.onlineStateTimer=null,Le(a.state===Mi.Unknown,"Timer should be canceled if we transitioned to a different state."),a.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds."),a.setAndBroadcast(Mi.Offline),Promise.resolve()}))},a.prototype.handleWatchStreamFailure=function(a){this.state===Mi.Online?(this.setAndBroadcast(Mi.Unknown),Le(0===this.watchStreamFailures,"watchStreamFailures must be 0"),Le(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,1<=this.watchStreamFailures&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 1 times. Most recent error: "+a.toString()),this.setAndBroadcast(Mi.Offline)))},a.prototype.set=function(a){this.clearOnlineStateTimer(),this.watchStreamFailures=0,a===Mi.Online&&(this.shouldWarnClientIsOffline=!1),this.setAndBroadcast(a)},a.prototype.setAndBroadcast=function(a){a!==this.state&&(this.state=a,this.onlineStateHandler(a))},a.prototype.logClientOfflineWarningIfNecessary=function(a){var b="Could not reach Cloud Firestore backend. "+a+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";this.shouldWarnClientIsOffline?(Ie(b),this.shouldWarnClientIsOffline=!1):He("OnlineStateTracker",b)},a.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)},a}();(Wi=Vi||(Vi={}))[Wi.OK=0]="OK",Wi[Wi.CANCELLED=1]="CANCELLED",Wi[Wi.UNKNOWN=2]="UNKNOWN",Wi[Wi.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Wi[Wi.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Wi[Wi.NOT_FOUND=5]="NOT_FOUND",Wi[Wi.ALREADY_EXISTS=6]="ALREADY_EXISTS",Wi[Wi.PERMISSION_DENIED=7]="PERMISSION_DENIED",Wi[Wi.UNAUTHENTICATED=16]="UNAUTHENTICATED",Wi[Wi.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Wi[Wi.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Wi[Wi.ABORTED=10]="ABORTED",Wi[Wi.OUT_OF_RANGE=11]="OUT_OF_RANGE",Wi[Wi.UNIMPLEMENTED=12]="UNIMPLEMENTED",Wi[Wi.INTERNAL=13]="INTERNAL",Wi[Wi.UNAVAILABLE=14]="UNAVAILABLE",Wi[Wi.DATA_LOSS=15]="DATA_LOSS";var $i,_i,aj,bj,cj=function(){function a(a){this.comparator=a?function(b,c){return a(b,c)||Gf.comparator(b.key,c.key)}:function(a,b){return Gf.comparator(a.key,b.key)},this.keyedMap=cg(),this.sortedSet=new Uf(this.comparator)}return a.emptySet=function(b){return new a(b.comparator)},a.prototype.has=function(a){return null!=this.keyedMap.get(a)},a.prototype.get=function(a){return this.keyedMap.get(a)},a.prototype.first=function(){return this.sortedSet.minKey()},a.prototype.last=function(){return this.sortedSet.maxKey()},a.prototype.isEmpty=function(){return this.sortedSet.isEmpty()},a.prototype.indexOf=function(a){var b=this.keyedMap.get(a);return b?this.sortedSet.indexOf(b):-1},Object.defineProperty(a.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0}),a.prototype.forEach=function(a){this.sortedSet.inorderTraversal(function(b,c){return a(b),!1})},a.prototype.add=function(a){var b=this.delete(a.key);return b.copy(b.keyedMap.insert(a.key,a),b.sortedSet.insert(a,null))},a.prototype.delete=function(a){var b=this.get(a);return b?this.copy(this.keyedMap.remove(a),this.sortedSet.remove(b)):this},a.prototype.isEqual=function(b){if(b instanceof a){if(this.size!==b.size)return!1;for(var c=this.sortedSet.getIterator(),d=b.sortedSet.getIterator();c.hasNext();){var e=c.getNext().key,f=d.getNext().key;if(!e.isEqual(f))return!1}return!0}return!1},a.prototype.toString=function(){var a=[];return this.forEach(function(b){a.push(b.toString())}),0===a.length?"DocumentSet ()":"DocumentSet (\n  "+a.join("  \n")+"\n)"},a.prototype.copy=function(b,c){var d=new a;return d.comparator=this.comparator,d.keyedMap=b,d.sortedSet=c,d},a}();(_i=$i||($i={}))[_i.Added=0]="Added",_i[_i.Removed=1]="Removed",_i[_i.Modified=2]="Modified",_i[_i.Metadata=3]="Metadata",(bj=aj||(aj={}))[bj.Local=0]="Local",bj[bj.Synced=1]="Synced";var dj,ej,fj=function(){function a(){this.changeMap=new Uf(Gf.comparator)}return a.prototype.track=function(a){var b=a.doc.key,c=this.changeMap.get(b);c?a.type!==$i.Added&&c.type===$i.Metadata?this.changeMap=this.changeMap.insert(b,a):a.type===$i.Metadata&&c.type!==$i.Removed?this.changeMap=this.changeMap.insert(b,{type:c.type,doc:a.doc}):a.type===$i.Modified&&c.type===$i.Modified?this.changeMap=this.changeMap.insert(b,{type:$i.Modified,doc:a.doc}):a.type===$i.Modified&&c.type===$i.Added?this.changeMap=this.changeMap.insert(b,{type:$i.Added,doc:a.doc}):a.type===$i.Removed&&c.type===$i.Added?this.changeMap=this.changeMap.remove(b):a.type===$i.Removed&&c.type===$i.Modified?this.changeMap=this.changeMap.insert(b,{type:$i.Removed,doc:c.doc}):a.type===$i.Added&&c.type===$i.Removed?this.changeMap=this.changeMap.insert(b,{type:$i.Modified,doc:a.doc}):Ke("unsupported combination of changes: "+JSON.stringify(a)+" after "+JSON.stringify(c)):this.changeMap=this.changeMap.insert(b,a)},a.prototype.getChanges=function(){var a=[];return this.changeMap.inorderTraversal(function(b,c){a.push(c)}),a},a}(),gj=function(){function a(a,b,c,d,e,f,g,h){this.query=a,this.docs=b,this.oldDocs=c,this.docChanges=d,this.mutatedKeys=e,this.fromCache=f,this.syncStateChanged=g,this.excludesMetadataChanges=h}return a.fromInitialDocuments=function(b,c,d,e){var f=[];return c.forEach(function(a){f.push({type:$i.Added,doc:a})}),new a(b,c,cj.emptySet(c),f,d,e,!0,!1)},Object.defineProperty(a.prototype,"hasPendingWrites",{get:function(){return!this.mutatedKeys.isEmpty()},enumerable:!0,configurable:!0}),a.prototype.isEqual=function(a){if(!(this.fromCache===a.fromCache&&this.syncStateChanged===a.syncStateChanged&&this.mutatedKeys.isEqual(a.mutatedKeys)&&this.query.isEqual(a.query)&&this.docs.isEqual(a.docs)&&this.oldDocs.isEqual(a.oldDocs)))return!1;var b=this.docChanges,c=a.docChanges;if(b.length!==c.length)return!1;for(var d=0;d<b.length;d++)if(b[d].type!==c[d].type||!b[d].doc.isEqual(c[d].doc))return!1;return!0},a}(),hj=function(){function a(a,b,c,d,e){this.snapshotVersion=a,this.targetChanges=b,this.targetMismatches=c,this.documentUpdates=d,this.resolvedLimboDocuments=e}return a.createSynthesizedRemoteEventForCurrentChange=function(b,c){var d,e=((d={})[b]=ij.createSynthesizedTargetChangeForCurrentChange(b,c),d);return new a(Tf.MIN,e,ig(),_f(),gg())},a}(),ij=function(){function a(a,b,c,d,e){this.resumeToken=a,this.current=b,this.addedDocuments=c,this.modifiedDocuments=d,this.removedDocuments=e}return a.createSynthesizedTargetChangeForCurrentChange=function(b,c){return new a(Ne(),c,gg(),gg(),gg())},a}(),jj=function(a,b,c,d){this.updatedTargetIds=a,this.removedTargetIds=b,this.key=c,this.newDoc=d},kj=function(a,b){this.targetId=a,this.existenceFilter=b};(ej=dj||(dj={}))[ej.NoChange=0]="NoChange",ej[ej.Added=1]="Added",ej[ej.Removed=2]="Removed",ej[ej.Current=3]="Current",ej[ej.Reset=4]="Reset";var lj=function(a,b,c,d){void 0===c&&(c=Ne()),void 0===d&&(d=null),this.state=a,this.targetIds=b,this.resumeToken=c,this.cause=d},mj=function(){function a(){this.pendingResponses=0,this.documentChanges=pj(),this._resumeToken=Ne(),this._current=!1,this._hasPendingChanges=!0}return Object.defineProperty(a.prototype,"current",{get:function(){return this._current},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0}),a.prototype.updateResumeToken=function(a){0<a.length&&(this._hasPendingChanges=!0,this._resumeToken=a)},a.prototype.toTargetChange=function(){var a=gg(),b=gg(),c=gg();return this.documentChanges.forEach(function(d,e){switch(e){case $i.Added:a=a.add(d);break;case $i.Modified:b=b.add(d);break;case $i.Removed:c=c.add(d);break;default:Ke("Encountered invalid change type: "+e)}}),new ij(this._resumeToken,this._current,a,b,c)},a.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1,this.documentChanges=pj()},a.prototype.addDocumentChange=function(a,b){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.insert(a,b)},a.prototype.removeDocumentChange=function(a){this._hasPendingChanges=!0,this.documentChanges=this.documentChanges.remove(a)},a.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1},a.prototype.recordTargetResponse=function(){this.pendingResponses-=1},a.prototype.markCurrent=function(){this._hasPendingChanges=!0,this._current=!0},a}(),nj=function(){function a(a){this.metadataProvider=a,this.targetStates={},this.pendingDocumentUpdates=_f(),this.pendingDocumentTargetMapping=oj(),this.pendingTargetResets=new Yf(of)}return a.prototype.handleDocumentChange=function(a){var b,c,d,e;try{for(var f=h(a.updatedTargetIds),g=f.next();!g.done;g=f.next()){var i=g.value;a.newDoc instanceof Kg?this.addDocumentToTarget(i,a.newDoc):a.newDoc instanceof Lg&&this.removeDocumentFromTarget(i,a.key,a.newDoc)}}catch(a){b={error:a}}finally{try{g&&!g.done&&(c=f.return)&&c.call(f)}finally{if(b)throw b.error}}try{for(var j=h(a.removedTargetIds),k=j.next();!k.done;k=j.next())i=k.value,this.removeDocumentFromTarget(i,a.key,a.newDoc)}catch(a){d={error:a}}finally{try{k&&!k.done&&(e=j.return)&&e.call(j)}finally{if(d)throw d.error}}},a.prototype.handleTargetChange=function(a){var b=this;this.forEachTarget(a,function(c){var d=b.ensureTargetState(c);switch(a.state){case dj.NoChange:b.isActiveTarget(c)&&d.updateResumeToken(a.resumeToken);break;case dj.Added:d.recordTargetResponse(),d.isPending||d.clearPendingChanges(),d.updateResumeToken(a.resumeToken);break;case dj.Removed:d.recordTargetResponse(),d.isPending||b.removeTarget(c),Le(!a.cause,"WatchChangeAggregator does not handle errored targets");break;case dj.Current:b.isActiveTarget(c)&&(d.markCurrent(),d.updateResumeToken(a.resumeToken));break;case dj.Reset:b.isActiveTarget(c)&&(b.resetTarget(c),d.updateResumeToken(a.resumeToken));break;default:Ke("Unknown target watch change state: "+a.state)}})},a.prototype.forEachTarget=function(a,b){0<a.targetIds.length?a.targetIds.forEach(b):Te(this.targetStates,b)},a.prototype.handleExistenceFilter=function(a){var b=a.targetId,c=a.existenceFilter.count,d=this.queryDataForActiveTarget(b);if(d){var e=d.query;if(e.isDocumentQuery())if(0===c){var f=new Gf(e.path);this.removeDocumentFromTarget(b,f,new Lg(f,Tf.forDeletedDoc()))}else Le(1===c,"Single document existence filter with count: "+c);else this.getCurrentDocumentCountForTarget(b)!==c&&(this.resetTarget(b),this.pendingTargetResets=this.pendingTargetResets.add(b))}},a.prototype.createRemoteEvent=function(a){var b=this,c={};Te(this.targetStates,function(d,e){var f=b.queryDataForActiveTarget(d);if(f){if(e.current&&f.query.isDocumentQuery()){var g=new Gf(f.query.path);null!==b.pendingDocumentUpdates.get(g)||b.targetContainsDocument(d,g)||b.removeDocumentFromTarget(d,g,new Lg(g,a))}e.hasPendingChanges&&(c[d]=e.toTargetChange(),e.clearPendingChanges())}});var d=gg();this.pendingDocumentTargetMapping.forEach(function(a,c){var e=!0;c.forEachWhile(function(a){var c=b.queryDataForActiveTarget(a);return!c||c.purpose===ph.LimboResolution||(e=!1)}),e&&(d=d.add(a))});var e=new hj(a,c,this.pendingTargetResets,this.pendingDocumentUpdates,d);return this.pendingDocumentUpdates=_f(),this.pendingDocumentTargetMapping=oj(),this.pendingTargetResets=new Yf(of),e},a.prototype.addDocumentToTarget=function(a,b){if(this.isActiveTarget(a)){var c=this.targetContainsDocument(a,b.key)?$i.Modified:$i.Added;this.ensureTargetState(a).addDocumentChange(b.key,c),this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(b.key,b),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(b.key,this.ensureDocumentTargetMapping(b.key).add(a))}},a.prototype.removeDocumentFromTarget=function(a,b,c){if(this.isActiveTarget(a)){var d=this.ensureTargetState(a);this.targetContainsDocument(a,b)?d.addDocumentChange(b,$i.Removed):d.removeDocumentChange(b),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(b,this.ensureDocumentTargetMapping(b).delete(a)),c&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(b,c))}},a.prototype.removeTarget=function(a){delete this.targetStates[a]},a.prototype.getCurrentDocumentCountForTarget=function(a){var b=this.ensureTargetState(a).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(a).size+b.addedDocuments.size-b.removedDocuments.size},a.prototype.recordPendingTargetRequest=function(a){this.ensureTargetState(a).recordPendingTargetRequest()},a.prototype.ensureTargetState=function(a){return this.targetStates[a]||(this.targetStates[a]=new mj),this.targetStates[a]},a.prototype.ensureDocumentTargetMapping=function(a){var b=this.pendingDocumentTargetMapping.get(a);return b||(b=new Yf(of),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(a,b)),b},a.prototype.isActiveTarget=function(a){return null!==this.queryDataForActiveTarget(a)},a.prototype.queryDataForActiveTarget=function(a){var b=this.targetStates[a];return b&&b.isPending?null:this.metadataProvider.getQueryDataForTarget(a)},a.prototype.resetTarget=function(a){var b=this;Le(!this.targetStates[a].isPending,"Should only reset active targets"),this.targetStates[a]=new mj,this.metadataProvider.getRemoteKeysForTarget(a).forEach(function(c){b.removeDocumentFromTarget(a,c,null)})},a.prototype.targetContainsDocument=function(a,b){return this.metadataProvider.getRemoteKeysForTarget(a).has(b)},a}(),qj="RemoteStore",rj=function(){function a(a,b,c,d,e){var h=this;this.localStore=a,this.datastore=b,this.writePipeline=[],this.listenTargets={},this.watchChangeAggregator=null,this.networkEnabled=!1,this.isPrimary=!1,this.connectivityMonitor=e,this.connectivityMonitor.addCallback(function(a){c.enqueueAndForget(function(){return f(h,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return this.canUseNetwork()?(He(qj,"Restarting streams for network reachability change."),[4,this.restartNetwork()]):[3,2];case 1:a.sent(),a.label=2;case 2:return[2]}})})})}),this.onlineStateTracker=new Xi(c,d),this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)}),this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),onMutationResult:this.onMutationResult.bind(this)})}return a.prototype.start=function(){return this.enableNetwork()},a.prototype.enableNetwork=function(){return f(this,void 0,void 0,function(){var a;return g(this,function(b){switch(b.label){case 0:return this.networkEnabled=!0,this.canUseNetwork()?(a=this.writeStream,[4,this.localStore.getLastStreamToken()]):[3,3];case 1:return a.lastStreamToken=b.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(Mi.Unknown),[4,this.fillWritePipeline()];case 2:b.sent(),b.label=3;case 3:return[2]}})})},a.prototype.disableNetwork=function(){return f(this,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return a.sent(),this.onlineStateTracker.set(Mi.Offline),[2]}})})},a.prototype.disableNetworkInternal=function(){return f(this,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return[4,this.writeStream.stop()];case 1:return a.sent(),[4,this.watchStream.stop()];case 2:return a.sent(),0<this.writePipeline.length&&(He(qj,"Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState(),[2]}})})},a.prototype.shutdown=function(){return f(this,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return He(qj,"RemoteStore shutting down."),this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return a.sent(),this.connectivityMonitor.shutdown(),this.onlineStateTracker.set(Mi.Unknown),[2]}})})},a.prototype.listen=function(a){Le(!Re(this.listenTargets,a.targetId),"listen called with duplicate targetId!"),this.listenTargets[a.targetId]=a,this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(a)},a.prototype.unlisten=function(a){Le(Re(this.listenTargets,a),"unlisten called without assigned target ID!"),delete this.listenTargets[a],this.watchStream.isOpen()&&this.sendUnwatchRequest(a),Ve(this.listenTargets)&&(this.watchStream.isOpen()?this.watchStream.markIdle():this.canUseNetwork()&&this.onlineStateTracker.set(Mi.Unknown))},a.prototype.getQueryDataForTarget=function(a){return this.listenTargets[a]||null},a.prototype.getRemoteKeysForTarget=function(a){return this.syncEngine.getRemoteKeysForTarget(a)},a.prototype.sendWatchRequest=function(a){this.watchChangeAggregator.recordPendingTargetRequest(a.targetId),this.watchStream.watch(a)},a.prototype.sendUnwatchRequest=function(a){this.watchChangeAggregator.recordPendingTargetRequest(a),this.watchStream.unwatch(a)},a.prototype.startWatchStream=function(){Le(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false."),this.watchChangeAggregator=new nj(this),this.watchStream.start(),this.onlineStateTracker.handleWatchStreamStart()},a.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!Ve(this.listenTargets)},a.prototype.canUseNetwork=function(){return this.isPrimary&&this.networkEnabled},a.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null},a.prototype.onWatchStreamOpen=function(){return f(this,void 0,void 0,function(){var a=this;return g(this,function(b){return Te(this.listenTargets,function(b,c){a.sendWatchRequest(c)}),[2]})})},a.prototype.onWatchStreamClose=function(a){return f(this,void 0,void 0,function(){return g(this,function(b){return void 0===a&&Le(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed."),this.cleanUpWatchStreamState(),this.shouldStartWatchStream()?(this.onlineStateTracker.handleWatchStreamFailure(a),this.startWatchStream()):this.onlineStateTracker.set(Mi.Unknown),[2]})})},a.prototype.onWatchStreamChange=function(a,b){return f(this,void 0,void 0,function(){var c;return g(this,function(d){switch(d.label){case 0:return this.onlineStateTracker.set(Mi.Online),a instanceof lj&&a.state===dj.Removed&&a.cause?[2,this.handleTargetError(a)]:(a instanceof jj?this.watchChangeAggregator.handleDocumentChange(a):a instanceof kj?this.watchChangeAggregator.handleExistenceFilter(a):(Le(a instanceof lj,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(a)),b.isEqual(Tf.MIN)?[3,3]:[4,this.localStore.getLastRemoteSnapshotVersion()]);case 1:return c=d.sent(),0<=b.compareTo(c)?[4,this.raiseWatchSnapshot(b)]:[3,3];case 2:d.sent(),d.label=3;case 3:return[2]}})})},a.prototype.raiseWatchSnapshot=function(a){var b=this;Le(!a.isEqual(Tf.MIN),"Can't raise event for unknown SnapshotVersion");var c=this.watchChangeAggregator.createRemoteEvent(a);return Te(c.targetChanges,function(c,d){if(0<d.resumeToken.length){var e=b.listenTargets[c];e&&(b.listenTargets[c]=e.copy({resumeToken:d.resumeToken,snapshotVersion:a}))}}),c.targetMismatches.forEach(function(a){var c=b.listenTargets[a];if(c){b.listenTargets[a]=c.copy({resumeToken:Ne()}),b.sendUnwatchRequest(a);var d=new uh(c.query,a,ph.ExistenceFilterMismatch,c.sequenceNumber);b.sendWatchRequest(d)}}),this.syncEngine.applyRemoteEvent(c)},a.prototype.handleTargetError=function(a){var b=this;Le(!!a.cause,"Handling target error without a cause");var c=a.cause,d=Promise.resolve();return a.targetIds.forEach(function(a){d=d.then(function(){return f(b,void 0,void 0,function(){return g(this,function(b){return Re(this.listenTargets,a)?(delete this.listenTargets[a],this.watchChangeAggregator.removeTarget(a),[2,this.syncEngine.rejectListen(a,c)]):[2]})})})}),d},a.prototype.fillWritePipeline=function(){return f(this,void 0,void 0,function(){var a,b;return g(this,function(c){switch(c.label){case 0:return this.canAddToWritePipeline()?(a=0<this.writePipeline.length?this.writePipeline[this.writePipeline.length-1].batchId:-1,[4,this.localStore.nextMutationBatch(a)]):[3,4];case 1:return null!==(b=c.sent())?[3,2]:(0===this.writePipeline.length&&this.writeStream.markIdle(),[3,4]);case 2:return this.addToWritePipeline(b),[4,this.fillWritePipeline()];case 3:c.sent(),c.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})},a.prototype.canAddToWritePipeline=function(){return this.canUseNetwork()&&this.writePipeline.length<10},a.prototype.outstandingWrites=function(){return this.writePipeline.length},a.prototype.addToWritePipeline=function(a){Le(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full"),this.writePipeline.push(a),this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(a.mutations)},a.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&0<this.writePipeline.length},a.prototype.startWriteStream=function(){Le(this.shouldStartWriteStream(),"startWriteStream() called when shouldStartWriteStream() is false."
),this.writeStream.start()},a.prototype.onWriteStreamOpen=function(){return f(this,void 0,void 0,function(){return g(this,function(a){return this.writeStream.writeHandshake(),[2]})})},a.prototype.onWriteHandshakeComplete=function(){var a=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){var b,c;try{for(var d=h(a.writePipeline),e=d.next();!e.done;e=d.next()){var f=e.value;a.writeStream.writeMutations(f.mutations)}}catch(c){b={error:c}}finally{try{e&&!e.done&&(c=d.return)&&c.call(d)}finally{if(b)throw b.error}}}).catch(Hh)},a.prototype.onMutationResult=function(a,b){var c=this;Le(0<this.writePipeline.length,"Got result for empty write pipeline");var d=this.writePipeline.shift(),e=kg.from(d,a,b,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(e).then(function(){return c.fillWritePipeline()})},a.prototype.onWriteStreamClose=function(a){return f(this,void 0,void 0,function(){var b=this;return g(this,function(c){return void 0===a&&Le(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed."),a&&0<this.writePipeline.length?(void 0,[2,(this.writeStream.handshakeComplete?this.handleWriteError(a):this.handleHandshakeError(a)).then(function(){b.shouldStartWriteStream()&&b.startWriteStream()})]):[2]})})},a.prototype.handleHandshakeError=function(a){return f(this,void 0,void 0,function(){return g(this,function(b){return Yi(a.code)?(He(qj,"RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=Ne(),[2,this.localStore.setLastStreamToken(Ne()).catch(Hh)]):[2]})})},a.prototype.handleWriteError=function(a){return f(this,void 0,void 0,function(){var b,c=this;return g(this,function(d){return Yi(e=a.code)&&e!==Oe.ABORTED?(b=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(b.batchId,a).then(function(){return c.fillWritePipeline()})]):[2];var e})})},a.prototype.createTransaction=function(){return new Ui(this.datastore)},a.prototype.restartNetwork=function(){return f(this,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return this.networkEnabled=!1,[4,this.disableNetworkInternal()];case 1:return a.sent(),this.onlineStateTracker.set(Mi.Unknown),[4,this.enableNetwork()];case 2:return a.sent(),[2]}})})},a.prototype.handleCredentialChange=function(){return f(this,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return this.canUseNetwork()?(He(qj,"RemoteStore restarting streams for new credential"),[4,this.restartNetwork()]):[3,2];case 1:a.sent(),a.label=2;case 2:return[2]}})})},a.prototype.applyPrimaryState=function(a){return f(this,void 0,void 0,function(){return g(this,function(b){switch(b.label){case 0:return(this.isPrimary=a)&&this.networkEnabled?[4,this.enableNetwork()]:[3,2];case 1:return b.sent(),[3,4];case 2:return a?[3,4]:[4,this.disableNetworkInternal()];case 3:b.sent(),this.onlineStateTracker.set(Mi.Unknown),b.label=4;case 4:return[2]}})})},a}(),sj=function(){function a(a,b){if(Xe("GeoPoint",arguments,2),$e("GeoPoint","number",1,a),$e("GeoPoint","number",2,b),!isFinite(a)||a<-90||90<a)throw new Pe(Oe.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+a);if(!isFinite(b)||b<-180||180<b)throw new Pe(Oe.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+b);this._lat=a,this._long=b}return Object.defineProperty(a.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0}),a.prototype.isEqual=function(a){return this._lat===a._lat&&this._long===a._long},a.prototype._compareTo=function(a){return of(this._lat,a._lat)||of(this._long,a._long)},a}(),tj=function(){function a(a,b,c,d,e,f,g){void 0===b&&(b=null),void 0===c&&(c=[]),void 0===d&&(d=[]),void 0===e&&(e=null),void 0===f&&(f=null),void 0===g&&(g=null),this.path=a,this.collectionGroup=b,this.explicitOrderBy=c,this.filters=d,this.limit=e,this.startAt=f,this.endAt=g,this.memoizedCanonicalId=null,this.memoizedOrderBy=null,this.startAt&&this.assertValidBound(this.startAt),this.endAt&&this.assertValidBound(this.endAt)}return a.atPath=function(b){return new a(b)},Object.defineProperty(a.prototype,"orderBy",{get:function(){var a,b;if(null===this.memoizedOrderBy){var c=this.getInequalityFilterField(),d=this.getFirstOrderByField();if(null!==c&&null===d)c.isKeyField()?this.memoizedOrderBy=[Fj]:this.memoizedOrderBy=[new Ej(c),Fj];else{Le(null===c||null!==d&&c.isEqual(d),"First orderBy should match inequality field.");var e=!(this.memoizedOrderBy=[]);try{for(var f=h(this.explicitOrderBy),g=f.next();!g.done;g=f.next()){var i=g.value;this.memoizedOrderBy.push(i),i.field.isKeyField()&&(e=!0)}}catch(b){a={error:b}}finally{try{g&&!g.done&&(b=f.return)&&b.call(f)}finally{if(a)throw a.error}}if(!e){var j=0<this.explicitOrderBy.length?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Cj.ASCENDING;this.memoizedOrderBy.push(j===Cj.ASCENDING?Fj:Gj)}}}return this.memoizedOrderBy},enumerable:!0,configurable:!0}),a.prototype.addFilter=function(b){Le(null==this.getInequalityFilterField()||!(b instanceof wj)||!b.isInequality()||b.field.isEqual(this.getInequalityFilterField()),"Query must only have one inequality field."),Le(!this.isDocumentQuery(),"No filtering allowed for document query");var c=this.filters.concat([b]);return new a(this.path,this.collectionGroup,this.explicitOrderBy.slice(),c,this.limit,this.startAt,this.endAt)},a.prototype.addOrderBy=function(b){Le(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");var c=this.explicitOrderBy.concat([b]);return new a(this.path,this.collectionGroup,c,this.filters.slice(),this.limit,this.startAt,this.endAt)},a.prototype.withLimit=function(b){return new a(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),b,this.startAt,this.endAt)},a.prototype.withStartAt=function(b){return new a(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,b,this.endAt)},a.prototype.withEndAt=function(b){return new a(this.path,this.collectionGroup,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,b)},a.prototype.asCollectionQueryAtPath=function(b){return new a(b,null,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,this.startAt,this.endAt)},a.prototype.canonicalId=function(){var a,b,c,d;if(null===this.memoizedCanonicalId){var e=this.path.canonicalString();this.isCollectionGroupQuery()&&(e+="|cg:"+this.collectionGroup),e+="|f:";try{for(var f=h(this.filters),g=f.next();!g.done;g=f.next())e+=g.value.canonicalId(),e+=","}catch(b){a={error:b}}finally{try{g&&!g.done&&(b=f.return)&&b.call(f)}finally{if(a)throw a.error}}e+="|ob:";try{for(var i=h(this.orderBy),j=i.next();!j.done;j=i.next())e+=j.value.canonicalId(),e+=","}catch(b){c={error:b}}finally{try{j&&!j.done&&(d=i.return)&&d.call(i)}finally{if(c)throw c.error}}Gi(this.limit)||(e+="|l:",e+=this.limit),this.startAt&&(e+="|lb:",e+=this.startAt.canonicalId()),this.endAt&&(e+="|ub:",e+=this.endAt.canonicalId()),this.memoizedCanonicalId=e}return this.memoizedCanonicalId},a.prototype.toString=function(){var a="Query("+this.path.canonicalString();return this.isCollectionGroupQuery()&&(a+=" collectionGroup="+this.collectionGroup),0<this.filters.length&&(a+=", filters: ["+this.filters.join(", ")+"]"),Gi(this.limit)||(a+=", limit: "+this.limit),0<this.explicitOrderBy.length&&(a+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]"),this.startAt&&(a+=", startAt: "+this.startAt.canonicalId()),this.endAt&&(a+=", endAt: "+this.endAt.canonicalId()),a+")"},a.prototype.isEqual=function(a){if(this.limit!==a.limit)return!1;if(this.orderBy.length!==a.orderBy.length)return!1;for(var b=0;b<this.orderBy.length;b++)if(!this.orderBy[b].isEqual(a.orderBy[b]))return!1;if(this.filters.length!==a.filters.length)return!1;for(b=0;b<this.filters.length;b++)if(!this.filters[b].isEqual(a.filters[b]))return!1;return this.collectionGroup===a.collectionGroup&&!!this.path.isEqual(a.path)&&(null!==this.startAt?!!this.startAt.isEqual(a.startAt):null===a.startAt)&&(null!==this.endAt?this.endAt.isEqual(a.endAt):null===a.endAt)},a.prototype.docComparator=function(a,b){var c,d,e=!1;try{for(var f=h(this.orderBy),g=f.next();!g.done;g=f.next()){var i=g.value,j=i.compare(a,b);if(0!==j)return j;e=e||i.field.isKeyField()}}catch(a){c={error:a}}finally{try{g&&!g.done&&(d=f.return)&&d.call(f)}finally{if(c)throw c.error}}return Le(e,"orderBy used that doesn't compare on key field"),0},a.prototype.matches=function(a){return this.matchesPathAndCollectionGroup(a)&&this.matchesOrderBy(a)&&this.matchesFilters(a)&&this.matchesBounds(a)},a.prototype.hasLimit=function(){return!Gi(this.limit)},a.prototype.getFirstOrderByField=function(){return 0<this.explicitOrderBy.length?this.explicitOrderBy[0].field:null},a.prototype.getInequalityFilterField=function(){var a,b;try{for(var c=h(this.filters),d=c.next();!d.done;d=c.next()){var e=d.value;if(e instanceof wj&&e.isInequality())return e.field}}catch(b){a={error:b}}finally{try{d&&!d.done&&(b=c.return)&&b.call(c)}finally{if(a)throw a.error}}return null},a.prototype.findFilterOperator=function(a){var b,c;try{for(var d=h(this.filters),e=d.next();!e.done;e=d.next()){var f=e.value;if(f instanceof wj&&0<=a.indexOf(f.op))return f.op}}catch(a){b={error:a}}finally{try{e&&!e.done&&(c=d.return)&&c.call(d)}finally{if(b)throw b.error}}return null},a.prototype.isDocumentQuery=function(){return Gf.isDocumentKey(this.path)&&null===this.collectionGroup&&0===this.filters.length},a.prototype.isCollectionGroupQuery=function(){return null!==this.collectionGroup},a.prototype.matchesPathAndCollectionGroup=function(a){var b=a.key.path;return null!==this.collectionGroup?a.key.hasCollectionId(this.collectionGroup)&&this.path.isPrefixOf(b):Gf.isDocumentKey(this.path)?this.path.isEqual(b):this.path.isImmediateParentOf(b)},a.prototype.matchesOrderBy=function(a){var b,c;try{for(var d=h(this.explicitOrderBy),e=d.next();!e.done;e=d.next()){var f=e.value;if(!f.field.isKeyField()&&null===a.field(f.field))return!1}}catch(a){b={error:a}}finally{try{e&&!e.done&&(c=d.return)&&c.call(d)}finally{if(b)throw b.error}}return!0},a.prototype.matchesFilters=function(a){var b,c;try{for(var d=h(this.filters),e=d.next();!e.done;e=d.next())if(!e.value.matches(a))return!1}catch(a){b={error:a}}finally{try{e&&!e.done&&(c=d.return)&&c.call(d)}finally{if(b)throw b.error}}return!0},a.prototype.matchesBounds=function(a){return(!this.startAt||!!this.startAt.sortsBeforeDocument(this.orderBy,a))&&(!this.endAt||!this.endAt.sortsBeforeDocument(this.orderBy,a))},a.prototype.assertValidBound=function(a){Le(a.position.length<=this.orderBy.length,"Bound is longer than orderBy")},a}(),uj=function(){},vj=function(){function a(a){this.name=a}return a.fromString=function(b){switch(b){case"<":return a.LESS_THAN;case"<=":return a.LESS_THAN_OR_EQUAL;case"==":return a.EQUAL;case">=":return a.GREATER_THAN_OR_EQUAL;case">":return a.GREATER_THAN;case"array-contains":return a.ARRAY_CONTAINS;case"in":return a.IN;case"array-contains-any":return a.ARRAY_CONTAINS_ANY;default:return Ke("Unknown FieldFilter operator: "+b)}},a.prototype.toString=function(){return this.name},a.prototype.isEqual=function(a){return this.name===a.name},a.LESS_THAN=new a("<"),a.LESS_THAN_OR_EQUAL=new a("<="),a.EQUAL=new a("=="),a.GREATER_THAN=new a(">"),a.GREATER_THAN_OR_EQUAL=new a(">="),a.ARRAY_CONTAINS=new a("array-contains"),a.IN=new a("in"),a.ARRAY_CONTAINS_ANY=new a("array-contains-any"),a}(),wj=function(a){function b(b,c,d){var e=a.call(this)||this;return e.field=b,e.op=c,e.value=d,e}return e(b,a),b.create=function(a,c,d){if(a.isKeyField())return c===vj.IN?(Le(d instanceof gi,"Comparing on key with IN, but filter value not an ArrayValue"),Le(d.internalValue.every(function(a){return a instanceof di}),"Comparing on key with IN, but an array value was not a RefValue"),new yj(a,d)):(Le(d instanceof di,"Comparing on key, but filter value not a RefValue"),Le(c!==vj.ARRAY_CONTAINS&&c!==vj.ARRAY_CONTAINS_ANY,"'"+c.toString()+"' queries don't make sense on document keys."),new xj(a,c,d));if(d.isEqual(Sh.INSTANCE)){if(c!==vj.EQUAL)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. Null supports only equality comparisons.");return new b(a,c,d)}if(d.isEqual(Zh.NAN)){if(c!==vj.EQUAL)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. NaN supports only equality comparisons.");return new b(a,c,d)}return c===vj.ARRAY_CONTAINS?new zj(a,d):c===vj.IN?(Le(d instanceof gi,"IN filter has invalid value: "+d.toString()),new Aj(a,d)):c===vj.ARRAY_CONTAINS_ANY?(Le(d instanceof gi,"ARRAY_CONTAINS_ANY filter has invalid value: "+d.toString()),new Bj(a,d)):new b(a,c,d)},b.prototype.matches=function(a){var b=a.field(this.field);return null!==b&&this.value.typeOrder===b.typeOrder&&this.matchesComparison(b.compareTo(this.value))},b.prototype.matchesComparison=function(a){switch(this.op){case vj.LESS_THAN:return a<0;case vj.LESS_THAN_OR_EQUAL:return a<=0;case vj.EQUAL:return 0===a;case vj.GREATER_THAN:return 0<a;case vj.GREATER_THAN_OR_EQUAL:return 0<=a;default:return Ke("Unknown FieldFilter operator: "+this.op)}},b.prototype.isInequality=function(){return 0<=[vj.LESS_THAN,vj.LESS_THAN_OR_EQUAL,vj.GREATER_THAN,vj.GREATER_THAN_OR_EQUAL].indexOf(this.op)},b.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()},b.prototype.isEqual=function(a){return a instanceof b&&this.op.isEqual(a.op)&&this.field.isEqual(a.field)&&this.value.isEqual(a.value)},b.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()},b}(uj),xj=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return e(b,a),b.prototype.matches=function(a){var b=this.value,c=Gf.comparator(a.key,b.key);return this.matchesComparison(c)},b}(wj),yj=function(a){function b(b,c){var d=a.call(this,b,vj.IN,c)||this;return d.value=c,d}return e(b,a),b.prototype.matches=function(a){return this.value.internalValue.some(function(b){return a.key.isEqual(b.key)})},b}(wj),zj=function(a){function b(b,c){return a.call(this,b,vj.ARRAY_CONTAINS,c)||this}return e(b,a),b.prototype.matches=function(a){var b=a.field(this.field);return b instanceof gi&&b.contains(this.value)},b}(wj),Aj=function(a){function b(b,c){var d=a.call(this,b,vj.IN,c)||this;return d.value=c,d}return e(b,a),b.prototype.matches=function(a){var b=this.value,c=a.field(this.field);return null!==c&&b.contains(c)},b}(wj),Bj=function(a){function b(b,c){var d=a.call(this,b,vj.ARRAY_CONTAINS_ANY,c)||this;return d.value=c,d}return e(b,a),b.prototype.matches=function(a){var b=this,c=a.field(this.field);return c instanceof gi&&c.internalValue.some(function(a){return b.value.contains(a)})},b}(wj),Cj=function(){function a(a){this.name=a}return a.prototype.toString=function(){return this.name},a.ASCENDING=new a("asc"),a.DESCENDING=new a("desc"),a}(),Dj=function(){function a(a,b){this.position=a,this.before=b}return a.prototype.canonicalId=function(){var a,b,c=this.before?"b:":"a:";try{for(var d=h(this.position),e=d.next();!e.done;e=d.next())c+=e.value.toString()}catch(b){a={error:b}}finally{try{e&&!e.done&&(b=d.return)&&b.call(d)}finally{if(a)throw a.error}}return c},a.prototype.sortsBeforeDocument=function(a,b){Le(this.position.length<=a.length,"Bound has more components than query's orderBy");for(var c=0,d=0;d<this.position.length;d++){var e=a[d],f=this.position[d];if(e.field.isKeyField())Le(f instanceof di,"Bound has a non-key value where the key path is being used."),c=Gf.comparator(f.key,b.key);else{var g=b.field(e.field);Le(void 0!==g,"Field should exist since document matched the orderBy already."),c=f.compareTo(g)}if(e.dir===Cj.DESCENDING&&(c*=-1),0!==c)break}return this.before?c<=0:c<0},a.prototype.isEqual=function(a){if(null===a)return!1;if(this.before!==a.before||this.position.length!==a.position.length)return!1;for(var b=0;b<this.position.length;b++){var c=this.position[b],d=a.position[b];if(!c.isEqual(d))return!1}return!0},a}(),Ej=function(){function a(a,b){this.field=a,void 0===b&&(b=Cj.ASCENDING),this.dir=b,this.isKeyOrderBy=a.isKeyField()}return a.prototype.compare=function(a,b){var c=this.isKeyOrderBy?Kg.compareByKey(a,b):Kg.compareByField(this.field,a,b);switch(this.dir){case Cj.ASCENDING:return c;case Cj.DESCENDING:return-1*c;default:return Ke("Unknown direction: "+this.dir)}},a.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()},a.prototype.toString=function(){return this.field.canonicalString()+" ("+this.dir+")"},a.prototype.isEqual=function(a){return this.dir===a.dir&&this.field.isEqual(a.field)},a}(),Fj=new Ej(Ff.keyField(),Cj.ASCENDING),Gj=new Ej(Ff.keyField(),Cj.DESCENDING),Hj=function(){function a(){}return a.prototype.applyToLocalView=function(a,b){return new bi(b,a)},a.prototype.applyToRemoteDocument=function(a,b){return b},a.prototype.computeBaseValue=function(a){return null},a.prototype.isEqual=function(b){return b instanceof a},a.instance=new a,a}(),Ij=function(){function a(a){this.elements=a}return a.prototype.applyToLocalView=function(a,b){return this.apply(a)},a.prototype.applyToRemoteDocument=function(a,b){return this.apply(a)},a.prototype.apply=function(a){var b,c,d=Lj(a),e=function(a){d.find(function(b){return b.isEqual(a)})||d.push(a)};try{for(var f=h(this.elements),g=f.next();!g.done;g=f.next())e(g.value)}catch(a){b={error:a}}finally{try{g&&!g.done&&(c=f.return)&&c.call(f)}finally{if(b)throw b.error}}return new gi(d)},a.prototype.computeBaseValue=function(a){return null},a.prototype.isEqual=function(b){return b instanceof a&&pf(b.elements,this.elements)},a}(),Jj=function(){function a(a){this.elements=a}return a.prototype.applyToLocalView=function(a,b){return this.apply(a)},a.prototype.applyToRemoteDocument=function(a,b){return this.apply(a)},a.prototype.apply=function(a){var b,c,d=Lj(a),e=function(a){d=d.filter(function(b){return!b.isEqual(a)})};try{for(var f=h(this.elements),g=f.next();!g.done;g=f.next())e(g.value)}catch(a){b={error:a}}finally{try{g&&!g.done&&(c=f.return)&&c.call(f)}finally{if(b)throw b.error}}return new gi(d)},a.prototype.computeBaseValue=function(a){return null},a.prototype.isEqual=function(b){return b instanceof a&&pf(b.elements,this.elements)},a}(),Kj=function(){function a(a){this.operand=a}return a.prototype.applyToLocalView=function(a,b){var c=this.computeBaseValue(a);if(c instanceof Yh&&this.operand instanceof Yh){var d=c.internalValue+this.operand.internalValue;return new Yh(d)}return d=c.internalValue+this.operand.internalValue,new Zh(d)},a.prototype.applyToRemoteDocument=function(a,b){return Le(null!==b,"Didn't receive transformResult for NUMERIC_ADD transform"),b},a.prototype.computeBaseValue=function(a){return a instanceof Uh?a:new Yh(0)},a.prototype.isEqual=function(b){return b instanceof a&&this.operand.isEqual(b.operand)},a}(),Mj,Nj,Oj=function(){function a(a){this.count=a}return a.prototype.isEqual=function(a){return a&&a.count===this.count},a}(),Pj=((Mj={})[Cj.ASCENDING.name]="ASCENDING",Mj[Cj.DESCENDING.name]="DESCENDING",Mj),Qj=((Nj={})[vj.LESS_THAN.name]="LESS_THAN",Nj[vj.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL",Nj[vj.GREATER_THAN.name]="GREATER_THAN",Nj[vj.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL",Nj[vj.EQUAL.name]="EQUAL",Nj[vj.ARRAY_CONTAINS.name]="ARRAY_CONTAINS",Nj[vj.IN.name]="IN",Nj[vj.ARRAY_CONTAINS_ANY.name]="ARRAY_CONTAINS_ANY",Nj),Rj=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/),Uj=function(){function a(a,b){this.databaseId=a,this.options=b}return a.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)},a.prototype.unsafeCastProtoByteString=function(a){return a},a.prototype.fromRpcStatus=function(a){var b=void 0===a.code?Oe.UNKNOWN:Zi(a.code);return new Pe(b,a.message||"")},a.prototype.toInt32Value=function(a){return Gi(a)?void 0:{value:a}},a.prototype.fromInt32Value=function(a){var b;return Gi(b="object"==typeof a?a.value:a)?null:b},a.prototype.toTimestamp=function(a){return{seconds:""+a.seconds,nanos:a.nanoseconds}},a.prototype.fromTimestamp=function(a){if("string"==typeof a)return this.fromIso8601String(a);Le(!!a,"Cannot deserialize null or undefined timestamp.");var b=Tj(a.seconds||"0"),c=a.nanos||0;return new Sf(b,c)},a.prototype.fromIso8601String=function(a){var b=0,c=Rj.exec(a);if(Le(!!c,"invalid timestamp: "+a),c[1]){var d=c[1];d=(d+"000000000").substr(0,9),b=Number(d)}var e=new Date(a),f=Math.floor(e.getTime()/1e3);return new Sf(f,b)},a.prototype.toBytes=function(a){return this.options.useProto3Json?a.toBase64():this.unsafeCastProtoByteString(a.toUint8Array())},a.prototype.fromBlob=function(a){return"string"==typeof a?(Le(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),vf.fromBase64String(a)):(Le(!this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),vf.fromUint8Array(a))},a.prototype.toVersion=function(a){return this.toTimestamp(a.toTimestamp())},a.prototype.fromVersion=function(a){return Le(!!a,"Trying to deserialize version that isn't set"),Tf.fromTimestamp(this.fromTimestamp(a))},a.prototype.toResourceName=function(a,b){return this.fullyQualifiedPrefixPath(a).child("documents").child(b).canonicalString()},a.prototype.fromResourceName=function(a){var b=Df.fromString(a);return Le(this.isValidResourceName(b),"Tried to deserialize invalid key "+b.toString()),b},a.prototype.toName=function(a){return this.toResourceName(this.databaseId,a.path)},a.prototype.fromName=function(a){var b=this.fromResourceName(a);return Le(b.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+b.get(1)+" vs "+this.databaseId.projectId),Le(!b.get(3)&&!this.databaseId.database||b.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+b.get(3)+" vs "+this.databaseId.database),new Gf(this.extractLocalPathFromResourceName(b))},a.prototype.toQueryPath=function(a){return this.toResourceName(this.databaseId,a)},a.prototype.fromQueryPath=function(a){var b=this.fromResourceName(a);return 4===b.length?Df.EMPTY_PATH:this.extractLocalPathFromResourceName(b)},Object.defineProperty(a.prototype,"encodedDatabaseId",{get:function(){return(new Df(["projects",this.databaseId.projectId,"databases",this.databaseId.database])).canonicalString()},enumerable:!0,configurable:!0}),a.prototype.fullyQualifiedPrefixPath=function(a){return new Df(["projects",a.projectId,"databases",a.database])},a.prototype.extractLocalPathFromResourceName=function(a){return Le(4<a.length&&"documents"===a.get(4),"tried to deserialize invalid key "+a.toString()),a.popFirst(5)},a.prototype.isValidResourceName=function(a){return 4<=a.length&&"projects"===a.get(0)&&"databases"===a.get(2)},a.prototype.toValue=function(a){if(a instanceof Sh)return{nullValue:"NULL_VALUE"};if(a instanceof Th)return{booleanValue:a.value()};if(a instanceof Yh)return{integerValue:""+a.value()};if(a instanceof Zh){var b=a.value();if(this.options.useProto3Json){if(isNaN(b))return{doubleValue:"NaN"};if(b===1/0)return{doubleValue:"Infinity"};if(b===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:a.value()}}return a instanceof $h?{stringValue:a.value()}:a instanceof fi?{mapValue:this.toMapValue(a)}:a instanceof gi?{arrayValue:this.toArrayValue(a)}:a instanceof ai?{timestampValue:this.toTimestamp(a.internalValue)}:a instanceof ei?{geoPointValue:{latitude:a.value().latitude,longitude:a.value().longitude}}:a instanceof ci?{bytesValue:this.toBytes(a.value())}:a instanceof di?{referenceValue:this.toResourceName(a.databaseId,a.key.path)}:Ke("Unknown FieldValue "+JSON.stringify(a))},a.prototype.fromValue=function(a){var b=this;if("nullValue"in a)return Sh.INSTANCE;if("booleanValue"in a)return Th.of(a.booleanValue);if("integerValue"in a)return new Yh(Tj(a.integerValue));if("doubleValue"in a){if(this.options.useProto3Json){if("NaN"===a.doubleValue)return Zh.NAN;if("Infinity"===a.doubleValue)return Zh.POSITIVE_INFINITY;if("-Infinity"===a.doubleValue)return Zh.NEGATIVE_INFINITY}return new Zh(a.doubleValue)}if("stringValue"in a)return new $h(a.stringValue);if("mapValue"in a)return this.fromFields(a.mapValue.fields||{});if("arrayValue"in a){Sj(a.arrayValue,"arrayValue");var c=a.arrayValue.values||[];return new gi(c.map(function(a){return b.fromValue(a)}))}if("timestampValue"in a)return Sj(a.timestampValue,"timestampValue"),new ai(this.fromTimestamp(a.timestampValue));if("geoPointValue"in a){Sj(a.geoPointValue,"geoPointValue");var d=a.geoPointValue.latitude||0,e=a.geoPointValue.longitude||0;return new ei(new sj(d,e))}if("bytesValue"in a){Sj(a.bytesValue,"bytesValue");var f=this.fromBlob(a.bytesValue);return new ci(f)}if("referenceValue"in a){Sj(a.referenceValue,"referenceValue");var g=this.fromResourceName(a.referenceValue),h=new zf(g.get(1),g.get(3)),i=new Gf(this.extractLocalPathFromResourceName(g));return new di(h,i)}return Ke("Unknown Value proto "+JSON.stringify(a))},a.prototype.toMutationDocument=function(a,b){return{name:this.toName(a),fields:this.toFields(b)}},a.prototype.toDocument=function(a){return Le(!a.hasLocalMutations,"Can't serialize documents with mutations."),{name:this.toName(a.key),fields:this.toFields(a.data),updateTime:this.toTimestamp(a.version.toTimestamp())}},a.prototype.fromDocument=function(a,b){return new Kg(this.fromName(a.name),this.fromVersion(a.updateTime),this.fromFields(a.fields||{}),{hasCommittedMutations:!!b})},a.prototype.toFields=function(a){var b=this,c={};return a.forEach(function(a,d){c[a]=b.toValue(d)}),c},a.prototype.fromFields=function(a){var b=this,c=a,d=fi.EMPTY;return Ue(c,function(a,c){d=d.set(new Ff([a]),b.fromValue(c))}),d},a.prototype.toMapValue=function(a){return{fields:this.toFields(a)}},a.prototype.toArrayValue=function(a){var b=this,c=[];return a.forEach(function(a){c.push(b.toValue(a))}),{values:c}},a.prototype.fromFound=function(a){Le(!!a.found,"Tried to deserialize a found document from a missing document."),Sj(a.found.name,"doc.found.name"),Sj(a.found.updateTime,"doc.found.updateTime");var b=this.fromName(a.found.name),c=this.fromVersion(a.found.updateTime),d=this.fromFields(a.found.fields||{});return new Kg(b,c,d,{},a.found)},a.prototype.fromMissing=function(a){Le(!!a.missing,"Tried to deserialize a missing document from a found document."),Le(!!a.readTime,"Tried to deserialize a missing document without a read time.");var b=this.fromName(a.missing),c=this.fromVersion(a.readTime);return new Lg(b,c)},a.prototype.fromMaybeDocument=function(a){return"found"in a?this.fromFound(a):"missing"in a?this.fromMissing(a):Ke("invalid batch get response: "+JSON.stringify(a))},a.prototype.toWatchTargetChangeState=function(a){switch(a){case dj.Added:return"ADD";case dj.Current:return"CURRENT";case dj.NoChange:return"NO_CHANGE";case dj.Removed:return"REMOVE";case dj.Reset:return"RESET";default:return Ke("Unknown WatchTargetChangeState: "+a)}},a.prototype.toTestWatchChange=function(a){if(a instanceof kj)return{filter:{count:a.existenceFilter.count,targetId:a.targetId}};if(a instanceof jj){if(a.newDoc instanceof Kg){var b=a.newDoc;return{documentChange:{document:{name:this.toName(b.key),fields:this.toFields(b.data),updateTime:this.toVersion(b.version)},targetIds:a.updatedTargetIds,removedTargetIds:a.removedTargetIds}}}if(a.newDoc instanceof Lg)return b=a.newDoc,{documentDelete:{document:this.toName(b.key),readTime:this.toVersion(b.version),removedTargetIds:a.removedTargetIds}};if(null===a.newDoc)return{documentRemove:{document:this.toName(a.key),removedTargetIds:a.removedTargetIds}}}if(a instanceof lj){var c=void 0;return a.cause&&(c={code:function(a){if(void 0===a)return Vi.OK;switch(a){case Oe.OK:return Vi.OK;case Oe.CANCELLED:return Vi.CANCELLED;case Oe.UNKNOWN:return Vi.UNKNOWN;case Oe.DEADLINE_EXCEEDED:return Vi.DEADLINE_EXCEEDED;case Oe.RESOURCE_EXHAUSTED:return Vi.RESOURCE_EXHAUSTED;case Oe.INTERNAL:return Vi.INTERNAL;case Oe.UNAVAILABLE:return Vi.UNAVAILABLE;case Oe.UNAUTHENTICATED:return Vi.UNAUTHENTICATED;case Oe.INVALID_ARGUMENT:return Vi.INVALID_ARGUMENT;case Oe.NOT_FOUND:return Vi.NOT_FOUND;case Oe.ALREADY_EXISTS:return Vi.ALREADY_EXISTS;case Oe.PERMISSION_DENIED:return Vi.PERMISSION_DENIED;case Oe.FAILED_PRECONDITION:return Vi.FAILED_PRECONDITION;case Oe.ABORTED:return Vi.ABORTED;case Oe.OUT_OF_RANGE:return Vi.OUT_OF_RANGE;case Oe.UNIMPLEMENTED:return Vi.UNIMPLEMENTED;case Oe.DATA_LOSS:return Vi.DATA_LOSS;default:return Ke("Unknown status code: "+a)}}(a.cause.code),message:a.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(a.state),targetIds:a.targetIds,resumeToken:this.unsafeCastProtoByteString(a.resumeToken),cause:c}}}return Ke("Unrecognized watch change: "+JSON.stringify(a))},a.prototype.fromWatchChange=function(a){var b;if("targetChange"in a){Sj(a.targetChange,"targetChange");var c=this.fromWatchTargetChangeState(a.targetChange.targetChangeType||"NO_CHANGE"),d=a.targetChange.targetIds||[],e=a.targetChange.resumeToken||this.emptyByteString(),f=a.targetChange.cause,g=f&&this.fromRpcStatus(f);b=new lj(c,d,e,g||null)}else if("documentChange"in a){Sj(a.documentChange,"documentChange"),Sj(a.documentChange.document,"documentChange.name"),Sj(a.documentChange.document.name,"documentChange.document.name"),Sj(a.documentChange.document.updateTime,"documentChange.document.updateTime");var h=a.documentChange,i=this.fromName(h.document.name),j=this.fromVersion(h.document.updateTime),k=this.fromFields(h.document.fields||{}),l=new Kg(i,j,k,{},h.document),m=h.targetIds||[],n=h.removedTargetIds||[];b=new jj(m,n,l.key,l)}else if("documentDelete"in a){Sj(a.documentDelete,"documentDelete"),Sj(a.documentDelete.document,"documentDelete.document");var o=a.documentDelete;i=this.fromName(o.document),j=o.readTime?this.fromVersion(o.readTime):Tf.forDeletedDoc(),l=new Lg(i,j),n=o.removedTargetIds||[],b=new jj([],n,l.key,l)}else if("documentRemove"in a){Sj(a.documentRemove,"documentRemove"),Sj(a.documentRemove.document,"documentRemove");var p=a.documentRemove;i=this.fromName(p.document),n=p.removedTargetIds||[],b=new jj([],n,i,null)}else{if(!("filter"in a))return Ke("Unknown change type "+JSON.stringify(a));Sj(a.filter,"filter"),Sj(a.filter.targetId,"filter.targetId");var q=a.filter,r=q.count||0,s=new Oj(r),t=q.targetId;b=new kj(t,s)}return b},a.prototype.fromWatchTargetChangeState=function(a){return"NO_CHANGE"===a?dj.NoChange:"ADD"===a?dj.Added:"REMOVE"===a?dj.Removed:"CURRENT"===a?dj.Current:"RESET"===a?dj.Reset:Ke("Got unexpected TargetChange.state: "+a)},a.prototype.versionFromListenResponse=function(a){if("targetChange"in a){var b=a.targetChange;return b.targetIds&&b.targetIds.length?Tf.MIN:b.readTime?this.fromVersion(b.readTime):Tf.MIN}return Tf.MIN},a.prototype.toMutation=function(a){var b,c=this;if(a instanceof mi)b={update:this.toMutationDocument(a.key,a.value)};else if(a instanceof pi)b={"delete":this.toName(a.key)};else if(a instanceof ni)b={update:this.toMutationDocument(a.key,a.data),updateMask:this.toDocumentMask(a.fieldMask)};else{if(!(a instanceof oi))return Ke("Unknown mutation type "+a.type);b={transform:{document:this.toName(a.key),fieldTransforms:a.fieldTransforms.map(function(a){return c.toFieldTransform(a)})}}}return a.precondition.isNone||(b.currentDocument=this.toPrecondition(a.precondition)),b},a.prototype.fromMutation=function(a){var b=this,c=a.currentDocument?this.fromPrecondition(a.currentDocument):ki.NONE;if(a.update){Sj(a.update.name,"name");var d=this.fromName(a.update.name),e=this.fromFields(a.update.fields||{});if(a.updateMask){var f=this.fromDocumentMask(a.updateMask);return new ni(d,e,f,c)}return new mi(d,e,c)}if(a.delete)return d=this.fromName(a.delete),new pi(d,c);if(a.transform){d=this.fromName(a.transform.document);var g=a.transform.fieldTransforms.map(function(a){return b.fromFieldTransform(a)});return Le(!0===c.exists,'Transforms only support precondition "exists == true"'),new oi(d,g)}return Ke("unknown mutation proto: "+JSON.stringify(a))},a.prototype.toPrecondition=function(a){return Le(!a.isNone,"Can't serialize an empty precondition"),void 0!==a.updateTime?{updateTime:this.toVersion(a.updateTime)}:void 0!==a.exists?{exists:a.exists}:Ke("Unknown precondition")},a.prototype.fromPrecondition=function(a){return void 0!==a.updateTime?ki.updateTime(this.fromVersion(a.updateTime)):void 0!==a.exists?ki.exists(a.exists):ki.NONE},a.prototype.fromWriteResult=function(a,b){var c=this,d=a.updateTime?this.fromVersion(a.updateTime):this.fromVersion(b),e=null;return a.transformResults&&0<a.transformResults.length&&(e=a.transformResults.map(function(a){return c.fromValue(a)})),new ji(d
,e)},a.prototype.fromWriteResults=function(a,b){var c=this;return a&&0<a.length?(Le(void 0!==b,"Received a write result without a commit time"),a.map(function(a){return c.fromWriteResult(a,b)})):[]},a.prototype.toFieldTransform=function(a){var b=this,c=a.transform;if(c instanceof Hj)return{fieldPath:a.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(c instanceof Ij)return{fieldPath:a.field.canonicalString(),appendMissingElements:{values:c.elements.map(function(a){return b.toValue(a)})}};if(c instanceof Jj)return{fieldPath:a.field.canonicalString(),removeAllFromArray:{values:c.elements.map(function(a){return b.toValue(a)})}};if(c instanceof Kj)return{fieldPath:a.field.canonicalString(),increment:this.toValue(c.operand)};throw Ke("Unknown transform: "+a.transform)},a.prototype.fromFieldTransform=function(a){var b=this,c=null;if("setToServerValue"in a)Le("REQUEST_TIME"===a.setToServerValue,"Unknown server value transform proto: "+JSON.stringify(a)),c=Hj.instance;else if("appendMissingElements"in a){var d=a.appendMissingElements.values||[];c=new Ij(d.map(function(a){return b.fromValue(a)}))}else if("removeAllFromArray"in a)d=a.removeAllFromArray.values||[],c=new Jj(d.map(function(a){return b.fromValue(a)}));else if("increment"in a){var e=this.fromValue(a.increment);Le(e instanceof Uh,"NUMERIC_ADD transform requires a NumberValue"),c=new Kj(e)}else Ke("Unknown transform proto: "+JSON.stringify(a));var f=Ff.fromServerFormat(a.fieldPath);return new ii(f,c)},a.prototype.toDocumentsTarget=function(a){return{documents:[this.toQueryPath(a.path)]}},a.prototype.fromDocumentsTarget=function(a){var b=a.documents.length;Le(1===b,"DocumentsTarget contained other than 1 document: "+b);var c=a.documents[0];return tj.atPath(this.fromQueryPath(c))},a.prototype.toQueryTarget=function(a){var b={structuredQuery:{}},c=a.path;null!==a.collectionGroup?(Le(c.length%2==0,"Collection Group queries should be within a document path or root."),b.parent=this.toQueryPath(c),b.structuredQuery.from=[{collectionId:a.collectionGroup,allDescendants:!0}]):(Le(c.length%2!=0,"Document queries with filters are not supported."),b.parent=this.toQueryPath(c.popLast()),b.structuredQuery.from=[{collectionId:c.lastSegment()}]);var d=this.toFilter(a.filters);d&&(b.structuredQuery.where=d);var e=this.toOrder(a.orderBy);e&&(b.structuredQuery.orderBy=e);var f=this.toInt32Value(a.limit);return void 0!==f&&(b.structuredQuery.limit=f),a.startAt&&(b.structuredQuery.startAt=this.toCursor(a.startAt)),a.endAt&&(b.structuredQuery.endAt=this.toCursor(a.endAt)),b},a.prototype.fromQueryTarget=function(a){var b=this.fromQueryPath(a.parent),c=a.structuredQuery,d=c.from?c.from.length:0,e=null;if(0<d){Le(1===d,"StructuredQuery.from with more than one collection is not supported.");var f=c.from[0];f.allDescendants?e=f.collectionId:b=b.child(f.collectionId)}var g=[];c.where&&(g=this.fromFilter(c.where));var h=[];c.orderBy&&(h=this.fromOrder(c.orderBy));var i=null;c.limit&&(i=this.fromInt32Value(c.limit));var j=null;c.startAt&&(j=this.fromCursor(c.startAt));var k=null;return c.endAt&&(k=this.fromCursor(c.endAt)),new tj(b,e,h,g,i,j,k)},a.prototype.toListenRequestLabels=function(a){var b=this.toLabel(a.purpose);return null==b?null:{"goog-listen-tags":b}},a.prototype.toLabel=function(a){switch(a){case ph.Listen:return null;case ph.ExistenceFilterMismatch:return"existence-filter-mismatch";case ph.LimboResolution:return"limbo-document";default:return Ke("Unrecognized query purpose: "+a)}},a.prototype.toTarget=function(a){var b,c=a.query;return(b=c.isDocumentQuery()?{documents:this.toDocumentsTarget(c)}:{query:this.toQueryTarget(c)}).targetId=a.targetId,0<a.resumeToken.length&&(b.resumeToken=this.unsafeCastProtoByteString(a.resumeToken)),b},a.prototype.toFilter=function(a){var b=this;if(0!==a.length){var c=a.map(function(a){return a instanceof wj?b.toUnaryOrFieldFilter(a):Ke("Unrecognized filter: "+JSON.stringify(a))});return 1===c.length?c[0]:{compositeFilter:{op:"AND",filters:c}}}},a.prototype.fromFilter=function(a){var b=this;return a?void 0!==a.unaryFilter?[this.fromUnaryFilter(a)]:void 0!==a.fieldFilter?[this.fromFieldFilter(a)]:void 0!==a.compositeFilter?a.compositeFilter.filters.map(function(a){return b.fromFilter(a)}).reduce(function(a,b){return a.concat(b)}):Ke("Unknown filter: "+JSON.stringify(a)):[]},a.prototype.toOrder=function(a){var b=this;if(0!==a.length)return a.map(function(a){return b.toPropertyOrder(a)})},a.prototype.fromOrder=function(a){var b=this;return a.map(function(a){return b.fromPropertyOrder(a)})},a.prototype.toCursor=function(a){var b=this;return{before:a.before,values:a.position.map(function(a){return b.toValue(a)})}},a.prototype.fromCursor=function(a){var b=this,c=!!a.before,d=a.values.map(function(a){return b.fromValue(a)});return new Dj(d,c)},a.prototype.toDirection=function(a){return Pj[a.name]},a.prototype.fromDirection=function(a){switch(a){case"ASCENDING":return Cj.ASCENDING;case"DESCENDING":return Cj.DESCENDING;default:return}},a.prototype.toOperatorName=function(a){return Qj[a.name]},a.prototype.fromOperatorName=function(a){switch(a){case"EQUAL":return vj.EQUAL;case"GREATER_THAN":return vj.GREATER_THAN;case"GREATER_THAN_OR_EQUAL":return vj.GREATER_THAN_OR_EQUAL;case"LESS_THAN":return vj.LESS_THAN;case"LESS_THAN_OR_EQUAL":return vj.LESS_THAN_OR_EQUAL;case"ARRAY_CONTAINS":return vj.ARRAY_CONTAINS;case"IN":return vj.IN;case"ARRAY_CONTAINS_ANY":return vj.ARRAY_CONTAINS_ANY;case"OPERATOR_UNSPECIFIED":return Ke("Unspecified operator");default:return Ke("Unknown operator")}},a.prototype.toFieldPathReference=function(a){return{fieldPath:a.canonicalString()}},a.prototype.fromFieldPathReference=function(a){return Ff.fromServerFormat(a.fieldPath)},a.prototype.toPropertyOrder=function(a){return{field:this.toFieldPathReference(a.field),direction:this.toDirection(a.dir)}},a.prototype.fromPropertyOrder=function(a){return new Ej(this.fromFieldPathReference(a.field),this.fromDirection(a.direction))},a.prototype.fromFieldFilter=function(a){return wj.create(this.fromFieldPathReference(a.fieldFilter.field),this.fromOperatorName(a.fieldFilter.op),this.fromValue(a.fieldFilter.value))},a.prototype.toUnaryOrFieldFilter=function(a){if(a.op===vj.EQUAL){if(a.value.isEqual(Zh.NAN))return{unaryFilter:{field:this.toFieldPathReference(a.field),op:"IS_NAN"}};if(a.value.isEqual(Sh.INSTANCE))return{unaryFilter:{field:this.toFieldPathReference(a.field),op:"IS_NULL"}}}return{fieldFilter:{field:this.toFieldPathReference(a.field),op:this.toOperatorName(a.op),value:this.toValue(a.value)}}},a.prototype.fromUnaryFilter=function(a){switch(a.unaryFilter.op){case"IS_NAN":var b=this.fromFieldPathReference(a.unaryFilter.field);return wj.create(b,vj.EQUAL,Zh.NAN);case"IS_NULL":var c=this.fromFieldPathReference(a.unaryFilter.field);return wj.create(c,vj.EQUAL,Sh.INSTANCE);case"OPERATOR_UNSPECIFIED":return Ke("Unspecified filter");default:return Ke("Unknown filter")}},a.prototype.toDocumentMask=function(a){var b=[];return a.fields.forEach(function(a){return b.push(a.canonicalString())}),{fieldPaths:b}},a.prototype.fromDocumentMask=function(a){var b=(a.fieldPaths||[]).map(function(a){return Ff.fromServerFormat(a)});return hi.fromArray(b)},a}(),Vj=function(){this.listeners=[]},Wj=function(){function a(a){this.syncEngine=a,this.queries=new Ng(function(a){return a.canonicalId()}),this.onlineState=Mi.Unknown,this.syncEngine.subscribe(this)}return a.prototype.listen=function(a){var b=a.query,c=!1,d=this.queries.get(b);return d||(c=!0,d=new Vj,this.queries.set(b,d)),d.listeners.push(a),a.applyOnlineStateChange(this.onlineState),d.viewSnap&&a.onViewSnapshot(d.viewSnap),c?this.syncEngine.listen(b).then(function(a){return d.targetId=a}):Promise.resolve(d.targetId)},a.prototype.unlisten=function(a){return f(this,void 0,void 0,function(){var b,c,d,e;return g(this,function(f){return b=a.query,c=!1,(d=this.queries.get(b))&&0<=(e=d.listeners.indexOf(a))&&(d.listeners.splice(e,1),c=0===d.listeners.length),c?(this.queries.delete(b),[2,this.syncEngine.unlisten(b)]):[2]})})},a.prototype.onWatchChange=function(a){var b,c,d,e;try{for(var f=h(a),g=f.next();!g.done;g=f.next()){var i=g.value,j=i.query,k=this.queries.get(j);if(k){try{for(var l=(d=void 0,h(k.listeners)),m=l.next();!m.done;m=l.next())m.value.onViewSnapshot(i)}catch(a){d={error:a}}finally{try{m&&!m.done&&(e=l.return)&&e.call(l)}finally{if(d)throw d.error}}k.viewSnap=i}}}catch(a){b={error:a}}finally{try{g&&!g.done&&(c=f.return)&&c.call(f)}finally{if(b)throw b.error}}},a.prototype.onWatchError=function(a,b){var c,d,e=this.queries.get(a);if(e)try{for(var f=h(e.listeners),g=f.next();!g.done;g=f.next())g.value.onError(b)}catch(a){c={error:a}}finally{try{g&&!g.done&&(d=f.return)&&d.call(f)}finally{if(c)throw c.error}}this.queries.delete(a)},a.prototype.onOnlineStateChange=function(a){this.onlineState=a,this.queries.forEach(function(b,c){var d,e;try{for(var f=h(c.listeners),g=f.next();!g.done;g=f.next())g.value.applyOnlineStateChange(a)}catch(b){d={error:b}}finally{try{g&&!g.done&&(e=f.return)&&e.call(f)}finally{if(d)throw d.error}}})},a}(),Xj=function(){function a(a,b,c){this.query=a,this.queryObserver=b,this.raisedInitialEvent=!1,this.onlineState=Mi.Unknown,this.options=c||{}}return a.prototype.onViewSnapshot=function(a){var b,c;if(Le(0<a.docChanges.length||a.syncStateChanged,"We got a new snapshot with no changes?"),!this.options.includeMetadataChanges){var d=[];try{for(var e=h(a.docChanges),f=e.next();!f.done;f=e.next()){var g=f.value;g.type!==$i.Metadata&&d.push(g)}}catch(a){b={error:a}}finally{try{f&&!f.done&&(c=e.return)&&c.call(e)}finally{if(b)throw b.error}}a=new gj(a.query,a.docs,a.oldDocs,d,a.mutatedKeys,a.fromCache,a.syncStateChanged,!0)}this.raisedInitialEvent?this.shouldRaiseEvent(a)&&this.queryObserver.next(a):this.shouldRaiseInitialEvent(a,this.onlineState)&&this.raiseInitialEvent(a),this.snap=a},a.prototype.onError=function(a){this.queryObserver.error(a)},a.prototype.applyOnlineStateChange=function(a){this.onlineState=a,this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,a)&&this.raiseInitialEvent(this.snap)},a.prototype.shouldRaiseInitialEvent=function(a,b){if(Le(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event"),!a.fromCache)return!0;var c=b!==Mi.Offline;return this.options.waitForSyncWhenOnline&&c?(Le(a.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!a.docs.isEmpty()||b===Mi.Offline},a.prototype.shouldRaiseEvent=function(a){if(0<a.docChanges.length)return!0;var b=this.snap&&this.snap.hasPendingWrites!==a.hasPendingWrites;return(!!a.syncStateChanged||!!b)&&!0===this.options.includeMetadataChanges},a.prototype.raiseInitialEvent=function(a){Le(!this.raisedInitialEvent,"Trying to raise initial events for second time"),a=gj.fromInitialDocuments(a.query,a.docs,a.mutatedKeys,a.fromCache),this.raisedInitialEvent=!0,this.queryObserver.next(a)},a}(),Yj=function(){function a(a,b,c){this.targetId=a,this.addedKeys=b,this.removedKeys=c}return a.fromSnapshot=function(b,c){var d,e,f=gg(),g=gg();try{for(var i=h(c.docChanges),j=i.next();!j.done;j=i.next()){var k=j.value;switch(k.type){case $i.Added:f=f.add(k.doc.key);break;case $i.Removed:g=g.add(k.doc.key)}}}catch(b){d={error:b}}finally{try{j&&!j.done&&(e=i.return)&&e.call(i)}finally{if(d)throw d.error}}return new a(b,f,g)},a}(),Zj=function(a){this.key=a},$j=function(a){this.key=a},_j=function(){function a(a,b){this.query=a,this._syncedDocuments=b,this.syncState=null,this.current=!1,this.limboDocuments=gg(),this.mutatedKeys=gg(),this.documentSet=new cj(a.docComparator.bind(a))}return Object.defineProperty(a.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0}),a.prototype.computeDocChanges=function(a,b){var c=this,d=b?b.changeSet:new fj,e=b?b.documentSet:this.documentSet,f=b?b.mutatedKeys:this.mutatedKeys,g=e,h=!1,i=this.query.hasLimit()&&e.size===this.query.limit?e.last():null;if(a.inorderTraversal(function(a,b){var j=e.get(a),k=b instanceof Kg?b:null;k&&(Le(a.isEqual(k.key),"Mismatching keys found in document changes: "+a+" != "+k.key),k=c.query.matches(k)?k:null);var l=!!j&&c.mutatedKeys.has(j.key),m=!!k&&(k.hasLocalMutations||c.mutatedKeys.has(k.key)&&k.hasCommittedMutations),n=!1;j&&k?j.data.isEqual(k.data)?l!==m&&(d.track({type:$i.Metadata,doc:k}),n=!0):c.shouldWaitForSyncedDocument(j,k)||(d.track({type:$i.Modified,doc:k}),n=!0,i&&0<c.query.docComparator(k,i)&&(h=!0)):!j&&k?(d.track({type:$i.Added,doc:k}),n=!0):j&&!k&&(d.track({type:$i.Removed,doc:j}),n=!0,i&&(h=!0)),n&&(f=k?(g=g.add(k),m?f.add(a):f.delete(a)):(g=g.delete(a),f.delete(a)))}),this.query.hasLimit())for(;g.size>this.query.limit;){var j=g.last();g=g.delete(j.key),f=f.delete(j.key),d.track({type:$i.Removed,doc:j})}return Le(!h||!b,"View was refilled using docs that themselves needed refilling."),{documentSet:g,changeSet:d,needsRefill:h,mutatedKeys:f}},a.prototype.shouldWaitForSyncedDocument=function(a,b){return a.hasLocalMutations&&b.hasCommittedMutations&&!b.hasLocalMutations},a.prototype.applyChanges=function(a,b,c){var d=this;Le(!a.needsRefill,"Cannot apply changes that need a refill");var e=this.documentSet;this.documentSet=a.documentSet,this.mutatedKeys=a.mutatedKeys;var f=a.changeSet.getChanges();f.sort(function(a,b){return c=a.type,e=b.type,(f=function(a){switch(a){case $i.Added:return 1;case $i.Modified:case $i.Metadata:return 2;case $i.Removed:return 0;default:return Ke("Unknown ChangeType: "+a)}})(c)-f(e)||d.query.docComparator(a.doc,b.doc);var c,e,f}),this.applyTargetChange(c);var g=b?this.updateLimboDocuments():[],h=0===this.limboDocuments.size&&this.current?aj.Synced:aj.Local,i=h!==this.syncState;return this.syncState=h,0!==f.length||i?{snapshot:new gj(this.query,a.documentSet,e,f,a.mutatedKeys,h===aj.Local,i,!1),limboChanges:g}:{limboChanges:g}},a.prototype.applyOnlineStateChange=function(a){return this.current&&a===Mi.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new fj,mutatedKeys:this.mutatedKeys,needsRefill:!1},!1)):{limboChanges:[]}},a.prototype.shouldBeInLimbo=function(a){return!this._syncedDocuments.has(a)&&!!this.documentSet.has(a)&&!this.documentSet.get(a).hasLocalMutations},a.prototype.applyTargetChange=function(a){var b=this;a&&(a.addedDocuments.forEach(function(a){return b._syncedDocuments=b._syncedDocuments.add(a)}),a.modifiedDocuments.forEach(function(a){return Le(b._syncedDocuments.has(a),"Modified document "+a+" not found in view.")}),a.removedDocuments.forEach(function(a){return b._syncedDocuments=b._syncedDocuments.delete(a)}),this.current=a.current)},a.prototype.updateLimboDocuments=function(){var a=this;if(!this.current)return[];var b=this.limboDocuments;this.limboDocuments=gg(),this.documentSet.forEach(function(b){a.shouldBeInLimbo(b.key)&&(a.limboDocuments=a.limboDocuments.add(b.key))});var c=[];return b.forEach(function(b){a.limboDocuments.has(b)||c.push(new $j(b))}),this.limboDocuments.forEach(function(a){b.has(a)||c.push(new Zj(a))}),c},a.prototype.synchronizeWithPersistedState=function(a,b){this._syncedDocuments=b,this.limboDocuments=gg();var c=this.computeDocChanges(a);return this.applyChanges(c,!0)},a.prototype.computeInitialSnapshot=function(){return gj.fromInitialDocuments(this.query,this.documentSet,this.mutatedKeys,this.syncState===aj.Local)},a}(),ak="SyncEngine",bk=function(a,b,c){this.query=a,this.targetId=b,this.view=c},ck=function(a){this.key=a},dk=function(){function a(a,b,c,d){this.localStore=a,this.remoteStore=b,this.sharedClientState=c,this.currentUser=d,this.syncEngineListener=null,this.queryViewsByQuery=new Ng(function(a){return a.canonicalId()}),this.queryViewsByTarget={},this.limboTargetsByKey=new Uf(Gf.comparator),this.limboResolutionsByTarget={},this.limboDocumentRefs=new ri,this.mutationUserCallbacks={},this.limboTargetIdGenerator=vg.forSyncEngine(),this.isPrimary=void 0,this.onlineState=Mi.Unknown}return Object.defineProperty(a.prototype,"isPrimaryClient",{get:function(){return!0===this.isPrimary},enumerable:!0,configurable:!0}),a.prototype.subscribe=function(a){Le(null!==a,"SyncEngine listener cannot be null"),Le(null===this.syncEngineListener,"SyncEngine already has a subscriber."),this.syncEngineListener=a},a.prototype.listen=function(a){return f(this,void 0,void 0,function(){var b,c,d,e,f;return g(this,function(g){switch(g.label){case 0:return this.assertSubscribed("listen()"),(d=this.queryViewsByQuery.get(a))?(b=d.targetId,this.sharedClientState.addLocalQueryTarget(b),c=d.view.computeInitialSnapshot(),[3,4]):[3,1];case 1:return[4,this.localStore.allocateQuery(a)];case 2:return e=g.sent(),f=this.sharedClientState.addLocalQueryTarget(e.targetId),b=e.targetId,[4,this.initializeViewAndComputeSnapshot(e,"current"===f)];case 3:c=g.sent(),this.isPrimary&&this.remoteStore.listen(e),g.label=4;case 4:return this.syncEngineListener.onWatchChange([c]),[2,b]}})})},a.prototype.initializeViewAndComputeSnapshot=function(a,b){var c=this,d=a.query;return this.localStore.executeQuery(d).then(function(e){return c.localStore.remoteDocumentKeys(a.targetId).then(function(f){var g=new _j(d,f),h=g.computeDocChanges(e),i=ij.createSynthesizedTargetChangeForCurrentChange(a.targetId,b&&c.onlineState!==Mi.Offline),j=g.applyChanges(h,!0===c.isPrimary,i);Le(0===j.limboChanges.length,"View returned limbo docs before target ack from the server."),Le(!!j.snapshot,"applyChanges for new view should always return a snapshot");var k=new bk(d,a.targetId,g);return c.queryViewsByQuery.set(d,k),c.queryViewsByTarget[a.targetId]=k,j.snapshot})})},a.prototype.synchronizeViewAndComputeSnapshot=function(a){var b=this;return this.localStore.executeQuery(a.query).then(function(c){return b.localStore.remoteDocumentKeys(a.targetId).then(function(d){return f(b,void 0,void 0,function(){var b;return g(this,function(e){return b=a.view.synchronizeWithPersistedState(c,d),this.isPrimary&&this.updateTrackedLimbos(a.targetId,b.limboChanges),[2,b]})})})})},a.prototype.unlisten=function(a){return f(this,void 0,void 0,function(){var b,c=this;return g(this,function(d){switch(d.label){case 0:return this.assertSubscribed("unlisten()"),Le(!!(b=this.queryViewsByQuery.get(a)),"Trying to unlisten on query not found:"+a),this.isPrimary?(this.sharedClientState.removeLocalQueryTarget(b.targetId),this.sharedClientState.isActiveQueryTarget(b.targetId)?[3,2]:[4,this.localStore.releaseQuery(a,!1).then(function(){c.sharedClientState.clearQueryState(b.targetId),c.remoteStore.unlisten(b.targetId),c.removeAndCleanupQuery(b)}).catch(Hh)]):[3,3];case 1:d.sent(),d.label=2;case 2:return[3,5];case 3:return this.removeAndCleanupQuery(b),[4,this.localStore.releaseQuery(a,!0)];case 4:d.sent(),d.label=5;case 5:return[2]}})})},a.prototype.write=function(a,b){var c=this;return this.assertSubscribed("write()"),this.localStore.localWrite(a).then(function(a){return c.sharedClientState.addPendingMutation(a.batchId),c.addMutationCallback(a.batchId,b),c.emitNewSnapsAndNotifyLocalStore(a.changes)}).then(function(){return c.remoteStore.fillWritePipeline()})},a.prototype.wrapUpdateFunctionError=function(a){return a},a.prototype.runTransaction=function(a,b){var c=this;void 0===b&&(b=5),Le(0<=b,"Got negative number of retries for transaction.");var d=this.remoteStore.createTransaction();return function(){try{var b=a(d);return!Gi(b)&&b.catch&&b.then?b.catch(function(a){return Promise.reject(c.wrapUpdateFunctionError(a))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(b){return Promise.reject(c.wrapUpdateFunctionError(b))}}().then(function(e){return d.commit().then(function(){return e}).catch(function(d){return 0===b?Promise.reject(d):c.runTransaction(a,b-1)})})},a.prototype.applyRemoteEvent=function(a){var b=this;return this.assertSubscribed("applyRemoteEvent()"),this.localStore.applyRemoteEvent(a).then(function(c){return Ue(a.targetChanges,function(a,c){var d=b.limboResolutionsByTarget[Number(a)];d&&(Le(c.addedDocuments.size+c.modifiedDocuments.size+c.removedDocuments.size<=1,"Limbo resolution for single document contains multiple changes."),0<c.addedDocuments.size?d.receivedDocument=!0:0<c.modifiedDocuments.size?Le(d.receivedDocument,"Received change for limbo target document without add."):0<c.removedDocuments.size&&(Le(d.receivedDocument,"Received remove for limbo target document without add."),d.receivedDocument=!1))}),b.emitNewSnapsAndNotifyLocalStore(c,a)}).catch(Hh)},a.prototype.applyOnlineStateChange=function(a,b){if(this.isPrimary&&b===Oi.RemoteStore||!this.isPrimary&&b===Oi.SharedClientState){var c=[];this.queryViewsByQuery.forEach(function(b,d){var e=d.view.applyOnlineStateChange(a);Le(0===e.limboChanges.length,"OnlineState should not affect limbo documents."),e.snapshot&&c.push(e.snapshot)}),this.syncEngineListener.onOnlineStateChange(a),this.syncEngineListener.onWatchChange(c),this.onlineState=a,this.isPrimary&&this.sharedClientState.setOnlineState(a)}},a.prototype.rejectListen=function(a,b){return f(this,void 0,void 0,function(){var c,d,e,f,h,i,j=this;return g(this,function(g){switch(g.label){case 0:return this.assertSubscribed("rejectListens()"),this.sharedClientState.updateQueryState(a,"rejected",b),c=this.limboResolutionsByTarget[a],(d=c&&c.key)?(this.limboTargetsByKey=this.limboTargetsByKey.remove(d),delete this.limboResolutionsByTarget[a],e=(e=new Uf(Gf.comparator)).insert(d,new Lg(d,Tf.forDeletedDoc())),f=gg().add(d),h=new hj(Tf.MIN,{},new Yf(of),e,f),[2,this.applyRemoteEvent(h)]):[3,1];case 1:return Le(!!(i=this.queryViewsByTarget[a]),"Unknown targetId: "+a),[4,this.localStore.releaseQuery(i.query,!1).then(function(){return j.removeAndCleanupQuery(i)}).catch(Hh)];case 2:g.sent(),this.syncEngineListener.onWatchError(i.query,b),g.label=3;case 3:return[2]}})})},a.prototype.applyBatchState=function(a,b,c){return f(this,void 0,void 0,function(){var d;return g(this,function(e){switch(e.label){case 0:return this.assertSubscribed("applyBatchState()"),[4,this.localStore.lookupMutationDocuments(a)];case 1:return null===(d=e.sent())?(He(ak,"Cannot apply mutation batch with id: "+a),[2]):"pending"!==b?[3,3]:[4,this.remoteStore.fillWritePipeline()];case 2:return e.sent(),[3,4];case 3:"acknowledged"===b||"rejected"===b?(this.processUserCallback(a,c||null),this.localStore.removeCachedMutationBatchMetadata(a)):Ke("Unknown batchState: "+b),e.label=4;case 4:return[4,this.emitNewSnapsAndNotifyLocalStore(d)];case 5:return e.sent(),[2]}})})},a.prototype.applySuccessfulWrite=function(a){var b=this;this.assertSubscribed("applySuccessfulWrite()");var c=a.batch.batchId;return this.processUserCallback(c,null),this.localStore.acknowledgeBatch(a).then(function(a){return b.sharedClientState.updateMutationState(c,"acknowledged"),b.emitNewSnapsAndNotifyLocalStore(a)}).catch(Hh)},a.prototype.rejectFailedWrite=function(a,b){var c=this;return this.assertSubscribed("rejectFailedWrite()"),this.processUserCallback(a,b),this.localStore.rejectBatch(a).then(function(d){return c.sharedClientState.updateMutationState(a,"rejected",b),c.emitNewSnapsAndNotifyLocalStore(d)}).catch(Hh)},a.prototype.addMutationCallback=function(a,b){var c=this.mutationUserCallbacks[this.currentUser.toKey()];c||(c=new Uf(of)),c=c.insert(a,b),this.mutationUserCallbacks[this.currentUser.toKey()]=c},a.prototype.processUserCallback=function(a,b){var c=this.mutationUserCallbacks[this.currentUser.toKey()];if(c){var d=c.get(a);d&&(Le(a===c.minKey(),"Mutation callbacks processed out-of-order?"),b?d.reject(b):d.resolve(),c=c.remove(a)),this.mutationUserCallbacks[this.currentUser.toKey()]=c}},a.prototype.removeAndCleanupQuery=function(a){var b=this;if(this.sharedClientState.removeLocalQueryTarget(a.targetId),this.queryViewsByQuery.delete(a.query),delete this.queryViewsByTarget[a.targetId],this.isPrimary){var c=this.limboDocumentRefs.referencesForId(a.targetId);this.limboDocumentRefs.removeReferencesForId(a.targetId),c.forEach(function(a){b.limboDocumentRefs.containsKey(a)||b.removeLimboTarget(a)})}},a.prototype.removeLimboTarget=function(a){var b=this.limboTargetsByKey.get(a);null!==b&&(this.remoteStore.unlisten(b),this.limboTargetsByKey=this.limboTargetsByKey.remove(a),delete this.limboResolutionsByTarget[b])},a.prototype.updateTrackedLimbos=function(a,b){var c,d;try{for(var e=h(b),f=e.next();!f.done;f=e.next()){var g=f.value;g instanceof Zj?(this.limboDocumentRefs.addReference(g.key,a),this.trackLimboChange(g)):g instanceof $j?(He(ak,"Document no longer in limbo: "+g.key),this.limboDocumentRefs.removeReference(g.key,a),this.limboDocumentRefs.containsKey(g.key)||this.removeLimboTarget(g.key)):Ke("Unknown limbo change: "+JSON.stringify(g))}}catch(a){c={error:a}}finally{try{f&&!f.done&&(d=e.return)&&d.call(e)}finally{if(c)throw c.error}}},a.prototype.trackLimboChange=function(a){var b=a.key;if(!this.limboTargetsByKey.get(b)){He(ak,"New document in limbo: "+b);var c=this.limboTargetIdGenerator.next(),d=tj.atPath(b.path);this.limboResolutionsByTarget[c]=new ck(b),this.remoteStore.listen(new uh(d,c,ph.LimboResolution,Af.INVALID)),this.limboTargetsByKey=this.limboTargetsByKey.insert(b,c)}},a.prototype.currentLimboDocs=function(){return this.limboTargetsByKey},a.prototype.emitNewSnapsAndNotifyLocalStore=function(a,b){return f(this,void 0,void 0,function(){var c,d,e,f=this;return g(this,function(g){switch(g.label){case 0:return c=[],d=[],e=[],this.queryViewsByQuery.forEach(function(g,h){e.push(Promise.resolve().then(function(){var b=h.view.computeDocChanges(a);return b.needsRefill?f.localStore.executeQuery(h.query).then(function(a){return h.view.computeDocChanges(a,b)}):b}).then(function(a){var e=b&&b.targetChanges[h.targetId],g=h.view.applyChanges(a,!0===f.isPrimary,e);if(f.updateTrackedLimbos(h.targetId,g.limboChanges),g.snapshot){f.isPrimary&&f.sharedClientState.updateQueryState(h.targetId,g.snapshot.fromCache?"not-current":"current"),c.push(g.snapshot);var i=Yj.fromSnapshot(h.targetId,g.snapshot);d.push(i)}}))}),[4,Promise.all(e)];case 1:return g.sent(),this.syncEngineListener.onWatchChange(c),[4,this.localStore.notifyLocalViewChanges(d)];case 2:return g.sent(),[2]}})})},a.prototype.assertSubscribed=function(a){Le(null!==this.syncEngineListener,"Trying to call "+a+" before calling subscribe().")},a.prototype.handleCredentialChange=function(a){return f(this,void 0,void 0,function(){var b,c;return g(this,function(d){switch(d.label){case 0:return b=!this.currentUser.isEqual(a),this.currentUser=a,b?[4,this.localStore.handleUserChange(a)]:[3,3];case 1:return c=d.sent(),this.sharedClientState.handleUserChange(a,c.removedBatchIds,c.addedBatchIds),[4,this.emitNewSnapsAndNotifyLocalStore(c.affectedDocuments)];case 2:d.sent(),d.label=3;case 3:return[4,this.remoteStore.handleCredentialChange()];case 4:return d.sent(),[2]}})})},a.prototype.applyPrimaryState=function(a){return f(this,void 0,void 0,function(){var b,c,d,e,f,i,j,k,l,m=this;return g(this,function(g){switch(g.label){case 0:return!0!==a||!0===this.isPrimary?[3,3]:(this.isPrimary=!0,[4,this.remoteStore.applyPrimaryState(!0)]);case 1:return g.sent(),b=this.sharedClientState.getAllActiveQueryTargets(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(b.toArray())];case 2:c=g.sent();try{for(d=h(c),e=d.next();!e.done;e=d.next())f=e.value,this.remoteStore.listen(f)}catch(g){k={error:g}}finally{try{e&&!e.done&&(l=d.return)&&l.call(d)}finally{if(k)throw k.error}}return[3,7];case 3:return!1!==a||!1===this.isPrimary?[3,7]:(this.isPrimary=!1,i=[],j=Promise.resolve(),Te(this.queryViewsByTarget,function(a,b){m.sharedClientState.isLocalQueryTarget(a)?i.push(a):j=j.then(function(){return m.unlisten(b.query)}),m.remoteStore.unlisten(b.targetId)}),[4,j]);case 4:return g.sent(),[4,this.synchronizeQueryViewsAndRaiseSnapshots(i)];case 5:return g.sent(),this.resetLimboDocuments(),[4,this.remoteStore.applyPrimaryState(!1)];case 6:g.sent(),g.label=7;case 7:return[2]}})})},a.prototype.resetLimboDocuments=function(){var a=this;Te(this.limboResolutionsByTarget,function(b){a.remoteStore.unlisten(b)}),this.limboDocumentRefs.removeAllReferences(),this.limboResolutionsByTarget=[],this.limboTargetsByKey=new Uf(Gf.comparator)},a.prototype.synchronizeQueryViewsAndRaiseSnapshots=function(a){var b,c,d=this,e=Promise.resolve(),i=[],j=[],k=function(a){e=e.then(function(){return f(d,void 0,void 0,function(){var b,c,d,e;return g(this,function(f){switch(f.label){case 0:return(c=this.queryViewsByTarget[a])?[4,this.localStore.releaseQuery(c.query,!0)]:[3,4];case 1:return f.sent(),[4,this.localStore.allocateQuery(c.query)];case 2:return b=f.sent(),[4,this.synchronizeViewAndComputeSnapshot(c)];case 3:return(d=f.sent()).snapshot&&j.push(d.snapshot),[3,8];case 4:return Le(!0===this.isPrimary,"A secondary tab should never have an active query without an active view."),[4,this.localStore.getQueryForTarget(a)];case 5:return Le(!!(e=f.sent()),"Query data for target "+a+" not found"),[4,this.localStore.allocateQuery(e)];case 6:return b=f.sent(),[4,this.initializeViewAndComputeSnapshot(b,!1)];case 7:f.sent(),f.label=8;case 8:return i.push(b),[2]}})})})};try{for(var l=h(a),m=l.next();!m.done;m=l.next())k(m.value)}catch(a){b={error:a}}finally{try{m&&!m.done&&(c=l.return)&&c.call(l)}finally{if(b)throw b.error}}return e.then(function(){return d.syncEngineListener.onWatchChange(j),i})},a.prototype.getActiveClients=function(){return this.localStore.getActiveClients()},a.prototype.applyTargetState=function(a,b,c){return f(this,void 0,void 0,function(){var d,e=this;return g(this,function(h){switch(h.label){case 0:if(this.isPrimary)return He(ak,"Ignoring unexpected query state notification."),[2];if(!this.queryViewsByTarget[a])return[3,5];switch(b){case"current":case"not-current":return[3,1];case"rejected":return[3,2]}return[3,4];case 1:return[2,this.localStore.getNewDocumentChanges().then(function(c){return f(e,void 0,void 0,function(){var d;return g(this,function(e){switch(e.label){case 0:return d=hj.createSynthesizedRemoteEventForCurrentChange(a,"current"===b),[4,this.emitNewSnapsAndNotifyLocalStore(c,d)];case 1:return e.sent(),[2]}})})},function(a){return f(e,void 0,void 0,function(){var b;return g(this,function(c){switch(c.label){case 0:return(d=a).code!==Oe.DATA_LOSS||d.message!==Pg?[3,2]:(b=[],Te(this.queryViewsByTarget,function(a){return b.push(a)}),[4,this.synchronizeQueryViewsAndRaiseSnapshots(b)]);case 1:return c.sent(),[3,3];case 2:throw a;case 3:return[2]}var d})})})];case 2:return d=this.queryViewsByTarget[a],this.removeAndCleanupQuery(d),[4,this.localStore.releaseQuery(d.query,!0)];case 3:return h.sent(),this.syncEngineListener.onWatchError(d.query,c),[3,5];case 4:Ke("Unexpected target state: "+b),h.label=5;case 5:return[2]}})})},a.prototype.applyActiveTargetsChange=function(a,b){return f(this,void 0,void 0,function(){var c,d,e,f,i,j,k,l,m,n,o,p,q,r,s,t=this;return g(this,function(u){switch(u.label){case 0:if(!this.isPrimary)return[2];u.label=1;case 1:u.trys.push([1,8,9,10]),c=h(a),d=c.next(),u.label=2;case 2:return d.done?[3,7]:(n=d.value,Le(!this.queryViewsByTarget[n],"Trying to add an already active target"),[4,this.localStore.getQueryForTarget(n)]);case 3:return Le(!!(e=u.sent()),"Query data for active target "+n+" not found"),[4,this.localStore.allocateQuery(e)];case 4:return f=u.sent(),[4,this.initializeViewAndComputeSnapshot(f,!1)];case 5:u.sent(),this.remoteStore.listen(f),u.label=6;case 6:return d=c.next(),[3,2];case 7:return[3,10];case 8:return i=u.sent(),p={error:i},[3,10];case 9:try{d&&!d.done&&(q=c.return)&&q.call(c)}finally{if(p)throw p.error}return[7];case 10:j=function(a){var b;return g(this,function(c){switch(c.label){case 0:return(b=k.queryViewsByTarget[a])?[4,k.localStore.releaseQuery(b.query,!1).then(function(){t.remoteStore.unlisten(a),t.removeAndCleanupQuery(b)}).catch(Hh)]:[3,2];case 1:c.sent(),c.label=2;case 2:return[2]}})},k=this,u.label=11;case 11:u.trys.push([11,16,17,18]),l=h(b),m=l.next(),u.label=12;case 12:return m.done?[3,15]:(n=m.value,[5,j(n)]);case 13:u.sent(),u.label=14;case 14:return m=l.next(),[3,12];case 15:return[3,18];case 16:return o=u.sent(),r={error:o},[3,18];case 17:try{m&&!m.done&&(s=l.return)&&s.call(l)}finally{if(r)throw r.error}return[7];case 18:return[2]}})})},a.prototype.enableNetwork=function(){return this.localStore.setNetworkEnabled(!0),this.remoteStore.enableNetwork()},a.prototype.disableNetwork=function(){return this.localStore.setNetworkEnabled(!1),this.remoteStore.disableNetwork()},a.prototype.getRemoteKeysForTarget=function(a){var b=this.limboResolutionsByTarget[a];return b&&b.receivedDocument?gg().add(b.key):this.queryViewsByTarget[a]?this.queryViewsByTarget[a].view.syncedDocuments:gg()},a}(),ek=function(){function a(a){this.uid=a}return a.prototype.isAuthenticated=function(){return null!=this.uid},a.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"
},a.prototype.isEqual=function(a){return a.uid===this.uid},a.UNAUTHENTICATED=new a(null),a.GOOGLE_CREDENTIALS=new a("google-credentials-uid"),a.FIRST_PARTY=new a("first-party-uid"),a}(),fk="SharedClientState",gk="firestore_clients",hk="firestore_mutations",ik="firestore_targets",jk=function(){function a(a,b,c,d){this.user=a,this.batchId=b,this.state=c,Le(void 0!==(this.error=d)==("rejected"===c),"MutationMetadata must contain an error iff state is 'rejected'")}return a.fromWebStorageEntry=function(b,c,d){var e=JSON.parse(d),f="object"==typeof e&&-1!==["pending","acknowledged","rejected"].indexOf(e.state)&&(void 0===e.error||"object"==typeof e.error),g=void 0;return f&&e.error&&(f="string"==typeof e.error.message&&"string"==typeof e.error.code)&&(g=new Pe(e.error.code,e.error.message)),f?new a(b,c,e.state,g):(Ie(fk,"Failed to parse mutation state for ID '"+c+"': "+d),null)},a.prototype.toWebStorageJSON=function(){var a={state:this.state,updateTimeMs:Date.now()};return this.error&&(a.error={code:this.error.code,message:this.error.message}),JSON.stringify(a)},a}(),kk=function(){function a(a,b,c){this.targetId=a,this.state=b,Le(void 0!==(this.error=c)==("rejected"===b),"QueryTargetMetadata must contain an error iff state is 'rejected'")}return a.fromWebStorageEntry=function(b,c){var d=JSON.parse(c),e="object"==typeof d&&-1!==["not-current","current","rejected"].indexOf(d.state)&&(void 0===d.error||"object"==typeof d.error),f=void 0;return e&&d.error&&(e="string"==typeof d.error.message&&"string"==typeof d.error.code)&&(f=new Pe(d.error.code,d.error.message)),e?new a(b,d.state,f):(Ie(fk,"Failed to parse target state for ID '"+b+"': "+c),null)},a.prototype.toWebStorageJSON=function(){var a={state:this.state,updateTimeMs:Date.now()};return this.error&&(a.error={code:this.error.code,message:this.error.message}),JSON.stringify(a)},a}(),lk=function(){function a(a,b){this.clientId=a,this.activeTargetIds=b}return a.fromWebStorageEntry=function(b,c){for(var d=JSON.parse(c),e="object"==typeof d&&d.activeTargetIds instanceof Array,f=ig(),g=0;e&&g<d.activeTargetIds.length;++g)e=Hi(d.activeTargetIds[g]),f=f.add(d.activeTargetIds[g]);return e?new a(b,f):(Ie(fk,"Failed to parse client data for instance '"+b+"': "+c),null)},a}(),mk=function(){function a(a,b){this.clientId=a,this.onlineState=b}return a.fromWebStorageEntry=function(b){var c=JSON.parse(b);return"object"==typeof c&&c.onlineState in Mi&&"string"==typeof c.clientId?new a(c.clientId,Mi[c.onlineState]):(Ie(fk,"Failed to parse online state: "+b),null)},a}(),nk=function(){function a(){this.activeTargetIds=ig()}return a.prototype.addQueryTarget=function(a){Le(!this.activeTargetIds.has(a),"Target with ID '"+a+"' already active."),this.activeTargetIds=this.activeTargetIds.add(a)},a.prototype.removeQueryTarget=function(a){this.activeTargetIds=this.activeTargetIds.delete(a)},a.prototype.toWebStorageJSON=function(){var a={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(a)},a}(),ok=function(){function a(b,c,d,e,f){if(this.queue=b,this.platform=c,this.persistenceKey=d,this.localClientId=e,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.activeClients={},this.storageListener=this.handleWebStorageEvent.bind(this),this.started=!1,this.earlyEvents=[],!a.isAvailable(this.platform))throw new Pe(Oe.UNIMPLEMENTED,"LocalStorage is not available on this platform.");var g=d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.platform.window.localStorage,this.currentUser=f,this.localClientStorageKey=this.toWebStorageClientStateKey(this.localClientId),this.sequenceNumberKey="firestore_sequence_number_"+d,this.activeClients[this.localClientId]=new nk,this.clientStateKeyRe=new RegExp("^"+gk+"_"+g+"_([^_]*)$"),this.mutationBatchKeyRe=new RegExp("^"+hk+"_"+g+"_(\\d+)(?:_(.*))?$"),this.queryTargetKeyRe=new RegExp("^"+ik+"_"+g+"_(\\d+)$"),this.onlineStateKey="firestore_online_state_"+d,this.platform.window.addEventListener("storage",this.storageListener)}return a.isAvailable=function(a){return!!a.window&&null!=a.window.localStorage},a.prototype.start=function(){return f(this,void 0,void 0,function(){var a,b,c,d,e,f,i,j,k,l,m,n,o,p,q,r=this;return g(this,function(g){switch(g.label){case 0:return Le(!this.started,"WebStorageSharedClientState already started"),Le(null!==this.syncEngine,"syncEngine property must be set before calling start()"),Le(null!==this.onlineStateHandler,"onlineStateHandler property must be set before calling start()"),[4,this.syncEngine.getActiveClients()];case 1:a=g.sent();try{for(b=h(a),c=b.next();!c.done;c=b.next())(d=c.value)!==this.localClientId&&(e=this.getItem(this.toWebStorageClientStateKey(d)))&&(f=lk.fromWebStorageEntry(d,e))&&(this.activeClients[f.clientId]=f)}catch(g){n={error:g}}finally{try{c&&!c.done&&(o=b.return)&&o.call(b)}finally{if(n)throw n.error}}this.persistClientState(),(i=this.storage.getItem(this.onlineStateKey))&&(j=this.fromWebStorageOnlineState(i))&&this.handleOnlineStateEvent(j);try{for(k=h(this.earlyEvents),l=k.next();!l.done;l=k.next())m=l.value,this.handleWebStorageEvent(m)}catch(g){p={error:g}}finally{try{l&&!l.done&&(q=k.return)&&q.call(k)}finally{if(p)throw p.error}}return this.earlyEvents=[],this.platform.window.addEventListener("unload",function(){return r.shutdown()}),this.started=!0,[2]}})})},a.prototype.writeSequenceNumber=function(a){this.setItem(this.sequenceNumberKey,JSON.stringify(a))},a.prototype.getAllActiveQueryTargets=function(){var a=ig();return Ue(this.activeClients,function(b,c){a=a.unionWith(c.activeTargetIds)}),a},a.prototype.isActiveQueryTarget=function(a){for(var b in this.activeClients)if(this.activeClients.hasOwnProperty(b)&&this.activeClients[b].activeTargetIds.has(a))return!0;return!1},a.prototype.addPendingMutation=function(a){this.persistMutationState(a,"pending")},a.prototype.updateMutationState=function(a,b,c){this.persistMutationState(a,b,c),this.removeMutationState(a)},a.prototype.addLocalQueryTarget=function(a){var b="not-current";if(this.isActiveQueryTarget(a)){var c=this.storage.getItem(this.toWebStorageQueryTargetMetadataKey(a));if(c){var d=kk.fromWebStorageEntry(a,c);d&&(b=d.state)}}return this.localClientState.addQueryTarget(a),this.persistClientState(),b},a.prototype.removeLocalQueryTarget=function(a){this.localClientState.removeQueryTarget(a),this.persistClientState()},a.prototype.isLocalQueryTarget=function(a){return this.localClientState.activeTargetIds.has(a)},a.prototype.clearQueryState=function(a){this.removeItem(this.toWebStorageQueryTargetMetadataKey(a))},a.prototype.updateQueryState=function(a,b,c){this.persistQueryTargetState(a,b,c)},a.prototype.handleUserChange=function(a,b,c){var d=this;b.forEach(function(a){d.removeMutationState(a)}),this.currentUser=a,c.forEach(function(a){d.addPendingMutation(a)})},a.prototype.setOnlineState=function(a){this.persistOnlineState(a)},a.prototype.shutdown=function(){this.started&&(this.platform.window.removeEventListener("storage",this.storageListener),this.removeItem(this.localClientStorageKey),this.started=!1)},a.prototype.getItem=function(a){var b=this.storage.getItem(a);return He(fk,"READ",a,b),b},a.prototype.setItem=function(a,b){He(fk,"SET",a,b),this.storage.setItem(a,b)},a.prototype.removeItem=function(a){He(fk,"REMOVE",a),this.storage.removeItem(a)},a.prototype.handleWebStorageEvent=function(a){var b=this;if(a.storageArea===this.storage){if(He(fk,"EVENT",a.key,a.newValue),a.key===this.localClientStorageKey)return void Ie("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.queue.enqueueAndForget(function(){return f(b,void 0,void 0,function(){var b,c,d,e,f,h;return g(this,function(g){if(!this.started)return this.earlyEvents.push(a),[2];if(null===a.key)return[2];if(this.clientStateKeyRe.test(a.key)){if(null==a.newValue)return c=this.fromWebStorageClientStateKey(a.key),[2,this.handleClientStateEvent(c,null)];if(b=this.fromWebStorageClientState(a.key,a.newValue))return[2,this.handleClientStateEvent(b.clientId,b)]}else if(this.mutationBatchKeyRe.test(a.key)){if(null!==a.newValue&&(d=this.fromWebStorageMutationMetadata(a.key,a.newValue)))return[2,this.handleMutationBatchEvent(d)]}else if(this.queryTargetKeyRe.test(a.key)){if(null!==a.newValue&&(e=this.fromWebStorageQueryTargetMetadata(a.key,a.newValue)))return[2,this.handleQueryTargetEvent(e)]}else if(a.key===this.onlineStateKey){if(null!==a.newValue&&(f=this.fromWebStorageOnlineState(a.newValue)))return[2,this.handleOnlineStateEvent(f)]}else a.key===this.sequenceNumberKey&&(Le(!!this.sequenceNumberHandler,"Missing sequenceNumberHandler"),(h=function(a){var b=Af.INVALID;if(null!=a)try{var c=JSON.parse(a);Le("number"==typeof c,"Found non-numeric sequence number"),b=c}catch(a){Ie(fk,"Failed to read sequence number from WebStorage",a)}return b}(a.newValue))!==Af.INVALID&&this.sequenceNumberHandler(h));return[2]})})})}},Object.defineProperty(a.prototype,"localClientState",{get:function(){return this.activeClients[this.localClientId]},enumerable:!0,configurable:!0}),a.prototype.persistClientState=function(){this.setItem(this.localClientStorageKey,this.localClientState.toWebStorageJSON())},a.prototype.persistMutationState=function(a,b,c){var d=new jk(this.currentUser,a,b,c),e=this.toWebStorageMutationBatchKey(a);this.setItem(e,d.toWebStorageJSON())},a.prototype.removeMutationState=function(a){var b=this.toWebStorageMutationBatchKey(a);this.removeItem(b)},a.prototype.persistOnlineState=function(a){var b={clientId:this.localClientId,onlineState:Mi[a]};this.storage.setItem(this.onlineStateKey,JSON.stringify(b))},a.prototype.persistQueryTargetState=function(a,b,c){var d=this.toWebStorageQueryTargetMetadataKey(a),e=new kk(a,b,c);this.setItem(d,e.toWebStorageJSON())},a.prototype.toWebStorageClientStateKey=function(a){return Le(-1===a.indexOf("_"),"Client key cannot contain '_', but was '"+a+"'"),gk+"_"+this.persistenceKey+"_"+a},a.prototype.toWebStorageQueryTargetMetadataKey=function(a){return ik+"_"+this.persistenceKey+"_"+a},a.prototype.toWebStorageMutationBatchKey=function(a){var b=hk+"_"+this.persistenceKey+"_"+a;return this.currentUser.isAuthenticated()&&(b+="_"+this.currentUser.uid),b},a.prototype.fromWebStorageClientStateKey=function(a){var b=this.clientStateKeyRe.exec(a);return b?b[1]:null},a.prototype.fromWebStorageClientState=function(a,b){var c=this.fromWebStorageClientStateKey(a);return Le(null!==c,"Cannot parse client state key '"+a+"'"),lk.fromWebStorageEntry(c,b)},a.prototype.fromWebStorageMutationMetadata=function(a,b){var c=this.mutationBatchKeyRe.exec(a);Le(null!==c,"Cannot parse mutation batch key '"+a+"'");var d=Number(c[1]),e=void 0!==c[2]?c[2]:null;return jk.fromWebStorageEntry(new ek(e),d,b)},a.prototype.fromWebStorageQueryTargetMetadata=function(a,b){var c=this.queryTargetKeyRe.exec(a);Le(null!==c,"Cannot parse query target key '"+a+"'");var d=Number(c[1]);return kk.fromWebStorageEntry(d,b)},a.prototype.fromWebStorageOnlineState=function(a){return mk.fromWebStorageEntry(a)},a.prototype.handleMutationBatchEvent=function(a){return f(this,void 0,void 0,function(){return g(this,function(b){return a.user.uid!==this.currentUser.uid?(He(fk,"Ignoring mutation for non-active user "+a.user.uid),[2]):[2,this.syncEngine.applyBatchState(a.batchId,a.state,a.error)]})})},a.prototype.handleQueryTargetEvent=function(a){return this.syncEngine.applyTargetState(a.targetId,a.state,a.error)},a.prototype.handleClientStateEvent=function(a,b){var c=this,d=this.getAllActiveQueryTargets();b?this.activeClients[a]=b:delete this.activeClients[a];var e=this.getAllActiveQueryTargets(),h=[],i=[];return e.forEach(function(a){return f(c,void 0,void 0,function(){return g(this,function(b){return d.has(a)||h.push(a),[2]})})}),d.forEach(function(a){return f(c,void 0,void 0,function(){return g(this,function(b){return e.has(a)||i.push(a),[2]})})}),this.syncEngine.applyActiveTargetsChange(h,i)},a.prototype.handleOnlineStateEvent=function(a){this.activeClients[a.clientId]&&this.onlineStateHandler(a.onlineState)},a}(),pk=function(){function a(){this.localState=new nk,this.queryState={},this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null}return a.prototype.addPendingMutation=function(a){},a.prototype.updateMutationState=function(a,b,c){},a.prototype.addLocalQueryTarget=function(a){return this.localState.addQueryTarget(a),this.queryState[a]||"not-current"},a.prototype.updateQueryState=function(a,b,c){this.queryState[a]=b},a.prototype.removeLocalQueryTarget=function(a){this.localState.removeQueryTarget(a)},a.prototype.isLocalQueryTarget=function(a){return this.localState.activeTargetIds.has(a)},a.prototype.clearQueryState=function(a){delete this.queryState[a]},a.prototype.getAllActiveQueryTargets=function(){return this.localState.activeTargetIds},a.prototype.isActiveQueryTarget=function(a){return this.localState.activeTargetIds.has(a)},a.prototype.start=function(){return this.localState=new nk,Promise.resolve()},a.prototype.handleUserChange=function(a,b,c){},a.prototype.setOnlineState=function(a){},a.prototype.shutdown=function(){},a.prototype.writeSequenceNumber=function(a){},a}(),qk="FirestoreClient",rk=function(){function a(a,b){this.cacheSizeBytes=a,this.synchronizeTabs=b}return a.prototype.lruParams=function(){return zh.withCacheSize(this.cacheSizeBytes)},a}(),sk=function(){},tk=function(){function a(a,b,c,d){this.platform=a,this.databaseInfo=b,this.credentials=c,this.asyncQueue=d,this.clientId=nf.newId(),this._clientShutdown=!1}return a.prototype.start=function(a){var b=this;this.verifyNotShutdown();var c=new Hf,d=new Hf,e=!1;return this.credentials.setChangeListener(function(f){e?b.asyncQueue.enqueueAndForget(function(){return b.handleCredentialChange(f)}):(e=!0,b.initializePersistence(a,d,f).then(function(a){return b.initializeRest(f,a)}).then(c.resolve,c.reject))}),this.asyncQueue.enqueueAndForget(function(){return c.promise}),d.promise},a.prototype.enableNetwork=function(){var a=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return a.syncEngine.enableNetwork()})},a.prototype.initializePersistence=function(a,b,c){var d=this;return a instanceof rk?this.startIndexedDbPersistence(c,a).then(function(a){return b.resolve(),a}).catch(function(a){if(b.reject(a),!d.canFallback(a))throw a;return console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+a),d.startMemoryPersistence()}):(b.resolve(),this.startMemoryPersistence())},a.prototype.canFallback=function(a){return a instanceof Pe?a.code===Oe.FAILED_PRECONDITION||a.code===Oe.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&a instanceof DOMException)||22===a.code||20===a.code||11===a.code},a.prototype.verifyNotShutdown=function(){if(this._clientShutdown)throw new Pe(Oe.FAILED_PRECONDITION,"The client has already been shutdown.")},a.prototype.startIndexedDbPersistence=function(a,b){var c=this,d=Gh.buildStoragePrefix(this.databaseInfo),e=new Uj(this.databaseInfo.databaseId,{useProto3Json:!0});return Promise.resolve().then(function(){return f(c,void 0,void 0,function(){var c,f;return g(this,function(g){switch(g.label){case 0:if(b.synchronizeTabs&&!ok.isAvailable(this.platform))throw new Pe(Oe.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");return f=b.lruParams(),b.synchronizeTabs?(this.sharedClientState=new ok(this.asyncQueue,this.platform,d,this.clientId,a),[4,Gh.createMultiClientIndexedDbPersistence(d,this.clientId,this.platform,this.asyncQueue,e,f,{sequenceNumberSyncer:this.sharedClientState})]):[3,2];case 1:return c=g.sent(),[3,4];case 2:return this.sharedClientState=new pk,[4,Gh.createIndexedDbPersistence(d,this.clientId,this.platform,this.asyncQueue,e,f)];case 3:c=g.sent(),g.label=4;case 4:return[2,(this.persistence=c).referenceDelegate.garbageCollector]}})})})},a.prototype.startMemoryPersistence=function(){return this.persistence=yi.createEagerPersistence(this.clientId),this.sharedClientState=new pk,Promise.resolve(null)},a.prototype.initializeRest=function(a,b){var c=this;return He(qk,"Initializing. user=",a.uid),this.platform.loadConnection(this.databaseInfo).then(function(d){return f(c,void 0,void 0,function(){var c,e,h,i,j,k=this;return g(this,function(l){switch(l.label){case 0:return this.localStore=new ti(this.persistence,a),b&&(this.lruScheduler=new Ah(b,this.asyncQueue,this.localStore)),c=this.platform.newConnectivityMonitor(),e=this.platform.newSerializer(this.databaseInfo.databaseId),h=new Ti(this.asyncQueue,d,this.credentials,e),i=function(a){return k.syncEngine.applyOnlineStateChange(a,Oi.RemoteStore)},j=function(a){return k.syncEngine.applyOnlineStateChange(a,Oi.SharedClientState)},this.remoteStore=new rj(this.localStore,h,this.asyncQueue,i,c),this.syncEngine=new dk(this.localStore,this.remoteStore,this.sharedClientState,a),this.sharedClientState.onlineStateHandler=j,this.remoteStore.syncEngine=this.syncEngine,this.sharedClientState.syncEngine=this.syncEngine,this.eventMgr=new Wj(this.syncEngine),[4,this.sharedClientState.start()];case 1:return l.sent(),[4,this.remoteStore.start()];case 2:return l.sent(),[4,this.persistence.setPrimaryStateListener(function(a){return f(k,void 0,void 0,function(){return g(this,function(b){switch(b.label){case 0:return[4,this.syncEngine.applyPrimaryState(a)];case 1:return b.sent(),this.lruScheduler&&(a&&!this.lruScheduler.started?this.lruScheduler.start():a||this.lruScheduler.stop()),[2]}})})})];case 3:return l.sent(),[4,this.persistence.setDatabaseDeletedListener(function(){return f(k,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return[4,this.shutdown()];case 1:return a.sent(),[2]}})})})];case 4:return l.sent(),[2]}})})})},a.prototype.handleCredentialChange=function(a){return this.asyncQueue.verifyOperationInProgress(),He(qk,"Credential Changed. Current user: "+a.uid),this.syncEngine.handleCredentialChange(a)},a.prototype.disableNetwork=function(){var a=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return a.syncEngine.disableNetwork()})},a.prototype.shutdown=function(){var a=this;return this.asyncQueue.enqueue(function(){return f(a,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return this._clientShutdown?[3,4]:(this.lruScheduler&&this.lruScheduler.stop(),[4,this.remoteStore.shutdown()]);case 1:return a.sent(),[4,this.sharedClientState.shutdown()];case 2:return a.sent(),[4,this.persistence.shutdown()];case 3:a.sent(),this.credentials.removeChangeListener(),this._clientShutdown=!0,a.label=4;case 4:return[2]}})})})},a.prototype.listen=function(a,b,c){var d=this;this.verifyNotShutdown();var e=new Xj(a,b,c);return this.asyncQueue.enqueueAndForget(function(){return d.eventMgr.listen(e)}),e},a.prototype.unlisten=function(a){var b=this;this.verifyNotShutdown(),this.asyncQueue.enqueueAndForget(function(){return b.eventMgr.unlisten(a)})},a.prototype.getDocumentFromLocalCache=function(a){var b=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return b.localStore.readDocument(a)}).then(function(a){if(a instanceof Kg)return a;if(a instanceof Lg)return null;throw new Pe(Oe.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)")})},a.prototype.getDocumentsFromLocalCache=function(a){var b=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return b.localStore.executeQuery(a)}).then(function(b){var c=gg(),d=new _j(a,c),e=d.computeDocChanges(b);return d.applyChanges(e,!1).snapshot})},a.prototype.write=function(a){var b=this;this.verifyNotShutdown();var c=new Hf;return this.asyncQueue.enqueueAndForget(function(){return b.syncEngine.write(a,c)}),c.promise},a.prototype.databaseId=function(){return this.databaseInfo.databaseId},Object.defineProperty(a.prototype,"clientShutdown",{get:function(){return this._clientShutdown},enumerable:!0,configurable:!0}),a.prototype.transaction=function(a){var b=this;return this.verifyNotShutdown(),this.asyncQueue.enqueue(function(){return f(b,void 0,void 0,function(){return g(this,function(a){return[2]})})}).then(function(){return b.syncEngine.runTransaction(a)})},a}(),uk=function(){function a(a){this.observer=a,this.muted=!1}return a.prototype.next=function(a){this.scheduleEvent(this.observer.next,a)},a.prototype.error=function(a){this.scheduleEvent(this.observer.error,a)},a.prototype.mute=function(){this.muted=!0},a.prototype.scheduleEvent=function(a,b){var c=this;this.muted||setTimeout(function(){c.muted||a(b)},0)},a}(),vk=function(){function a(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];!function(a,b,c,d){if(!(b instanceof Array)||b.length<d)throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() requires its "+c+" argument to be an array with at least "+mf(d,"element")+".")}("FieldPath",a,"fieldNames",1);for(var c=0;c<a.length;++c)if($e("FieldPath","string",c,a[c]),0===a[c].length)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new Ff(a)}return a.documentId=function(){return a._DOCUMENT_ID},a.prototype.isEqual=function(b){if(b instanceof a)return this._internalPath.isEqual(b._internalPath);throw kf("isEqual","FieldPath",1,b)},a._DOCUMENT_ID=new a(Ff.keyField().canonicalString()),a}(),wk=new RegExp("[~\\*/\\[\\]]"),xk=function(a,b){this.user=b,this.type="OAuth",this.authHeaders={Authorization:"Bearer "+a}},yk=function(){function a(){this.changeListener=null}return a.prototype.getToken=function(){return Promise.resolve(null)},a.prototype.invalidateToken=function(){},a.prototype.setChangeListener=function(a){Le(!this.changeListener,"Can only call setChangeListener() once."),(this.changeListener=a)(ek.UNAUTHENTICATED)},a.prototype.removeChangeListener=function(){Le(null!==this.changeListener,"removeChangeListener() when no listener registered"),this.changeListener=null},a}(),zk=function(){function a(a){var b=this;this.app=a,this.tokenListener=null,this.tokenCounter=0,this.changeListener=null,this.forceRefresh=!1,this.tokenListener=function(){b.tokenCounter++,b.currentUser=b.getUser(),b.changeListener&&b.changeListener(b.currentUser)},this.tokenCounter=0,this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}return a.prototype.getToken=function(){var a=this;Le(null!=this.tokenListener,"getToken cannot be called after listener removed.");var b=this.tokenCounter,c=this.forceRefresh;return this.forceRefresh=!1,this.app.INTERNAL.getToken(c).then(function(c){if(a.tokenCounter!==b)throw new Pe(Oe.ABORTED,"getToken aborted due to token change.");return c?(Le("string"==typeof c.accessToken,"Invalid tokenData returned from getToken():"+c),new xk(c.accessToken,a.currentUser)):null})},a.prototype.invalidateToken=function(){this.forceRefresh=!0},a.prototype.setChangeListener=function(a){Le(!this.changeListener,"Can only call setChangeListener() once."),this.changeListener=a,this.currentUser&&a(this.currentUser)},a.prototype.removeChangeListener=function(){Le(null!=this.tokenListener,"removeChangeListener() called twice"),Le(null!==this.changeListener,"removeChangeListener() called when no listener registered"),this.app.INTERNAL.removeAuthTokenListener(this.tokenListener),this.tokenListener=null,this.changeListener=null},a.prototype.getUser=function(){var a=this.app.INTERNAL.getUid();return Le(null===a||"string"==typeof a,"Received invalid UID: "+a),new ek(a)},a}(),Ak=function(){function a(a,b){this.gapi=a,this.sessionIndex=b,this.type="FirstParty",this.user=ek.FIRST_PARTY}return Object.defineProperty(a.prototype,"authHeaders",{get:function(){var a={"X-Goog-AuthUser":this.sessionIndex},b=this.gapi.auth.getAuthHeaderValueForFirstParty([]);return b&&(a.Authorization=b),a},enumerable:!0,configurable:!0}),a}(),Bk=function(){function a(a,b){this.gapi=a,this.sessionIndex=b}return a.prototype.getToken=function(){return Promise.resolve(new Ak(this.gapi,this.sessionIndex))},a.prototype.setChangeListener=function(a){a(ek.FIRST_PARTY)},a.prototype.removeChangeListener=function(){},a.prototype.invalidateToken=function(){},a}(),Dk,Ek,Fk=function(){function a(a){this._methodName=a}return a.delete=function(){return We("FieldValue.delete",arguments),Gk.instance},a.serverTimestamp=function(){return We("FieldValue.serverTimestamp",arguments),Hk.instance},a.arrayUnion=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return Ye("FieldValue.arrayUnion",arguments,1),new Ik(a)},a.arrayRemove=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];return Ye("FieldValue.arrayRemove",arguments,1),new Jk(a)},a.increment=function(a){return $e("FieldValue.increment","number",1,a),Xe("FieldValue.increment",arguments,1),new Kk(a)},a.prototype.isEqual=function(a){return this===a},a}(),Gk=function(a){function b(){return a.call(this,"FieldValue.delete")||this}return e(b,a),b.instance=new b,b}(Fk),Hk=function(a){function b(){return a.call(this,"FieldValue.serverTimestamp")||this}return e(b,a),b.instance=new b,b}(Fk),Ik=function(a){function b(b){var c=a.call(this,"FieldValue.arrayUnion")||this;return c._elements=b,c}return e(b,a),b}(Fk),Jk=function(a){function b(b){var c=a.call(this,"FieldValue.arrayRemove")||this;return c._elements=b,c}return e(b,a),b}(Fk),Kk=function(a){function b(b){var c=a.call(this,"FieldValue.increment")||this;return c._operand=b,c}return e(b,a),b}(Fk),Lk=Qe(Fk,"Use FieldValue.<field>() instead."),Mk=/^__.*__$/,Nk=function(){function a(a,b,c){this.data=a,this.fieldMask=b,this.fieldTransforms=c}return a.prototype.toMutations=function(a,b){var c=[];return null!==this.fieldMask?c.push(new ni(a,this.data,this.fieldMask,b)):c.push(new mi(a,this.data,b)),0<this.fieldTransforms.length&&c.push(new oi(a,this.fieldTransforms)),c},a}(),Ok=function(){function a(a,b,c){this.data=a,this.fieldMask=b,this.fieldTransforms=c}return a.prototype.toMutations=function(a,b){var c=[new ni(a,this.data,this.fieldMask,b)];return 0<this.fieldTransforms.length&&c.push(new oi(a,this.fieldTransforms)),c},a}();(Ek=Dk||(Dk={}))[Ek.Set=0]="Set",Ek[Ek.Update=1]="Update",Ek[Ek.MergeSet=2]="MergeSet",Ek[Ek.Argument=3]="Argument";var Qk=function(){function a(a,b,c,d,e,f){this.dataSource=a,this.methodName=b,this.path=c,this.arrayElement=d,void 0===e&&this.validatePath(),this.arrayElement=void 0!==d&&d,this.fieldTransforms=e||[],this.fieldMask=f||[]}return a.prototype.childContextForField=function(b){var c=null==this.path?null:this.path.child(b),d=new a(this.dataSource,this.methodName,c,!1,this.fieldTransforms,this.fieldMask);return d.validatePathSegment(b),d},a.prototype.childContextForFieldPath=function(b){var c=null==this.path?null:this.path.child(b),d=new a(this.dataSource,this.methodName,c,!1,this.fieldTransforms,this.fieldMask);return d.validatePath(),d},a.prototype.childContextForArray=function(b){return new a(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)},a.prototype.createError=function(a){var b=null===this.path||this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new Pe(Oe.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+a+b)},a.prototype.contains=function(a){return void 0!==this.fieldMask.find(function(b){return a.isPrefixOf(b)})||void 0!==this.fieldTransforms.find(function(b){return a.isPrefixOf(b.field)})},a.prototype.validatePath=function(){if(null!==this.path)for(var a=0;a<this.path.length;a++)this.validatePathSegment(this.path.get(a))},a.prototype.validatePathSegment=function(a){if(Pk(this.dataSource)&&Mk.test(a))throw this.createError("Document fields cannot begin and end with __")},a}(),Rk=function(a,b){this.databaseId=a,this.key=b},Sk=function(){function a(a){this.preConverter=a}return a.prototype.parseSetData=function(a,b){var c=new Qk(Dk.Set,a,Ff.EMPTY_PATH);Uk("Data must be an object, but it was:",c,b);var d=this.parseData(b,c);return new Nk(d,null,c.fieldTransforms)},a.prototype.parseMergeData=function(a,b,c){var d,e,f=new Qk(Dk.MergeSet,a,Ff.EMPTY_PATH);Uk("Data must be an object, but it was:",f,b);var g,i,j=this.parseData(b,f);if(c){var k=new Yf(Ff.comparator);try{for(var l=h(c),m=l.next();!m.done;m=l.next()){var n=m.value,o=void 0;if(n instanceof vk)o=n._internalPath;else{if("string"!=typeof n)throw Ke("Expected stringOrFieldPath to be a string or a FieldPath");o=Wk(a,n)}if(!f.contains(o))throw new Pe(Oe.INVALID_ARGUMENT,"Field '"+o+"' is specified in your field mask but missing from your input data.");k=k.add(o)}}catch(a){d={error:a}}finally{try{m&&!m.done&&(e=l.return)&&e.call(l)}finally{if(d)throw d.error}}g=hi.fromSet(k),i=f.fieldTransforms.filter(function(a){return g.covers(a.field)})}else g=hi.fromArray(f.fieldMask),i=f.fieldTransforms;return new Nk(j,g,i)},a.prototype.parseUpdateData=function(a,b){var c=this,d=new Qk(Dk.Update,a,Ff.EMPTY_PATH);Uk("Data must be an object, but it was:",d,b);var e=new Yf(Ff.comparator),f=fi.EMPTY;Ue(b,function(b,g){var h=Wk(a,b),i=d.childContextForFieldPath(h);if((g=c.runPreConverter(g,i))instanceof Gk)e=e.add(h);else{var j=c.parseData(g,i);null!=j&&(e=e.add(h),f=f.set(h,j))}});var g=hi.fromSet(e);return new Ok(f,g,d.fieldTransforms)},a.prototype.parseUpdateVarargs=function(a,b,c,d){var e=new Qk(Dk.Update,a,Ff.EMPTY_PATH),f=[Vk(a,b)],g=[c];if(d.length%2!=0)throw new Pe(Oe.INVALID_ARGUMENT,"Function "+a+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var h=0;h<d.length;h+=2)f.push(Vk(a,d[h])),g.push(d[h+1]);var i=new Yf(Ff.comparator),j=fi.EMPTY;for(h=0;h<f.length;++h){var k=f[h],l=e.childContextForFieldPath(k),m=this.runPreConverter(g[h],l);if(m instanceof Gk)i=i.add(k);else{var n=this.parseData(m,l);null!=n&&(i=i.add(k),j=j.set(k,n))}}var o=hi.fromSet(i);return new Ok(j,o,e.fieldTransforms)},a.prototype.parseQueryValue=function(a,b){var c=new Qk(Dk.Argument,a,Ff.EMPTY_PATH),d=this.parseData(b,c);return Le(null!=d,"Parsed data should not be null."),Le(0===c.fieldTransforms.length,"Field transforms should have been disallowed."),d},a.prototype.runPreConverter=function(a,b){try{return this.preConverter(a)}catch(a){var c=Xk(a);throw b.createError(c)}},a.prototype.parseData=function(a,b){if(Tk(a=this.runPreConverter(a,b)))return Uk("Unsupported field value:",b,a),this.parseObject(a,b);if(a instanceof Fk)return this.parseSentinelFieldValue(a,b),null;if(b.path&&b.fieldMask.push(b.path),a instanceof Array){if(b.arrayElement)throw b.createError("Nested arrays are not supported");return this.parseArray(a,b)}return this.parseScalarValue(a,b)},a.prototype.parseObject=function(a,b){var c=this,d=new Uf(of);return Ve(a)?b.path&&0<b.path.length&&b.fieldMask.push(b.path):Ue(a,function(a,e){var f=c.parseData(e,b.childContextForField(a));null!=f&&(d=d.insert(a,f))}),new fi(d)},a.prototype.parseArray=function(a,b){var c,d,e=[],f=0;try{for(var g=h(a),i=g.next();!i.done;i=g.next()){var j=i.value,k=this.parseData(j,b.childContextForArray(f));null==k&&(k=Sh.INSTANCE),e.push(k),f++}}catch(a){c={error:a}}finally{try{i&&!i.done&&(d=g.return)&&d.call(g)}finally{if(c)throw c.error}}return new gi(e)},a.prototype.parseSentinelFieldValue=function(a,b){if(!Pk(b.dataSource))throw b.createError(a._methodName+"() can only be used with update() and set()");if(null===b.path)throw b.createError(a._methodName+"() is not currently supported inside arrays");if(a instanceof Gk){if(b.dataSource!==Dk.MergeSet)throw b.dataSource===Dk.Update?(Le(0<b.path.length,"FieldValue.delete() at the top level should have already been handled."),b.createError("FieldValue.delete() can only appear at the top level of your update data")):b.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");b.fieldMask.push(b.path)}else if(a instanceof Hk)b.fieldTransforms.push(new ii(b.path,Hj.instance));else if(a instanceof Ik){var c=this.parseArrayTransformElements(a._methodName,a._elements),d=new Ij(c);b.fieldTransforms.push(new ii(b.path,d))}else if(a instanceof Jk){c=this.parseArrayTransformElements(a._methodName,a._elements);var e=new Jj(c);b.fieldTransforms.push(new ii(b.path,e))}else if(a instanceof Kk){var f=this.parseQueryValue("FieldValue.increment",a._operand),g=new Kj(f);b.fieldTransforms.push(new ii(b.path,g))}else Ke("Unknown FieldValue type: "+a)},a.prototype.parseScalarValue=function(a,b){if(null===a)return Sh.INSTANCE;if("number"==typeof a)return Hi(a)?new Yh(a):new Zh(a);if("boolean"==typeof a)return Th.of(a);if("string"==typeof a)return new $h(a);if(a instanceof Date)return new ai(Sf.fromDate(a));if(a instanceof Sf)return new ai(new Sf(a.seconds,1e3*Math.floor(a.nanoseconds/1e3)));if(a instanceof sj)return new ei(a);if(a instanceof vf)return new ci(a);if(a instanceof 
Rk)return new di(a.databaseId,a.key);throw b.createError("Unsupported field value: "+gf(a))},a.prototype.parseArrayTransformElements=function(a,b){var c=this;return b.map(function(b,d){var e=new Qk(Dk.Argument,a,Ff.EMPTY_PATH);return c.parseData(b,e.childContextForArray(d))})},a}(),Yk=zh.COLLECTION_DISABLED,Zk=function(){function a(a){if(void 0===a.host){if(void 0!==a.ssl)throw new Pe(Oe.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else af("settings","non-empty string","host",a.host),this.host=a.host,bf("settings","boolean","ssl",a.ssl),this.ssl=Se(a.ssl,!0);if(jf("settings",a,["host","ssl","credentials","timestampsInSnapshots","cacheSizeBytes","experimentalForceLongPolling"]),bf("settings","object","credentials",a.credentials),this.credentials=a.credentials,bf("settings","boolean","timestampsInSnapshots",a.timestampsInSnapshots),!0===a.timestampsInSnapshots?Ie("\n  The timestampsInSnapshots setting now defaults to true and you no\n  longer need to explicitly set it. In a future release, the setting\n  will be removed entirely and so it is recommended that you remove it\n  from your firestore.settings() call now."):!1===a.timestampsInSnapshots&&Ie("\n  The timestampsInSnapshots setting will soon be removed. YOU MUST UPDATE\n  YOUR CODE.\n\n  To hide this warning, stop using the timestampsInSnapshots setting in your\n  firestore.settings({ ... }) call.\n\n  Once you remove the setting, Timestamps stored in Cloud Firestore will be\n  read back as Firebase Timestamp objects instead of as system Date objects.\n  So you will also need to update code expecting a Date to instead expect a\n  Timestamp. For example:\n\n  // Old:\n  const date = snapshot.get('created_at');\n  // New:\n  const timestamp = snapshot.get('created_at'); const date =\n  timestamp.toDate();\n\n  Please audit all existing usages of Date when you enable the new\n  behavior."),this.timestampsInSnapshots=Se(a.timestampsInSnapshots,!0),bf("settings","number","cacheSizeBytes",a.cacheSizeBytes),void 0===a.cacheSizeBytes)this.cacheSizeBytes=zh.DEFAULT_CACHE_SIZE_BYTES;else{if(a.cacheSizeBytes!==Yk&&a.cacheSizeBytes<zh.MINIMUM_CACHE_SIZE_BYTES)throw new Pe(Oe.INVALID_ARGUMENT,"cacheSizeBytes must be at least "+zh.MINIMUM_CACHE_SIZE_BYTES);this.cacheSizeBytes=a.cacheSizeBytes}bf("settings","boolean","experimentalForceLongPolling",a.experimentalForceLongPolling),this.forceLongPolling=void 0!==a.experimentalForceLongPolling&&a.experimentalForceLongPolling}return a.prototype.isEqual=function(a){return this.host===a.host&&this.ssl===a.ssl&&this.timestampsInSnapshots===a.timestampsInSnapshots&&this.credentials===a.credentials&&this.cacheSizeBytes===a.cacheSizeBytes&&this.forceLongPolling===a.forceLongPolling},a}(),$k=function(){},_k=function(){function a(b){var c=this;this._queue=new Jf,this.INTERNAL={"delete":function(){return f(c,void 0,void 0,function(){return g(this,function(a){switch(a.label){case 0:return this.ensureClientConfigured(),[4,this._firestoreClient.shutdown()];case 1:return a.sent(),[2]}})})}};var d=new $k;if("object"==typeof b.options){var e=b;d.firebaseApp=e,d.databaseId=a.databaseIdFromApp(e),d.persistenceKey=d.firebaseApp.name,d.credentials=new zk(e)}else{var h=b;if(!h.projectId)throw new Pe(Oe.INVALID_ARGUMENT,"Must provide projectId");d.databaseId=new zf(h.projectId,h.database),d.persistenceKey="[DEFAULT]",d.credentials=new yk}d.settings=new Zk({}),this._config=d,this._databaseId=d.databaseId}return a.prototype.settings=function(a){if(Xe("Firestore.settings",arguments,1),$e("Firestore.settings","object",1,a),Re(a,"persistence"))throw new Pe(Oe.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var b=new Zk(a);if(this._firestoreClient&&!this._config.settings.isEqual(b))throw new Pe(Oe.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");void 0!==(this._config.settings=b).credentials&&(this._config.credentials=function(a){if(!a)return new yk;switch(a.type){case"gapi":var b=a.client;return Le("object"==typeof b&&null!==b&&!!b.auth&&!!b.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface"),new Bk(b,a.sessionIndex||"0");case"provider":return a.client;default:throw new Pe(Oe.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type")}}(b.credentials))},a.prototype.enableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.enableNetwork()},a.prototype.disableNetwork=function(){return this.ensureClientConfigured(),this._firestoreClient.disableNetwork()},a.prototype.enablePersistence=function(a){if(this._firestoreClient)throw new Pe(Oe.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");var b=!1;return a&&(void 0!==a.experimentalTabSynchronization&&Ie("The 'experimentalTabSynchronization' setting has been renamed to 'synchronizeTabs'. In a future release, the setting will be removed and it is recommended that you update your firestore.enablePersistence() call to use 'synchronizeTabs'."),b=Se(void 0!==a.synchronizeTabs?a.synchronizeTabs:a.experimentalTabSynchronization,!1)),this.configureClient(new rk(this._config.settings.cacheSizeBytes,b))},a.prototype.clearPersistence=function(){var a=this,b=Gh.buildStoragePrefix(this.makeDatabaseInfo()),c=new Hf;return this._queue.enqueueAndForget(function(){return f(a,void 0,void 0,function(){var a;return g(this,function(d){switch(d.label){case 0:if(d.trys.push([0,2,,3]),void 0!==this._firestoreClient&&!this._firestoreClient.clientShutdown)throw new Pe(Oe.FAILED_PRECONDITION,"Persistence cannot be cleared after this Firestore instance is initialized.");return[4,Gh.clearPersistence(b)];case 1:return d.sent(),c.resolve(),[3,3];case 2:return a=d.sent(),c.reject(a),[3,3];case 3:return[2]}})})}),c.promise},a.prototype.ensureClientConfigured=function(){return this._firestoreClient||this.configureClient(new sk),this._firestoreClient},a.prototype.makeDatabaseInfo=function(){return new xf(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl,this._config.settings.forceLongPolling)},a.prototype.configureClient=function(a){var b=this;Le(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey"),Le(!this._firestoreClient,"configureClient() called multiple times");var c=this.makeDatabaseInfo();return this._dataConverter=new Sk(function(a){if(a instanceof cl){var c=b._config.databaseId,d=a.firestore._config.databaseId;if(!d.isEqual(c))throw new Pe(Oe.INVALID_ARGUMENT,"Document reference is for database "+d.projectId+"/"+d.database+" but should be for database "+c.projectId+"/"+c.database);return new Rk(b._config.databaseId,a._key)}return a}),this._firestoreClient=new tk(Me.getPlatform(),c,this._config.credentials,this._queue),this._firestoreClient.start(a)},a.databaseIdFromApp=function(a){var b=a.options;if(!Re(b,"projectId"))throw new Pe(Oe.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');var c=b.projectId;if(!c||"string"!=typeof c)throw new Pe(Oe.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new zf(c)},Object.defineProperty(a.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new Pe(Oe.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,configurable:!0}),a.prototype.collection=function(a){return Xe("Firestore.collection",arguments,1),$e("Firestore.collection","non-empty string",1,a),this.ensureClientConfigured(),new il(Df.fromString(a),this)},a.prototype.doc=function(a){return Xe("Firestore.doc",arguments,1),$e("Firestore.doc","non-empty string",1,a),this.ensureClientConfigured(),cl.forPath(Df.fromString(a),this)},a.prototype.collectionGroup=function(a){if(Xe("Firestore.collectionGroup",arguments,1),$e("Firestore.collectionGroup","non-empty string",1,a),0<=a.indexOf("/"))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid collection ID '"+a+"' passed to function Firestore.collectionGroup(). Collection IDs must not contain '/'.");return this.ensureClientConfigured(),new gl(new tj(Df.EMPTY_PATH,a),this)},a.prototype.runTransaction=function(a){var b=this;return Xe("Firestore.runTransaction",arguments,1),$e("Firestore.runTransaction","function",1,a),this.ensureClientConfigured().transaction(function(c){return a(new al(b,c))})},a.prototype.batch=function(){return this.ensureClientConfigured(),new bl(this)},Object.defineProperty(a,"logLevel",{get:function(){switch(Fe()){case ve.DEBUG:return"debug";case ve.ERROR:return"error";case ve.SILENT:return"silent";default:return Ke("Unknown log level: "+Fe())}},enumerable:!0,configurable:!0}),a.setLogLevel=function(a){switch(Xe("Firestore.setLogLevel",arguments,1),$e("Firestore.setLogLevel","non-empty string",1,a),a){case"debug":Ge(ve.DEBUG);break;case"error":Ge(ve.ERROR);break;case"silent":Ge(ve.SILENT);break;default:throw new Pe(Oe.INVALID_ARGUMENT,"Invalid log level: "+a)}},a.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots},a}(),al=function(){function a(a,b){this._firestore=a,this._transaction=b}return a.prototype.get=function(a){var b=this;Xe("Transaction.get",arguments,1);var c=ml("Transaction.get",a,this._firestore);return this._transaction.lookup([c._key]).then(function(a){if(!a||1!==a.length)return Ke("Mismatch in docs returned from document lookup.");var d=a[0];if(d instanceof Lg)return new el(b._firestore,c._key,null,!1,!1);if(d instanceof Kg)return new el(b._firestore,c._key,d,!1,!1);throw Ke("BatchGetDocumentsRequest returned unexpected document type: "+d.constructor.name)})},a.prototype.set=function(a,b,c){Ze("Transaction.set",arguments,2,3);var d=ml("Transaction.set",a,this._firestore),e=(c=jl("Transaction.set",c)).merge||c.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",b,c.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",b);return this._transaction.set(d._key,e),this},a.prototype.update=function(a,b,c){for(var d,e,f=[],g=3;g<arguments.length;g++)f[g-3]=arguments[g];return e="string"==typeof b||b instanceof vk?(Ye("Transaction.update",arguments,3),d=ml("Transaction.update",a,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",b,c,f)):(Xe("Transaction.update",arguments,2),d=ml("Transaction.update",a,this._firestore),this._firestore._dataConverter.parseUpdateData("Transaction.update",b)),this._transaction.update(d._key,e),this},a.prototype.delete=function(a){Xe("Transaction.delete",arguments,1);var b=ml("Transaction.delete",a,this._firestore);return this._transaction.delete(b._key),this},a}(),bl=function(){function a(a){this._firestore=a,this._mutations=[],this._committed=!1}return a.prototype.set=function(a,b,c){Ze("WriteBatch.set",arguments,2,3),this.verifyNotCommitted();var d=ml("WriteBatch.set",a,this._firestore),e=(c=jl("WriteBatch.set",c)).merge||c.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",b,c.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",b);return this._mutations=this._mutations.concat(e.toMutations(d._key,ki.NONE)),this},a.prototype.update=function(a,b,c){for(var d,e,f=[],g=3;g<arguments.length;g++)f[g-3]=arguments[g];return this.verifyNotCommitted(),e="string"==typeof b||b instanceof vk?(Ye("WriteBatch.update",arguments,3),d=ml("WriteBatch.update",a,this._firestore),this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",b,c,f)):(Xe("WriteBatch.update",arguments,2),d=ml("WriteBatch.update",a,this._firestore),this._firestore._dataConverter.parseUpdateData("WriteBatch.update",b)),this._mutations=this._mutations.concat(e.toMutations(d._key,ki.exists(!0))),this},a.prototype.delete=function(a){Xe("WriteBatch.delete",arguments,1),this.verifyNotCommitted();var b=ml("WriteBatch.delete",a,this._firestore);return this._mutations=this._mutations.concat(new pi(b._key,ki.NONE)),this},a.prototype.commit=function(){return f(this,void 0,void 0,function(){return g(this,function(a){return this.verifyNotCommitted(),this._committed=!0,0<this._mutations.length?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})},a.prototype.verifyNotCommitted=function(){if(this._committed)throw new Pe(Oe.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")},a}(),cl=function(){function a(a,b){this._key=a,this.firestore=b,this._firestoreClient=this.firestore.ensureClientConfigured()}return a.forPath=function(b,c){if(b.length%2!=0)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid document reference. Document references must have an even number of segments, but "+b.canonicalString()+" has "+b.length);return new a(new Gf(b),c)},Object.defineProperty(a.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"parent",{get:function(){return new il(this._key.path.popLast(),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0}),a.prototype.collection=function(a){if(Xe("DocumentReference.collection",arguments,1),$e("DocumentReference.collection","non-empty string",1,a),!a)throw new Pe(Oe.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var b=Df.fromString(a);return new il(this._key.path.child(b),this.firestore)},a.prototype.isEqual=function(b){if(b instanceof a)return this.firestore===b.firestore&&this._key.isEqual(b._key);throw kf("isEqual","DocumentReference",1,b)},a.prototype.set=function(a,b){Ze("DocumentReference.set",arguments,1,2);var c=(b=jl("DocumentReference.set",b)).merge||b.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",a,b.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",a);return this._firestoreClient.write(c.toMutations(this._key,ki.NONE))},a.prototype.update=function(a,b){for(var c,d=[],e=2;e<arguments.length;e++)d[e-2]=arguments[e];return c="string"==typeof a||a instanceof vk?(Ye("DocumentReference.update",arguments,2),this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",a,b,d)):(Xe("DocumentReference.update",arguments,1),this.firestore._dataConverter.parseUpdateData("DocumentReference.update",a)),this._firestoreClient.write(c.toMutations(this._key,ki.exists(!0)))},a.prototype.delete=function(){return Xe("DocumentReference.delete",arguments,0),this._firestoreClient.write([new pi(this._key,ki.NONE)])},a.prototype.onSnapshot=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];Ze("DocumentReference.onSnapshot",arguments,1,4);var c,d={includeMetadataChanges:!1},e=0;"object"!=typeof a[e]||Ck(a[e])||(jf("DocumentReference.onSnapshot",d=a[e],["includeMetadataChanges"]),bf("DocumentReference.onSnapshot","boolean","includeMetadataChanges",d.includeMetadataChanges),e++);var f={includeMetadataChanges:d.includeMetadataChanges};return c=Ck(a[e])?a[e]:($e("DocumentReference.onSnapshot","function",e,a[e]),_e("DocumentReference.onSnapshot","function",e+1,a[e+1]),_e("DocumentReference.onSnapshot","function",e+2,a[e+2]),{next:a[e],error:a[e+1],complete:a[e+2]}),this.onSnapshotInternal(f,c)},a.prototype.onSnapshotInternal=function(a,b){var c=this,d=function(a){console.error("Uncaught Error in onSnapshot:",a)};b.error&&(d=b.error.bind(b));var e=new uk({next:function(a){if(b.next){Le(a.docs.size<=1,"Too many documents returned on a document query");var d=a.docs.get(c._key);b.next(new el(c.firestore,c._key,d,a.fromCache,a.hasPendingWrites))}},error:d}),f=this._firestoreClient.listen(tj.atPath(this._key.path),e,a);return function(){e.mute(),c._firestoreClient.unlisten(f)}},a.prototype.get=function(a){var b=this;return Ze("DocumentReference.get",arguments,0,1),ll("DocumentReference.get",a),new Promise(function(c,d){a&&"cache"===a.source?b.firestore.ensureClientConfigured().getDocumentFromLocalCache(b._key).then(function(a){c(new el(b.firestore,b._key,a,!0,a instanceof Kg&&a.hasLocalMutations))},d):b.getViaSnapshotListener(c,d,a)})},a.prototype.getViaSnapshotListener=function(a,b,c){var d=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(e){d(),!e.exists&&e.metadata.fromCache?b(new Pe(Oe.UNAVAILABLE,"Failed to get document because the client is offline.")):e.exists&&e.metadata.fromCache&&c&&"server"===c.source?b(new Pe(Oe.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a(e)},error:b})},a}(),dl=function(){function a(a,b){this.hasPendingWrites=a,this.fromCache=b}return a.prototype.isEqual=function(a){return this.hasPendingWrites===a.hasPendingWrites&&this.fromCache===a.fromCache},a}(),el=function(){function a(a,b,c,d,e){this._firestore=a,this._key=b,this._document=c,this._fromCache=d,this._hasPendingWrites=e}return a.prototype.data=function(a){return Ze("DocumentSnapshot.data",arguments,0,1),a=kl("DocumentSnapshot.data",a),this._document?this.convertObject(this._document.data,Qh.fromSnapshotOptions(a,this._firestore._areTimestampsInSnapshotsEnabled())):void 0},a.prototype.get=function(a,b){if(Ze("DocumentSnapshot.get",arguments,1,2),b=kl("DocumentSnapshot.get",b),this._document){var c=this._document.data.field(Vk("DocumentSnapshot.get",a));if(null!==c)return this.convertValue(c,Qh.fromSnapshotOptions(b,this._firestore._areTimestampsInSnapshotsEnabled()))}},Object.defineProperty(a.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"ref",{get:function(){return new cl(this._key,this._firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"metadata",{get:function(){return new dl(this._hasPendingWrites,this._fromCache)},enumerable:!0,configurable:!0}),a.prototype.isEqual=function(b){if(b instanceof a)return this._firestore===b._firestore&&this._fromCache===b._fromCache&&this._key.isEqual(b._key)&&(null===this._document?null===b._document:this._document.isEqual(b._document));throw kf("isEqual","DocumentSnapshot",1,b)},a.prototype.convertObject=function(a,b){var c=this,d={};return a.forEach(function(a,e){d[a]=c.convertValue(e,b)}),d},a.prototype.convertValue=function(a,b){if(a instanceof fi)return this.convertObject(a,b);if(a instanceof gi)return this.convertArray(a,b);if(a instanceof di){var c=a.value(b),d=this._firestore.ensureClientConfigured().databaseId();return a.databaseId.isEqual(d)||Ie("Document "+this._key.path+" contains a document reference within a different database ("+a.databaseId.projectId+"/"+a.databaseId.database+") which is not supported. It will be treated as a reference in the current database ("+d.projectId+"/"+d.database+") instead."),new cl(c,this._firestore)}return a.value(b)},a.prototype.convertArray=function(a,b){var c=this;return a.internalValue.map(function(a){return c.convertValue(a,b)})},a}(),fl=function(a){function b(){return null!==a&&a.apply(this,arguments)||this}return e(b,a),b.prototype.data=function(b){var c=a.prototype.data.call(this,b);return Le("object"==typeof c,"Document in a QueryDocumentSnapshot should exist"),c},b}(el),gl=function(){function a(a,b){this._query=a,this.firestore=b}return a.prototype.where=function(b,c,d){var e,f,g;(Xe("Query.where",arguments,3),hf("Query.where",3,d),"in"!==c&&"array-contains-any"!==c)&&!function(a,b,c,d){if(!b.some(function(a){return a===d}))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid value "+gf(d)+" provided to function "+a+"() for its "+lf(c)+" argument. Acceptable values: "+b.join(", "))}("Query.where",["<","<=","==",">=",">","array-contains"],2,c);var i=Vk("Query.where",b),j=vj.fromString(c);if(i.isKeyField()){if(j===vj.ARRAY_CONTAINS||j===vj.ARRAY_CONTAINS_ANY)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid Query. You can't perform '"+j.toString()+"' queries on FieldPath.documentId().");if(j===vj.IN){this.validateDisjunctiveFilterElements(d,j);var k=[];try{for(var l=h(d),m=l.next();!m.done;m=l.next()){var n=m.value;k.push(this.parseDocumentIdValue(n))}}catch(b){e={error:b}}finally{try{m&&!m.done&&(f=l.return)&&f.call(l)}finally{if(e)throw e.error}}g=new gi(k)}else g=this.parseDocumentIdValue(d)}else j!==vj.IN&&j!==vj.ARRAY_CONTAINS_ANY||this.validateDisjunctiveFilterElements(d,j),g=this.firestore._dataConverter.parseQueryValue("Query.where",d);var o=wj.create(i,j,g);return this.validateNewFilter(o),new a(this._query.addFilter(o),this.firestore)},a.prototype.orderBy=function(b,c){var d;if(Ze("Query.orderBy",arguments,1,2),_e("Query.orderBy","non-empty string",2,c),void 0===c||"asc"===c)d=Cj.ASCENDING;else{if("desc"!==c)throw new Pe(Oe.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+c+"', expected 'asc' or 'desc'.");d=Cj.DESCENDING}if(null!==this._query.startAt)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");var e=Vk("Query.orderBy",b),f=new Ej(e,d);return this.validateNewOrderBy(f),new a(this._query.addOrderBy(f),this.firestore)},a.prototype.limit=function(b){if(Xe("Query.limit",arguments,1),$e("Query.limit","number",1,b),b<=0)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid Query. Query limit ("+b+") is invalid. Limit must be positive.");return new a(this._query.withLimit(b),this.firestore)},a.prototype.startAt=function(b){for(var c=[],d=1;d<arguments.length;d++)c[d-1]=arguments[d];Ye("Query.startAt",arguments,1);var e=this.boundFromDocOrFields("Query.startAt",b,c,!0);return new a(this._query.withStartAt(e),this.firestore)},a.prototype.startAfter=function(b){for(var c=[],d=1;d<arguments.length;d++)c[d-1]=arguments[d];Ye("Query.startAfter",arguments,1);var e=this.boundFromDocOrFields("Query.startAfter",b,c,!1);return new a(this._query.withStartAt(e),this.firestore)},a.prototype.endBefore=function(b){for(var c=[],d=1;d<arguments.length;d++)c[d-1]=arguments[d];Ye("Query.endBefore",arguments,1);var e=this.boundFromDocOrFields("Query.endBefore",b,c,!0);return new a(this._query.withEndAt(e),this.firestore)},a.prototype.endAt=function(b){for(var c=[],d=1;d<arguments.length;d++)c[d-1]=arguments[d];Ye("Query.endAt",arguments,1);var e=this.boundFromDocOrFields("Query.endAt",b,c,!1);return new a(this._query.withEndAt(e),this.firestore)},a.prototype.isEqual=function(b){if(b instanceof a)return this.firestore===b.firestore&&this._query.isEqual(b._query);throw kf("isEqual","Query",1,b)},a.prototype.boundFromDocOrFields=function(a,b,c,d){if(hf(a,1,b),b instanceof el){if(0<c.length)throw new Pe(Oe.INVALID_ARGUMENT,"Too many arguments provided to "+a+"().");var e=b;if(!e.exists)throw new Pe(Oe.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+a+"().");return this.boundFromDocument(a,e._document,d)}var f=[b].concat(c);return this.boundFromFields(a,f,d)},a.prototype.boundFromDocument=function(a,b,c){var d,e,f=[];try{for(var g=h(this._query.orderBy),i=g.next();!i.done;i=g.next()){var j=i.value;if(j.field.isKeyField())f.push(new di(this.firestore._databaseId,b.key));else{var k=b.field(j.field);if(k instanceof bi)throw new Pe(Oe.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+j.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===k){var l=j.field.canonicalString();throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a document for which the field '"+l+"' (used as the orderBy) does not exist.")}f.push(k)}}}catch(a){d={error:a}}finally{try{i&&!i.done&&(e=g.return)&&e.call(g)}finally{if(d)throw d.error}}return new Dj(f,c)},a.prototype.boundFromFields=function(a,b,c){var d=this._query.explicitOrderBy;if(b.length>d.length)throw new Pe(Oe.INVALID_ARGUMENT,"Too many arguments provided to "+a+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var e=[],f=0;f<b.length;f++){var g=b[f];if(d[f].field.isKeyField()){if("string"!=typeof g)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+a+"(), but got a "+typeof g);if(!this._query.isCollectionGroupQuery()&&-1!==g.indexOf("/"))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. When querying a collection and ordering by FieldPath.documentId(), the value passed to "+a+"() must be a plain document ID, but '"+g+"' contains a slash.");var h=this._query.path.child(Df.fromString(g));if(!Gf.isDocumentKey(h))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. When querying a collection group and ordering by FieldPath.documentId(), the value passed to "+a+"() must result in a valid document path, but '"+h+"' is not because it contains an odd number of segments.");var i=new Gf(h);e.push(new di(this.firestore._databaseId,i))}else{var j=this.firestore._dataConverter.parseQueryValue(a,g);e.push(j)}}return new Dj(e,c)},a.prototype.onSnapshot=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];Ze("Query.onSnapshot",arguments,1,4);var c,d={},e=0;return"object"!=typeof a[e]||Ck(a[e])||(jf("Query.onSnapshot",d=a[e],["includeMetadataChanges"]),bf("Query.onSnapshot","boolean","includeMetadataChanges",d.includeMetadataChanges),e++),c=Ck(a[e])?a[e]:($e("Query.onSnapshot","function",e,a[e]),_e("Query.onSnapshot","function",e+1,a[e+1]),_e("Query.onSnapshot","function",e+2,a[e+2]),{next:a[e],error:a[e+1],complete:a[e+2]}),this.onSnapshotInternal(d,c)},a.prototype.onSnapshotInternal=function(a,b){var c=this,d=function(a){console.error("Uncaught Error in onSnapshot:",a)};b.error&&(d=b.error.bind(b));var e=new uk({next:function(a){b.next&&b.next(new hl(c.firestore,c._query,a))},error:d}),f=this.firestore.ensureClientConfigured(),g=f.listen(this._query,e,a);return function(){e.mute(),f.unlisten(g)}},a.prototype.get=function(a){var b=this;return Ze("Query.get",arguments,0,1),ll("Query.get",a),new Promise(function(c,d){a&&"cache"===a.source?b.firestore.ensureClientConfigured().getDocumentsFromLocalCache(b._query).then(function(a){c(new hl(b.firestore,b._query,a))},d):b.getViaSnapshotListener(c,d,a)})},a.prototype.getViaSnapshotListener=function(a,b,c){var d=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(e){d(),e.metadata.fromCache&&c&&"server"===c.source?b(new Pe(Oe.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):a(e)},error:b})},a.prototype.parseDocumentIdValue=function(a){if("string"==typeof a){if(""===a)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid document ID, but it was an empty string.");if(!this._query.isCollectionGroupQuery()&&-1!==a.indexOf("/"))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. When querying a collection by FieldPath.documentId(), you must provide a plain document ID, but '"+a+"' contains a '/' character.");var b=this._query.path.child(Df.fromString(a));if(!Gf.isDocumentKey(b))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. When querying a collection group by FieldPath.documentId(), the value provided must result in a valid document path, but '"+b+"' is not because it has an odd number of segments ("+b.length+").");return new di(this.firestore._databaseId,new Gf(b))}if(a instanceof cl){var c=a;return new di(this.firestore._databaseId,c._key)}throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. When querying with FieldPath.documentId(), you must provide a valid string or a DocumentReference, but it was: "+gf(a)+".")},a.prototype.validateDisjunctiveFilterElements=function(a,b){if(!Array.isArray(a)||0===a.length)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid Query. A non-empty array is required for '"+b.toString()+"' filters.");if(10<a.length)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid Query. '"+b.toString()+"' filters support a maximum of 10 elements in the value array.");if(0<=a.indexOf(null))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid Query. '"+b.toString()+"' filters cannot contain 'null' in the value array.");if(0<a.filter(function(a){return Number.isNaN(a)}).length)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid Query. '"+b.toString()+"' filters cannot contain 'NaN' in the value array.")},a.prototype.validateNewFilter=function(a){if(a instanceof wj){var b=[vj.ARRAY_CONTAINS,vj.ARRAY_CONTAINS_ANY],c=[vj.IN,vj.ARRAY_CONTAINS_ANY],d=0<=b.indexOf(a.op),e=0<=c.indexOf(a.op);if(a.isInequality()){var f=this._query.getInequalityFilterField();if(null!==f&&!f.isEqual(a.field))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (<, <=, >, or >=) must be on the same field. But you have inequality filters on '"+f.toString()+"' and '"+a.field.toString()+"'");var g=this._query.getFirstOrderByField();null!==g&&this.validateOrderByAndInequalityMatch(a.field,g)}else if(e||d){var h=null;if(e&&(h=this._query.findFilterOperator(c)),null===h&&d&&(h=this._query.findFilterOperator(b)),null!=h)throw h===a.op?new Pe(Oe.INVALID_ARGUMENT,"Invalid query. You cannot use more than one '"+a.op.toString()+"' filter."):new Pe(Oe.INVALID_ARGUMENT,"Invalid query. You cannot use '"+a.op.toString()+"' filters with '"+h.toString()+"' filters.")}}},a.prototype.validateNewOrderBy=function(a){if(null===this._query.getFirstOrderByField()){var b=this._query.getInequalityFilterField();null!==b&&this.validateOrderByAndInequalityMatch(b,a.field)}},a.prototype.validateOrderByAndInequalityMatch=function(a,b){if(!b.isEqual(a))throw new Pe(Oe.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality (<, <=, >, or >=) on field '"+a.toString()+"' and so you must also use '"+a.toString()+"' as your first Query.orderBy(), but your first Query.orderBy() is on field '"+b.toString()+"' instead.")},a}(),hl=function(){function a(a,b,c){this._firestore=a,this._originalQuery=b,this._snapshot=c,this._cachedChanges=null,this._cachedChangesIncludeMetadataChanges=null,this.metadata=new dl(c.hasPendingWrites,c.fromCache)}return Object.defineProperty(a.prototype,"docs",{get:function(){var a=[];return this.forEach(function(b){return a.push(b)}),a},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0}),a.prototype.forEach=function(a,b){var c=this;Ze("QuerySnapshot.forEach",arguments,1,2),$e("QuerySnapshot.forEach","function",1,a),this._snapshot.docs.forEach(function(d){a.call(b,c.convertToDocumentImpl(d))})},Object.defineProperty(a.prototype,"query",{get:function(){return new gl(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0}),a.prototype.docChanges=function(a){a&&(jf("QuerySnapshot.docChanges",a,["includeMetadataChanges"]),bf("QuerySnapshot.docChanges","boolean","includeMetadataChanges",a.includeMetadataChanges));var b=!!a&&!!a.includeMetadataChanges;if(b&&this._snapshot.excludesMetadataChanges)throw new Pe(Oe.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===b||(this._cachedChanges=function(a,b,c){if(c.oldDocs.isEmpty()){var d,e=0;return c.docChanges.map(function(b){var f=new fl(a,b.doc.key,b.doc,c.fromCache,c.mutatedKeys.has(b.doc.key));return Le(b.type===$i.Added,"Invalid event type for first snapshot"),Le(!d||c.query.docComparator(d,b.doc)<0,"Got added events in wrong order"),d=b.doc,{type:"added",doc:f,oldIndex:-1,newIndex:e++}})}var f=c.oldDocs;return c.docChanges.filter(function(a){return b||a.type!==$i.Metadata}).map(function(b){var d=new fl(a,b.doc.key,b.doc,c.fromCache,c.mutatedKeys.has(b.doc.key)),e=-1,g=-1;return b.type!==$i.Added&&(Le(0<=(e=f.indexOf(b.doc.key)),"Index for document not found"),f=f.delete(b.doc.key)),b.type!==$i.Removed&&(f=f.add(b.doc),g=f.indexOf(b.doc.key)),{type:function(a){switch(
a){case $i.Added:return"added";case $i.Modified:case $i.Metadata:return"modified";case $i.Removed:return"removed";default:return Ke("Unknown change type: "+a)}}(b.type),doc:d,oldIndex:e,newIndex:g}})}(this._firestore,b,this._snapshot),this._cachedChangesIncludeMetadataChanges=b),this._cachedChanges},a.prototype.isEqual=function(b){if(b instanceof a)return this._firestore===b._firestore&&this._originalQuery.isEqual(b._originalQuery)&&this._snapshot.isEqual(b._snapshot);throw kf("isEqual","QuerySnapshot",1,b)},a.prototype.convertToDocumentImpl=function(a){return new fl(this._firestore,a.key,a,this.metadata.fromCache,this._snapshot.mutatedKeys.has(a.key))},a}();j(["length","forEach","map"],"undefined"!=typeof Symbol?[Symbol.iterator]:[]).forEach(function(a){try{Object.defineProperty(hl.prototype.docChanges,a,{get:function(){return function(){throw new Pe(Oe.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"')}()}})}catch(a){}});var il=function(a){function b(b,c){var d=a.call(this,tj.atPath(b),c)||this;if(b.length%2!=1)throw new Pe(Oe.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+b.canonicalString()+" has "+b.length);return d}return e(b,a),Object.defineProperty(b.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"parent",{get:function(){var a=this._query.path.popLast();return a.isEmpty()?null:new cl(new Gf(a),this.firestore)},enumerable:!0,configurable:!0}),Object.defineProperty(b.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0}),b.prototype.doc=function(a){if(Ze("CollectionReference.doc",arguments,0,1),0===arguments.length&&(a=nf.newId()),$e("CollectionReference.doc","non-empty string",1,a),""===a)throw new Pe(Oe.INVALID_ARGUMENT,"Document path must be a non-empty string");var b=Df.fromString(a);return cl.forPath(this._query.path.child(b),this.firestore)},b.prototype.add=function(a){Xe("CollectionReference.add",arguments,1),$e("CollectionReference.add","object",1,a);var b=this.doc();return b.set(a).then(function(){return b})},b}(gl),nl=Qe(_k,"Use firebase.firestore() instead."),ol=Qe(al,"Use firebase.firestore().runTransaction() instead."),pl=Qe(bl,"Use firebase.firestore().batch() instead."),ql=Qe(cl,"Use firebase.firestore().doc() instead."),rl=Qe(el),sl=Qe(fl),tl=Qe(gl),ul=Qe(hl),vl=Qe(il,"Use firebase.firestore().collection() instead."),wl={Firestore:nl,GeoPoint:sj,Timestamp:Sf,Blob:wf,Transaction:ol,WriteBatch:pl,DocumentReference:ql,DocumentSnapshot:rl,Query:tl,QueryDocumentSnapshot:sl,QuerySnapshot:ul,CollectionReference:vl,FieldPath:vk,FieldValue:Lk,setLogLevel:_k.setLogLevel,CACHE_SIZE_UNLIMITED:Yk},yl=function(){function a(){}return a.prototype.addCallback=function(a){},a.prototype.shutdown=function(){},a}(),zl="ConnectivityMonitor",Al=function(){function a(){var a=this;this.networkAvailableListener=function(){return a.onNetworkAvailable()},this.networkUnavailableListener=function(){return a.onNetworkUnavailable()},this.callbacks=[],this.configureNetworkMonitoring()}return a.prototype.addCallback=function(a){this.callbacks.push(a)},a.prototype.shutdown=function(){window.removeEventListener("online",this.networkAvailableListener),window.removeEventListener("offline",this.networkUnavailableListener)},a.prototype.configureNetworkMonitoring=function(){window.addEventListener("online",this.networkAvailableListener),window.addEventListener("offline",this.networkUnavailableListener)},a.prototype.onNetworkAvailable=function(){var a,b;He(zl,"Network connectivity changed: AVAILABLE");try{for(var c=h(this.callbacks),d=c.next();!d.done;d=c.next())(0,d.value)(0)}catch(b){a={error:b}}finally{try{d&&!d.done&&(b=c.return)&&b.call(c)}finally{if(a)throw a.error}}},a.prototype.onNetworkUnavailable=function(){var a,b;He(zl,"Network connectivity changed: UNAVAILABLE");try{for(var c=h(this.callbacks),d=c.next();!d.done;d=c.next())(0,d.value)(1)}catch(b){a={error:b}}finally{try{d&&!d.done&&(b=c.return)&&b.call(c)}finally{if(a)throw a.error}}},a.isAvailable=function(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener},a}(),Bl=function(){function a(a){this.sendFn=a.sendFn,this.closeFn=a.closeFn}return a.prototype.onOpen=function(a){Le(!this.wrappedOnOpen,"Called onOpen on stream twice!"),this.wrappedOnOpen=a},a.prototype.onClose=function(a){Le(!this.wrappedOnClose,"Called onClose on stream twice!"),this.wrappedOnClose=a},a.prototype.onMessage=function(a){Le(!this.wrappedOnMessage,"Called onMessage on stream twice!"),this.wrappedOnMessage=a},a.prototype.close=function(){this.closeFn()},a.prototype.send=function(a){this.sendFn(a)},a.prototype.callOnOpen=function(){Le(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set"),this.wrappedOnOpen()},a.prototype.callOnClose=function(a){Le(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set"),this.wrappedOnClose(a)},a.prototype.callOnMessage=function(a){Le(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set"),this.wrappedOnMessage(a)},a}(),Cl="Connection",Dl={BatchGetDocuments:"batchGet",Commit:"commit"},El="gl-js/ fire/"+De,Fl=function(){function a(a){this.databaseId=a.databaseId;var b=a.ssl?"https":"http";this.baseUrl=b+"://"+a.host,this.forceLongPolling=a.forceLongPolling}return a.prototype.modifyHeadersForRequest=function(a,b){if(b)for(var c in b.authHeaders)b.authHeaders.hasOwnProperty(c)&&(a[c]=b.authHeaders[c]);a["X-Goog-Api-Client"]=El},a.prototype.invokeRPC=function(a,b,c){var d=this,e=this.makeUrl(a);return new Promise(function(f,g){var h=new Ce;h.listenOnce(Ae.COMPLETE,function(){try{switch(h.getLastErrorCode()){case ze.NO_ERROR:var b=h.getResponseJson();He(Cl,"XHR received:",JSON.stringify(b)),f(b);break;case ze.TIMEOUT:He(Cl,'RPC "'+a+'" timed out'),g(new Pe(Oe.DEADLINE_EXCEEDED,"Request time out"));break;case ze.HTTP_ERROR:var c=h.getStatus();He(Cl,'RPC "'+a+'" failed with status:',c,"response text:",h.getResponseText()),0<c?g(new Pe(function(a){switch(a){case 200:return Oe.OK;case 400:return Oe.INVALID_ARGUMENT;case 401:return Oe.UNAUTHENTICATED;case 403:return Oe.PERMISSION_DENIED;case 404:return Oe.NOT_FOUND;case 409:return Oe.ABORTED;case 416:return Oe.OUT_OF_RANGE;case 429:return Oe.RESOURCE_EXHAUSTED;case 499:return Oe.CANCELLED;case 500:return Oe.UNKNOWN;case 501:return Oe.UNIMPLEMENTED;case 503:return Oe.UNAVAILABLE;case 504:return Oe.DEADLINE_EXCEEDED;default:return 200<=a&&a<300?Oe.OK:400<=a&&a<500?Oe.FAILED_PRECONDITION:500<=a&&a<600?Oe.INTERNAL:Oe.UNKNOWN}}(c),"Server responded with status "+h.getStatusText())):(He(Cl,'RPC "'+a+'" failed'),g(new Pe(Oe.UNAVAILABLE,"Connection failed.")));break;default:Ke('RPC "'+a+'" failed with unanticipated webchannel error '+h.getLastErrorCode()+": "+h.getLastError()+", giving up.")}}finally{He(Cl,'RPC "'+a+'" completed.')}});var i=JSON.stringify(b);He(Cl,"XHR sending: ",e+" "+i);var j={"Content-Type":"text/plain"};d.modifyHeadersForRequest(j,c),h.send(e,"POST",i,j,15)})},a.prototype.invokeStreamingRPC=function(a,b,c){return this.invokeRPC(a,b,c)},a.prototype.openStream=function(a,b){var c=[this.baseUrl,"/","google.firestore.v1.Firestore","/",a,"/channel"],d=ye(),e={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling};this.modifyHeadersForRequest(e.initMessageHeaders,b),"object"==typeof navigator&&"ReactNative"===navigator.product||(e.httpHeadersOverwriteParam="$httpHeaders");var f=c.join("");He(Cl,"Creating WebChannel: "+f+" "+e);var g=d.createWebChannel(f,e),h=!1,i=!1,j=new Bl({sendFn:function(a){i?He(Cl,"Not sending because WebChannel is closed:",a):(h||(He(Cl,"Opening WebChannel transport."),g.open(),h=!0),He(Cl,"WebChannel sending:",a),g.send(a))},closeFn:function(){return g.close()}}),k=function(a,b){g.listen(a,function(a){try{b(a)}catch(a){setTimeout(function(){throw a},0)}})};return k(Be.EventType.OPEN,function(){i||He(Cl,"WebChannel transport opened.")}),k(Be.EventType.CLOSE,function(){i||(i=!0,He(Cl,"WebChannel transport closed"),j.callOnClose())}),k(Be.EventType.ERROR,function(a){i||(i=!0,He(Cl,"WebChannel transport errored:",a),j.callOnClose(new Pe(Oe.UNAVAILABLE,"The operation could not be completed")))}),k(Be.EventType.MESSAGE,function(a){if(!i){var b=a.data[0];Le(!!b,"Got a webchannel message without data.");var c=b,d=c.error||c[0]&&c[0].error;if(d){He(Cl,"WebChannel received error:",d);var e=d.status,f=function(a){var b=Vi[a];if(void 0!==b)return Zi(b)}(e),h=d.message;void 0===f&&(f=Oe.INTERNAL,h="Unknown error status: "+e+" with message "+d.message),i=!0,j.callOnClose(new Pe(f,h)),g.close()}else He(Cl,"WebChannel received:",b),j.callOnMessage(b)}}),setTimeout(function(){j.callOnOpen()},0),j},a.prototype.makeUrl=function(a){var b=Dl[a];Le(void 0!==b,"Unknown REST mapping for: "+a);var c=[this.baseUrl,"/","v1"];return c.push("/projects/"),c.push(this.databaseId.projectId),c.push("/databases/"),c.push(this.databaseId.database),c.push("/documents"),c.push(":"),c.push(b),c.join("")},a}(),Gl=function(){function a(){this.emptyByteString="",this.base64Available="undefined"!=typeof atob}return Object.defineProperty(a.prototype,"document",{get:function(){return"undefined"!=typeof document?document:null},enumerable:!0,configurable:!0}),Object.defineProperty(a.prototype,"window",{get:function(){return"undefined"!=typeof window?window:null},enumerable:!0,configurable:!0}),a.prototype.loadConnection=function(a){return Promise.resolve(new Fl(a))},a.prototype.newConnectivityMonitor=function(){return Al.isAvailable()?new Al:new yl},a.prototype.newSerializer=function(a){return new Uj(a,{useProto3Json:!0})},a.prototype.formatJSON=function(a){return JSON.stringify(a)},a.prototype.atob=function(a){return atob(a)},a.prototype.btoa=function(a){return btoa(a)},a}();Me.setPlatform(new Gl),xl(a)}).apply(this,arguments)}catch(b){throw console.error(b),new Error("Cannot instantiate firebase-firestore - be sure to load firebase-app.js first.")}});